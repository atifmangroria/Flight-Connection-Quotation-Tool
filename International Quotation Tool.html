<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>International Tour Quotation Tool — Flight Connection</title>

<!-- Libraries for PDF/Image/Excel -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDx3Qxt84vJlz_-mXuxiC0W2flaLadr9Ws",
    authDomain: "fc-quotation-tool.firebaseapp.com",
    projectId: "fc-quotation-tool",
    storageBucket: "fc-quotation-tool.firebasestorage.app",
    messagingSenderId: "370566945624",
    appId: "1:370566945624:web:a84b20d5a8f99d20a6e32d"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Make db and auth global
  window.db = db;
  window.auth = auth;

  // ========== Firebase Cloud Storage Utility Functions ==========
  window.firebaseDB = {
    // Save data to Firestore
    async saveData(collection_name, docId, data) {
      try {
        await setDoc(doc(db, collection_name, docId), data, { merge: true });
        return true;
      } catch (error) {
        console.error(`Error saving to ${collection_name}:`, error);
        return false;
      }
    },

    // Get data from Firestore
    async getData(collection_name, docId) {
      try {
        const docSnap = await getDoc(doc(db, collection_name, docId));
        return docSnap.exists() ? docSnap.data() : null;
      } catch (error) {
        console.error(`Error getting from ${collection_name}:`, error);
        return null;
      }
    },

    // Get all documents from a collection
    async getAll(collection_name) {
      try {
        const snapshot = await getDocs(collection(db, collection_name));
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error(`Error getting all from ${collection_name}:`, error);
        return [];
      }
    },

    // Delete data from Firestore
    async deleteData(collection_name, docId) {
      try {
        await deleteDoc(doc(db, collection_name, docId));
        return true;
      } catch (error) {
        console.error(`Error deleting from ${collection_name}:`, error);
        return false;
      }
    },

    // Update specific fields
    async updateData(collection_name, docId, updates) {
      try {
        await updateDoc(doc(db, collection_name, docId), updates);
        return true;
      } catch (error) {
        console.error(`Error updating ${collection_name}:`, error);
        return false;
      }
    }
  };

  // Make collection functions available
  window.collection = collection;
  window.doc = doc;
  window.deleteDoc = deleteDoc;
  window.updateDoc = updateDoc;
</script>

<style>
  :root{--accent:#0b76d1;--muted:#666;--success-bg:#d4edda;--success-text:#155724;--error-bg:#f8d7da;--error-text:#721c24}
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;margin:10px;color:#111}
  .wrap{max-width:1150px;margin:0 auto;background:#fff;padding:14px;border-radius:8px;box-shadow:0 8px 24px rgba(12,20,40,0.06)}
  h1{margin:0 0 6px;font-size:20px}
  label{display:block;font-size:13px;color:#222;margin-top:8px}
  input,select,textarea,button{font-family:inherit}
input[type="text"], input[type="number"], input[type="date"], input[type="password"], select, textarea{
  width:100%;padding:10px 12px;border:1px solid #d6dbe2;border-radius:6px;font-size:16px;background:#fff;
  box-sizing:border-box;transition:border-color 0.3s ease, box-shadow 0.3s ease;
}
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="password"]:focus, select:focus, textarea:focus{
  border-color:var(--accent);box-shadow:0 0 0 3px rgba(11, 118, 209, 0.1);outline:none;
}
  textarea{min-height:70px;resize:vertical}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .full{grid-column:1/-1}
  .section{border:1px solid #e6eef8;padding:12px;border-radius:8px;margin-top:12px;background:#fbfdff}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--accent);color:#fff;border:0;padding:8px 8px;border-radius:6px;cursor:pointer;transition:background-color 0.2s}
  button.ghost{background:#eef5fb;color:var(--accent);border:1px solid #d6e8fb}
  button:hover{background-color: #085ea3;}
  button.ghost:hover{background-color: #d6e8fb;}
  .small{font-size:12px;color:var(--muted)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header img{height:56px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:6px;border-bottom:1px solid #eee;font-size:13px;text-align:left}
  .saved-list{max-height:220px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px}
  .no-print{display:block}
  .center{text-align:center}
  pre{background:#ffffff;padding:8px;border-radius:6px;border:1px solid #eee;white-space:pre-wrap}
  
  .input-error { border: 2px solid red !important; }
  .flight-header, .hotel-header, .transfer-header, .visa-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .flight-header h3, .hotel-header h3, .transfer-header h3, .visa-header h3 { margin: 0; }
  .add-btn { background: #4CAF50; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; }
  .add-btn:hover { background: #45a049; }
  .remove-btn { background: #e74c3c; color: #fff; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px; }
  .remove-btn:hover { background: #c0392b; }

  /* Currency Selector */
  .currency-selector {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .currency-selector select {
    width: 120px;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  
  .currency-display {
    font-weight: bold;
    color: var(--accent);
    padding: 5px 10px;
    background: #e3f2fd;
    border-radius: 4px;
  }
  
  /* Tour Type Badge */
  .tour-type-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
    background: #007bff;
    color: white;
  }
  
  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .modal-overlay.visible {
    opacity: 1;
    visibility: visible;
  }
  .modal-content {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    max-width: 600px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    transform: translateY(-20px);
    transition: transform 0.3s ease;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-overlay.visible .modal-content {
    transform: translateY(0);
  }
  .modal-content h3 {
    margin: 0 0 10px;
    font-size: 22px;
    color: #333;
  }
  .modal-content p {
    color: #666;
    margin-bottom: 20px;
  }
  .modal-buttons button {
    padding: 10px 20px;
    font-size: 14px;
    margin: 5px;
  }

  /* Notification Styles */
  .temp-notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .temp-notification-overlay.visible {
    opacity: 1;
    visibility: visible;
  }
  .temp-notification {
    background: #ffff;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    color: #333;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    min-width: 300px;
    font-size: 16px;
  }
  .temp-notification-overlay.visible .temp-notification {
    transform: scale(1);
  }
  .temp-notification.success { background-color: var(--success-bg); color: var(--success-text); border: 2px solid #28a745; }
  .temp-notification.error { background-color: var(--error-bg); color: var(--error-text); border: 2px solid #dc3545; }
  .temp-notification.info { background-color: #e2f2ff; color: #004085; border: 2px solid #007bff; }

  /* Add-ons Section Styles */
  .addon-header {
    background:#f5f5f5;
    padding:8px 12px;
    cursor:pointer;
    border-radius:6px;
    margin-top:6px;
    font-weight:bold;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .addon-panel {
    padding:8px 12px;
    border:1px solid #ddd;
    border-radius:6px;
    margin-top:4px;
  }
  .panel-icon {
    font-weight:bold;
  }
  .green-btn { background:#4CAF50; }
  .green-btn:hover { background:#45a049; }
  .orange-btn { background:#f39c12; }
  .orange-btn:hover { background:#d68910; }
  .blue-btn { background:#3498db; }
  .blue-btn:hover { background:#2980b9; }
  .whatsapp-btn { background:#25D366; }
  .whatsapp-btn:hover { background:#128C7E; }
  
  .section-entry { border:1px solid #ddd; padding:10px; margin-top:8px; border-radius:6px; }
  .section-entry h4 { display:flex; justify-content:space-between; align-items:center; margin:0 0 6px 0; }
  .inline-input { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .inline-input input { width:120px; }
  .inline-input label { width:140px; }

  /* Calculation Table Styles */
  #calcSummaryTable thead th {
    background-color: #007bff;
    color: white;
    font-weight: bold;
  }

  /* Header Button Styling */
  .header-btn {
    min-width: 140px !important;
    height: 40px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
    padding: 8px 16px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    box-sizing: border-box !important;
  }

  /* Rich Text Editor Styles */
  .rich-editor-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    padding: 10px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
  }

  .rich-editor-btn {
    padding: 8px 12px;
    border: 1px solid #1a237e;
    background: #1a237e;
    cursor: pointer;
    border-radius: 4px;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.2s;
    min-width: 30px;
    text-align: center;
    color: white !important;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }

  .rich-editor-btn:hover {
    background: #283593;
    border-color: #3949ab;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
  }

  .rich-editor-btn.active {
    background: #0d47a1;
    color: white !important;
    border-color: #0d47a1;
    box-shadow: 0 2px 6px rgba(13, 71, 161, 0.4);
  }

  .rich-editor-separator {
    width: 1px;
    background: #ccc;
    margin: 0 5px;
  }

  /* Section Toggle Styles */
  .section-toggle-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding: 10px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
  }

  .section-toggle-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    color: #333;
  }

  .toggle-switch {
    position: relative;
    width: 50px;
    height: 24px;
    background: #ccc;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .toggle-switch.active {
    background: var(--accent);
  }

  .toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .toggle-switch.active::after {
    transform: translateX(26px);
  }

  .section-disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .section-status {
    font-size: 12px;
    color: #666;
    font-style: italic;
  }

  /* Terms Edit Styles */
  .terms-editor {
    width: 100%;
    min-height: 200px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 15px;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }

  /* Certifications Styles */
  .certifications {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  .certification {
    text-align: center;
    margin: 10px;
    max-width: 150px;
  }
  .certification img {
    max-width: 100px;
    max-height: 100px;
    margin-bottom: 5px;
  }
  .certification p {
    font-size: 12px;
    margin: 0;
  }

  /* Progress Bar */
  .progress-container {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .progress-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #e9ecef;
    padding: 10px;
    border-radius: 25px;
    position: relative;
  }

  .progress-step {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: #6c757d;
    background: white;
    border: 2px solid #dee2e6;
    position: relative;
    z-index: 1;
  }

  .progress-step.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .progress-step.completed {
    background: #28a745;
    color: white;
    border-color: #28a745;
  }

  .progress-step::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 100%;
    width: 20px;
    height: 2px;
    background: #dee2e6;
    z-index: 0;
  }

  .progress-step:last-child::after {
    display: none;
  }

  @media (max-width:768px){ 
    body { margin: 5px; }
    .wrap { padding: 10px; }
    .grid{grid-template-columns:1fr} 
    .modal-content { width: 95%; max-height: 90vh; padding: 15px; }
    .actions { flex-direction: column; }
    button { width: 100%; margin-bottom: 8px; min-height: 44px; }
    .inline-input { flex-direction: column; align-items: stretch; }
    .inline-input label { margin-bottom: 5px; }
    table { font-size: 12px; overflow-x: auto; display: block; }
    th, td { padding: 6px; }
    .saved-list { max-height: 150px; }
  }
  @media print{ .no-print{display:none} }

  /* Rich Text Editor Styles */
.rich-editor-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 10px;
  background: #f5f5f5;
  border: 1px solid #ddd;
  border-bottom: none;
  border-radius: 6px 6px 0 0;
}

.rich-editor-btn {
  padding: 8px 12px;
  border: 1px solid #1a237e;
  background: #1a237e;
  cursor: pointer;
  border-radius: 4px;
  font-size: 14px;
  font-weight: bold;
  transition: all 0.2s;
  min-width: 30px;
  text-align: center;
  color: white !important;
  box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
}

.rich-editor-btn:hover {
  background: #283593;
  border-color: #3949ab;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
}

.rich-editor-btn.active {
  background: #0d47a1;
  color: white !important;
  border-color: #0d47a1;
  box-shadow: 0 2px 6px rgba(13, 71, 161, 0.4);
}

.rich-editor-separator {
  width: 1px;
  background: #ccc;
  margin: 0 5px;
}

/* Section Toggle Styles */
.section-toggle-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
  padding: 10px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
}

.section-toggle-label {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: bold;
  color: #333;
}

.toggle-switch {
  position: relative;
  width: 50px;
  height: 24px;
  background: #ccc;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.3s;
}

.toggle-switch.active {
  background: var(--accent);
}

.toggle-switch::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  transition: transform 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch.active::after {
  transform: translateX(26px);
}

.section-disabled {
  opacity: 0.5;
  pointer-events: none;
}

.section-status {
  font-size: 12px;
  color: #666;
  font-style: italic;
}

/* Add this to your main <style> section */
@media print {
  * {
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
}

@page { 
  margin: 0.5in; 
  size: A4;
  
  /* Header and Footer */
  @top-center {
    content: "Flight Connection Travel & Tours";
    font-size: 12px;
    color: #0b76d1;
    font-weight: bold;
  }
  
  @bottom-center {
    content: "Page " counter(page);
    font-size: 10px;
    color: #666;
  }
}

@media print {
  button[onclick*="toggle"] {
    display: none !important;
  }
}

</style>
</head>
<body>

<!-- Temporary Notification HTML -->
<div id="temp-notification-overlay" class="temp-notification-overlay no-print">
  <div id="temp-notification" class="temp-notification"></div>
</div>

<div id="custom-modal" class="modal-overlay no-print">
  <div class="modal-content">
    <h3 id="modal-title"></h3>
    <p id="modal-message"></p>
    <div id="modal-buttons" class="modal-buttons"></div>
  </div>
</div>

<div class="wrap">

<!-- HEADER -->
<div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
  <div>
    <h1>International Quotation</h1>
    <div class="small">Use Chrome/Edge.</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center" class="no-print">
    <div id="agentInfoDisplay" class="small"></div>
    <button id="btnSaveQuotation" class="ghost">Save Quotation</button>
    <button id="btnLoadQuotation" class="ghost">Load Quotation</button>
    <button id="btnDashboard" class="ghost">Dashboard</button>
  </div>
</div>

<script>
 // --- Custom UI functions for Notifications and Modals ---
    const tempNotificationOverlay = document.getElementById("temp-notification-overlay");
    const tempNotification = document.getElementById("temp-notification");

    function showNotification(message, type = 'info', duration = 3000) {
        tempNotification.textContent = message;
        tempNotification.className = `temp-notification ${type}`;
        tempNotificationOverlay.classList.add("visible");

        setTimeout(() => {
            tempNotificationOverlay.classList.remove("visible");
        }, duration);
    }
    
    const customModal = document.getElementById("custom-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalMessage = document.getElementById("modal-message");
    const modalButtons = document.getElementById("modal-buttons");

    function showAlert(message, title = 'Alert') {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            const okBtn = document.createElement("button");
            okBtn.textContent = 'OK';
            okBtn.addEventListener("click", () => {
                customModal.classList.remove("visible");
                resolve();
            });
            modalButtons.appendChild(okBtn);
            customModal.classList.add("visible");
        });
    }

    function showConfirm(message, title = 'Confirm') {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            const yesBtn = document.createElement("button");
            yesBtn.textContent = 'Yes';
            yesBtn.addEventListener("click", () => {
                customModal.classList.remove("visible");
                resolve(true);
            });
            const noBtn = document.createElement("button");
            noBtn.textContent = 'No';
            noBtn.classList.add("ghost");
            noBtn.addEventListener("click", () => {
                customModal.classList.remove("visible");
                resolve(false);
            });
            modalButtons.appendChild(yesBtn);
            modalButtons.appendChild(noBtn);
            customModal.classList.add("visible");
        });
    }

// --- SIMPLE AUTHENTICATION CHECK ---
function checkAuthentication() {
  const agent = JSON.parse(localStorage.getItem("loggedInAgent"));
  if (!agent) {
    showNotification("Please login to access the quotation tool", "error");
    setTimeout(() => {
      window.location.href = 'dashboard.html';
    }, 2000);
    return null;
  }
  return agent;
}

// --- AGENT UI UPDATE ---
function updateAgentUI() {
  const agent = JSON.parse(localStorage.getItem("loggedInAgent"));
  const agentInfoDisplay = document.getElementById("agentInfoDisplay");
  const agentNameDisplay = document.getElementById("agentNameDisplay");
  const agentPhoneDisplay = document.getElementById("agentPhoneDisplay");
  const btnSaveQuotation = document.getElementById("btnSaveQuotation");
  
  if (agent) {
    if (agentInfoDisplay) agentInfoDisplay.innerText = `Logged in as: ${agent.name} (${agent.phone})`;
    if (agentNameDisplay) agentNameDisplay.textContent = agent.name;
    if (agentPhoneDisplay) agentPhoneDisplay.textContent = agent.phone;
    if (btnSaveQuotation) btnSaveQuotation.style.display = "inline-block";
    
    // Add this at the end of the function
    showStatusSection();
  } else {
    if (agentInfoDisplay) agentInfoDisplay.innerText = "";
    if (agentNameDisplay) agentNameDisplay.textContent = '—';
    if (agentPhoneDisplay) agentPhoneDisplay.textContent = '';
    if (btnSaveQuotation) btnSaveQuotation.style.display = "none";
  }
}

// --- DASHBOARD BUTTON ---
document.getElementById('btnDashboard').addEventListener('click', () => {
  window.location.href = 'dashboard.html';
});

// Function to get current agent
function getCurrentAgent() {
  return JSON.parse(localStorage.getItem("loggedInAgent"));
}

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', function() {
  // Check authentication on page load
  const agent = checkAuthentication();
  if (agent) {
    updateAgentUI();
    // Load quotations from Firebase
    window.firebaseDB.getData('international_quotations', agent.id).then(firebaseData => {
      if (firebaseData && firebaseData.quotations) {
        localStorage.setItem('savedQuotations_international', JSON.stringify(firebaseData.quotations));
        savedQuotations = firebaseData.quotations;
      }
    }).catch(err => console.error('Load error:', err));
  }
});

</script>

<!-- MAIN FORM -->
<form id="mainForm" onsubmit="return false;">

<!-- COMPANY HEADER / AGENT -->
<div class="section">
  <header style="display:flex;justify-content:space-between;align-items:center">
    <div style="display:flex;gap:12px;align-items:center">
      <img id="companyLogo" src="https://flightconnection.net.pk/wp-content/uploads/2018/09/cropped-cropped-Flight-Connection-Travel-1.png" alt="logo">
    </div>
    <div style="text-align:right">
      <div id="agentNameDisplay" style="font-weight:700">—</div>
      <div id="agentPhoneDisplay" class="small"></div>
    </div>
  </header>
</div>

  <!-- CLIENT & PAX -->
  <div class="section">
    <h3>Client & Pax</h3>
    <div class="grid">
      <div>
        <label for="clientName">Client Name</label>
        <input id="clientName" type="text" aria-required="true">
      </div>
      <div>
        <label for="reference">Reference</label>
        <select id="reference" aria-required="true">
          <option value="">-- Select --</option>
          <option value="Campaign">Campaign</option>
          <option value="Walkin">Walkin</option>
          <option value="Call">Call</option>
          <option value="Careoff">Careoff</option>
        </select>
      </div>

      <div id="refExtraDiv" class="full" style="display:none">
        <label id="refExtraLabel"></label>
        <input id="refExtra" type="text">
      </div>

      <div>
        <label for="clientPhone">Phone Number</label>
        <input id="clientPhone" type="text" aria-required="true">
      </div>
      <div>
        <label for="depCity">Departure City</label>
        <select id="depCity" aria-required="true">
          <option>Karachi</option>
          <option>Islamabad</option>
          <option>Lahore</option>
          <option>Multan</option>
          <option>Peshawar</option>
        </select>
      </div>

      <div>
        <label for="numAdult">Adults</label>
        <input id="numAdult" type="number" value="1" min="0" aria-required="true">
      </div>
      <div>
        <label for="numChildBed">Children (With Bed)</label>
        <input id="numChildBed" type="number" value="0" min="0">
      </div>
      <div>
        <label for="numChildNoBed">Children (Without Bed)</label>
        <input id="numChildNoBed" type="number" value="0" min="0">
      </div>
      <div>
        <label for="numInfant">Infants</label>
        <input id="numInfant" type="number" value="0" min="0">
      </div>

      <div class="full">
        <label for="dateFrom">Travel Dates (From — To)</label>
        <div style="display:flex;gap:8px">
          <input id="dateFrom" type="date" aria-required="true">
          <input id="dateTo" type="date" aria-required="true">
        </div>
        <div id="dateWarning" class="small" style="margin-top:6px;color:red;display:none" role="alert">
          Please select valid dates. "From" cannot be before today. "To" must be after "From".
        </div>
        <div id="dateSummary" class="small" style="margin-top:6px;font-weight:bold;color:green;display:none"></div>
      </div>

      <div class="full">
        <label for="tourDestination">Tour Destination</label>
        <input id="tourDestination" type="text" placeholder="e.g. Dubai, Singapore, Turkey">
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button id="btnSaveClient" type="button">Save Client & Pax</button>
      <button id="btnCheckClient" type="button">Check Data</button>
    </div>
  </div>

<script>
  let isClientDataSaved = false;
  let savedQuotations = JSON.parse(localStorage.getItem('savedQuotations_international')) || [];
  let currentQuotationId = null;
  let lastSavedPax = {};
  let lastSavedDates = {};
  let lastSavedClientInfo = {};

  // Helper function to get current agent
  function getCurrentAgent() {
    const agentData = localStorage.getItem("loggedInAgent");
    return agentData ? JSON.parse(agentData) : null;
  }

  // Save data to Firebase Cloud (async)
  async function saveToFirebase(key, data) {
    try {
      const agent = getCurrentAgent();
      if (!agent || !agent.uid) {
        console.warn('User not authenticated, using localStorage only');
        localStorage.setItem(key, JSON.stringify(data));
        return true;
      }
      
      // Save to Firestore under user's data collection
      await window.firebaseDB.saveData('agents/' + agent.uid + '/data', key, { value: data, updatedAt: new Date() });
      return true;
    } catch (error) {
      console.error('Error saving to Firebase:', error);
      // Fallback to localStorage
      localStorage.setItem(key, JSON.stringify(data));
      return false;
    }
  }

  function saveToLocalStorage(key, data) {
    try {
      // Try Firebase first (async)
      saveToFirebase(key, data).catch(err => {
        console.error('Firebase save failed:', err);
      });
      // Keep in localStorage for immediate access
      localStorage.setItem(key, JSON.stringify(data));
      return true;
    } catch (error) {
      showAlert("Failed to save data. Your browser's storage might be full.", "Error");
      return false;
    }
  }

  // Format date to DD/MM/YYYY
  function formatDateToDMY(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // Sanitize input to prevent XSS
  function sanitizeInput(input) {
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
  }

  const reference = document.getElementById("reference");
  const refExtraDiv = document.getElementById("refExtraDiv");
  const refExtraLabel = document.getElementById("refExtraLabel");

  reference.addEventListener("change", () => {
    if (reference.value === "Campaign") {
      refExtraDiv.style.display = "block";
      refExtraLabel.innerText = "Campaign Name";
    } else if (reference.value === "Careoff") {
      refExtraDiv.style.display = "block";
      refExtraLabel.innerText = "Person Name (Careoff)";
    } else {
      refExtraDiv.style.display = "none";
      refExtraLabel.innerText = "";
    }
  });

  // Date validation
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");
  const dateWarning = document.getElementById("dateWarning");
  const dateSummary = document.getElementById("dateSummary");

  function updateDateSummary() {
    if (dateFrom.value && dateTo.value && dateTo.value > dateFrom.value) {
      const d1 = new Date(dateFrom.value);
      const d2 = new Date(dateTo.value);
      const diffNights = Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
      const totalDays = diffNights + 1;
      dateSummary.style.display = "block";
      dateSummary.innerText = `Total: ${diffNights} Nights / ${totalDays} Days (${formatDateToDMY(dateFrom.value)} - ${formatDateToDMY(dateTo.value)})`;
    } else {
      dateSummary.style.display = "none";
    }
  }

  dateFrom.addEventListener("change", () => {
    const today = new Date().toISOString().split("T")[0];
    if (dateFrom.value < today) {
      dateWarning.style.display = "block";
      dateFrom.classList.add("input-error");
    } else {
      dateWarning.style.display = "none";
      dateFrom.classList.remove("input-error");
      dateTo.min = dateFrom.value;
    }
    updateDateSummary();
    if(isClientDataSaved) {
      checkDateChanges();
    }
  });

  dateTo.addEventListener("change", () => {
    if (dateTo.value <= dateFrom.value) {
      dateWarning.style.display = "block";
      dateTo.classList.add("input-error");
    } else {
      dateWarning.style.display = "none";
      dateTo.classList.remove("input-error");
    }
    updateDateSummary();
    if(isClientDataSaved) {
      checkDateChanges();
    }
  });

  const btnSaveClient = document.getElementById("btnSaveClient");

  async function validateAndSaveClientData() {
    let isValid = true;
    let errorMessage = "";

    // Function to clear all input error classes
    function clearErrors() {
      const inputs = document.querySelectorAll('#mainForm input, #mainForm select');
      inputs.forEach(input => input.classList.remove('input-error'));
      document.getElementById('dateWarning').style.display = 'none';
    }

    clearErrors();

    const clientName = document.getElementById("clientName");
    const ref = document.getElementById("reference");
    const clientPhone = document.getElementById("clientPhone");
    const numAdult = document.getElementById("numAdult");
    const dateFrom = document.getElementById("dateFrom");
    const dateTo = document.getElementById("dateTo");
    const tourDestination = document.getElementById("tourDestination");

    if (!clientName.value.trim()) {
      clientName.classList.add('input-error');
      errorMessage += "Client Name is required.\n";
      isValid = false;
    }

    if (ref.value === "") {
      ref.classList.add('input-error');
      errorMessage += "Reference is required.\n";
      isValid = false;
    }

    if (!clientPhone.value.trim()) {
      clientPhone.classList.add('input-error');
      errorMessage += "Phone Number is required.\n";
      isValid = false;
    }

    if (parseInt(numAdult.value) < 1) {
      numAdult.classList.add('input-error');
      errorMessage += "At least 1 Adult must be entered.\n";
      isValid = false;
    }

    if (!dateFrom.value || !dateTo.value) {
      dateFrom.classList.add('input-error');
      dateTo.classList.add('input-error');
      errorMessage += "Travel Dates are required.\n";
      isValid = false;
    }

    if (!tourDestination.value.trim()) {
      tourDestination.classList.add('input-error');
      errorMessage += "Tour Destination is required.\n";
      isValid = false;
    }

    if (isValid) {
      const clientData = {
        name: sanitizeInput(clientName.value.trim()),
        reference: sanitizeInput(ref.value.trim()),
        refExtra: sanitizeInput(document.getElementById("refExtra").value.trim()),
        phone: sanitizeInput(clientPhone.value.trim()),
        depCity: sanitizeInput(document.getElementById("depCity").value),
        adults: parseInt(numAdult.value || 0),
        childBed: parseInt(document.getElementById("numChildBed").value || 0),
        childNoBed: parseInt(document.getElementById("numChildNoBed").value || 0),
        infants: parseInt(document.getElementById("numInfant").value || 0),
        dateFrom: dateFrom.value,
        dateTo: dateTo.value,
        tourDestination: sanitizeInput(tourDestination.value.trim()),
      };

      saveToLocalStorage("savedClientData_international", clientData);
      showNotification("Client & Pax data saved successfully!", 'success');
      isClientDataSaved = true;

      // Update the last saved data for change detection
      lastSavedPax = getCurrentPaxData();
      lastSavedDates = { dateFrom: dateFrom.value, dateTo: dateTo.value };
      lastSavedClientInfo = { name: clientName.value, phone: clientPhone.value };
    } else {
      showAlert(errorMessage, "Validation Error");
      isClientDataSaved = false;
    }
  }

  btnSaveClient.addEventListener("click", validateAndSaveClientData);

  // Event listeners for PAX changes
  const paxInputs = ['numAdult', 'numChildBed', 'numChildNoBed', 'numInfant'];
  paxInputs.forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
      if (isClientDataSaved) {
        checkPaxChanges();
      }
    });
  });

  // Event listeners for Client Info changes
  const clientInfoInputs = ['clientName', 'clientPhone'];
  clientInfoInputs.forEach(id => {
    document.getElementById(id).addEventListener('input', () => {
      if (isClientDataSaved) {
        checkClientInfoChanges();
      }
    });
  });

  function checkPaxChanges() {
    const newPax = getCurrentPaxData();
    let changes = [];
    if (newPax.adults !== lastSavedPax.adults) changes.push(`Adults from ${lastSavedPax.adults} to ${newPax.adults}`);
    if (newPax.childBed !== lastSavedPax.childBed) changes.push(`Children (with bed) from ${lastSavedPax.childBed} to ${newPax.childBed}`);
    if (newPax.childNoBed !== lastSavedPax.childNoBed) changes.push(`Children (without bed) from ${lastSavedPax.childNoBed} to ${newPax.childNoBed}`);
    if (newPax.infants !== lastSavedPax.infants) changes.push(`Infants from ${lastSavedPax.infants} to ${newPax.infants}`);

    if (changes.length > 0) {
      const changeMsg = "Client & Pax data has been modified:\n" + changes.join("\n") + "\nUpdating sections accordingly.";
      showNotification(changeMsg, 'info', 5000);
      updateFlightsPaxFields();
      updateHotelRoomTypes();
      updateDirectFlightAddonsPaxFields();
      lastSavedPax = newPax;
    }
  }

  function checkClientInfoChanges() {
    const newClientName = document.getElementById("clientName").value;
    const newClientPhone = document.getElementById("clientPhone").value;
    const changes = [];

    if (newClientName !== lastSavedClientInfo.name) {
      changes.push(`Client Name from "${lastSavedClientInfo.name}" to "${newClientName}"`);
    }
    if (newClientPhone !== lastSavedClientInfo.phone) {
      changes.push(`Phone from "${lastSavedClientInfo.phone}" to "${newClientPhone}"`);
    }

    if (changes.length > 0) {
      const changeMsg = "Client data has been modified:\n" + changes.join("\n");
      showNotification(changeMsg, 'info', 5000);
    }
    lastSavedClientInfo = { name: newClientName, phone: newClientPhone };
  }

  function checkDateChanges() {
    const newDates = { dateFrom: dateFrom.value, dateTo: dateTo.value };
    if (newDates.dateFrom !== lastSavedDates.dateFrom || newDates.dateTo !== lastSavedDates.dateTo) {
      const dateChangeMsg = "Travel dates have been modified. Updating sections accordingly.";
      showNotification(dateChangeMsg, 'info', 5000);
      updateHotelDates();
      lastSavedDates = newDates;
    }
  }
</script>

<!-- FLIGHT -->
<div class="section" id="flightContainerWrapper">
  <div class="flight-header">
    <h3>Flight</h3>
    <button type="button" id="btnAddFlight" class="add-btn">+ Add Flight</button>
  </div>
  <div id="flightContainer"></div>
</div>

<script>
let nextFlightNumber = 0;
let flights = [];

function getCurrentPaxData() {
  return {
    adults: parseInt(document.getElementById("numAdult")?.value || 0),
    childBed: parseInt(document.getElementById("numChildBed")?.value || 0),
    childNoBed: parseInt(document.getElementById("numChildNoBed")?.value || 0),
    infants: parseInt(document.getElementById("numInfant")?.value || 0),
  };
}

// Get main flight costs for comparison
function getMainFlightCosts() {
  const mainFlights = [];
  document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const pax = getCurrentPaxData();
    
    const flightData = {
      adultCost: parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0),
      adultSvc: parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0),
      childBedCost: parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0),
      childBedSvc: parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0),
      childNoBedCost: parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0),
      childNoBedSvc: parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0),
      infantCost: parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0),
      infantSvc: parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0)
    };
    
    mainFlights.push(flightData);
  });
  
  return mainFlights;
}

// Calculate difference between upgrade and main flight
function calculateUpgradeDifference(upgradeIndex) {
  const mainFlights = getMainFlightCosts();
  if (mainFlights.length === 0) {
    showAlert("Please add main flight details first.");
    return { adultDiff: 0, childBedDiff: 0, childNoBedDiff: 0, infantDiff: 0 };
  }
  
  // Use the first main flight for comparison
  const mainFlight = mainFlights[0];
  
  // Get upgrade flight costs
  const upgradeAdultCost = parseFloat(document.getElementById(`upgradeFlightCostAdult_${upgradeIndex}`)?.value || 0);
  const upgradeAdultSvc = parseFloat(document.getElementById(`upgradeFlightSvcAdult_${upgradeIndex}`)?.value || 0);
  const upgradeChildBedCost = parseFloat(document.getElementById(`upgradeFlightCostChildBed_${upgradeIndex}`)?.value || 0);
  const upgradeChildBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildBed_${upgradeIndex}`)?.value || 0);
  const upgradeChildNoBedCost = parseFloat(document.getElementById(`upgradeFlightCostChildNoBed_${upgradeIndex}`)?.value || 0);
  const upgradeChildNoBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildNoBed_${upgradeIndex}`)?.value || 0);
  const upgradeInfantCost = parseFloat(document.getElementById(`upgradeFlightCostInf_${upgradeIndex}`)?.value || 0);
  const upgradeInfantSvc = parseFloat(document.getElementById(`upgradeFlightSvcInf_${upgradeIndex}`)?.value || 0);
  
  // Calculate differences
  const differences = {
    adultDiff: (upgradeAdultCost + upgradeAdultSvc) - (mainFlight.adultCost + mainFlight.adultSvc),
    childBedDiff: (upgradeChildBedCost + upgradeChildBedSvc) - (mainFlight.childBedCost + mainFlight.childBedSvc),
    childNoBedDiff: (upgradeChildNoBedCost + upgradeChildNoBedSvc) - (mainFlight.childNoBedCost + mainFlight.childNoBedSvc),
    infantDiff: (upgradeInfantCost + upgradeInfantSvc) - (mainFlight.infantCost + mainFlight.infantSvc)
  };
  
  // Store differences in the element for later use
  const upgradeElement = document.getElementById(`dfAddon_${upgradeIndex}`);
  if (upgradeElement) {
    upgradeElement.dataset.adultDifference = differences.adultDiff;
    upgradeElement.dataset.childBedDifference = differences.childBedDiff;
    upgradeElement.dataset.childNoBedDifference = differences.childNoBedDiff;
    upgradeElement.dataset.infantDifference = differences.infantDiff;
  }
  
  return differences;
}

// Generate pax input fields for a flight
function generatePaxFields(index) {
  const pax = getCurrentPaxData();
  const fields = [];
  function addField(id, label) {
    fields.push(`<div><label>${label}</label><input id="${id}" type="number" value="0" min="0"></div>`);
  }

  if(pax.adults > 0){
    addField(`flightCostAdult_${index}`, "Cost per Adult");
    addField(`flightSvcAdult_${index}`, "Service fee per Adult");
  }
  if(pax.childBed > 0){
    addField(`flightCostChildBed_${index}`, "Cost per Child (with bed)");
    addField(`flightSvcChildBed_${index}`, "Service fee per Child (with bed)");
  }
  if(pax.childNoBed > 0){
    addField(`flightCostChildNoBed_${index}`, "Cost per Child (no bed)");
    addField(`flightSvcChildNoBed_${index}`, "Service fee per Child (no bed)");
  }
  if(pax.infants > 0){
    addField(`flightCostInf_${index}`, "Cost per Infant");
    addField(`flightSvcInf_${index}`, "Service fee per Infant");
  }

  return fields.join("");
}

// Update existing flights when pax changes
function updateFlightsPaxFields() {
  flights.forEach(index => {
    const flightBlock = document.getElementById(`flightBlock_${index}`);
    if(!flightBlock) return;

    // Get the HTML content excluding the PAX fields part
    const paxFieldsStart = `<!-- PAX-FIELDS-START -->`;
    const paxFieldsEnd = `<!-- PAX-FIELDS-END -->`;
    const existingHtml = flightBlock.innerHTML;

    const beforePax = existingHtml.split(paxFieldsStart)[0];
    const afterPax = existingHtml.split(paxFieldsEnd)[1];

    const newPaxFields = generatePaxFields(index);
    flightBlock.innerHTML = beforePax + paxFieldsStart + newPaxFields + paxFieldsEnd + afterPax;
  });
}

// Validate flight
function validateFlight(index){
  const itinerary = document.getElementById("flightItinerary_" + index);
  const airline = document.getElementById("airline_" + index);
  const flightDirect = document.getElementById("flightDirect_" + index); // Add this line
  let valid = true;

  if(!itinerary.value.trim()){ itinerary.classList.add("input-error"); valid=false; } else { itinerary.classList.remove("input-error"); }
  if(!airline.value.trim()){ airline.classList.add("input-error"); valid=false; } else { airline.classList.remove("input-error"); }
  if(!flightDirect.value.trim()){ flightDirect.classList.add("input-error"); valid=false; } else { flightDirect.classList.remove("input-error"); } // Add this line

  return valid;
}

// Add new flight
async function addFlight() {
  if(flights.length > 0 && !validateFlight(flights[flights.length-1])){
    await showAlert("Please complete all mandatory fields of the previous flight first.");
    return;
  }

  nextFlightNumber++;
  flights.push(nextFlightNumber);
  const container = document.getElementById("flightContainer");
  const paxFields = generatePaxFields(nextFlightNumber);

  const flightDiv = document.createElement("div");
  flightDiv.className = "section";
  flightDiv.style.marginTop = "10px";
  flightDiv.setAttribute("id", "flightBlock_" + nextFlightNumber);

  flightDiv.innerHTML = `
    <h4>
      Flight ${nextFlightNumber}
      <button type="button" onclick="removeFlight(${nextFlightNumber})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div class="full">
        <label>Flight itinerary (paste full itinerary)</label>
        <textarea id="flightItinerary_${nextFlightNumber}" placeholder="Paste flight details..."></textarea>
      </div>
      <div>
        <label>Airline</label>
        <input id="airline_${nextFlightNumber}" list="airlist">
        <datalist id="airlist">
          <option>Emirates (EK)</option>
          <option>Qatar (QR)</option>
          <option>Turkish Airlines (TK)</option>
          <option>Etihad (EY)</option>
          <option>Singapore Airlines (SQ)</option>
        </datalist>
      </div>
<div>
  <label>Flight Type</label>
  <select id="flightDirect_${nextFlightNumber}">
    <option>Stopover</option>
    <option>Direct</option>
  </select>
</div>
      <div>
        <label>Flight Currency</label>
        <select id="flightCurrency_${nextFlightNumber}">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="PKR">PKR</option>
        </select>
      </div>
      <!-- PAX-FIELDS-START -->
      ${paxFields}
      <!-- PAX-FIELDS-END -->
    </div>
  `;

  container.appendChild(flightDiv);
}

// Remove flight
function removeFlight(index){
  const block = document.getElementById("flightBlock_" + index);
  if(block) block.remove();
  flights = flights.filter(f => f !== index);
  if (flights.length === 0) {
      nextFlightNumber = 0;
  }
}

// Event listeners
document.getElementById("btnAddFlight").addEventListener("click", async () => {
    if(!isClientDataSaved) {
        await showAlert("Please save the Client & Pax data before adding flights.");
        return;
    }
    addFlight();
});
</script>

<!-- HOTELS -->
<div class="section" id="hotelWrapper">
  <div class="hotel-header">
    <h3>Hotels</h3>
    <button type="button" id="btnAddHotel" class="add-btn">+ Add Hotel</button>
  </div>
  <div id="hotelContainer"></div>
</div>

<script>
const hotelLimit = 6;
let nextHotelNumber = 0;
let hotels = [];

const roomConfig = {
  "Single": { adults: 1, childNoBed: 0 },
  "Double": { adults: 2, childNoBed: 1 },
  "Triple": { adults: 3, childNoBed: 1 },
  "Quad": { adults: 4, childNoBed: 1 },
  "Family": { adults: 2, childNoBed: 2 }
};

// Get Client & Pax data
function getClientData() {
  const data = JSON.parse(localStorage.getItem("savedClientData_international")) || {};
  data.adults = parseInt(data.adults) || 0;
  data.childBed = parseInt(data.childBed) || 0;
  data.childNoBed = parseInt(data.childNoBed) || 0;
  data.infants = parseInt(data.infants) || 0;
  data.totalPax = data.adults + data.childBed;
  data.totalChildNoBed = data.childNoBed;
  // parse dates safely
  data.dateFromObj = data.dateFrom && data.dateFrom.trim() !== "" ? new Date(data.dateFrom) : null;
  data.dateToObj = data.dateTo && data.dateTo.trim() !== "" ? new Date(data.dateTo) : null;
  return data;
}

// Validate date object
function isValidDate(d){
  return d instanceof Date && !isNaN(d.getTime());
}

// Format date for input fields
function formatDate(d){
  if(!isValidDate(d)) return "";
  const yyyy = d.getFullYear();
  let mm = d.getMonth()+1; if(mm<10) mm="0"+mm;
  let dd = d.getDate(); if(dd<10) dd="0"+dd;
  return `${yyyy}-${mm}-${dd}`;
}

// Check if hotel dates overlap with existing hotels
function checkHotelDateOverlap(checkIn, checkOut, excludeIndex = null) {
  const newCheckIn = new Date(checkIn);
  const newCheckOut = new Date(checkOut);
  
  for (let i = 0; i < hotels.length; i++) {
    if (excludeIndex !== null && hotels[i] === excludeIndex) continue;
    
    const existingCheckIn = document.getElementById(`hotelCheckIn_${hotels[i]}`)?.value;
    const existingCheckOut = document.getElementById(`hotelCheckOut_${hotels[i]}`)?.value;
    
    if (existingCheckIn && existingCheckOut) {
      const existingIn = new Date(existingCheckIn);
      const existingOut = new Date(existingCheckOut);
      
      // Check if dates overlap
      if (newCheckIn < existingOut && newCheckOut > existingIn) {
        return true; // Overlap found
      }
    }
  }
  
  return false; // No overlap
}

// Validate last hotel fields before adding new
function isHotelFilled(index){
  const fields = [
    `hotelName${index}`,
    `hotelCity${index}`,
    `hotelCheckIn${index}`,
    `hotelCheckOut${index}`
  ];
  let valid = true;
  fields.forEach(id=>{
    const el = document.getElementById(id);
    if(el && !el.value.trim()){
      el.classList.add('input-error');
      valid = false;
    } else if (el) {
      el.classList.remove("input-error");
    }
  });
  return valid;
}

// Function to calculate total pax for rooms (adults + children with bed)
function getTotalPaxForRooms() {
    const adults = parseInt(document.getElementById("numAdult")?.value || 0);
    const childBed = parseInt(document.getElementById("numChildBed")?.value || 0);
    return adults + childBed;
}

// Function to recommend a room type based on total pax for rooms
function getRecommendedRoomType() {
    const totalPax = getTotalPaxForRooms();
    if (totalPax <= 1) return "Single";
    if (totalPax <= 2) return "Double";
    if (totalPax <= 3) return "Triple";
    if (totalPax <= 4) return "Quad";
    if (totalPax <= 4) return "Family";
    return "Family";
}

// Function to update all hotel room types based on current pax
function updateHotelRoomTypes() {
  const recommendedType = getRecommendedRoomType();
  hotels.forEach(index => {
    const roomTypeSelect = document.getElementById(`hotelRoomType_${index}`);
    if (roomTypeSelect) {
      roomTypeSelect.value = recommendedType;
    }
  });
}

// Function to calculate total capacity across ALL hotels
function calculateTotalHotelCapacity() {
    let totalCapacity = 0;
    let totalChildNoBedCapacity = 0;

    hotels.forEach(index => {
        const roomTypeSelect = document.getElementById(`hotelRoomType_${index}`);
        const roomsCountInput = document.getElementById(`hotelRooms_${index}`);
        
        if (roomTypeSelect && roomsCountInput) {
            const roomType = roomTypeSelect.value;
            const numRooms = parseInt(roomsCountInput.value) || 0;
            const roomCapacity = roomConfig[roomType];
            
            if (roomCapacity) {
                totalCapacity += roomCapacity.adults * numRooms;
                totalChildNoBedCapacity += roomCapacity.childNoBed * numRooms;
            }
        }
    });

    return { totalCapacity, totalChildNoBedCapacity };
}

// Function to validate ALL hotel configurations
function validateAllHotels() {
    const clientData = getClientData();
    if (!clientData) return false;
    
    const totalPax = clientData.totalPax;
    const totalChildNoBed = clientData.totalChildNoBed;
    const { totalCapacity, totalChildNoBedCapacity } = calculateTotalHotelCapacity();

    let isValid = true;
    let errorMessage = '';

    // Check if total rooms are enough for total pax
    if (totalPax > totalCapacity) {
        errorMessage += `Total rooms booked can only accommodate ${totalCapacity} people, but your group has ${totalPax}.\n`;
        isValid = false;
    }

    // Check if total rooms are enough for children without bed
    if (totalChildNoBed > totalChildNoBedCapacity) {
        errorMessage += `Total rooms booked can only accommodate ${totalChildNoBedCapacity} children without a bed. Your group has ${totalChildNoBed}.\n`;
        isValid = false;
    }
    
    // Only show error message if there's an actual validation error
    if (!isValid) {
        const allRoomsInputs = document.querySelectorAll('[id^="hotelRooms_"]');
        allRoomsInputs.forEach(input => input.classList.add("input-error"));
        showAlert(errorMessage, "Room Configuration Error");
    } else {
        const allRoomsInputs = document.querySelectorAll('[id^="hotelRooms_"]');
        allRoomsInputs.forEach(input => input.classList.remove("input-error"));
    }

    return isValid;
}

// Create hotel section
async function createHotelSection(index){
  const clientData = getClientData();

  // Validate travel dates again
  if(!isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
    await showAlert("Cannot create hotel form. Please provide valid From/To dates in Client & Pax data.");
    return;
  }

  const container = document.getElementById("hotelContainer");
  const roomOptions = Object.keys(roomConfig).map(rt=>`<option>${rt}</option>`).join("");

  const hotelDiv = document.createElement("div");
  hotelDiv.className = "section";
  hotelDiv.id = "hotelBlock_" + index;
  hotelDiv.style.marginTop = "10px";

  hotelDiv.innerHTML = `
    <h4>
      Hotel ${index}
      <button type="button" onclick="removeHotel(${index})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div><label>Hotel Name</label><input id="hotelName_${index}" type="text"></div>
      <div><label>City</label><input id="hotelCity_${index}" type="text"></div>
      <div><label>Check-in</label>
        <input id="hotelCheckIn_${index}" type="date"
               min="${formatDate(clientData.dateFromObj)}"
               max="${formatDate(clientData.dateToObj)}">
      </div>
      <div><label>Check-out</label>
        <input id="hotelCheckOut_${index}" type="date"
               min="${formatDate(clientData.dateFromObj)}"
               max="${formatDate(clientData.dateToObj)}">
      </div>
      <div><label>Total Nights</label><input id="hotelNights_${index}" type="number" value="0" min="0" readonly></div>
      <div><label>Room Type</label><select id="hotelRoomType_${index}">${roomOptions}</select></div>
      <div><label>Room Name (Optional)</label><input id="hotelRoomName_${index}" type="text" placeholder="e.g. Deluxe Suite"></div>
      <div><label>Rooms count</label><input id="hotelRooms_${index}" type="number" value="1" min="1"></div>
      <div><label>Service Type</label><select id="hotelService_${index}"><option>Room Only</option><option>With Breakfast</option><option>Half Board</option><option>Full Board</option></select></div>
      <div><label>Cost per night</label><input id="hotelCostNight_${index}" type="number" value="0" min="0"></div>
      <div><label>Hotel Currency</label><select id="hotelCurrency_${index}"><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="PKR">PKR</option></select></div>
      <div><label>Service per night</label><input id="hotelSvcNight_${index}" type="number" value="0" min="0"></div>
    </div>
  `;
  container.appendChild(hotelDiv);
  hotels.push(index);

  const chkIn = document.getElementById(`hotelCheckIn_${index}`);
  const chkOut = document.getElementById(`hotelCheckOut_${index}`);
  const nights = document.getElementById(`hotelNights_${index}`);
  const roomTypeSelect = document.getElementById(`hotelRoomType_${index}`);
  const roomsCountInput = document.getElementById(`hotelRooms_${index}`);

  // Set the default room type based on pax
  if (roomTypeSelect) {
    roomTypeSelect.value = getRecommendedRoomType();
  }

  function updateNights(){
    if(chkIn.value && chkOut.value){
      const diff = Math.round((new Date(chkOut.value) - new Date(chkIn.value))/(1000*60*60*24));
      nights.value = diff>0 ? diff : 0;
    } else {
      nights.value = 0;
    }
  }

  // Add date validation
  chkIn.addEventListener("change", () => {
    // Check if date is within travel dates
    if (chkIn.value < clientData.dateFrom || chkIn.value > clientData.dateTo) {
      chkIn.classList.add("input-error");
      showAlert("Check-in date must be within travel dates.");
    } else {
      chkIn.classList.remove("input-error");
    }
    
    // Check for overlapping dates
    if (checkHotelDateOverlap(chkIn.value, chkOut.value, index)) {
      chkIn.classList.add("input-error");
      chkOut.classList.add("input-error");
      showAlert("Hotel dates overlap with another hotel. Please select different dates.");
    } else {
      chkIn.classList.remove("input-error");
      chkOut.classList.remove("input-error");
    }
    
    updateNights();
  });

  chkOut.addEventListener("change", () => {
    // Check if date is within travel dates
    if (chkOut.value < clientData.dateFrom || chkOut.value > clientData.dateTo) {
      chkOut.classList.add("input-error");
      showAlert("Check-out date must be within travel dates.");
    } else {
      chkOut.classList.remove("input-error");
    }
    
    // Check for overlapping dates
    if (checkHotelDateOverlap(chkIn.value, chkOut.value, index)) {
      chkIn.classList.add("input-error");
      chkOut.classList.add("input-error");
      showAlert("Hotel dates overlap with another hotel. Please select different dates.");
    } else {
      chkIn.classList.remove("input-error");
      chkOut.classList.remove("input-error");
    }
    
    updateNights();
  });

  // Add event listeners for room validation
  if (roomTypeSelect) roomTypeSelect.addEventListener('change', validateAllHotels);
  if (roomsCountInput) roomsCountInput.addEventListener('input', validateAllHotels);
}

// Remove hotel
function removeHotel(index){
  const block = document.getElementById("hotelBlock_" + index);
  if(block) block.remove();
  hotels = hotels.filter(h => h !== index);
  if (hotels.length === 0) {
      nextHotelNumber = 0;
  }
  validateAllHotels();
}

// Update all hotel date ranges
function updateHotelDates() {
  const clientData = getClientData();
  hotels.forEach(index => {
    const chkIn = document.getElementById(`hotelCheckIn_${index}`);
    const chkOut = document.getElementById(`hotelCheckOut_${index}`);
    if (chkIn) chkIn.setAttribute('min', formatDate(clientData.dateFromObj));
    if (chkOut) chkOut.setAttribute('max', formatDate(clientData.dateToObj));
  });
}

document.getElementById("btnAddHotel").addEventListener("click", async ()=>{
    if(!isClientDataSaved) {
      await showAlert("Please save the Client & Pax data before adding hotels.");
      return;
    }

    const clientData = getClientData();
    if(!clientData.dateFrom || clientData.dateFrom.trim() === "" ||
       !clientData.dateTo || clientData.dateTo.trim() === "" ||
       !isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
      await showAlert("Cannot add hotel. Please provide valid From/To dates in Client & Pax data.");
      return;
    }
    
    if(hotels.length > 0 && !isHotelFilled(hotels[hotels.length-1])){
      await showAlert("Please complete all mandatory fields of the previous hotel before adding a new one.");
      return;
    }
    
    if(nextHotelNumber >= hotelLimit){
      await showAlert("Max 6 hotels only.");
      return;
    }

    nextHotelNumber++;
    createHotelSection(nextHotelNumber);
});
</script>

<!-- TRANSFERS -->
<div class="section" id="transferWrapper">
  <div class="transfer-header">
    <h3>Transfers</h3>
    <button type="button" id="btnAddTrans" class="add-btn">+ Add Transfer</button>
  </div>
  <div id="transferContainer"></div>
</div>

<script>
let nextTransferNumber = 0;
let transfers = [];

// Helper: check valid date
function isValidDate(d){
  return d instanceof Date && !isNaN(d.getTime());
}

// Helper: get saved Client data (dates & pax)
function getClientData() {
  const saved = localStorage.getItem("savedClientData_international");
  if(!saved) return null;
  const data = JSON.parse(saved);
  data.dateFromObj = new Date(data.dateFrom);
  data.dateToObj = new Date(data.dateTo);
  return data;
}

// Pax total (excluding infants)
function getTotalPax() {
  const adults = parseInt(document.getElementById("numAdult")?.value || 0);
  const cBed = parseInt(document.getElementById("numChildBed")?.value || 0);
  const cNoBed = parseInt(document.getElementById("numChildNoBed")?.value || 0);
  const infants = parseInt(document.getElementById("numInfant")?.value || 0);
  return adults + cBed + cNoBed + infants;
}

// Function to determine the best-fit vehicle
function getRecommendedVehicle() {
  const totalPax = getTotalPax();
  if (totalPax <= 3) return 'Sedan';
  if (totalPax <= 7) return 'SUV';
  if (totalPax <= 12) return 'Van';
  if (totalPax <= 25) return 'Bus';
  return 'Bus';
}

// Added function to check if transfer date is within travel dates
function checkDateRange(dateInput, clientData) {
  const transferDate = new Date(dateInput.value);
  if (transferDate < clientData.dateFromObj || transferDate > clientData.dateToObj) {
    dateInput.classList.add("input-error");
    showAlert(`The transfer date must be between ${formatDateToDMY(clientData.dateFrom)} and ${formatDateToDMY(clientData.dateTo)}.`);
    return false;
  } else {
    dateInput.classList.remove("input-error");
    return true;
  }
}

// Validate a transfer section
function validateTransfer(index){
  const date = document.getElementById(`tDate_${index}`);
  const from = document.getElementById(`tFrom_${index}`);
  const to = document.getElementById(`tTo_${index}`);
  const direction = document.getElementById(`tDirection_${index}`);
  const returnDate = document.getElementById(`tReturnDate_${index}`);
  let valid = true;

  if(!date.value.trim()){ date.classList.add("input-error"); valid=false; } else { date.classList.remove("input-error"); }
  if(!from.value.trim()){ from.classList.add("input-error"); valid=false; } else { from.classList.remove("input-error"); }
  if(!to.value.trim()){ to.classList.add("input-error"); valid=false; } else { to.classList.remove("input-error"); }
  
  // Validate return date if transfer type is Return
  if (direction && direction.value === "Return") {
    if (!returnDate || !returnDate.value.trim()) {
      if (returnDate) returnDate.classList.add("input-error");
      valid = false;
    } else {
      if (returnDate) returnDate.classList.remove("input-error");
    }
  }
  
  return valid;
}

// Add new transfer
async function addTransfer(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding transfers.");
    return;
  }
  
  const clientData = getClientData();
  if(!clientData || !isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
    await showAlert("Please save valid From/To dates in Client & Pax first.");
    return;
  }
  
  // Prevent adding new transfer if last one is incomplete
  if(transfers.length > 0 && !validateTransfer(transfers[transfers.length-1])){
    await showAlert("Please complete all mandatory fields of the previous transfer first.");
    return;
  }

  nextTransferNumber++;
  transfers.push(nextTransferNumber);

  const container = document.getElementById("transferContainer");
  const div = document.createElement("div");
  div.className = "section";
  div.style.marginTop = "10px";
  div.id = "transferBlock_" + nextTransferNumber;

  div.innerHTML = `
    <h4>
      Transfer ${nextTransferNumber}
      <button type="button" onclick="removeTransfer(${nextTransferNumber})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div>
        <label>Date</label>
        <input id="tDate_${nextTransferNumber}" type="date">
      </div>
      <div>
        <label>From</label>
        <input id="tFrom_${nextTransferNumber}" type="text" placeholder="e.g. Airport, Hotel">
      </div>
      <div>
        <label>To</label>
        <input id="tTo_${nextTransferNumber}" type="text" placeholder="e.g. Hotel, Airport">
      </div>
      <div>
        <label>Vehicle Type</label>
        <select id="tCar_${nextTransferNumber}">
          <option>Sedan</option>
          <option>SUV</option>
          <option>Van</option>
          <option>Bus</option>
        </select>
      </div>
      <div>
        <label>Type</label>
        <select id="tType_${nextTransferNumber}">
          <option>Private</option>
          <option>Sharing</option>
        </select>
      </div>
      <div>
        <label>Transfer Type</label>
        <select id="tDirection_${nextTransferNumber}">
          <option>One Way</option>
          <option>Return</option>
        </select>
      </div>
      <div id="returnDateDiv_${nextTransferNumber}" style="display:none;">
        <label>Return Date</label>
        <input id="tReturnDate_${nextTransferNumber}" type="date">
      </div>
      <div>
        <label>Cost</label>
        <input id="tCost_${nextTransferNumber}" type="number" placeholder="Cost">
      </div>
      <div>
        <label>Currency</label>
        <select id="tCurrency_${nextTransferNumber}">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="PKR">PKR</option>
        </select>
      </div>
      <div>
        <label>Service</label>
        <input id="tSvc_${nextTransferNumber}" type="number" placeholder="Service">
      </div>
    </div>
  `;

  container.appendChild(div);

  // Set the default vehicle based on pax count
  const carSelect = document.getElementById(`tCar_${nextTransferNumber}`);
  const recommendedVehicle = getRecommendedVehicle();
  carSelect.value = recommendedVehicle;

  // Date validation on change
  const dateInput = div.querySelector(`#tDate_${nextTransferNumber}`);
  
  if (dateInput) {
    dateInput.addEventListener("change", () => {
      checkDateRange(dateInput, clientData);
    });
    dateInput.setAttribute('min', formatDate(clientData.dateFromObj));
    dateInput.setAttribute('max', formatDate(clientData.dateToObj));
  }

  // Toggle return date field based on transfer type
  const directionSelect = div.querySelector(`#tDirection_${nextTransferNumber}`);
  const returnDateDiv = div.querySelector(`#returnDateDiv_${nextTransferNumber}`);
  const returnDateInput = div.querySelector(`#tReturnDate_${nextTransferNumber}`);

  if (directionSelect && returnDateDiv && returnDateInput) {
    directionSelect.addEventListener("change", () => {
      if (directionSelect.value === "Return") {
        returnDateDiv.style.display = "block";
        returnDateInput.setAttribute('min', formatDate(clientData.dateFromObj));
        returnDateInput.setAttribute('max', formatDate(clientData.dateToObj));
      } else {
        returnDateDiv.style.display = "none";
        returnDateInput.value = "";
      }
    });

    // Also validate return date if shown
    returnDateInput.addEventListener("change", () => {
      if (returnDateDiv.style.display !== "none") {
        checkDateRange(returnDateInput, clientData);
      }
    });
  }
}

// Remove transfer
function removeTransfer(index){
  const block = document.getElementById("transferBlock_" + index);
  if(block) block.remove();
  transfers = transfers.filter(t => t !== index);
  if (transfers.length === 0) {
      nextTransferNumber = 0;
  }
}

// Event listener
document.getElementById("btnAddTrans").addEventListener("click", addTransfer);
</script>

<!-- TOURS & ACTIVITIES -->
<div class="section" id="toursWrapper">
  <div class="transfer-header">
    <h3>Tours & Activities</h3>
    <button type="button" id="btnAddTour" class="add-btn">+ Add Tour</button>
  </div>
  <div id="toursContainer"></div>
</div>

<script>
let nextTourNumber = 0;
let mainTours = [];

// Function to get available cities from hotels
function getAvailableCities() {
  const cities = new Set();
  document.querySelectorAll("[id^='hotelBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const city = document.getElementById(`hotelCity_${idx}`)?.value?.trim();
    if (city) cities.add(city);
  });
  return Array.from(cities);
}

// Add new tour
async function addTour(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding tours.");
    return;
  }
  
  const clientData = getClientData();
  if(!clientData || !isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
    await showAlert("Please save valid From/To dates in Client & Pax first.");
    return;
  }
  
  nextTourNumber++;
  mainTours.push(nextTourNumber);

  const container = document.getElementById("toursContainer");
  const div = document.createElement("div");
  div.className = "section";
  div.style.marginTop = "10px";
  div.id = "tourBlock_" + nextTourNumber;

  // Get available cities from hotels
  const availableCities = getAvailableCities();
  const cityOptions = availableCities.length > 0 
    ? availableCities.map(city => `<option value="${city}">${city}</option>`).join('')
    : '<option value="">No hotels added yet</option>';

  div.innerHTML = `
    <h4>
      Tour ${nextTourNumber}
      <button type="button" onclick="removeTour(${nextTourNumber})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div>
        <label>Tour Date</label>
        <input id="tourDate_${nextTourNumber}" type="date" 
               min="${clientData.dateFrom}" 
               max="${clientData.dateTo}">
      </div>
      <div>
        <label>Tour Name</label>
        <input id="tourName_${nextTourNumber}" type="text" placeholder="e.g. City Tour, Desert Safari">
      </div>
      <div>
        <label>City</label>
        <select id="tourCity_${nextTourNumber}">
          ${cityOptions}
        </select>
      </div>
      <div>
        <label>Tour Duration</label>
        <select id="tourDuration_${nextTourNumber}">
          <option value="half-day">Half Day</option>
          <option value="full-day">Full Day</option>
        </select>
      </div>
      <div>
        <label>Tour Mode</label>
        <select id="tourMode_${nextTourNumber}">
          <option value="private">Private</option>
          <option value="sharing">Sharing</option>
        </select>
      </div>
      <div>
        <label>Vehicle Type</label>
        <select id="tourVehicle_${nextTourNumber}">
          <option>Sedan</option>
          <option>SUV</option>
          <option>Van</option>
          <option>Bus</option>
          <option>Jeep</option>
        </select>
      </div>
      <div>
        <label>Cost per Person</label>
        <input id="tourCost_${nextTourNumber}" type="number" value="0" min="0">
      </div>
      <div>
        <label>Currency</label>
        <select id="tourCurrency_${nextTourNumber}">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="PKR">PKR</option>
        </select>
      </div>
      <div>
        <label>Service Fee per Person</label>
        <input id="tourSvc_${nextTourNumber}" type="number" value="0" min="0">
      </div>
    </div>
  `;

  container.appendChild(div);
}

function removeTour(index) {
  const block = document.getElementById("tourBlock_" + index);
  if(block) block.remove();
  mainTours = mainTours.filter(t => t !== index);
}

// Event listener
document.getElementById("btnAddTour").addEventListener("click", addTour);
</script>

<!-- VISA -->
<div class="section" id="visaWrapper">
  <div class="visa-header">
    <h3>Visa</h3>
    <button type="button" id="btnAddVisa" class="add-btn">+ Add Visa</button>
  </div>
  <div id="visaContainer"></div>
</div>

<script>
let visaAdded = false;

// Calculate total pax
function getTotalPax(){
  const adults = parseInt(document.getElementById("numAdult")?.value || 0);
  const cBed = parseInt(document.getElementById("numChildBed")?.value || 0);
  const cNoBed = parseInt(document.getElementById("numChildNoBed")?.value || 0);
  const infants = parseInt(document.getElementById("numInfant")?.value || 0);
  return adults + cBed + cNoBed + infants;
}

// Add Visa section (only once)
async function addVisa(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding visa details.");
    return;
  }
  
  if(visaAdded){
    await showAlert("Visa section already added.");
    return;
  }
  visaAdded = true;

  const container = document.getElementById("visaContainer");
  const div = document.createElement("div");
  div.className = "section";
  div.style.marginTop = "10px";
  div.id = "visaBlock";

  const totalPax = getTotalPax();

  div.innerHTML = `
    <h4>
      Visa
      <button type="button" onclick="removeVisa()" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div>
        <label>Visa Type</label>
        <select id="visaType">
          <option>Tourist Visa</option>
          <option>Business Visa</option>
          <option>Student Visa</option>
        </select>
      </div>
      <div>
        <label>Country</label>
        <select id="visaCountry">
          <option>United Arab Emirates</option>
          <option>Singapore</option>
          <option>Malaysia</option>
          <option>Thailand</option>
          <option>Turkey</option>
          <option>United Kingdom</option>
          <option>United States</option>
          <option>Schengen Area</option>
          <option>Other</option>
        </select>
      </div>
      <div>
        <label>No. of Visas (auto)</label>
        <input id="visaCount" type="number" value="${totalPax}" readonly>
      </div>
      <div>
        <label>Cost per Visa</label>
        <input id="visaCost" type="number" value="0">
      </div>
      <div>
        <label>Visa Currency</label>
        <select id="visaCurrency">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="PKR">PKR</option>
        </select>
      </div>
      <div>
        <label>Service Fee per Visa</label>
        <input id="visaSvc" type="number" value="0">
      </div>
    </div>
    <div class="small">Visa count updates automatically if pax changes.</div>
  `;

  container.appendChild(div);

  // auto update if pax fields change
  ["numAdult","numChildBed","numChildNoBed","numInfant"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.addEventListener("input", ()=>{
        document.getElementById("visaCount").value = getTotalPax();
      });
    }
  });
}

// Remove Visa
function removeVisa(){
  const block = document.getElementById("visaBlock");
  if(block) block.remove();
  visaAdded = false;
}

// Event listener
document.getElementById("btnAddVisa").addEventListener("click", addVisa);
</script>

<!-- ADD-ONS -->
<div class="section" id="addonsWrapper">
  <h3>Add Extras</h3>

  <!-- Upgraded Flight Panel -->
  <div class="addon-category">
    <div class="addon-header" onclick="togglePanel('directFlightPanel', this)">
      <span class="panel-icon">+</span> Upgraded Flight
    </div>
    <div id="directFlightPanel" class="addon-panel" style="display:none;">
      <div id="directFlightContainer"></div>
      <button type="button" class="add-btn green-btn" onclick="addDirectFlightAddon()">+ Add Upgraded Flight</button>
    </div>
  </div>

  <!-- Meal Type Panel -->
  <div class="addon-category">
    <div class="addon-header" onclick="togglePanel('mealTypePanel', this)">
      <span class="panel-icon">+</span> Meal Type
    </div>
    <div id="mealTypePanel" class="addon-panel" style="display:none;">
      <div id="mealTypeContainer"></div>
      <button type="button" class="add-btn orange-btn" onclick="addMealTypeAddon()">+ Add Meal</button>
    </div>
  </div>

  <!-- Tours Panel -->
  <div class="addon-category">
    <div class="addon-header" onclick="togglePanel('toursPanel', this)">
      <span class="panel-icon">+</span> Tours & Activities
    </div>
    <div id="toursPanel" class="addon-panel" style="display:none;">
      <div id="addonToursContainer"></div>
      <button type="button" class="add-btn blue-btn" onclick="addTourAddon()">+ Add Tour</button>
    </div>
  </div>
</div>

<script>
// ----------------- Toggle Panel with + / - -----------------
function togglePanel(id, header){
  const panel=document.getElementById(id);
  const icon=header.querySelector(".panel-icon");
  if(panel.style.display==='none'){
    panel.style.display='block';
    icon.textContent='-';
  } else{
    panel.style.display='none';
    icon.textContent='+';
  }
}

// ----------------- Upgraded Flight -----------------
let dfIndex = 0;

// Helper to generate the pax fields HTML for addons
function generateAddonPaxFieldsHTML(pax) {
    let html = '';
    if (pax.adults > 0) html += `<div class="inline-input"><label>Adult - Difference</label><input type="number" value="0"><label>Service Fee</label><input type="number" value="0"></div>`;
    if (pax.childBed > 0) html += `<div class="inline-input"><label>Child (with bed) - Difference</label><input type="number" value="0"><label>Service Fee</label><input type="number" value="0"></div>`;
    if (pax.childNoBed > 0) html += `<div class="inline-input"><label>Child (no bed) - Difference</label><input type="number" value="0"><label>Service Fee</label><input type="number" value="0"></div>`;
    if (pax.infants > 0) html += `<div class="inline-input"><label>Infant - Difference</label><input type="number" value="0"><label>Service Fee</label><input type="number" value="0"></div>`;
    return html;
}

// Generate upgrade flight cost fields (not difference)
function generateUpgradeFlightPaxFieldsHTML(pax) {
  const fields = [];
  function addField(id, label) {
    fields.push(`<div class="inline-input"><label>${label}</label><input id="${id}" type="number" value="0" min="0"></div>`);
  }

  if(pax.adults > 0){
    addField(`upgradeFlightCostAdult_${dfIndex}`, "Adult Cost");
    addField(`upgradeFlightSvcAdult_${dfIndex}`, "Adult Service");
  }
  if(pax.childBed > 0){
    addField(`upgradeFlightCostChildBed_${dfIndex}`, "Child (with bed) Cost");
    addField(`upgradeFlightSvcChildBed_${dfIndex}`, "Child (with bed) Service");
  }
  if(pax.childNoBed > 0){
    addField(`upgradeFlightCostChildNoBed_${dfIndex}`, "Child (no bed) Cost");
    addField(`upgradeFlightSvcChildNoBed_${dfIndex}`, "Child (no bed) Service");
  }
  if(pax.infants > 0){
    addField(`upgradeFlightCostInf_${dfIndex}`, "Infant Cost");
    addField(`upgradeFlightSvcInf_${dfIndex}`, "Infant Service");
  }

  return fields.join("");
}

// New function to update existing direct flight addons
function updateDirectFlightAddonsPaxFields() {
    const pax = getCurrentPaxData();
    const addons = document.querySelectorAll('[id^="dfAddon_"]');
    addons.forEach(addon => {
        const existingHtml = addon.innerHTML;
        const paxFieldsStart = `<!-- PAX-FIELDS-START -->`;
        const paxFieldsEnd = `<!-- PAX-FIELDS-END -->`;
        
        // Split the HTML content to isolate the PAX fields section
        const beforePax = existingHtml.split(paxFieldsStart)[0];
        const afterPax = existingHtml.split(paxFieldsEnd)[1];
        
        // Generate the new HTML for pax fields
        const newPaxHtml = generateAddonPaxFieldsHTML(pax);
        
        // Reconstruct the full HTML
        addon.innerHTML = `${beforePax}${paxFieldsStart}${newPaxHtml}${paxFieldsEnd}${afterPax}`;
    });
}

async function addDirectFlightAddon(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding extras.");
    return;
  }
  dfIndex++;
  const container = document.getElementById("directFlightContainer");
  const pax = getCurrentPaxData();

  const div=document.createElement("div");
  div.className="section-entry";
  div.id="dfAddon_"+dfIndex;
  div.innerHTML=`
    <h4>Upgraded Flight
      <button type="button" onclick="removeAddon('dfAddon_${dfIndex}')" class="remove-btn">❌ Remove</button>
    </h4>
    <div>
      <label>Flight Itinerary</label><textarea placeholder="Paste flight details..."></textarea>
      <label>Airline</label><input list="airlist">
      <datalist id="airlist">
        <option>Emirates (EK)</option>
        <option>Qatar (QR)</option>
        <option>Turkish Airlines (TK)</option>
      </datalist>
      <label>Flight Currency</label>
      <select><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="PKR">PKR</option></select>
<!-- PAX-FIELDS-START -->
<div class="upgrade-flight-costs">
  <h5 style="margin-bottom: 10px; color: #007bff;">Enter Upgrade Flight Costs (System will calculate difference)</h5>
  ${generateUpgradeFlightPaxFieldsHTML(pax)}
</div>
<!-- PAX-FIELDS-END -->
      <div class="small">Enter the difference in cost between base and upgraded flight.</div>
    </div>
  `;
  container.appendChild(div);
  
  // Add event listeners to calculate difference automatically
  const upgradeInputs = div.querySelectorAll('.upgrade-flight-costs input[type="number"]');
  upgradeInputs.forEach(input => {
    input.addEventListener('input', () => {
      const differences = calculateUpgradeDifference(dfIndex);
      
      // Show difference to user
      const pax = getCurrentPaxData();
      let diffMessage = "Upgrade Difference: ";
      
      if (pax.adults > 0 && differences.adultDiff > 0) {
        diffMessage += `Adult: +${differences.adultDiff} `;
      }
      if (pax.childBed > 0 && differences.childBedDiff > 0) {
        diffMessage += `Child: +${differences.childBedDiff} `;
      }
      if (pax.childNoBed > 0 && differences.childNoBedDiff > 0) {
        diffMessage += `Child: +${differences.childNoBedDiff} `;
      }
      if (pax.infants > 0 && differences.infantDiff > 0) {
        diffMessage += `Infant: +${differences.infantDiff}`;
      }
      
      // Update or create difference display
      let diffDisplay = div.querySelector('.upgrade-difference');
      if (!diffDisplay) {
        diffDisplay = document.createElement('div');
        diffDisplay.className = 'upgrade-difference';
        diffDisplay.style.cssText = 'margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px; font-weight: bold; color: #2e7d32;';
        div.querySelector('.upgrade-flight-costs').appendChild(diffDisplay);
      }
      diffDisplay.textContent = diffMessage;
    });
  });
}

// ----------------- Meal Type -----------------
let mealIndex=0;
async function addMealTypeAddon(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding extras.");
    return;
  }
  mealIndex++;
  const container=document.getElementById("mealTypeContainer");
  
  // Get list of hotels for selection
  const hotelOptions = [];
  hotels.forEach(index => {
    const hotelName = document.getElementById(`hotelName_${index}`)?.value || '';
    const hotelCity = document.getElementById(`hotelCity_${index}`)?.value || '';
    if (hotelName && hotelCity) {
      hotelOptions.push(`<option value="${index}">${hotelName} (${hotelCity})</option>`);
    }
  });
  
  if (hotelOptions.length === 0) {
    await showAlert("Please add at least one hotel before adding meal options.");
    return;
  }
  
  const div=document.createElement("div");
  div.className="section-entry";
  div.id="mealAddon_"+mealIndex;
  div.innerHTML=`
    <h4>Meal Type
      <button type="button" onclick="removeAddon('mealAddon_${mealIndex}')" class="remove-btn">❌ Remove</button>
    </h4>
    <div>
      <label>Select Hotel</label>
      <select id="mealHotel_${mealIndex}">
        ${hotelOptions.join('')}
      </select>
      <label>Meal Type</label><select id="mealType_${mealIndex}"><option>Breakfast</option><option>Half Board</option><option>Full Board</option></select>
      <div class="inline-input">
        <label>Cost per pax/night</label><input type="number" value="0">
        <label>Service per pax/night</label><input type="number" value="0">
        <label>Currency</label><select id="mealCurrency_${mealIndex}"><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="PKR">PKR</option></select>
      </div>
    </div>
  `;
  container.appendChild(div);
}

// ----------------- Tours -----------------
let tourIndex = 0;
let tours = [];

async function addTourAddon(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding tours.");
    return;
  }
  
  const clientData = getClientData();
  if(!clientData || !isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
    await showAlert("Please save valid From/To dates in Client & Pax first.");
    return;
  }
  
  tourIndex++;
  tours.push(tourIndex);
  
  const container = document.getElementById("addonToursContainer");
  const div = document.createElement("div");
  div.className = "section";
  div.style.marginTop = "10px";
  div.id = "tourAddon_" + tourIndex;

  // Get available cities from hotels
  const availableCities = getAvailableCities();
  const cityOptions = availableCities.length > 0 
    ? availableCities.map(city => `<option value="${city}">${city}</option>`).join('')
    : '<option value="">No hotels added yet</option>';

  div.innerHTML = `
    <h4>
      Tour ${tourIndex}
      <button type="button" onclick="removeTourAddon(${tourIndex})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div>
        <label>Tour Date</label>
        <input id="tourAddonDate_${tourIndex}" type="date" 
               min="${clientData.dateFrom}" 
               max="${clientData.dateTo}">
      </div>
      <div>
        <label>Tour Name</label>
        <input id="tourAddonName_${tourIndex}" type="text" placeholder="e.g. City Tour, Desert Safari">
      </div>
      <div>
        <label>City</label>
        <select id="tourAddonCity_${tourIndex}">
          ${cityOptions}
        </select>
      </div>
      <div>
        <label>Tour Duration</label>
        <select id="tourAddonDuration_${tourIndex}">
          <option value="half-day">Half Day</option>
          <option value="full-day">Full Day</option>
        </select>
      </div>
      <div>
        <label>Tour Mode</label>
        <select id="tourAddonMode_${tourIndex}">
          <option value="private">Private</option>
          <option value="sharing">Sharing</option>
        </select>
      </div>
      <div>
        <label>Vehicle Type</label>
        <select id="tourAddonVehicle_${tourIndex}">
          <option>Sedan</option>
          <option>SUV</option>
          <option>Van</option>
          <option>Bus</option>
          <option>Jeep</option>
        </select>
      </div>
      <div>
        <label>Cost per Person</label>
        <input id="tourAddonCost_${tourIndex}" type="number" value="0" min="0">
      </div>
      <div>
        <label>Currency</label>
        <select id="tourAddonCurrency_${tourIndex}">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="PKR">PKR</option>
        </select>
      </div>
      <div>
        <label>Service Fee per Person</label>
        <input id="tourAddonSvc_${tourIndex}" type="number" value="0" min="0">
      </div>
    </div>
  `;
  
  container.appendChild(div);
}

function removeTourAddon(index) {
  const block = document.getElementById("tourAddon_" + index);
  if(block) block.remove();
  tours = tours.filter(t => t !== index);
}

function removeAddon(id){
  const block=document.getElementById(id);
  if(block) block.remove();
}
</script>

<!-- Quotation Status Section -->
<div class="section" id="statusSection" style="display:none;">
  <h3>Update Quotation Status</h3>
  <div class="grid">
    <div>
      <label for="quotationStatus">Current Status</label>
      <select id="quotationStatus">
        <option value="pending">Pending</option>
        <option value="followup">Follow-up Required</option>
        <option value="booked">Booked</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
  </div>
  <div class="actions" style="margin-top:10px">
    <button id="btnUpdateStatus" type="button">Update Status</button>
  </div>
</div>

<!-- PACKAGE CALCULATION -->
<div class="section" id="calcSectionWrapper">
  <div class="actions">
    <button type="button" id="btnCalculate" class="green-btn">💰 Calculate Package</button>
    <button type="button" id="btnGenerateQuotation" class="blue-btn" style="display:none;">📄 Generate Quotation</button>
  </div>
</div>

<div id="calcSummarySection" class="section" style="display:none;">
  <h3>📊 Package Calculation Summary</h3>

  <div class="grid">
    <div>
      <label>Base Currency (for conversion)</label>
      <input id="baseCurrency" type="text" value="PKR" readonly>
    </div>
    <div>
      <label>USD to PKR Rate</label>
      <input id="usdToPkrRate" type="number" value="310" min="1">
    </div>
  </div>

  <div style="overflow-x:auto;margin-top:12px;">
    <table id="calcSummaryTable" border="1" style="width:100%;border-collapse:collapse;">
      <thead style="background:#eef5fb;">
        <tr>
          <th>Section</th>
          <th>Description</th>
          <th>Currency</th>
          <th>Cost</th>
          <th>Service</th>
          <th>Cost (PKR)</th>
          <th>Service (PKR)</th>
          <th>Total (PKR)</th>
          <th>Per Person</th>
        </tr>
      </thead>
      <tbody id="calcSummaryBody"></tbody>
      <tfoot id="calcSummaryFooter" style="font-weight:bold;background:#f5f5f5;"></tfoot>
    </table>
  </div>

  <div class="section" id="agentExtraSvc" style="margin-top: 20px; border: 1px dashed #ccc; padding: 15px; border-radius: 8px;">
    <h4>Agent Service Charge Options (Optional)</h4>
    <p class="small" style="color:#666; margin-top:-10px;">Choose one option for adding service fee to the final selling price.</p>
    
    <div style="margin-bottom: 15px;">
      <label style="display: flex; align-items: center; margin-bottom: 10px;">
        <input type="radio" name="svcOption" value="perPerson" onchange="toggleServiceOption('perPerson')" style="margin-right: 8px;">
        <span>Add Service Fee Per Person (PKR)</span>
      </label>
      <label style="display: flex; align-items: center;">
        <input type="radio" name="svcOption" value="none" checked onchange="toggleServiceOption('none')" style="margin-right: 8px;">
        <span>No Service Charge</span>
      </label>
    </div>
    
    <!-- Per Person Service Option -->
    <div id="perPersonSvcOption" class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 10px; display: none;">
      <div>
        <label>Service / Adult (PKR)</label>
        <input id="svcPerAdult" type="number" value="0" min="0" oninput="performCalculation()">
      </div>
      <div>
        <label>Service / Child (PKR)</label>
        <input id="svcPerChild" type="number" value="0" min="0" oninput="performCalculation()">
      </div>
      <div>
        <label>Service / Infant (PKR)</label>
        <input id="svcPerInfant" type="number" value="0" min="0" oninput="performCalculation()">
      </div>
    </div>
  </div>
  
  <div id="calcTotals" style="margin-top:14px;font-weight:bold;"></div>

<div class="actions" style="margin-top:14px;">
  <button type="button" id="btnRecalculate" class="blue-btn">🔁 Recalculate</button>
  <button type="button" id="btnGenerateQuotation2" class="blue-btn" onclick="showQuotationModal()">📄 Generate Quotation</button>
  <button type="button" id="btnExportExcel" class="green-btn">📊 Export Cost Sheet</button>
  <button type="button" id="btnCloseSummary" class="ghost">❌ Close Summary</button>
</div>

<script>
const btnCalculate = document.getElementById("btnCalculate");
const calcSummarySection = document.getElementById("calcSummarySection");
const calcSummaryBody = document.getElementById("calcSummaryBody");
const calcSummaryFooter = document.getElementById("calcSummaryFooter");
const calcTotalsDiv = document.getElementById("calcTotals");
const btnCloseSummary = document.getElementById("btnCloseSummary");
const btnRecalculate = document.getElementById("btnRecalculate");
const btnGenerateQuotation = document.getElementById("btnGenerateQuotation");
const btnExportExcel = document.getElementById("btnExportExcel");
const baseCurrencyInput = document.getElementById("baseCurrency");
const usdToPkrRateInput = document.getElementById("usdToPkrRate");

// --- UPDATED CURRENCY CONVERSION FUNCTION ---
function convertToPKR(amount, currency) {
  // Default to USD if currency is not specified
  if (!currency) currency = 'USD'; 
  
  const rate = parseFloat(usdToPkrRateInput.value || 310);
  
  if (currency === 'PKR') {
    return amount;
  }
  if (currency === 'USD') {
    return amount * rate;
  }
  // If any other currency appears, treat it as USD for conversion
  console.warn(`Unexpected currency '${currency}'. Converting as USD.`);
  return amount * rate;
}

function fmt(num) {
  return num.toLocaleString("en-PK", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

// Toggle service charge options for International tool
function toggleServiceOption(option) {
  const perPersonOption = document.getElementById('perPersonSvcOption');
  
  if (option === 'perPerson') {
    perPersonOption.style.display = 'block';
  } else {
    perPersonOption.style.display = 'none';
  }
  
  // Reset values when switching options
  if (option === 'perPerson') {
    // No need to reset values when selecting perPerson
  } else {
    document.getElementById('svcPerAdult').value = 0;
    document.getElementById('svcPerChild').value = 0;
    document.getElementById('svcPerInfant').value = 0;
  }
  
  // Recalculate after changing options
  performCalculation();
}

// Replace the entire performCalculation function with this corrected version
function performCalculation() {
  // Check if the calculation was triggered by a button click
  const isButtonClick = document.activeElement === btnCalculate || document.activeElement === btnRecalculate;

  // --- VALIDATION 1: CLIENT & PAX ---
  const clientName = document.querySelector("#clientName, #client_name, #client")?.value?.trim() || "";
  const paxData = getCurrentPaxData();
  const totalPax = paxData ? (paxData.adults + paxData.childBed + paxData.childNoBed + paxData.infants) : 0;
  
  // --- VALIDATION 2: SERVICE CHECK FLAGS ---
  const hasFlights = document.querySelectorAll("[id^='flightBlock_']").length > 0;
  const hasHotels = document.querySelectorAll("[id^='hotelBlock_']").length > 0;
  const hasTransfers = document.querySelectorAll("[id^='transferBlock_']").length > 0;
  const hasTours = document.querySelectorAll("[id^='tourBlock_']").length > 0;
  const visaCost = parseFloat(document.getElementById("visaCost")?.value || 0);
  const hasExtras = document.querySelectorAll("[id^='dfAddon_']").length > 0 ||
    document.querySelectorAll("[id^='mealAddon_']").length > 0 ||
    document.querySelectorAll("[id^='tourAddon_']").length > 0;
    
  // --- CORE VALIDATION LOGIC (Runs only on explicit button click) ---
  if (isButtonClick) {
    if (!clientName) {
      showNotification("⚠️ Please enter client details!", "warning");
      return;
    }
    if (totalPax === 0) {
      showNotification("⚠️ Please add Pax details before calculation!", "warning");
      return;
    }
    if (!(hasFlights || hasHotels || hasTransfers || hasTours || hasExtras || visaCost > 0)) {
      showNotification("⚠️ Please add at least one service before calculating!", "warning");
      return;
    }
    
    showNotification("✅ All details verified. Generating quotation...", "success");
  }

// --- CALCULATION LOGIC ---
  let totalCostPKR = 0, totalServicePKR = 0;
  let addonCostPKR = 0, addonServicePKR = 0;

  // Pax Counts for Agent Service Fee Calculation
  const numAdult = parseInt(document.getElementById('numAdult')?.value || 0);
  const numChildBed = parseInt(document.getElementById('numChildBed')?.value || 0);
  const numChildNoBed = parseInt(document.getElementById('numChildNoBed')?.value || 0);
  const numChild = numChildBed + numChildNoBed;
  const numInfant = parseInt(document.getElementById('numInfant')?.value || 0);

  calcSummaryBody.innerHTML = "";

  // --- FINAL, DEFINITIVE addDetailedRow FUNCTION ---
  // It takes original values, converts them, and displays both.
  const addDetailedRow = (section, desc, details, currency, costOrig, svcOrig, perPerson = '', isAddon = false) => {
    // Convert the original currency values to PKR
    const costPKR = convertToPKR(costOrig, currency);
    const svcPKR = convertToPKR(svcOrig, currency);
    const totalPKR = costPKR + svcPKR;

    if (isAddon) {
      addonCostPKR += costPKR;
      addonServicePKR += svcPKR;
    } else {
      totalCostPKR += costPKR;
      totalServicePKR += svcPKR;
    }
    calcSummaryBody.innerHTML += `
      <tr>
        <td>${section}</td>
        <td>
          <div style="font-weight: bold;">${desc}</div>
          <div class="small" style="color: #666;">${details}</div>
        </td>
        <td>${currency}</td>
        <td>${fmt(costOrig)}</td>
        <td>${fmt(svcOrig)}</td>
        <td>${fmt(costPKR)}</td>
        <td>${fmt(svcPKR)}</td>
        <td><strong>${fmt(totalPKR)}</strong></td>
        <td>${perPerson}</td>
      </tr>`;
  };

  // --- FLIGHTS ---
  document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const p = paxData || { adults: 1, childBed: 0, childNoBed: 0, infants: 0 };
    
    const airline = document.getElementById(`airline_${idx}`)?.value || "Not specified";
    const flightType = document.getElementById(`flightDirect_${idx}`)?.value || "Not specified";
    const currency = document.getElementById(`flightCurrency_${idx}`)?.value || "USD";
    
    const costAdult = parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0);
    const svcAdult = parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0);
    const costChildBed = parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0);
    const svcChildBed = parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0);
    const costChildNoBed = parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0);
    const svcChildNoBed = parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0);
    const costInf = parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0);
    const svcInf = parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0);

    // Calculate totals in ORIGINAL currency
    const totalCostOrig = (costAdult * p.adults) + (costChildBed * p.childBed) + (costChildNoBed * p.childNoBed) + (costInf * p.infants);
    const totalSvcOrig = (svcAdult * p.adults) + (svcChildBed * p.childBed) + (svcChildNoBed * p.childNoBed) + (svcInf * p.infants);
    
    // Calculate per person pricing in ORIGINAL currency for display
    const perAdult = convertToPKR(costAdult + svcAdult, currency);
    const perChildBed = convertToPKR(costChildBed + svcChildBed, currency);
    const perChildNoBed = convertToPKR(costChildNoBed + svcChildNoBed, currency);
    const perInfant = convertToPKR(costInf + svcInf, currency);
    
    let perPersonText = [];
    if (p.adults > 0) perPersonText.push(`Adult x${p.adults}: PKR ${fmt(perAdult)}`);
    if (p.childBed > 0) perPersonText.push(`Child (with bed) x${p.childBed}: PKR ${fmt(perChildBed)}`);
    if (p.childNoBed > 0) perPersonText.push(`Child (no bed) x${p.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (p.infants > 0) perPersonText.push(`Infant x${p.infants}: PKR ${fmt(perInfant)}`);
    perPersonText = perPersonText.join(', ');
    
    const details = `${airline} - ${flightType}<br>
                    Adults: ${p.adults} × ${currency} ${fmt(costAdult)}<br>
                    Children (with bed): ${p.childBed} × ${currency} ${fmt(costChildBed)}<br>
                    Children (no bed): ${p.childNoBed} × ${currency} ${fmt(costChildNoBed)}<br>
                    Infants: ${p.infants} × ${currency} ${fmt(costInf)}`;

    if (totalCostOrig + totalSvcOrig > 0) {
      addDetailedRow(`Flight ${idx}`, airline, details, currency, totalCostOrig, totalSvcOrig, perPersonText, false);
    }
  });

  // --- HOTELS ---
  document.querySelectorAll("[id^='hotelBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`hotelName_${idx}`)?.value || "Not specified";
    const city = document.getElementById(`hotelCity_${idx}`)?.value || "Not specified";
    const checkIn = document.getElementById(`hotelCheckIn_${idx}`)?.value || "Not specified";
    const checkOut = document.getElementById(`hotelCheckOut_${idx}`)?.value || "Not specified";
    const nights = parseFloat(document.getElementById(`hotelNights_${idx}`)?.value || 0);
    const roomType = document.getElementById(`hotelRoomType_${idx}`)?.value || "Not specified";
    const rooms = parseFloat(document.getElementById(`hotelRooms_${idx}`)?.value || 0);
    const serviceType = document.getElementById(`hotelService_${idx}`)?.value || "Room Only";
    const costNight = parseFloat(document.getElementById(`hotelCostNight_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hotelSvcNight_${idx}`)?.value || 0);
    const currency = document.getElementById(`hotelCurrency_${idx}`)?.value || "USD";

    // Calculate totals in ORIGINAL currency
    const totalCostOrig = costNight * nights * rooms;
    const totalSvcOrig = svcNight * nights * rooms;
    
    const payingPax = paxData.adults + paxData.childBed;
    const perPersonCost = payingPax > 0 ? convertToPKR((costNight + svcNight) * nights * rooms, currency) / payingPax : 0;
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    
    const details = `${name} (${city})<br>
                    Check-in: ${formatDateToDMY(checkIn)}, Check-out: ${formatDateToDMY(checkOut)}<br>
                    ${nights} nights, ${roomType} × ${rooms} rooms<br>
                    Service: ${serviceType}<br>
                    Rate: ${currency} ${fmt(costNight)}/night<br>
                    Charged to: Adults (${paxData.adults}) + Children with bed (${paxData.childBed})`;

    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    perPersonText = perPersonText.join(', ');

    if (totalCostOrig + totalSvcOrig > 0) {
      addDetailedRow(`Hotel ${idx}`, name, details, currency, totalCostOrig, totalSvcOrig, perPersonText, false);
    }
  });

  // --- TRANSFERS ---
  document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const date = document.getElementById(`tDate_${idx}`)?.value || "Not specified";
    const from = document.getElementById(`tFrom_${idx}`)?.value || "Not specified";
    const to = document.getElementById(`tTo_${idx}`)?.value || "Not specified";
    const vehicle = document.getElementById(`tCar_${idx}`)?.value || "Not specified";
    const type = document.getElementById(`tType_${idx}`)?.value || "Not specified";
    const currency = document.getElementById(`tCurrency_${idx}`)?.value || "USD";
    
    // Get costs in ORIGINAL currency
    const costOrig = parseFloat(document.getElementById(`tCost_${idx}`)?.value || 0);
    const svcOrig = parseFloat(document.getElementById(`tSvc_${idx}`)?.value || 0);
    
    const payingPax = paxData.adults + paxData.childBed + paxData.childNoBed;
    const perPersonCost = payingPax > 0 ? convertToPKR(costOrig + svcOrig, currency) / payingPax : 0;
    
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = paxData.childNoBed > 0 ? perPersonCost : 0;
    
    const details = `Date: ${formatDateToDMY(date)}<br>
                    Route: ${from} → ${to}<br>
                    Vehicle: ${vehicle} (${type})<br>
                    Rate: ${currency} ${fmt(costOrig)}<br>
                    Charged to: Adults (${paxData.adults}) + Children with bed (${paxData.childBed}) + Children without bed (${paxData.childNoBed})`;

    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    perPersonText = perPersonText.join(', ');

    if (costOrig + svcOrig > 0) {
      addDetailedRow(`Transfer ${idx}`, `${from} to ${to}`, details, currency, costOrig, svcOrig, perPersonText, false);
    }
  });

  // --- TOURS & ACTIVITIES ---
  document.querySelectorAll("[id^='tourBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`tourName_${idx}`)?.value || "Not specified";
    const city = document.getElementById(`tourCity_${idx}`)?.value || "Not specified";
    const date = document.getElementById(`tourDate_${idx}`)?.value || "Not specified";
    const duration = document.getElementById(`tourDuration_${idx}`)?.value || "Not specified";
    const mode = document.getElementById(`tourMode_${idx}`)?.value || "Not specified";
    const vehicle = document.getElementById(`tourVehicle_${idx}`)?.value || "Not specified";
    const currency = document.getElementById(`tourCurrency_${idx}`)?.value || "USD";
    
    // Get costs in ORIGINAL currency
    const costOrig = parseFloat(document.getElementById(`tourCost_${idx}`)?.value || 0);
    const svcOrig = parseFloat(document.getElementById(`tourSvc_${idx}`)?.value || 0);
    
    const payingPax = paxData.adults + paxData.childBed + paxData.childNoBed + paxData.infants;
    const perPersonCost = payingPax > 0 ? convertToPKR(costOrig + svcOrig, currency) / payingPax : 0;
    
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = paxData.childNoBed > 0 ? perPersonCost : 0;
    const perInfant = paxData.infants > 0 ? perPersonCost : 0;
    
    const details = `Date: ${formatDateToDMY(date)}<br>
                    City: ${city}<br>
                    Duration: ${duration}<br>
                    Mode: ${mode}<br>
                    Vehicle: ${vehicle}<br>
                    Rate: ${currency} ${fmt(costOrig)} per person<br>
                    Charged to: All passengers (${payingPax})`;

    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (paxData.infants > 0) perPersonText.push(`Infant x${paxData.infants}: PKR ${fmt(perInfant)}`);
    perPersonText = perPersonText.join(', ');

    if (costOrig + svcOrig > 0) {
      addDetailedRow(`Tour ${idx}`, name, details, currency, costOrig * payingPax, svcOrig * payingPax, perPersonText, false);
    }
  });

  // --- VISA ---
  if (document.getElementById('visaBlock')) {
    const visaType = document.getElementById('visaType')?.value || "Tourist Visa";
    const visaCountry = document.getElementById('visaCountry')?.value || "Not specified";
    const visaCount = parseFloat(document.getElementById('visaCount')?.value || 0);
    const visaCurrency = document.getElementById('visaCurrency')?.value || "USD";
    
    // Get costs in ORIGINAL currency
    const visaCostOrig = parseFloat(document.getElementById("visaCost")?.value || 0);
    const visaSvcOrig = parseFloat(document.getElementById("visaSvc")?.value || 0);
    
    const totalCostOrig = visaCostOrig * visaCount;
    const totalSvcOrig = visaSvcOrig * visaCount;
    
    const payingPax = paxData.adults + paxData.childBed + paxData.childNoBed + paxData.infants;
    const perPersonCost = payingPax > 0 ? convertToPKR(visaCostOrig + visaSvcOrig, visaCurrency) : 0;
    
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = paxData.childNoBed > 0 ? perPersonCost : 0;
    const perInfant = paxData.infants > 0 ? perPersonCost : 0;
    
    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (paxData.infants > 0) perPersonText.push(`Infant x${paxData.infants}: PKR ${fmt(perInfant)}`);
    perPersonText = perPersonText.join(', ');
    
    if (totalCostOrig > 0) {
      const details = `Cost: ${visaCurrency} ${fmt(visaCostOrig)} × ${visaCount}<br>Service: ${visaCurrency} ${fmt(visaSvcOrig)} × ${visaCount}`;
      addDetailedRow("Visa", `${visaType} (${visaCountry})`, details, visaCurrency, totalCostOrig, totalSvcOrig, perPersonText, false);
    }
  }

  // --- AGENT EXTRA SERVICE CHARGE CALCULATION ---
  const svcOption = document.querySelector('input[name="svcOption"]:checked').value;
  let totalExtraServicePKR = 0;

  if (svcOption === 'perPerson') {
    const svcPerAdult = parseFloat(document.getElementById('svcPerAdult')?.value || 0);
    const svcPerChild = parseFloat(document.getElementById('svcPerChild')?.value || 0);
    const svcPerInfant = parseFloat(document.getElementById('svcPerInfant')?.value || 0);
    
    totalExtraServicePKR = (svcPerAdult * numAdult) + (svcPerChild * numChild) + (svcPerInfant * numInfant);
  }

  if (totalExtraServicePKR > 0) {
    const svcPerAdult = parseFloat(document.getElementById('svcPerAdult')?.value || 0);
    const svcPerChild = parseFloat(document.getElementById('svcPerChild')?.value || 0);
    const svcPerInfant = parseFloat(document.getElementById('svcPerInfant')?.value || 0);
    const svcDescription = `Per Person Service: Adult PKR ${fmt(svcPerAdult)}, Child PKR ${fmt(svcPerChild)}, Infant PKR ${fmt(svcPerInfant)}`;
    
    // This service is already in PKR, so cost and service PKR are the same.
    addDetailedRow(
        `Agent Service Fee`, 
        svcDescription,
        'PKR', 
        0, 
        totalExtraServicePKR, 
        '',
        false
    );
  }

  // --- FINAL PACKAGE TOTALS & SUMMARY ---
  const finalPackageServicePKR = totalServicePKR + totalExtraServicePKR;
  const finalPackageSellPKR = totalCostPKR + finalPackageServicePKR;

  const perPersonCosts = calculatePerPersonCosts(totalCostPKR, finalPackageServicePKR, paxData);
  const { perAdult, perChildBed, perChildNoBed, perInfant } = perPersonCosts;

  let packagePricingText = [];
  if (numAdult > 0) packagePricingText.push(`Adult x${numAdult}: PKR ${fmt(perAdult)}`);
  if (numChildBed > 0) packagePricingText.push(`Child (bed) x${numChildBed}: PKR ${fmt(perChildBed)}`);
  if (numChildNoBed > 0) packagePricingText.push(`Child (no bed) x${numChildNoBed}: PKR ${fmt(perChildNoBed)}`);
  if (numInfant > 0) packagePricingText.push(`Infant x${numInfant}: PKR ${fmt(perInfant)}`);
  packagePricingText = packagePricingText.join(', ');

  calcSummaryBody.innerHTML += `
    <tr style="font-weight: bold; background-color: #e3f2fd;">
      <td colspan="2">PACKAGE TOTALS</td>
      <td>PKR</td>
      <td>${fmt(totalCostPKR)}</td>
      <td>${fmt(finalPackageServicePKR)}</td>
      <td>${fmt(totalCostPKR)}</td>
      <td>${fmt(finalPackageServicePKR)}</td>
      <td>${fmt(finalPackageSellPKR)}</td>
      <td>${packagePricingText}</td>
    </tr>`;

  // --- UPGRADED FLIGHT ADD-ONS ---
  document.querySelectorAll("[id^='dfAddon_']").forEach((el, i) => {
    const idx = i + 1;
    const pax = paxData || { adults: 1, childBed: 0, childNoBed: 0, infants: 0 };
    const upgradeIndex = el.id.split('_')[1];
    
    const currency = el.querySelector(`select[id^='upgradeFlightCurrency']`)?.value || "USD";
    
    // Get costs in ORIGINAL currency
    const adultCost = parseFloat(document.getElementById(`upgradeFlightCostAdult_${upgradeIndex}`)?.value || 0);
    const adultSvc = parseFloat(document.getElementById(`upgradeFlightSvcAdult_${upgradeIndex}`)?.value || 0);
    const childBedCost = parseFloat(document.getElementById(`upgradeFlightCostChildBed_${upgradeIndex}`)?.value || 0);
    const childBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildBed_${upgradeIndex}`)?.value || 0);
    const childNoBedCost = parseFloat(document.getElementById(`upgradeFlightCostChildNoBed_${upgradeIndex}`)?.value || 0);
    const childNoBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildNoBed_${upgradeIndex}`)?.value || 0);
    const infantCost = parseFloat(document.getElementById(`upgradeFlightCostInf_${upgradeIndex}`)?.value || 0);
    const infantSvc = parseFloat(document.getElementById(`upgradeFlightSvcInf_${upgradeIndex}`)?.value || 0);

    // Calculate total cost in ORIGINAL currency
    const totalCostOrig = (adultCost * pax.adults) + (childBedCost * pax.childBed) + (childNoBedCost * pax.childNoBed) + (infantCost * pax.infants);
    const totalSvcOrig = (adultSvc * pax.adults) + (childBedSvc * pax.childBed) + (childNoBedSvc * pax.childNoBed) + (infantSvc * pax.infants);

    // Calculate per person cost in ORIGINAL currency for display
    const perAdult = convertToPKR(adultCost + adultSvc, currency);
    const perChildBed = convertToPKR(childBedCost + childBedSvc, currency);
    const perChildNoBed = convertToPKR(childNoBedCost + childNoBedSvc, currency);
    const perInfant = convertToPKR(infantCost + infantSvc, currency);
    
    let perPersonText = [];
    if (pax.adults > 0) perPersonText.push(`Adult x${pax.adults}: PKR ${fmt(perAdult)}`);
    if (pax.childBed > 0) perPersonText.push(`Child (with bed) x${pax.childBed}: PKR ${fmt(perChildBed)}`);
    if (pax.childNoBed > 0) perPersonText.push(`Child (no bed) x${pax.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (pax.infants > 0) perPersonText.push(`Infant x${pax.infants}: PKR ${fmt(perInfant)}`);
    perPersonText = perPersonText.join(', ');
    
    const airline = el.querySelector("input[list='airlist']")?.value || "Unspecified";
    const flightType = el.querySelector('select')?.value || "Not specified";
    
    if (totalCostOrig + totalSvcOrig > 0) {
      const details = `${airline} - ${flightType}<br>
                      Difference: Adult PKR ${fmt(perAdult)}, Child (with bed) PKR ${fmt(perChildBed)}, Child (no bed) PKR ${fmt(perChildNoBed)}, Infant PKR ${fmt(perInfant)}`;
      
      addDetailedRow(`Add-on - Upgrade Flight ${idx}`, airline, details, currency, totalCostOrig, totalSvcOrig, perPersonText, true);
    }
  });

  // --- MEAL TYPE ADD-ONS ---
  document.querySelectorAll("[id^='mealAddon_']").forEach((el, i) => {
    const idx = i + 1;
    const selects = el.querySelectorAll('select');
    const inputs = el.querySelectorAll("input[type='number']");
    
    const hotel = selects[0]?.value || 'Not specified';
    const mealType = selects[1]?.value || "Not specified";
    const currency = el.querySelector("select[id^='mealCurrency']")?.value || "USD";
    
    let costPerPaxPerNight = 0; 
    let svcPerPaxPerNight = 0;
    
    if (inputs.length >= 2) {
      costPerPaxPerNight = parseFloat(inputs[0].value || 0);
      svcPerPaxPerNight = parseFloat(inputs[1].value || 0);
    }
    
    let cityNights = 0;
    if (hotel.includes('Madina')) {
      cityNights = parseInt(document.getElementById('nightsMadina')?.value || 0); 
    } else if (hotel.includes('Makkah')) {
      cityNights = parseInt(document.getElementById('nightsMakkah')?.value || 0);
    } else {
      const dateFrom = document.getElementById("dateFrom");
      const dateTo = document.getElementById("dateTo");
      if (dateFrom.value && dateTo.value) {
          const d1 = new Date(dateFrom.value);
          const d2 = new Date(dateTo.value);
          cityNights = Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
      }
    }
    
    const totalNights = cityNights > 0 ? cityNights : 0; 
    const payingPax = numAdult + numChildBed;
    const effectivePax = payingPax > 0 ? payingPax : 1; 

    // Calculate total cost in ORIGINAL currency
    const totalCostOrig = costPerPaxPerNight * effectivePax * totalNights;
    const totalSvcOrig = svcPerPaxPerNight * effectivePax * totalNights;
    
    const perPersonCost = effectivePax > 0 ? convertToPKR(costPerPaxPerNight + svcPerPaxPerNight, currency) : 0;
    const perAdult = numAdult > 0 ? perPersonCost : 0;
    const perChildBed = numChildBed > 0 ? perPersonCost : 0;
    
    if (totalCostOrig + totalSvcOrig > 0 && totalNights > 0) {
      const details = `${hotel} - ${mealType}<br>
                      ${effectivePax} pax × ${totalNights} nights<br>
                      Cost: ${currency} ${fmt(costPerPaxPerNight)}/pax/night<br>
                      Service: ${currency} ${fmt(svcPerPaxPerNight)}/pax/night<br>
                      Charged to: Adults (${numAdult}) + Children with bed (${numChildBed})`;
      
      let perPersonText = [];
      if (numAdult > 0) perPersonText.push(`Adult x${numAdult}: PKR ${fmt(perAdult)}`);
      if (numChildBed > 0) perPersonText.push(`Child (with bed) x${numChildBed}: PKR ${fmt(perChildBed)}`);
      perPersonText = perPersonText.join(', ');
      
      addDetailedRow(`Add-on - Meal Type ${idx}`, `${hotel} ${mealType}`, details, currency, totalCostOrig, totalSvcOrig, perPersonText, true);
    }
  });

  // --- TOUR ADD-ONS ---
  document.querySelectorAll("[id^='tourAddon_']").forEach((el, i) => {
    const idx = i + 1;
    const tourName = document.getElementById(`tourAddonName_${idx}`)?.value || 'Not specified';
    const tourCity = document.getElementById(`tourAddonCity_${idx}`)?.value || 'Not specified';
    const tourDate = document.getElementById(`tourAddonDate_${idx}`)?.value || '';
    const tourDuration = document.getElementById(`tourAddonDuration_${idx}`)?.value || 'Not specified';
    const tourMode = document.getElementById(`tourAddonMode_${idx}`)?.value || 'Not specified';
    const tourVehicle = document.getElementById(`tourAddonVehicle_${idx}`)?.value || 'Not specified';
    const currency = document.getElementById(`tourAddonCurrency_${idx}`)?.value || "USD";
    
    // Get costs in ORIGINAL currency
    const costOrig = parseFloat(document.getElementById(`tourAddonCost_${idx}`)?.value || 0);
    const svcOrig = parseFloat(document.getElementById(`tourAddonSvc_${idx}`)?.value || 0);
    
    const payingPax = paxData.adults + paxData.childBed + paxData.childNoBed + paxData.infants;
    const perPersonCost = payingPax > 0 ? convertToPKR(costOrig + svcOrig, currency) / payingPax : 0;
    
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = paxData.childNoBed > 0 ? perPersonCost : 0;
    const perInfant = paxData.infants > 0 ? perPersonCost : 0;
    
    const totalCostOrig = costOrig * payingPax;
    const totalSvcOrig = svcOrig * payingPax;
    
    const details = `Date: ${formatDateToDMY(tourDate)}<br>
                    City: ${tourCity}<br>
                    Duration: ${tourDuration}<br>
                    Mode: ${tourMode}<br>
                    Vehicle: ${tourVehicle}<br>
                    Rate: ${currency} ${fmt(costOrig)} per person<br>
                    Charged to: All passengers (${payingPax})`;
    
    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (paxData.infants > 0) perPersonText.push(`Infant x${paxData.infants}: PKR ${fmt(perInfant)}`);
    perPersonText = perPersonText.join(', ');
    
    if (costOrig + svcOrig > 0) {
      addDetailedRow(`Add-on - Tour ${idx}`, tourName, details, currency, totalCostOrig, totalSvcOrig, perPersonText, true);
    }
  });

  // Final Footer Row
  if (addonCostPKR > 0 || addonServicePKR > 0) {
    calcSummaryFooter.innerHTML = `
      <tr style="background-color: #f8f9fa;">
        <td colspan="9" style="text-align: center; font-weight: bold; color: #666; padding: 10px;">
          OPTIONAL ADD-ONS (Customer can select as needed)
        </td>
      </tr>`;
  } else {
    calcSummaryFooter.innerHTML = '';
  }

  // Final Totals Div
  calcTotalsDiv.innerHTML = `
      <div style="margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 6px;">
        <h4 style="margin: 0 0 5px 0; color: #0b76d1;">Package Summary</h4>
        <div>Package Cost: PKR ${fmt(totalCostPKR)}</div>
        <div>Package Service: PKR ${fmt(finalPackageServicePKR)}</div>
        <div style="font-size: 18px; font-weight: bold; color: #0b76d1;">Package Total: PKR ${fmt(finalPackageSellPKR)}</div>
        <div style="margin-top: 5px; font-size: 14px;">${packagePricingText}</div>
      </div>
      ${addonCostPKR > 0 || addonServicePKR > 0 ? `
      <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
        <h4 style="margin: 0 0 5px 0; color: #666;">Optional Add-ons</h4>
        <div>Add-ons Cost: PKR ${fmt(addonCostPKR)}</div>
        <div>Add-ons Service: PKR ${fmt(addonServicePKR)}</div>
        <div style="font-size: 16px; font-weight: bold; color: #666;">Add-ons Total: PKR ${fmt(addonCostPKR + addonServicePKR)}</div>
      </div>
      <div style="padding: 10px; background: #e8f5e8; border-radius: 6px;">
        <h4 style="margin: 0 0 5px 0; color: #2e7d32;">Grand Total (Package + Selected Add-ons)</h4>
        <div style="font-size: 20px; font-weight: bold; color: #2e7d32;">PKR ${fmt(finalPackageSellPKR + addonCostPKR + addonServicePKR)}</div>
      </div>` : ''}
  `;
  showStatusSection();

  calcSummarySection.style.display = "block";
  btnGenerateQuotation.style.display = "inline-block";
  
  // Auto-save quotation after calculation
  saveQuotation();
  
  if (isButtonClick) {
    calcSummarySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// Function to calculate per person costs based on your requirements
function calculatePerPersonCosts(packageCostPKR, packageServicePKR, paxData) {
  const numAdult = paxData.adults || 0;
  const numChildBed = paxData.childBed || 0;
  const numChildNoBed = paxData.childNoBed || 0;
  const numInfant = paxData.infants || 0;
  
  let perAdultCost = 0, perChildBedCost = 0, perChildNoBedCost = 0, perInfantCost = 0;
  
  // Calculate Flight costs per person
  document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const currency = document.getElementById(`flightCurrency_${idx}`)?.value || "USD";
    
    if (numAdult > 0) {
      const costAdult = parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0);
      const svcAdult = parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0);
      perAdultCost += convertToPKR(costAdult + svcAdult, currency);
    }
    
    if (numChildBed > 0) {
      const costChildBed = parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0);
      const svcChildBed = parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0);
      perChildBedCost += convertToPKR(costChildBed + svcChildBed, currency);
    }
    
    if (numChildNoBed > 0) {
      const costChildNoBed = parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0);
      const svcChildNoBed = parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0);
      perChildNoBedCost += convertToPKR(costChildNoBed + svcChildNoBed, currency);
    }
    
    if (numInfant > 0) {
      const costInf = parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0);
      const svcInf = parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0);
      perInfantCost += convertToPKR(costInf + svcInf, currency);
    }
  });
  
  // Calculate Hotel costs per person (only for adults and children with bed)
  const hotelPayingPax = numAdult + numChildBed;
  
  document.querySelectorAll("[id^='hotelBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const nights = parseFloat(document.getElementById(`hotelNights_${idx}`)?.value || 0);
    const rooms = parseFloat(document.getElementById(`hotelRooms_${idx}`)?.value || 0);
    const costNight = parseFloat(document.getElementById(`hotelCostNight_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hotelSvcNight_${idx}`)?.value || 0);
    const currency = document.getElementById(`hotelCurrency_${idx}`)?.value || "USD";
    
    if (hotelPayingPax > 0) {
      const totalCost = (costNight + svcNight) * nights * rooms;
      const totalCostPKR = convertToPKR(totalCost, currency);
      const perPersonCost = totalCostPKR / hotelPayingPax;
      
      if (numAdult > 0) perAdultCost += perPersonCost;
      if (numChildBed > 0) perChildBedCost += perPersonCost;
    }
  });
  
  // Calculate Visa costs per person
  if (document.getElementById('visaBlock')) {
    const visaCost = parseFloat(document.getElementById("visaCost")?.value || 0);
    const visaSvc = parseFloat(document.getElementById("visaSvc")?.value || 0);
    const visaCurrency = document.getElementById('visaCurrency')?.value || "USD";
    const visaPerPerson = convertToPKR(visaCost + visaSvc, visaCurrency);
    
    if (numAdult > 0) perAdultCost += visaPerPerson;
    if (numChildBed > 0) perChildBedCost += visaPerPerson;
    if (numChildNoBed > 0) perChildNoBedCost += visaPerPerson;
    if (numInfant > 0) perInfantCost += visaPerPerson;
  }
  
  // Calculate Transfer costs per person
  const transferPayingPax = numAdult + numChildBed + numChildNoBed;
  
  document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const cost = parseFloat(document.getElementById(`tCost_${idx}`)?.value || 0);
    const svc = parseFloat(document.getElementById(`tSvc_${idx}`)?.value || 0);
    const currency = document.getElementById(`tCurrency_${idx}`)?.value || "USD";
    const totalTransferCost = convertToPKR(cost + svc, currency);
    
    if (transferPayingPax > 0) {
      const perPersonCost = totalTransferCost / transferPayingPax;
      
      if (numAdult > 0) perAdultCost += perPersonCost;
      if (numChildBed > 0) perChildBedCost += perPersonCost;
      if (numChildNoBed > 0) perChildNoBedCost += perPersonCost;
    }
  });
  
  // Calculate Tour costs per person
  const tourPayingPax = numAdult + numChildBed + numChildNoBed + numInfant;
  
  document.querySelectorAll("[id^='tourBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const cost = parseFloat(document.getElementById(`tourCost_${idx}`)?.value || 0);
    const svc = parseFloat(document.getElementById(`tourSvc_${idx}`)?.value || 0);
    const currency = document.getElementById(`tourCurrency_${idx}`)?.value || "USD";
    const totalTourCost = convertToPKR(cost + svc, currency);
    
    if (tourPayingPax > 0) {
      const perPersonCost = totalTourCost / tourPayingPax;
      
      if (numAdult > 0) perAdultCost += perPersonCost;
      if (numChildBed > 0) perChildBedCost += perPersonCost;
      if (numChildNoBed > 0) perChildNoBedCost += perPersonCost;
      if (numInfant > 0) perInfantCost += perPersonCost;
    }
  });
  
  // Add agent service fee per person if applicable
  const svcOption = document.querySelector('input[name="svcOption"]:checked').value;
  if (svcOption === 'perPerson') {
    const svcPerAdult = parseFloat(document.getElementById('svcPerAdult')?.value || 0);
    const svcPerChild = parseFloat(document.getElementById('svcPerChild')?.value || 0);
    const svcPerInfant = parseFloat(document.getElementById('svcPerInfant')?.value || 0);
    
    if (numAdult > 0) perAdultCost += svcPerAdult;
    if (numChildBed > 0) perChildBedCost += svcPerChild;
    if (numChildNoBed > 0) perChildNoBedCost += svcPerChild;
    if (numInfant > 0) perInfantCost += svcPerInfant;
  }
  
  return {
    perAdult: perAdultCost,
    perChildBed: perChildBedCost,
    perChildNoBed: perChildNoBedCost,
    perInfant: perInfantCost
  };
}

// Update the event listeners
btnCalculate.addEventListener("click", () => {
  document.activeElement = btnCalculate;
  performCalculation();
});
btnRecalculate.addEventListener("click", () => {
  document.activeElement = btnRecalculate;
  performCalculation();
});
btnCloseSummary.addEventListener("click", () => (calcSummarySection.style.display = "none"));
</script>

<script>

// Function to update quotation status
function updateQuotationStatus(quotationId, newStatus) {
  try {
    // Get all quotations
    let savedQuotations = JSON.parse(localStorage.getItem('savedQuotations_international')) || [];
    
    // Find and update the quotation
    const quotationIndex = savedQuotations.findIndex(q => q.id === quotationId);
    if (quotationIndex !== -1) {
      savedQuotations[quotationIndex].status = newStatus;
      savedQuotations[quotationIndex].updatedAt = new Date().toISOString();
      
      // Save back to localStorage and Firebase
      localStorage.setItem('savedQuotations_international', JSON.stringify(savedQuotations));
      
      // Also save to Firebase
      const agent = getCurrentAgent();
      if (agent && agent.id) {
        window.firebaseDB.saveData('international_quotations', agent.id, { 
          quotations: savedQuotations, 
          updatedAt: new Date(),
          agentId: agent.id 
        }).catch(err => console.error('Firebase update error:', err));
      }
      
      // Trigger dashboard refresh
      sessionStorage.setItem('refreshDashboard_international', 'true');
      
      showNotification(`Quotation status updated to: ${newStatus}`, "success");
      
      // Add this to ensure status section is visible after update
      showStatusSection();
      
      return true;
    }
    return false;
  } catch (error) {
    console.error('Error updating quotation status:', error);
    showAlert("Failed to update quotation status. Please try again.", "Error");
    return false;
  }
}

// Function to show/hide status section
function showStatusSection() {
  const statusSection = document.getElementById('statusSection');
  const quotationStatus = document.getElementById('quotationStatus');
  
  // Get all quotations from localStorage
  const allSavedQuotations = JSON.parse(localStorage.getItem('savedQuotations_international')) || [];
  
  if (currentQuotationId) {
    statusSection.style.display = 'block';
    
    // Get current status
    const quotation = allSavedQuotations.find(q => q.id === currentQuotationId);
    if (quotation && quotation.status) {
      quotationStatus.value = quotation.status;
    } else {
      quotationStatus.value = 'pending';
    }
  } else {
      statusSection.style.display = 'none';
    }
  }

// Add a small delay to ensure all elements are loaded
setTimeout(() => {
  showStatusSection();
}, 100);

// Event listener for status update button
document.getElementById('btnUpdateStatus').addEventListener('click', () => {
  if (!currentQuotationId) {
    showAlert("No quotation selected. Please save or load a quotation first.");
    return;
  }
  
  const newStatus = document.getElementById('quotationStatus').value;
  updateQuotationStatus(currentQuotationId, newStatus);
});
</script>

<!-- Quotation Modal -->
<div id="quotationModal" class="modal-overlay no-print">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <h3 id="quotationModalTitle"></h3>
    <div id="quotationModalContent"></div>
    <div id="quotationModalButtons" class="modal-buttons"></div>
  </div>
</div>

<!-- Terms Edit Modal -->
<div id="termsModal" class="modal-overlay no-print">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <h3>Edit Terms & Conditions</h3>
    <textarea id="termsEditor" class="terms-editor"></textarea>
    <button id="resetTermsBtn" class="modal-btn" style="margin-top:10px;">Reset to Default</button>
    <div id="termsModalButtons" class="modal-buttons"></div>
  </div>
</div>

<!-- Content Editor Modal -->
<div id="contentEditorModal" class="modal-overlay no-print">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <h3 id="contentEditorModalTitle"></h3>
    <div id="contentEditorModalContent"></div>
    <div id="contentEditorModalButtons" class="modal-buttons"></div>
  </div>
</div>

<script>
// Default terms and conditions
const defaultTerms = `
<h4 style="margin-top: 20px; color: #222; text-align: left; font-size: 16px; font-weight: 600;">1. Payment Policy</h4>
<p>A 50% advance payment is required at the time of booking to confirm the reservation. The remaining 50% balance must be paid at the time of voucher handover (prior to final ticket issuance or hotel confirmation)</p>
<p>Payments may be made by bank transfer, cash, or any other approved payment method communicated by Flight Connection Travel.</p>
<p>Bookings will be processed only after receipt of the advance payment and confirmation from our accounts department.</p>
<p>Failure to pay the balance by the due time may result in cancellation of the booking and forfeiture of the advance payment, as per supplier rules.</p>

<h4 style="margin-top: 20px; color: #222; text-align: left; font-size: 16px; font-weight: 600;">2. Rates & Availability</h4>
<p>All rates quoted are subject to change without prior notice due to fluctuations in airline fares, hotel rates, exchange rates, and supplier availability.</p>
<p>Package prices are calculated based on the prevailing exchange rate at the time of quotation; any change in exchange rate at the time of final payment will be applied accordingly.</p>
<p>Availability of flights, hotels, and ground transport is not guaranteed until bookings are confirmed and payment has been received.</p>
<p>Flight Connection Travel reserves the right to revise the quotation if any supplier increases fares or imposes additional charges before confirmation.</p>

<h4 style="margin-top: 20px; color: #222; text-align: left; font-size: 16px; font-weight: 600;">3. Cancellation & Refund Policy</h4>
<p>Cancellation and refund charges are determined by the respective airlines, hotels, and other service providers. Clients must contact Flight Connection Travel to confirm applicable charges prior to cancelling.</p>
<p>Airline tickets, hotel reservations, and other supplier services may be non-refundable or partially refundable depending on supplier rules.</p>
<p>Flight Connection Travel charges a non-refundable service fee for administrative processing; this service fee will not be refunded under any circumstances.</p>
<p>Any refunds due from suppliers will be processed after deducting applicable supplier charges and Flight Connection Travel service fees. Refund processing times depend on supplier policies.</p>
<p>In case of cancellations initiated by the supplier (airline/hotel), the supplier's policy for rebooking, refund, or compensation will apply and Flight Connection Travel will assist in accordance with those policies</p>

<h4 style="margin-top: 20px; color: #222; text-align: left; font-size: 16px; font-weight: 600;">4. General Terms</h4>
<p>Flight Connection Travel acts as an intermediary between the client and third-party service providers (airlines, hotels, ground transport, visa agencies, etc.) and is not liable for delays, cancellations, or service failures caused by those providers.</p>
<p>Passengers are responsible for ensuring they hold valid travel documents (passport, visas, vaccination certificates, etc.) prior to departure. Flight Connection Travel will not be liable for denied boarding or entry due to invalid documents.</p>
<p>The company reserves the right to amend or withdraw any quotation or offer without prior notice.</p>
<p>Acceptance of the quotation and payment of the advance constitutes acceptance of these Terms & Conditions by the client.</p>
<p>Any disputes arising under these terms shall be governed by the applicable laws of Pakistan and subject to the jurisdiction of competent courts.</p>
`;

// Store custom terms in localStorage
let customTerms = defaultTerms; // Temporary default

// Load custom terms from Firebase on startup
async function loadCustomTermsFromFirebase() {
  try {
    const agent = getCurrentAgent();
    if (agent && agent.uid) {
      const data = await window.firebaseDB.getData('agents/' + agent.uid + '/data', 'customTerms_international');
      if (data && data.value) {
        customTerms = data.value;
        localStorage.setItem('customTerms_international', data.value);
      } else {
        // If no custom terms in Firebase, use default and save
        customTerms = defaultTerms;
        await window.firebaseDB.saveData('agents/' + agent.uid + '/data', 'customTerms_international', { value: defaultTerms });
        localStorage.setItem('customTerms_international', defaultTerms);
      }
    } else {
      // Fallback to localStorage if no agent
      customTerms = localStorage.getItem('customTerms_international') || defaultTerms;
    }
  } catch (error) {
    console.log('Could not load custom terms from Firebase, using local:', error);
    customTerms = localStorage.getItem('customTerms_international') || defaultTerms;
  }
}

loadCustomTermsFromFirebase();

// Get stored content
const section1Content = localStorage.getItem('section1Content_international') || '';
const section2Content = localStorage.getItem('section2Content_international') || '';

function showQuotationModal() {
  const modal = document.getElementById('quotationModal');
  const modalTitle = document.getElementById('quotationModalTitle');
  const modalContent = document.getElementById('quotationModalContent');
  const modalButtons = document.getElementById('quotationModalButtons');

function printQuotation() {
  try {
    const modalContent = document.getElementById("quotationModalContent");
    if (!modalContent) {
      showAlert("Quotation preview not found!", "Error");
      return;
    }
    
    setTimeout(() => {
      let clonedContent = modalContent.cloneNode(true);
      // Remove toggle buttons
      const buttons = clonedContent.querySelectorAll('button[onclick*="toggle"]');
      buttons.forEach(btn => btn.remove());
      // Remove hidden sections
      const sectionIds = ['calculationSummarySection', 'flightSection', 'hotelSection', 'addonSection', 'priceBreakupSection'];
      sectionIds.forEach(id => {
        const div = clonedContent.querySelector('#' + id);
        if (div && div.style.display === 'none') {
          div.remove();
        }
      });
      let html = clonedContent.innerHTML;
      // Improve PDF readability by adjusting margins and padding
      html = html.replace(/margin-bottom:\s*20px/g, 'margin-bottom: 20px');
      html = html.replace(/padding:\s*15px/g, 'padding: 15px');
      html = html.replace(/margin:\s*15px/g, 'margin: 15px');
      
      const printWindow = window.open('', '_blank');
      
      const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Quotation #${currentQuotationId}</title>
          <style>
            /* Force colors with multiple methods */
            * {
              -webkit-print-color-adjust: exact !important;
              color-adjust: exact !important;
              print-color-adjust: exact !important;
            }
            
            body { 
              font-family: 'Calibri', Arial, sans-serif;
              margin: 0px;
              color: #111;
              background: white !important;
              font-size: 14px;
              line-height: 1.5;
            }
            
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            
            /* Headers - no blue background, just color */
            h1, h2, h3 { 
              color: #0b76d1 !important;
              padding: 0px 0 !important;
              margin: 0px 0 15px 0 !important;
              display: block !important;
              font-size: 18px !important;
              page-break-after: avoid !important;
              page-break-inside: avoid !important;
              page-break-before: avoid !important;
            }
            
            h4 {
              page-break-after: avoid !important;
            }
            
            /* Tables - keep exactly as original */
            table { 
              width: 100%;
              border-collapse: collapse;
              margin: 10px 0 15px 0;
              border: 0.5px solid #ddd !important;
              page-break-inside: avoid !important;
              page-break-before: avoid !important;
              page-break-after: avoid !important;
            }
            
            th, td { 
              border: 0.5px solid #ddd !important;
              padding: 8px 10px;
              text-align: left;
              font-size: 13px;
            }
            
            th { 
              background: linear-gradient(to right, #0b76d1, #0a6bbd) !important;
              color: white !important;
              font-weight: bold;
            }
            
            p {
              margin: 8px 0;
            }
            
            /* Sections - NO blue background or borders */
            div[style*="border: 1px solid #eee"],
            div[style*="border: 1px solid #ddd"] {
              margin: 0px 0 20px 0 !important;
              padding: 15px !important;
              border: none !important;
              border-radius: 0px !important;
              background: white !important;
              page-break-inside: avoid !important;
              page-break-after: auto !important;
              page-break-before: avoid !important;
              display: block !important;
              position: relative !important;
            }
            
            /* Keep green sections */
            div[style*="background-color: #e8f5e8"], 
            div[style*="background-color: #e8f5e9"] {
              background: #e8f5e8 !important;
              border: 2px solid #2e7d32 !important;
              color: #2e7d32 !important;
              page-break-inside: avoid !important;
            }
            
            /* Keep gray sections */
            div[style*="background-color: #f8f9fa"] {
              background: #f8f9fa !important;
              border: 1px solid #ddd !important;
              color: #666 !important;
              page-break-inside: avoid !important;
            }
            
            /* Keep table rows exactly as original - no alternating colors */
            table tbody tr {
              /* Keep original styling - don't add or remove grey */
            }
            
            /* Total rows with light blue */
            table tfoot tr,
            tr[style*="background-color: #e3f2fd"] {
              background: #e3f2fd !important;
              color: #0b76d1 !important;
              font-weight: bold !important;
            }
            
            /* Remove blue from package total section */
            div[style*="background-color: #e3f2fd"]:not(table tr) {
              background: white !important;
              border: 1px solid #ddd !important;
            }
            
            /* Image styling */
            img {
              max-width: 100% !important;
              height: auto !important;
              page-break-inside: avoid !important;
            }
            
            /* Print settings */
            @media print {
              @page { 
                margin: 0.5in; 
                size: A4;
                
                /* Header and Footer */
                @top-center {
                  content: "Flight Connection Travel & Tours";
                  font-size: 12px;
                  color: #0b76d1;
                  font-weight: bold;
                }
                
                @bottom-center {
                  content: "Page " counter(page);
                  font-size: 10px;
                  color: #666;
                }
              }
              
              /* Force everything to print with colors */
              * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
              }
              
              /* Prevent breaks */
              .section, table, h1, h2, h3, h4, img {
                page-break-inside: avoid !important;
              }
              
              /* Additional print-specific break prevention */
              div {
                page-break-inside: auto !important;
              }
              
              /* Ensure no orphans */
              p, li {
                page-break-inside: avoid !important;
              }
            }
          </style>
        </head>
        <body>
          ${html}
        </body>
        </html>
      `;
      
      printWindow.document.write(printHTML);
      printWindow.document.close();
      
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 1000);
      };
      
    }, 1000);
    
  } catch (error) {
    console.error('Error printing quotation:', error);
    showAlert("Failed to print. Please try again.", "Error");
  }
}
  
  const clientData = JSON.parse(localStorage.getItem("savedClientData_international")) || {};
  const agentData = getCurrentAgent();
  
  if (!currentQuotationId) {
    currentQuotationId = 'INT-' + Date.now().toString().slice(-6);
  }
  
  let totalCostPKR = 0;
  let totalServicePKR = 0;
  let addonCostPKR = 0;
  let addonServicePKR = 0;
  
  // Calculate totals from the summary table
  document.querySelectorAll("#calcSummaryBody tr").forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length >= 9) {
      const costBase = parseFloat(cells[5].textContent.replace(/,/g, ''));
      const svcBase = parseFloat(cells[6].textContent.replace(/,/g, ''));
      const section = cells[0].textContent;
      
      if (section.includes("Add-on")) {
        addonCostPKR += costBase;
        addonServicePKR += svcBase;
      } else {
        totalCostPKR += costBase;
        totalServicePKR += svcBase;
      }
    }
  });
  
  const finalTotalSellPKR = totalCostPKR + totalServicePKR;
  const grandTotalPKR = finalTotalSellPKR + addonCostPKR + addonServicePKR;

  // Calculate per person costs
  const paxData = getCurrentPaxData();
  const numAdult = paxData.adults || 0;
  const numChildBed = paxData.childBed || 0;
  const numChildNoBed = paxData.childNoBed || 0;
  const numInfant = paxData.infants || 0;
  const totalPax = numAdult + numChildBed + numChildNoBed + numInfant;
  
  // Calculate per person costs using the same logic as package calculation
  const perPersonCosts = calculatePerPersonCosts(totalCostPKR, totalServicePKR, paxData);
  const perAdultCost = perPersonCosts.perAdult;
  const perChildBedCost = perPersonCosts.perChildBed;
  const perChildNoBedCost = perPersonCosts.perChildNoBed;
  const perInfantCost = perPersonCosts.perInfant;

  // Build the HTML for the quotation preview
  let quotationHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="https://flightconnection.net.pk/wp-content/uploads/2018/09/cropped-cropped-Flight-Connection-Travel-1.png" alt="Company Logo" style="max-height: 80px;">
      <h2 style="margin: 5px 0; color: #0b76d1;">Flight Connection Travel & Tours</h2>
      <div style="font-size: 18px; font-weight: bold; color: #333; margin-top: 10px;">
        International Tour Quotation Number: <span style="color: #0b76d1;">${currentQuotationId}</span>
      </div>
      <div style="font-size: 14px; color: #666; margin-top: 5px;">
      </div>
    </div>
    
    <div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #0b76d1;">Client Information</h3>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <div><strong>Client Name:</strong> ${sanitizeInput(clientData.name || 'N/A')}</div>
        <div><strong>Phone:</strong> ${sanitizeInput(clientData.phone || 'N/A')}</div>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <div><strong>Reference:</strong> ${sanitizeInput(clientData.reference || 'N/A')}</div>
        <div><strong>Quotation Date:</strong> ${new Date().toLocaleDateString()}</div>
      </div>
    </div>
    
    <div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #0b76d1;">Travel Information</h3>
      <div style="margin-bottom: 8px;"><strong>Travel Dates:</strong> ${formatDateToDMY(clientData.dateFrom)} to ${formatDateToDMY(clientData.dateTo)}</div>
      <div style="margin-bottom: 8px;"><strong>Package Duration:</strong> ${clientData.dateFrom && clientData.dateTo ? `${Math.round((new Date(clientData.dateTo) - new Date(clientData.dateFrom)) / (1000 * 60 * 60 * 24))} Nights / ${Math.round((new Date(clientData.dateTo) - new Date(clientData.dateFrom)) / (1000 * 60 * 60 * 24)) + 1} Days` : '-'}</div>
      <div style="margin-bottom: 8px;"><strong>Departure City:</strong> ${sanitizeInput(clientData.depCity || 'N/A')}</div>
      <div style="margin-bottom: 8px;"><strong>Destination:</strong> ${sanitizeInput(clientData.tourDestination || 'N/A')}</div>
      <div><strong>Passengers:</strong> Adults: ${clientData.adults || 0}, Children (with bed): ${clientData.childBed || 0}, Children (without bed): ${clientData.childNoBed || 0}, Infants: ${clientData.infants || 0}</div>
    </div>
    
    <div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #0b76d1;">Package Price</h3>
      <table style="width:100%; border-collapse: collapse;">
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Per Adult</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(perAdultCost)}</td>
        </tr>
        ${numChildBed > 0 ? `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Per Child (with bed)</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(perChildBedCost)}</td>
        </tr>` : ''}
        ${numChildNoBed > 0 ? `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Per Child (without bed)</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(perChildNoBedCost)}</td>
        </tr>` : ''}
        ${numInfant > 0 ? `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Per Infant</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(perInfantCost)}</td>
        </tr>` : ''}
        <tr style="background-color: #f9f9f9;">
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Total Package Amount</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>PKR ${fmt(finalTotalSellPKR)}</strong></td>
        </tr>
      </table>
    </div>
        
    <!-- Service Details -->
<div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
  <h3 style="margin-top: 0; color: #0b76d1;">Service Details</h3>
  
  <!-- Flight Details - Only show if flights are included -->
  ${document.querySelectorAll("[id^='flightBlock_']").length > 0 ? `
  <div style="margin-bottom: 15px;">
    <h4 style="color: #0b76d1; margin-bottom: 8px;">Flight</h4>
    <table style="width:100%; border-collapse: collapse;">
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 150px;">Airline</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getFlightDetails().airline}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Flight Type</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getFlightDetails().direct}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; vertical-align: top;">Flight Itinerary</td>
        <td style="border: 1px solid #ddd; padding: 8px; white-space: pre-wrap; font-family: monospace; font-size: 13px;">${getFlightDetails().itinerary}</td>
      </tr>
    </table>
  </div>` : ''}
  
  <!-- Hotel Details - Only show if hotels are included -->
  ${document.querySelectorAll("[id^='hotelBlock_']").length > 0 ? 
    getHotelDetails().map((hotel, index) => `
    <div style="margin-bottom: 15px;">
      <h4 style="color: #0b76d1; margin-bottom: 8px;">${hotel.city} Hotel</h4>
      <table style="width:100%; border-collapse: collapse;">
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 150px;">Hotel Name</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${hotel.name}</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Check-in</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDMY(hotel.checkIn)}</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Check-out</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDMY(hotel.checkOut)}</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Total Nights</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${hotel.nights}</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Room Type</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${hotel.roomType}</td>
        </tr>
        ${hotel.roomName ? `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Room Name</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${hotel.roomName}</td>
        </tr>` : ''}
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Service Type</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${hotel.serviceType}</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Number of Rooms</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${hotel.rooms}</td>
        </tr>
      </table>
    </div>
    `).join('') : ''}
  
  <!-- Visa Details - Only show if visa is included -->
  ${document.getElementById('visaBlock') ? `
  <div style="margin-bottom: 15px;">
    <h4 style="color: #0b76d1; margin-bottom: 8px;">Visa</h4>
    <table style="width:100%; border-collapse: collapse;">
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 150px;">Visa Type</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getVisaDetails().type}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Country</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getVisaDetails().country}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Number of Visas</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getVisaDetails().count}</td>
      </tr>
    </table>
  </div>` : ''}
  
  <!-- Transfer Details - Only show if transfers are included -->
  ${document.querySelectorAll("[id^='transferBlock_']").length > 0 ? `
  <div style="margin-bottom: 15px;">
    <h4 style="color: #0b76d1; margin-bottom: 8px;">Transfer</h4>
    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; text-align: left; font-family: Arial, Helvetica, sans-serif; font-size: 13px; line-height: 1.6;">
      ${getTransferDetails()}
    </div>
  </div>` : ''}
  
  <!-- Tours & Activities Details - Only show if main tours are included -->
  ${document.querySelectorAll("[id^='tourBlock_']").length > 0 ? `
  <div style="margin-bottom: 20px;">
    <h4 style="color: #0b76d1; margin-bottom: 15px;">Tours & Activities</h4>
    
    <!-- Main Tours -->
    ${document.querySelectorAll("[id^='tourBlock_']").length > 0 ? 
      getTourDetails().map((tour, index) => `
      <div style="margin-bottom: 15px; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
        <h5 style="color: #0b76d1; margin-bottom: 8px; margin-top: 0;">${tour.city} Tour</h5>
        <table style="width:100%; border-collapse: collapse;">
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 150px;">Tour Name</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${tour.name}</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Tour Date</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDMY(tour.date)}</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Duration</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${tour.duration}</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Mode</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${tour.mode}</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Vehicle Type</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${tour.vehicle}</td>
          </tr>
        </table>
      </div>
      `).join('') : ''}
  </div>` : ''}
</div>
  
  <button onclick="toggleCalculationSummary()" style="margin-bottom: 10px; padding: 5px 10px; background: #0b76d1; color: white; border: none; border-radius: 4px; cursor: pointer;">Show/Hide Calculation Summary</button>
  <div id="calculationSummarySection" style="margin-bottom: 20px;">
    <h3 style="color: #0b76d1; text-align: center; margin-bottom: 15px; font-size: 18px;">Package Price</h3>
    <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
      <thead>
        <tr style="background: linear-gradient(to right, #0b76d1, #0a6bbd); color: white;">
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Service</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Details</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Adult</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Child (with bed)</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Child (no bed)</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Infant</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Total Price</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  // Add flight details
  document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const airline = document.getElementById(`airline_${idx}`)?.value || "Not specified";
    const currency = document.getElementById(`flightCurrency_${idx}`)?.value || "USD";
    
    const costAdult = parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0);
    const costChildBed = parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0);
    const costChildNoBed = parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0);
    const costInf = parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0);
    
    const svcAdult = parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0);
    const svcChildBed = parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0);
    const svcChildNoBed = parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0);
    const svcInf = parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0);
    
    // Calculate per person costs
    const perAdultCost = convertToPKR(costAdult + svcAdult, currency);
    const perChildBedCost = convertToPKR(costChildBed + svcChildBed, currency);
    const perChildNoBedCost = convertToPKR(costChildNoBed + svcChildNoBed, currency);
    const perInfantCost = convertToPKR(costInf + svcInf, currency);
    
    // Calculate total costs
    const totalAdult = perAdultCost * numAdult;
    const totalChildBed = perChildBedCost * numChildBed;
    const totalChildNoBed = perChildNoBedCost * numChildNoBed;
    const totalInf = perInfantCost * numInfant;
    const totalFlight = totalAdult + totalChildBed + totalChildNoBed + totalInf;
    
    quotationHTML += `
  <tr style="background-color: #f8f9fa;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">✈️ Flight ${idx}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${sanitizeInput(airline)}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numAdult > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${numAdult}</div><div style="font-weight: 600;">PKR ${fmt(perAdultCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${numChildBed}</div><div style="font-weight: 600;">PKR ${fmt(perChildBedCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${numChildNoBed}</div><div style="font-weight: 600;">PKR ${fmt(perChildNoBedCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numInfant > 0 ? `<div style="font-size: 12px; color: #666;">Infant x${numInfant}</div><div style="font-weight: 600;">PKR ${fmt(perInfantCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalFlight)}</td>
  </tr>
`;
  });
  
  // Add hotel details
  document.querySelectorAll("[id^='hotelBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`hotelName_${idx}`)?.value || "Not specified";
    const city = document.getElementById(`hotelCity_${idx}`)?.value || "Not specified";
    const nights = parseFloat(document.getElementById(`hotelNights_${idx}`)?.value || 0);
    const roomType = document.getElementById(`hotelRoomType_${idx}`)?.value || "Not specified";
    const rooms = parseFloat(document.getElementById(`hotelRooms_${idx}`)?.value || 0);
    const serviceType = document.getElementById(`hotelService_${idx}`)?.value || "Not specified";
    const costNight = parseFloat(document.getElementById(`hotelCostNight_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hotelSvcNight_${idx}`)?.value || 0);
    const currency = document.getElementById(`hotelCurrency_${idx}`)?.value || "USD";
    
    // Only Adults and Children with bed pay for hotels
    const payingPax = numAdult + numChildBed;
    const totalHotel = convertToPKR((costNight + svcNight) * nights * rooms, currency);
    
    // Calculate per person cost by dividing by total paying passengers
    const perPersonCost = payingPax > 0 ? totalHotel / payingPax : 0;
    
    const costPerAdult = numAdult > 0 ? perPersonCost : 0;
    const costPerChildBed = numChildBed > 0 ? perPersonCost : 0;
    const costPerChildNoBed = 0; // Children without bed don't pay for hotels
    const costPerInfant = 0; // Infants don't pay for hotels
    
    quotationHTML += `
  <tr style="background-color: #fff;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🏨 ${city} Hotel ${idx}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
      <div style="font-weight: 500;">${sanitizeInput(name)}</div>
      <div style="font-size: 12px; color: #666;">${sanitizeInput(roomType)} × ${rooms} rooms | ${nights} nights | ${sanitizeInput(serviceType)}</div>
    </td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numAdult > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${numAdult}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${numChildBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalHotel)}</td>
  </tr>
`;
  });
  
  // Add transfer details
  document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const from = document.getElementById(`tFrom_${idx}`)?.value || "Not specified";
    const to = document.getElementById(`tTo_${idx}`)?.value || "Not specified";
    const direction = document.getElementById(`tDirection_${idx}`)?.value || "One Way";
    const cost = parseFloat(document.getElementById(`tCost_${idx}`)?.value || 0);
    const svc = parseFloat(document.getElementById(`tSvc_${idx}`)?.value || 0);
    const currency = document.getElementById(`tCurrency_${idx}`)?.value || "USD";
    
    // Adults, Children with bed, and Children without bed pay for transfers
    const payingPax = numAdult + numChildBed + numChildNoBed;
    const totalTransfer = convertToPKR(cost + svc, currency);
    
    // Calculate per person costs
    const costPerAdult = numAdult > 0 ? totalTransfer / payingPax : 0;
    const costPerChildBed = numChildBed > 0 ? totalTransfer / payingPax : 0;
    const costPerChildNoBed = numChildNoBed > 0 ? totalTransfer / payingPax : 0;
    const costPerInfant = 0; // Infants don't pay for transfers
    
    quotationHTML += `
  <tr style="background-color: #fff;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🚗 Transfer ${idx}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
      <div style="font-weight: 500;">${sanitizeInput(from)} → ${sanitizeInput(to)}</div>
      <div style="font-size: 12px; color: #666;">${direction}</div>
    </td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numAdult > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${numAdult}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${numChildBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${numChildNoBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildNoBed)}` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalTransfer)}</td>
  </tr>
`;
  });
  
 // Add visa details
const visaType = document.getElementById("visaType")?.value || "Not specified";
const visaCountry = document.getElementById("visaCountry")?.value || "Not specified";
const visaCount = parseFloat(document.getElementById("visaCount")?.value || 0);
const visaCost = parseFloat(document.getElementById("visaCost")?.value || 0);
const visaSvc = parseFloat(document.getElementById("visaSvc")?.value || 0);
const visaCurrency = document.getElementById("visaCurrency")?.value || "USD";

if (visaCost > 0 || visaSvc > 0) {
  // All passenger types pay for visa
  const costPerVisa = convertToPKR(visaCost + visaSvc, visaCurrency);
  const totalVisa = costPerVisa * visaCount;
  
  const costPerAdult = numAdult > 0 ? costPerVisa : 0;
  const costPerChildBed = numChildBed > 0 ? costPerVisa : 0;
  const costPerChildNoBed = numChildNoBed > 0 ? costPerVisa : 0;
  const costPerInfant = numInfant > 0 ? costPerVisa : 0;
  
quotationHTML += `
  <tr style="background-color: #f8f9fa;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🛂 Visa</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
      <div style="font-weight: 500;">${visaType} (${visaCountry})</div>
      <div style="font-size: 12px; color: #666;">${visaCount} visas</div>
    </td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numAdult > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${numAdult}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${numChildBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${numChildNoBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildNoBed)}` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numInfant > 0 ? `<div style="font-size: 12px; color: #666;">Infant x${numInfant}</div><div style="font-weight: 600;">PKR ${fmt(costPerInfant)}` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalVisa)}</td>
  </tr>
`;
}
  
  // Add tour details
  document.querySelectorAll("[id^='tourBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const tourName = document.getElementById(`tourName_${idx}`)?.value || "Not specified";
    const tourCity = document.getElementById(`tourCity_${idx}`)?.value || "Not specified";
    const tourDate = document.getElementById(`tourDate_${idx}`)?.value || "";
    const tourDuration = document.getElementById(`tourDuration_${idx}`)?.value || "Not specified";
    const tourMode = document.getElementById(`tourMode_${idx}`)?.value || "Not specified";
    const tourVehicle = document.getElementById(`tourVehicle_${idx}`)?.value || "Not specified";
    const currency = document.getElementById(`tourCurrency_${idx}`)?.value || "USD";
    
    const costPerPerson = parseFloat(document.getElementById(`tourCost_${idx}`)?.value || 0);
    const svcPerPerson = parseFloat(document.getElementById(`tourSvc_${idx}`)?.value || 0);
    
    // Calculate per person costs
    const perAdultCost = convertToPKR(costPerPerson + svcPerPerson, currency);
    const perChildBedCost = convertToPKR(costPerPerson + svcPerPerson, currency);
    const perChildNoBedCost = convertToPKR(costPerPerson + svcPerPerson, currency);
    const perInfantCost = convertToPKR(costPerPerson + svcPerPerson, currency); // All passengers pay for tours
    
    // Calculate total costs
    const totalAdult = perAdultCost * numAdult;
    const totalChildBed = perChildBedCost * numChildBed;
    const totalChildNoBed = perChildNoBedCost * numChildNoBed;
    const totalInfant = perInfantCost * numInfant;
    const totalTour = totalAdult + totalChildBed + totalChildNoBed + totalInfant;
    
    quotationHTML += `
  <tr style="background-color: #f0f8ff;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🏛️ Tour ${idx}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
      <div style="font-weight: 500;">${sanitizeInput(tourName)}</div>
      <div style="font-size: 12px; color: #666;">${tourCity} • ${tourDuration} • ${tourMode}</div>
      ${tourDate ? `<div style="font-size: 12px; color: #666;">Date: ${formatDateToDMY(tourDate)}</div>` : ''}
    </td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numAdult > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${numAdult}</div><div style="font-weight: 600;">PKR ${fmt(perAdultCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${numChildBed}</div><div style="font-weight: 600;">PKR ${fmt(perChildBedCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${numChildNoBed}</div><div style="font-weight: 600;">PKR ${fmt(perChildNoBedCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numInfant > 0 ? `<div style="font-size: 12px; color: #666;">Infant x${numInfant}</div><div style="font-weight: 600;">PKR ${fmt(perInfantCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalTour)}</td>
  </tr>
`;
  });
  
  quotationHTML += `
        </tbody>
      </table>
    </div>
  `;
  
 // Add add-ons if any
const hasAddons = document.querySelectorAll("[id^='dfAddon_'], [id^='mealAddon_'], [id^='tourAddon_']").length > 0;

if (hasAddons) {
    quotationHTML += `
      <div style="margin-bottom: 20px; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px; font-size: 18px;">Add-Ons (Optional)</h3>
        <table style="width:100%; border-collapse: collapse; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
          <thead>
            <tr style="background: linear-gradient(to right, #28a745, #218838); color: white;">
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Add-On</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Details</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Adult</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Child (with bed)</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Child (no bed)</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Infant</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Total Price</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    // Direct Flight Add-ons
    document.querySelectorAll("[id^='dfAddon_']").forEach((el, i) => {
      const idx = i + 1;
      const name = "Upgraded Flight";
      const currency = el.querySelector("select")?.value || "USD";
      
      const inputs = el.querySelectorAll("input[type='number']");
      const cost = parseFloat(inputs[0]?.value || 0);
      const svc = parseFloat(inputs[1]?.value || 0);
      
      const totalCost = convertToPKR(cost + svc, currency);
      
      // Calculate per person costs
      const costPerAdult = numAdult > 0 ? totalCost / numAdult : 0;
      const costPerChildBed = numChildBed > 0 ? totalCost / numChildBed : 0;
      const costPerChildNoBed = numChildNoBed > 0 ? totalCost / numChildNoBed : 0;
      const costPerInfant = numInfant > 0 ? totalCost / numInfant : 0;
      
      quotationHTML += `
        <tr style="background-color: #fff;">
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">✈️ ${name} ${idx}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
            <div style="font-weight: 500;">Flight Upgrade</div>
            <div style="font-size: 12px; color: #666;">${currency}</div>
          </td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numAdult > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${numAdult}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${numChildBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${numChildNoBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildNoBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numInfant > 0 ? `<div style="font-size: 12px; color: #666;">Infant x${numInfant}</div><div style="font-weight: 600;">PKR ${fmt(costPerInfant)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #28a745;">PKR ${fmt(totalCost)}</td>
        </tr>
      `;
    });
    
    // Meal Type Add-ons
    document.querySelectorAll("[id^='mealAddon_']").forEach((el, i) => {
      const idx = i + 1;
      const name = "Meal Type";
      const hotelIndex = el.querySelector("select")?.value || 'Not specified';
      const hotelName = document.getElementById(`hotelName_${hotelIndex}`)?.value || 'Not specified';
      const inputs = el.querySelectorAll("input[type='number']");
      const cost = parseFloat(inputs[0]?.value || 0);
      const svc = parseFloat(inputs[1]?.value || 0);
      const currency = el.querySelector("select[id^='mealCurrency']")?.value || "USD";
      
      const totalCost = convertToPKR(cost + svc, currency);
      
      // FIXED: Only Adults and Children with bed pay for meals
      const payingPax = numAdult + numChildBed;
      const perPersonCost = payingPax > 0 ? totalCost / payingPax : 0;
      
      const costPerAdult = numAdult > 0 ? perPersonCost : 0;
      const costPerChildBed = numChildBed > 0 ? perPersonCost : 0;
      const costPerChildNoBed = 0; // Children without bed don't pay for meals
      const costPerInfant = 0; // Infants don't pay for meals
      
      quotationHTML += `
        <tr style="background-color: #f8f9fa;">
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🍽️ ${name} ${idx}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
            <div style="font-weight: 500;">${hotelName} Meal</div>
            <div style="font-size: 12px; color: #666;">${currency}</div>
          </td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numAdult > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${numAdult}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${numChildBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #28a745;">PKR ${fmt(totalCost)}</td>
        </tr>
      `;
    });
    
    // Tour Add-ons
    document.querySelectorAll("[id^='tourAddon_']").forEach((el, i) => {
      const idx = i + 1;
      const name = "Tour";
      const tourName = document.getElementById(`tourAddonName_${idx}`)?.value || 'Not specified';
      const inputs = el.querySelectorAll("input[type='number']");
      
      const costPerPerson = parseFloat(document.getElementById(`tourAddonCost_${idx}`)?.value || 0);
      const svcPerPerson = parseFloat(document.getElementById(`tourAddonSvc_${idx}`)?.value || 0);
      
      const currency = document.getElementById(`tourAddonCurrency_${idx}`)?.value || "USD";
      
      const totalAdultCost = convertToPKR((costPerPerson + svcPerPerson) * numAdult, currency);
      const totalChildBedCost = convertToPKR((costPerPerson + svcPerPerson) * numChildBed, currency);
      const totalChildNoBedCost = convertToPKR((costPerPerson + svcPerPerson) * numChildNoBed, currency);
      const totalInfantCost = convertToPKR((costPerPerson + svcPerPerson) * numInfant, currency);
      
      const totalCost = totalAdultCost + totalChildBedCost + totalChildNoBedCost + totalInfantCost;
      
      // Calculate per person costs
      const costPerAdult = numAdult > 0 ? totalAdultCost / numAdult : 0;
      const costPerChildBed = numChildBed > 0 ? totalChildBedCost / numChildBed : 0;
      const costPerChildNoBed = numChildNoBed > 0 ? totalChildNoBedCost / numChildNoBed : 0;
      const costPerInfant = numInfant > 0 ? totalInfantCost / numInfant : 0;
      
      quotationHTML += `
        <tr style="background-color: #fff;">
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🏛️ ${name} ${idx}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
            <div style="font-weight: 500;">${tourName}</div>
            <div style="font-size: 12px; color: #666;">${currency}</div>
          </td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numAdult > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${numAdult}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${numChildBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numChildNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${numChildNoBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildNoBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${numInfant > 0 ? `<div style="font-size: 12px; color: #666;">Infant x${numInfant}</div><div style="font-weight: 600;">PKR ${fmt(costPerInfant)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #28a745;">PKR ${fmt(totalCost)}</td>
        </tr>
      `;
    });
    
    quotationHTML += `
          </tbody>
        </table>
        
<!-- Add-ons Summary -->
<div style="background-color: #e8f5e9; border-radius: 8px; padding: 15px; margin-top: 15px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
  <div style="font-weight: 600; color: #2e7d32;">Package Total:</div>
  <div style="font-weight: 600; color: #2e7d32;">PKR ${fmt(finalTotalSellPKR)}</div>
</div>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <div style="font-weight: 600; color: #2e7d32;">Add-ons Subtotal:</div>
    <div style="font-weight: 600; color: #2e7d32;">PKR ${fmt(addonCostPKR + addonServicePKR)}</div>
  </div>
  <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #c8e6c9;">
    <div style="font-size: 16px; font-weight: bold; color: #2e7d32;">Grand Total (Package + Add-ons):</div>
    <div style="font-size: 16px; font-weight: bold; color: #2e7d32;">PKR ${fmt(finalTotalSellPKR + addonCostPKR + addonServicePKR)}</div>
  </div>
</div>
    `;
  }

// Add inclusions section
quotationHTML += `
  <div style="margin-bottom: 20px; border: 1px solid #f5e6e6; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px;">Inclusions</h3>
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
      <ul style="padding-left: 20px; margin: 0; text-align: left;">
`;

// Build inclusions list
let inclusionsList = [];

// Check for flights
const flightElements = document.querySelectorAll("[id^='flightBlock_']");
if (flightElements && flightElements.length > 0) {
  flightElements.forEach((el) => {
    if (el && el.id) {
      const idx = el.id.split("_")[1];
      const airline = document.getElementById(`airline_${idx}`)?.value || "Airline";
      inclusionsList.push(`${sanitizeInput(airline)} flight tickets`);
    }
  });
}

// Check for hotels
const hotelElements = document.querySelectorAll("[id^='hotelBlock_']");
if (hotelElements && hotelElements.length > 0) {
  hotelElements.forEach((el) => {
    if (el && el.id) {
      const idx = el.id.split("_")[1];
      const hotelName = document.getElementById(`hotelName_${idx}`)?.value || "Hotel";
      const city = document.getElementById(`hotelCity_${idx}`)?.value || "City";
      const nights = document.getElementById(`hotelNights_${idx}`)?.value || 0;
      const serviceType = document.getElementById(`hotelService_${idx}`)?.value || "Room Only";
      const roomType = document.getElementById(`hotelRoomType_${idx}`)?.value || "Room Type";
      const rooms = document.getElementById(`hotelRooms_${idx}`)?.value || 0;
      
      inclusionsList.push(`${nights} nights, ${rooms} ${roomType} ${serviceType.toLowerCase()} Accommodation in ${sanitizeInput(hotelName)}, ${sanitizeInput(city)}`);
      if (serviceType === "With Breakfast") {
        inclusionsList.push(`Breakfast in ${sanitizeInput(hotelName)}`);
      }
    }
  });
}

// Check for visa
if (document.getElementById('visaBlock')) {
  const visaType = document.getElementById('visaType')?.value || "Visa";
  const visaCountry = document.getElementById('visaCountry')?.value || "Country";
  const visaCount = document.getElementById('visaCount')?.value || 0;
  inclusionsList.push(`${visaCount} x ${visaType} for ${visaCountry}`);
}

// Check for transfers
const transferElements = document.querySelectorAll("[id^='transferBlock_']");
if (transferElements && transferElements.length > 0) {
  transferElements.forEach((el) => {
    if (el && el.id) {
      const idx = el.id.split("_")[1];
      const from = document.getElementById(`tFrom_${idx}`)?.value || "Location";
      const to = document.getElementById(`tTo_${idx}`)?.value || "Location";
      const direction = document.getElementById(`tDirection_${idx}`)?.value || "One Way";
      const vehicle = document.getElementById(`tCar_${idx}`)?.value || "Not specified";
      const serviceType = document.getElementById(`tType_${idx}`)?.value || "Not specified";
      const date = document.getElementById(`tDate_${idx}`)?.value || "";
      const returnDate = document.getElementById(`tReturnDate_${idx}`)?.value || "";
      
      if (direction === "Return" && returnDate) {
        // Create two entries for return transfer
        const formattedDate = date ? formatDateToDMY(date) : "Date not specified";
        const formattedReturnDate = formatDateToDMY(returnDate);
        
        inclusionsList.push(`Outbound transfer (${formattedDate}) from ${sanitizeInput(from)} to ${sanitizeInput(to)} (${vehicle}, ${serviceType})`);
        inclusionsList.push(`Return transfer (${formattedReturnDate}) from ${sanitizeInput(to)} to ${sanitizeInput(from)} (${vehicle}, ${serviceType})`);
      } else {
        // One way transfer
        const formattedDate = date ? formatDateToDMY(date) : "Date not specified";
        inclusionsList.push(`${direction} transfer (${formattedDate}) from ${sanitizeInput(from)} to ${sanitizeInput(to)} (${vehicle}, ${serviceType})`);
      }
    }
  });
}

// Check for tours
const tourElements = document.querySelectorAll("[id^='tourBlock_']");
if (tourElements && tourElements.length > 0) {
  tourElements.forEach((el) => {
    if (el && el.id) {
      const idx = el.id.split("_")[1];
      const tourName = document.getElementById(`tourName_${idx}`)?.value || "Tour";
      const tourCity = document.getElementById(`tourCity_${idx}`)?.value || "City";
      const tourDuration = document.getElementById(`tourDuration_${idx}`)?.value || "Not specified";
      const tourMode = document.getElementById(`tourMode_${idx}`)?.value || "Not specified";
      
      inclusionsList.push(`${sanitizeInput(tourName)} (${tourDuration}, ${tourMode}) in ${sanitizeInput(tourCity)}`);
    }
  });
}

// Add general inclusions
inclusionsList.push("Professional guidance throughout the journey");
inclusionsList.push("All taxes and service charges (as specified)");

// Add all inclusions to HTML
inclusionsList.forEach(inclusion => {
  quotationHTML += `<li>${inclusion}</li>`;
});

quotationHTML += `
      </ul>
    </div>
  </div>
`;

// Add exclusions section
quotationHTML += `
<div style="margin-bottom: 20px; border: 1px solid #f5e6e6; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px;">Exclusions</h3>
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
      <ul style="padding-left: 20px; margin: 0; text-align: left;">
`;

// Check for flight exclusion
const hasFlights = document.querySelectorAll("[id^='flightBlock_']").length > 0;
if (!hasFlights) {
  quotationHTML += `<li>Flight tickets are not included in this package</li>`;
}

// Check for hotel exclusions
const hasHotels = document.querySelectorAll("[id^='hotelBlock_']").length > 0;

if (hasHotels) {
  document.querySelectorAll("[id^='hotelBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const serviceType = document.getElementById(`hotelService_${idx}`)?.value || "Room Only";
    if (serviceType === "Room Only") {
      const hotelName = document.getElementById(`hotelName_${idx}`)?.value || "Hotel";
      quotationHTML += `<li>Meals in ${sanitizeInput(hotelName)}</li>`;
    }
  });
}

// Check for visa exclusion
const hasVisa = document.getElementById('visaBlock');
if (!hasVisa) {
  quotationHTML += `<li>Visa is not included in this package</li>`;
}

// Check for transfer exclusion
const hasTransfers = document.querySelectorAll("[id^='transferBlock_']").length > 0;
if (!hasTransfers) {
  quotationHTML += `<li>Airport transfers are not included in this package</li>`;
}

// Add general exclusions
quotationHTML += `
        <li>Any personal expenses such as laundry, telephone calls, etc.</li>
        <li>Meals not mentioned in the package.</li>
        <li>Early check-in or late check-out at hotels.</li>
        <li>Any services not mentioned in the inclusions</li>
        <li>Tips and porterage</li>
        <li>Travel insurance</li>
      </ul>
    </div>
  </div>
`;

// Get stored content
const section1Content = localStorage.getItem('section1Content_international') || '';
const section2Content = localStorage.getItem('section2Content_international') || '';

// Add Section 1
quotationHTML += `
  <div style="margin-bottom: 20px; border: 1px solid #e3f2fd; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
      ${section1Content}
    </div>
  </div>
  
  <!-- Add Section 2 -->
  <div style="margin-bottom: 20px; border: 1px solid #e3f2fd; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
      ${section2Content}
    </div>
  </div>
`;

// Add terms and conditions
quotationHTML += `
   <div style="margin-bottom: 20px; border: 1px solid #e3f2fd; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
    ${customTerms}
  </div>
  </div>

  <!-- Add your image right after Terms and Conditions -->
<div style="text-align: center; margin-bottom: 30px;">
  <img src="https://flightconnection.net.pk/wp-content/uploads/2020/08/flight-connection.jpeg" 
       alt="Flight Connection Travel & Tours" 
       style="max-width: 800px; width: 100%; height: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
</div>

  <div style="text-align: center; margin-top: 30px; color: #666; font-size: 16px;">
    <p>For any queries, please contact us</p>
    <p style="margin-bottom: 5px;">Prepared by: <strong>${sanitizeInput(agentData?.name || 'N/A')}</strong></p>
    <p style="margin-bottom: 5px;">Phone: <strong>${sanitizeInput(agentData?.phone || 'N/A')}</strong></p>
    <p>Mezzanine Floor, 17-E, Shahbaz Commercial, Phase 6. DHA</p>
  </div>

  `;
  
  // Set modal content
  modalTitle.textContent = "Quotation Preview";
  modalContent.innerHTML = quotationHTML;
  
// Add buttons
modalButtons.innerHTML = `
  <button id="editContentBtn" class="ghost">📝 Edit Content</button>
  <button id="printQuotationBtn" class="green-btn" style="margin-right: 10px;">🖨️ Print Quotation</button>
  <button id="shareWhatsAppBtn" class="whatsapp-btn">📱 Share on WhatsApp</button>
  <button id="closeQuotationBtn" class="ghost">Close</button>
`;

// Add event listeners after modal is shown
setTimeout(() => {
// Edit Content button
document.getElementById('editContentBtn').onclick = function() {
  document.getElementById('quotationModal').classList.remove('visible');
  setTimeout(() => {
    showContentEditor();
  }, 300);
};

  // Print Quotation button
  document.getElementById('printQuotationBtn').onclick = function() {
    printQuotation();
  };

  // Share WhatsApp button
  document.getElementById('shareWhatsAppBtn').onclick = function() {
    shareOnWhatsApp();
  };

  // Close button
  document.getElementById('closeQuotationBtn').onclick = function() {
    modal.classList.remove('visible');
  };
}, 100);

  // Show modal
  modal.classList.add('visible');
}

function toggleCalculationSummary() {
  const div = document.getElementById('calculationSummarySection');
  if (div.style.display === 'none') {
    div.style.display = 'block';
  } else {
    div.style.display = 'none';
  }
}

function shareOnWhatsApp() {
  try {
    const clientData = getClientData();
    const agentData = getCurrentAgent();
    const clientPhone = clientData.phone || '';
    
    if (!clientPhone) {
      showAlert("Client phone number is required for WhatsApp sharing.");
      return;
    }
    
    // Create a simple text message
    const message = `Dear ${sanitizeInput(clientData.name)},

Your Umrah package quotation is ready. Please find the details in the attached PDF.

Best regards,
 ${sanitizeInput(agentData?.name || 'Agent')}
 ${sanitizeInput(agentData?.phone || '')}
Flight Connection Travel & Tours
Email: muhammad.atif@flightconnection.net.pk
Website: www.flightconnection.net.pk`;

    // Clean phone number
    const cleanPhone = clientPhone.replace(/\D/g, '');
    
    // WhatsApp URL with pre-filled message
    const whatsappUrl = `https://wa.me/92${cleanPhone.replace(/^0+/, '')}?text=${encodeURIComponent(message)}`;
    
    // Open WhatsApp in a new window
    window.open(whatsappUrl, '_blank');
    
    showNotification("WhatsApp opened with quotation details!", "success");
  } catch (error) {
    console.error('Error sharing on WhatsApp:', error);
    showAlert("Failed to share on WhatsApp. Please try again.", "Error");
  }
}


// Helper functions for getting service details
function getFlightDetails() {
  const firstFlight = document.querySelector("[id^='flightBlock_']");
  if (!firstFlight) return { airline: "Not specified", direct: "Not specified", itinerary: "Not specified" };
  
  const idx = firstFlight.id.split("_")[1];
  const airline = document.getElementById(`airline_${idx}`)?.value || "Not specified";
  const direct = document.getElementById(`flightDirect_${idx}`)?.value || "Not specified"; // Add this line
  const itinerary = document.getElementById(`flightItinerary_${idx}`)?.value || "Not specified";
  
  return { airline, direct, itinerary };
}

function getHotelDetails() {
  const hotels = [];
  document.querySelectorAll("[id^='hotelBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`hotelName_${idx}`)?.value || "Not specified";
    const city = document.getElementById(`hotelCity_${idx}`)?.value || "Not specified";
    const nights = parseFloat(document.getElementById(`hotelNights_${idx}`)?.value || 0);
    const roomType = document.getElementById(`hotelRoomType_${idx}`)?.value || "Not specified";
    const roomName = document.getElementById(`hotelRoomName_${idx}`)?.value || "";
    const rooms = parseFloat(document.getElementById(`hotelRooms_${idx}`)?.value || 0);
    const serviceType = document.getElementById(`hotelService_${idx}`)?.value || "Room Only";
    const checkIn = document.getElementById(`hotelCheckIn_${idx}`)?.value || new Date().toISOString().split('T')[0];
    const checkOut = document.getElementById(`hotelCheckOut_${idx}`)?.value || new Date().toISOString().split('T')[0];
    
    hotels.push({
      name, city, nights, roomType, roomName, rooms, serviceType, checkIn, checkOut
    });
  });
  
  return hotels;
}

function getVisaDetails() {
  if (!document.getElementById('visaBlock')) {
    return { type: "Not specified", country: "Not specified", count: 0 };
  }
  
  const type = document.getElementById('visaType')?.value || "Not specified";
  const country = document.getElementById('visaCountry')?.value || "Not specified";
  const count = parseFloat(document.getElementById('visaCount')?.value || 0);
  
  return { type, country, count };
}

function getTransferDetails() {
  let transferHTML = "";
  document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const from = document.getElementById(`tFrom_${idx}`)?.value || "Not specified";
    const to = document.getElementById(`tTo_${idx}`)?.value || "Not specified";
    const direction = document.getElementById(`tDirection_${idx}`)?.value || "One Way";
    const vehicle = document.getElementById(`tCar_${idx}`)?.value || "Not specified";
    const serviceType = document.getElementById(`tType_${idx}`)?.value || "Not specified";
    const date = document.getElementById(`tDate_${idx}`)?.value || "";
    const returnDate = document.getElementById(`tReturnDate_${idx}`)?.value || "";
    
    if (direction === "Return" && returnDate) {
      // Create two entries for return transfer
      const formattedDate = date ? formatDateToDMY(date) : "Date not specified";
      const formattedReturnDate = formatDateToDMY(returnDate);
      
      transferHTML += `<div><strong>Outbound Transfer (${formattedDate}):</strong> ${sanitizeInput(from)} → ${sanitizeInput(to)} (${vehicle}, ${serviceType})</div>`;
      transferHTML += `<div><strong>Return Transfer (${formattedReturnDate}):</strong> ${sanitizeInput(to)} → ${sanitizeInput(from)} (${vehicle}, ${serviceType})</div>`;
    } else {
      // One way transfer
      const formattedDate = date ? formatDateToDMY(date) : "Date not specified";
      transferHTML += `<div><strong>${direction} Transfer (${formattedDate}):</strong> ${sanitizeInput(from)} → ${sanitizeInput(to)} (${vehicle}, ${serviceType})</div>`;
    }
  });
  
  return transferHTML || "No transfers included";
}

function getTourDetails() {
  const tours = [];
  document.querySelectorAll("[id^='tourBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`tourName_${idx}`)?.value || "Not specified";
    const city = document.getElementById(`tourCity_${idx}`)?.value || "Not specified";
    const date = document.getElementById(`tourDate_${idx}`)?.value || "";
    const duration = document.getElementById(`tourDuration_${idx}`)?.value || "Not specified";
    const mode = document.getElementById(`tourMode_${idx}`)?.value || "Not specified";
    const vehicle = document.getElementById(`tourVehicle_${idx}`)?.value || "Not specified";
    
    tours.push({
      name, city, date, duration, mode, vehicle
    });
  });
  
  return tours;
}


// Add event listener for the Generate Quotation button
btnGenerateQuotation.addEventListener('click', () => {
  if (!isClientDataSaved) {
    showAlert("Please save the Client & Pax data before generating a quotation.");
    return;
  }
  
  // Check if calculation has been performed
  if (calcSummarySection.style.display === 'none') {
    showAlert("Please calculate the package before generating a quotation.");
    return;
  }
  
  showQuotationModal();
});

// Export to Excel functionality
btnExportExcel.addEventListener('click', () => {
  try {
    // Create a new workbook
    const wb = XLSX.utils.book_new();
    
    // Get the calculation table
    const table = document.getElementById('calcSummaryTable');
    const ws = XLSX.utils.table_to_sheet(table);
    
    // Add the worksheet to the workbook
    XLSX.utils.book_append_sheet(wb, ws, "Package Calculation");
    
    // Get client data
    const clientData = JSON.parse(localStorage.getItem("savedClientData_international")) || {};
    
    // Create a client info worksheet
    const clientDataArray = [
      ["Client Information", ""],
      ["Client Name", clientData.name || ""],
      ["Reference", clientData.reference || ""],
      ["Phone", clientData.phone || ""],
      ["Departure City", clientData.depCity || ""],
      ["Travel Dates", `${formatDateToDMY(clientData.dateFrom)} - ${formatDateToDMY(clientData.dateTo)}`],
      ["Destination", clientData.tourDestination || ""],
      ["Adults", clientData.adults || 0],
      ["Children (with bed)", clientData.childBed || 0],
      ["Children (no bed)", clientData.childNoBed || 0],
      ["Infants", clientData.infants || 0]
    ];
    
    const wsClient = XLSX.utils.aoa_to_sheet(clientDataArray);
    XLSX.utils.book_append_sheet(wb, wsClient, "Client Information");
    
    // Get agent data
    const agentData = getCurrentAgent();
    if (agentData) {
      const agentDataArray = [
        ["Agent Information", ""],
        ["Agent Name", agentData.name],
        ["Agent ID", agentData.id],
        ["Phone", agentData.phone]
      ];
      
      const wsAgent = XLSX.utils.aoa_to_sheet(agentDataArray);
      XLSX.utils.book_append_sheet(wb, wsAgent, "Agent Information");
    }
    
    // Generate a filename with date and quotation ID
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const filename = `Quotation_${currentQuotationId || 'INT'}_${date}.xlsx`;
    
    // Save the file
    XLSX.writeFile(wb, filename);
    
    showNotification("Excel file exported successfully!", "success");
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    showAlert("Failed to export to Excel. Please try again.", "Error");
  }
});

// Function to save the current quotation
function saveQuotation() {
  try {
    // Check if client data is saved
    if (!isClientDataSaved) {
      showNotification("Please save Client & Pax information first before saving the quotation.", "error");
      return;
    }
    
    // Check if calculation has been performed
    if (calcSummarySection.style.display === 'none') {
      showNotification("Please calculate the package before saving the quotation.", "error");
      return;
    }
    
    // Check if there's at least one service added
    const hasFlights = document.querySelectorAll("[id^='flightBlock_']").length > 0;
    const hasHotels = document.querySelectorAll("[id^='hotelBlock_']").length > 0;
    const hasTransfers = document.querySelectorAll("[id^='transferBlock_']").length > 0;
    const hasVisa = document.getElementById('visaBlock') !== null;
    const hasDirectFlights = document.querySelectorAll("[id^='dfAddon_']").length > 0;
    const hasMeals = document.querySelectorAll("[id^='mealAddon_']").length > 0;
    const hasTours = document.querySelectorAll("[id^='tourAddon_']").length > 0;
    
    // Check if any service is added
    if (!hasFlights && !hasHotels && !hasTransfers && !hasVisa && 
        !hasDirectFlights && !hasMeals && !hasTours) {
      showNotification("Please add at least one service (Flight, Hotel, Transfer, Visa, or Add-on) before saving the quotation.", "error");
      return;
    }
    
    // Get basic client information
    const clientName = document.getElementById("clientName")?.value || "No Name";
    const clientPhone = document.getElementById("clientPhone")?.value || "No Phone";
    const dateFrom = document.getElementById("dateFrom")?.value || "No Date";
    const dateTo = document.getElementById("dateTo")?.value || "No Date";
    
    // Get current agent
    const agent = getCurrentAgent();
    if (!agent) {
      showNotification("Please login to save quotations.", "error");
      return;
    }
    
    // Calculate expiry date (7 days from creation)
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 30);
    
    // Collect flight data
    const flightsData = [];
    document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const flightData = {
        itinerary: document.getElementById(`flightItinerary_${idx}`)?.value || "",
        airline: document.getElementById(`airline_${idx}`)?.value || "",
         direct: document.getElementById(`flightDirect_${idx}`)?.value || "",
        currency: document.getElementById(`flightCurrency_${idx}`)?.value || "USD",
        costs: {
          adult: {
            cost: parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0)
          },
          childBed: {
            cost: parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0)
          },
          childNoBed: {
            cost: parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0)
          },
          infant: {
            cost: parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0)
          }
        }
      };
      flightsData.push(flightData);
    });
    
    // Collect hotel data
    const hotelsData = [];
    document.querySelectorAll("[id^='hotelBlock_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const hotelData = {
        name: document.getElementById(`hotelName_${idx}`)?.value || "",
        city: document.getElementById(`hotelCity_${idx}`)?.value || "",
        checkIn: document.getElementById(`hotelCheckIn_${idx}`)?.value || "",
        checkOut: document.getElementById(`hotelCheckOut_${idx}`)?.value || "",
        nights: parseInt(document.getElementById(`hotelNights_${idx}`)?.value || 0),
        roomType: document.getElementById(`hotelRoomType_${idx}`)?.value || "",
        roomName: document.getElementById(`hotelRoomName_${idx}`)?.value || "",
        rooms: parseInt(document.getElementById(`hotelRooms_${idx}`)?.value || 1),
        serviceType: document.getElementById(`hotelService_${idx}`)?.value || "",
        costNight: parseFloat(document.getElementById(`hotelCostNight_${idx}`)?.value || 0),
        currency: document.getElementById(`hotelCurrency_${idx}`)?.value || "USD",
        svcNight: parseFloat(document.getElementById(`hotelSvcNight_${idx}`)?.value || 0)
      };
      hotelsData.push(hotelData);
    });
    
    // Collect transfer data
    const transfersData = [];
    document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const transferData = {
        date: document.getElementById(`tDate_${idx}`)?.value || "",
        from: document.getElementById(`tFrom_${idx}`)?.value || "",
        to: document.getElementById(`tTo_${idx}`)?.value || "",
        vehicle: document.getElementById(`tCar_${idx}`)?.value || "",
        type: document.getElementById(`tType_${idx}`)?.value || "",
        direction: document.getElementById(`tDirection_${idx}`)?.value || "",
        returnDate: document.getElementById(`tReturnDate_${idx}`)?.value || "",
        cost: parseFloat(document.getElementById(`tCost_${idx}`)?.value || 0),
        currency: document.getElementById(`tCurrency_${idx}`)?.value || "USD",
        service: parseFloat(document.getElementById(`tSvc_${idx}`)?.value || 0)
      };
      transfersData.push(transferData);
    });
    
    // Collect visa data
    let visaData = null;
    if (document.getElementById('visaBlock')) {
      visaData = {
        type: document.getElementById('visaType')?.value || "",
        country: document.getElementById('visaCountry')?.value || "",
        count: parseInt(document.getElementById('visaCount')?.value || 0),
        cost: parseFloat(document.getElementById('visaCost')?.value || 0),
        currency: document.getElementById('visaCurrency')?.value || "USD",
        service: parseFloat(document.getElementById('visaSvc')?.value || 0)
      };
    }
    
    // Collect tours data
    const toursData = [];
    document.querySelectorAll("[id^='tourBlock_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const tourData = {
        date: document.getElementById(`tourDate_${idx}`)?.value || "",
        name: document.getElementById(`tourName_${idx}`)?.value || "",
        city: document.getElementById(`tourCity_${idx}`)?.value || "",
        duration: document.getElementById(`tourDuration_${idx}`)?.value || "",
        mode: document.getElementById(`tourMode_${idx}`)?.value || "",
        vehicle: document.getElementById(`tourVehicle_${idx}`)?.value || "",
        cost: parseFloat(document.getElementById(`tourCost_${idx}`)?.value || 0),
        currency: document.getElementById(`tourCurrency_${idx}`)?.value || "USD",
        service: parseFloat(document.getElementById(`tourSvc_${idx}`)?.value || 0)
      };
      toursData.push(tourData);
    });
    
    // Collect add-ons data
    const addonsData = {
      directFlights: [],
      meals: [],
      tours: []
    };
    
    // Direct flight add-ons
    document.querySelectorAll("[id^='dfAddon_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const addonData = {
        itinerary: el.querySelector('textarea')?.value || "",
        airline: el.querySelector("input[list='airlist']")?.value || "",
        currency: el.querySelector('select')?.value || "USD",
        costs: {
          adult: {
            cost: parseFloat(document.getElementById(`upgradeFlightCostAdult_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`upgradeFlightSvcAdult_${idx}`)?.value || 0)
          },
          childBed: {
            cost: parseFloat(document.getElementById(`upgradeFlightCostChildBed_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`upgradeFlightSvcChildBed_${idx}`)?.value || 0)
          },
          childNoBed: {
            cost: parseFloat(document.getElementById(`upgradeFlightCostChildNoBed_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`upgradeFlightSvcChildNoBed_${idx}`)?.value || 0)
          },
          infant: {
            cost: parseFloat(document.getElementById(`upgradeFlightCostInf_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`upgradeFlightSvcInf_${idx}`)?.value || 0)
          }
        }
      };
      addonsData.directFlights.push(addonData);
    });
    
    // Meal add-ons
    document.querySelectorAll("[id^='mealAddon_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const selects = el.querySelectorAll('select');
      const inputs = el.querySelectorAll("input[type='number']");
      const addonData = {
        hotelIndex: selects[0]?.value || '',
        mealType: selects[1]?.value || '',
        cost: parseFloat(inputs[0]?.value || 0),
        service: parseFloat(inputs[1]?.value || 0),
        currency: selects[2]?.value || "USD"
      };
      addonsData.meals.push(addonData);
    });
    
    // Tour add-ons
    document.querySelectorAll("[id^='tourAddon_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const addonData = {
        date: document.getElementById(`tourAddonDate_${idx}`)?.value || "",
        name: document.getElementById(`tourAddonName_${idx}`)?.value || "",
        city: document.getElementById(`tourAddonCity_${idx}`)?.value || "",
        duration: document.getElementById(`tourAddonDuration_${idx}`)?.value || "",
        mode: document.getElementById(`tourAddonMode_${idx}`)?.value || "",
        vehicle: document.getElementById(`tourAddonVehicle_${idx}`)?.value || "",
        cost: parseFloat(document.getElementById(`tourAddonCost_${idx}`)?.value || 0),
        currency: document.getElementById(`tourAddonCurrency_${idx}`)?.value || "USD",
        service: parseFloat(document.getElementById(`tourAddonSvc_${idx}`)?.value || 0)
      };
      addonsData.tours.push(addonData);
    });
    
    // Get client data from localStorage
    const savedClientData = JSON.parse(localStorage.getItem('savedClientData_international')) || {};
    
    // Calculate total amounts
    let totalCostPKR = 0;
    let totalServicePKR = 0;
    
    // Calculate totals from the summary table
    document.querySelectorAll("#calcSummaryBody tr").forEach(row => {
      const cells = row.querySelectorAll("td");
      if (cells.length >= 9) {
        const costBase = parseFloat(cells[5].textContent.replace(/,/g, ''));
        const svcBase = parseFloat(cells[6].textContent.replace(/,/g, ''));
        totalCostPKR += costBase;
        totalServicePKR += svcBase;
      }
    });
    
    const finalTotalSellPKR = totalCostPKR + totalServicePKR;
    
    // Add custom sections data
const customSectionsData = {
  terms: customTerms,
  section1: localStorage.getItem('section1Content_international') || '',
  section2: localStorage.getItem('section2Content_international') || '',
  section1Disabled: localStorage.getItem('sectionDisabled_1') === 'true',
  section2Disabled: localStorage.getItem('sectionDisabled_2') === 'true'
};    
    // Create a complete quotation object
    const quotationData = {
      id: currentQuotationId || 'INT-' + Date.now().toString().slice(-6),
      clientData: {
        name: savedClientData.name || clientName,
        phone: savedClientData.phone || clientPhone,
        reference: savedClientData.reference || "",
        refExtra: savedClientData.refExtra || "",
        depCity: savedClientData.depCity || "Karachi",
        adults: savedClientData.adults || 0,
        childBed: savedClientData.childBed || 0,
        childNoBed: savedClientData.childNoBed || 0,
        infants: savedClientData.infants || 0,
        dateFrom: savedClientData.dateFrom || dateFrom,
        dateTo: savedClientData.dateTo || dateTo,
        tourDestination: savedClientData.tourDestination || ""
      },
      agentData: agent,
      createdAt: currentQuotationId ? 
        (savedQuotations.find(q => q.id === currentQuotationId)?.createdAt || new Date().toISOString()) : 
        new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      expiresAt: expiryDate.toISOString(),
      status: document.getElementById('quotationStatus')?.value || 'pending',
      totalAmount: finalTotalSellPKR,
      flights: flightsData,
      hotels: hotelsData,
      transfers: transfersData,
      tours: toursData,
      visa: visaData,
      addons: addonsData,
      customSections: customSectionsData  // Add this line
    };
    
    // Get ALL existing quotations from localStorage
    let allQuotations = JSON.parse(localStorage.getItem('savedQuotations_international')) || [];
    
    // Add or update the quotation
    if (currentQuotationId) {
      // Update existing
      const index = allQuotations.findIndex(q => q.id === currentQuotationId);
      if (index !== -1) {
        allQuotations[index] = quotationData;
      }
    } else {
      // Add new
      allQuotations.push(quotationData);
      currentQuotationId = quotationData.id;
    }
    
    // Save to localStorage
    localStorage.setItem('savedQuotations_international', JSON.stringify(allQuotations));
    
    // Save to Firebase
    if (agent && agent.id) {
      window.firebaseDB.saveData('international_quotations', agent.id, { 
        quotations: allQuotations, 
        updatedAt: new Date(),
        agentId: agent.id 
      }).catch(err => console.error('Firebase save error:', err));
    }
    
    // Update the global variable
    savedQuotations = allQuotations;
    
    showNotification("Quotation saved successfully!", "success");
    showStatusSection();
    
  } catch (error) {
    console.error('Error saving quotation:', error);
    showNotification("Failed to save quotation. Please try again.", "error");
  }
}

// Function to load a quotation
function loadQuotation(quotationId) {
  try {
    // Get all saved quotations
    savedQuotations = JSON.parse(localStorage.getItem('savedQuotations_international')) || [];
    
    // Find the quotation
    const quotation = savedQuotations.find(q => q.id === quotationId);
    
    if (!quotation) {
      showNotification("Quotation not found.", "error");
      return;
    }
    
    // Set the current quotation ID
    currentQuotationId = quotationId;
    
    // Store the expiry date if it exists
    if (quotation.expiresAt) {
      console.log("Quotation expires on:", new Date(quotation.expiresAt).toLocaleDateString());
    }
    
    // Load client data
    if (quotation.clientData) {
      // Save client data to localStorage
      localStorage.setItem("savedClientData_international", JSON.stringify(quotation.clientData));
      
      // Populate client form fields
      if (document.getElementById("clientName")) document.getElementById("clientName").value = quotation.clientData.name || "";
      if (document.getElementById("reference")) document.getElementById("reference").value = quotation.clientData.reference || "";
      if (document.getElementById("refExtra")) document.getElementById("refExtra").value = quotation.clientData.refExtra || "";
      if (document.getElementById("clientPhone")) document.getElementById("clientPhone").value = quotation.clientData.phone || "";
      if (document.getElementById("depCity")) document.getElementById("depCity").value = quotation.clientData.depCity || "Karachi";
      if (document.getElementById("numAdult")) document.getElementById("numAdult").value = quotation.clientData.adults || 0;
      if (document.getElementById("numChildBed")) document.getElementById("numChildBed").value = quotation.clientData.childBed || 0;
      if (document.getElementById("numChildNoBed")) document.getElementById("numChildNoBed").value = quotation.clientData.childNoBed || 0;
      if (document.getElementById("numInfant")) document.getElementById("numInfant").value = quotation.clientData.infants || 0;
      if (document.getElementById("dateFrom")) document.getElementById("dateFrom").value = quotation.clientData.dateFrom || "";
      if (document.getElementById("dateTo")) document.getElementById("dateTo").value = quotation.clientData.dateTo || "";
      if (document.getElementById("tourDestination")) document.getElementById("tourDestination").value = quotation.clientData.tourDestination || "";
      
      // Update date summary
      updateDateSummary();
      
      // Mark client data as saved
      isClientDataSaved = true;
      
      // Update last saved data
      lastSavedPax = getCurrentPaxData();
      lastSavedDates = { dateFrom: quotation.clientData.dateFrom, dateTo: quotation.clientData.dateTo };
      lastSavedClientInfo = { name: quotation.clientData.name, phone: quotation.clientData.phone };
    }
    
    // Load custom sections if they exist in the quotation
    if (quotation.customSections) {
      // Load terms and conditions
      if (quotation.customSections.terms) {
        customTerms = quotation.customSections.terms;
        localStorage.setItem('customTerms_international', customTerms);
      }
      
      // Load section 1
      if (quotation.customSections.section1) {
        localStorage.setItem('section1Content_international', quotation.customSections.section1);
        // Set section 1 disabled state if needed
        if (quotation.customSections.section1Disabled) {
          localStorage.setItem('sectionDisabled_1', 'true');
        } else {
          localStorage.setItem('sectionDisabled_1', 'false');
        }
      }
      
      // Load section 2
      if (quotation.customSections.section2) {
        localStorage.setItem('section2Content_international', quotation.customSections.section2);
        // Set section 2 disabled state if needed
        if (quotation.customSections.section2Disabled) {
          localStorage.setItem('sectionDisabled_2', 'true');
        } else {
          localStorage.setItem('sectionDisabled_2', 'false');
        }
      }
    }
    
    // Clear existing sections
    if (document.getElementById("flightContainer")) document.getElementById("flightContainer").innerHTML = "";
    if (document.getElementById("hotelContainer")) {
      const header = document.getElementById("hotelContainer").querySelector('.hotel-header');
      document.getElementById("hotelContainer").innerHTML = "";
      if (header) document.getElementById("hotelContainer").appendChild(header);
    }
    if (document.getElementById("transferContainer")) document.getElementById("transferContainer").innerHTML = "";
    if (document.getElementById("visaContainer")) document.getElementById("visaContainer").innerHTML = "";
    if (document.getElementById("directFlightContainer")) document.getElementById("directFlightContainer").innerHTML = "";
    if (document.getElementById("mealTypeContainer")) document.getElementById("mealTypeContainer").innerHTML = "";
    if (document.getElementById("toursContainer")) document.getElementById("toursContainer").innerHTML = "";
    if (document.getElementById("addonToursContainer")) document.getElementById("addonToursContainer").innerHTML = "";
    
    // Reset counters
    nextFlightNumber = 0;
    flights = [];
    nextHotelNumber = 0;
    hotels = [];
    nextTransferNumber = 0;
    transfers = [];
    nextTourNumber = 0;
    mainTours = [];
    visaAdded = false;
    dfIndex = 0;
    mealIndex = 0;
    tourIndex = 0;
    tours = [];
    
    // Load flights with proper timing
    if (quotation.flights && Array.isArray(quotation.flights)) {
      quotation.flights.forEach((flightData, flightIndex) => {
        setTimeout(() => {
          // Trigger the addFlight function
          addFlight();
          
          // Wait a moment for the flight to be added
          setTimeout(() => {
            const idx = nextFlightNumber;
            
            // Fill flight data
            if (document.getElementById(`flightItinerary_${idx}`)) 
              document.getElementById(`flightItinerary_${idx}`).value = flightData.itinerary || "";
            if (document.getElementById(`airline_${idx}`)) 
              document.getElementById(`airline_${idx}`).value = flightData.airline || "";
            if (document.getElementById(`flightDirect_${idx}`)) 
  document.getElementById(`flightDirect_${idx}`).value = flightData.direct || "";  
            if (document.getElementById(`flightCurrency_${idx}`)) 
              document.getElementById(`flightCurrency_${idx}`).value = flightData.currency || "USD";
            
            // Fill costs
            if (flightData.costs) {
              if (document.getElementById(`flightCostAdult_${idx}`)) 
                document.getElementById(`flightCostAdult_${idx}`).value = flightData.costs.adult?.cost || 0;
              if (document.getElementById(`flightSvcAdult_${idx}`)) 
                document.getElementById(`flightSvcAdult_${idx}`).value = flightData.costs.adult?.service || 0;
              if (document.getElementById(`flightCostChildBed_${idx}`)) 
                document.getElementById(`flightCostChildBed_${idx}`).value = flightData.costs.childBed?.cost || 0;
              if (document.getElementById(`flightSvcChildBed_${idx}`)) 
                document.getElementById(`flightSvcChildBed_${idx}`).value = flightData.costs.childBed?.service || 0;
              if (document.getElementById(`flightCostChildNoBed_${idx}`)) 
                document.getElementById(`flightCostChildNoBed_${idx}`).value = flightData.costs.childNoBed?.cost || 0;
              if (document.getElementById(`flightSvcChildNoBed_${idx}`)) 
                document.getElementById(`flightSvcChildNoBed_${idx}`).value = flightData.costs.childNoBed?.service || 0;
              if (document.getElementById(`flightCostInf_${idx}`)) 
                document.getElementById(`flightCostInf_${idx}`).value = flightData.costs.infant?.cost || 0;
              if (document.getElementById(`flightSvcInf_${idx}`)) 
                document.getElementById(`flightSvcInf_${idx}`).value = flightData.costs.infant?.service || 0;
            }
          }, 100);
        }, 200 * flightIndex);
      });
    }
    
    // Load hotels with proper timing
    if (quotation.hotels && Array.isArray(quotation.hotels)) {
      quotation.hotels.forEach((hotelData, hotelIndex) => {
        setTimeout(() => {
          // Trigger the addHotel function
          document.getElementById("btnAddHotel").click();
          
          // Wait a moment for the hotel to be added
          setTimeout(() => {
            const idx = nextHotelNumber;
            
            // Fill hotel data
            if (document.getElementById(`hotelName_${idx}`)) 
              document.getElementById(`hotelName_${idx}`).value = hotelData.name || "";
            if (document.getElementById(`hotelCity_${idx}`)) 
              document.getElementById(`hotelCity_${idx}`).value = hotelData.city || "";
            if (document.getElementById(`hotelCheckIn_${idx}`)) 
              document.getElementById(`hotelCheckIn_${idx}`).value = hotelData.checkIn || "";
            if (document.getElementById(`hotelCheckOut_${idx}`)) 
              document.getElementById(`hotelCheckOut_${idx}`).value = hotelData.checkOut || "";
            if (document.getElementById(`hotelNights_${idx}`)) 
              document.getElementById(`hotelNights_${idx}`).value = hotelData.nights || 0;
            if (document.getElementById(`hotelRoomType_${idx}`)) 
              document.getElementById(`hotelRoomType_${idx}`).value = hotelData.roomType || "";
            if (document.getElementById(`hotelRoomName_${idx}`)) 
              document.getElementById(`hotelRoomName_${idx}`).value = hotelData.roomName || "";
            if (document.getElementById(`hotelRooms_${idx}`)) 
              document.getElementById(`hotelRooms_${idx}`).value = hotelData.rooms || 1;
            if (document.getElementById(`hotelService_${idx}`)) 
              document.getElementById(`hotelService_${idx}`).value = hotelData.serviceType || "";
            if (document.getElementById(`hotelCostNight_${idx}`)) 
              document.getElementById(`hotelCostNight_${idx}`).value = hotelData.costNight || 0;
            if (document.getElementById(`hotelCurrency_${idx}`)) 
              document.getElementById(`hotelCurrency_${idx}`).value = hotelData.currency || "USD";
            if (document.getElementById(`hotelSvcNight_${idx}`)) 
              document.getElementById(`hotelSvcNight_${idx}`).value = hotelData.svcNight || 0;
          }, 100);
        }, 200 * hotelIndex);
      });
    }
    
    // Load transfers with proper timing
    if (quotation.transfers && Array.isArray(quotation.transfers)) {
      quotation.transfers.forEach((transferData, transferIndex) => {
        setTimeout(() => {
          // Trigger the addTransfer function
          document.getElementById("btnAddTrans").click();
          
          // Wait a moment for the transfer to be added
          setTimeout(() => {
            const idx = nextTransferNumber;
            
            // Fill transfer data
            if (document.getElementById(`tDate_${idx}`)) 
              document.getElementById(`tDate_${idx}`).value = transferData.date || "";
            if (document.getElementById(`tFrom_${idx}`)) 
              document.getElementById(`tFrom_${idx}`).value = transferData.from || "";
            if (document.getElementById(`tTo_${idx}`)) 
              document.getElementById(`tTo_${idx}`).value = transferData.to || "";
            if (document.getElementById(`tCar_${idx}`)) 
              document.getElementById(`tCar_${idx}`).value = transferData.vehicle || "";
            if (document.getElementById(`tType_${idx}`)) 
              document.getElementById(`tType_${idx}`).value = transferData.type || "";
            if (document.getElementById(`tDirection_${idx}`)) 
              document.getElementById(`tDirection_${idx}`).value = transferData.direction || "";
            if (document.getElementById(`tReturnDate_${idx}`)) 
              document.getElementById(`tReturnDate_${idx}`).value = transferData.returnDate || "";
            if (document.getElementById(`tCost_${idx}`)) 
              document.getElementById(`tCost_${idx}`).value = transferData.cost || 0;
            if (document.getElementById(`tCurrency_${idx}`)) 
              document.getElementById(`tCurrency_${idx}`).value = transferData.currency || "USD";
            if (document.getElementById(`tSvc_${idx}`)) 
              document.getElementById(`tSvc_${idx}`).value = transferData.service || 0;

            // Trigger change event on direction select to show/hide return date
            const directionSelect = document.getElementById(`tDirection_${idx}`);
            if (directionSelect) {
              directionSelect.dispatchEvent(new Event('change'));
            }
          }, 100);
        }, 200 * transferIndex);
      });
    }
    
    // Load tours with proper timing
    if (quotation.tours && Array.isArray(quotation.tours)) {
      quotation.tours.forEach((tourData, tourIndex) => {
        setTimeout(() => {
          // Trigger the addTour function
          document.getElementById("btnAddTour").click();
          
          // Wait a moment for the tour to be added
          setTimeout(() => {
            const idx = nextTourNumber;
            
            // Fill tour data
            if (document.getElementById(`tourDate_${idx}`)) 
              document.getElementById(`tourDate_${idx}`).value = tourData.date || "";
            if (document.getElementById(`tourName_${idx}`)) 
              document.getElementById(`tourName_${idx}`).value = tourData.name || "";
            if (document.getElementById(`tourCity_${idx}`)) {
              // Update city options first, then set value
              const availableCities = getAvailableCities();
              const citySelect = document.getElementById(`tourCity_${idx}`);
              if (availableCities.length > 0) {
                citySelect.innerHTML = availableCities.map(city => `<option value="${city}">${city}</option>`).join('');
              }
              citySelect.value = tourData.city || "";
            }
            if (document.getElementById(`tourDuration_${idx}`)) 
              document.getElementById(`tourDuration_${idx}`).value = tourData.duration || "";
            if (document.getElementById(`tourMode_${idx}`)) 
              document.getElementById(`tourMode_${idx}`).value = tourData.mode || "";
            if (document.getElementById(`tourVehicle_${idx}`)) 
              document.getElementById(`tourVehicle_${idx}`).value = tourData.vehicle || "";
            if (document.getElementById(`tourCost_${idx}`)) 
              document.getElementById(`tourCost_${idx}`).value = tourData.cost || 0;
            if (document.getElementById(`tourCurrency_${idx}`)) 
              document.getElementById(`tourCurrency_${idx}`).value = tourData.currency || "USD";
            if (document.getElementById(`tourSvc_${idx}`)) 
              document.getElementById(`tourSvc_${idx}`).value = tourData.service || 0;
          }, 100);
        }, 200 * tourIndex);
      });
    }
    
    // Load visa with proper timing
    if (quotation.visa && quotation.visa.count) {
      setTimeout(() => {
        // Trigger the addVisa function
        document.getElementById("btnAddVisa").click();
        
        // Wait a moment for the visa to be added
        setTimeout(() => {
          if (document.getElementById('visaType')) 
            document.getElementById('visaType').value = quotation.visa.type || "";
          if (document.getElementById('visaCountry')) 
            document.getElementById('visaCountry').value = quotation.visa.country || "";
          if (document.getElementById('visaCount')) 
            document.getElementById('visaCount').value = quotation.visa.count || 0;
          if (document.getElementById('visaCost')) 
            document.getElementById('visaCost').value = quotation.visa.cost || 0;
          if (document.getElementById('visaCurrency')) 
            document.getElementById('visaCurrency').value = quotation.visa.currency || "USD";
          if (document.getElementById('visaSvc')) 
            document.getElementById('visaSvc').value = quotation.visa.service || 0;
        }, 100);
      }, 200);
    }
    
    // Load add-ons with proper timing
    if (quotation.addons) {
      // Load direct flight add-ons
      if (quotation.addons.directFlights && Array.isArray(quotation.addons.directFlights)) {
        quotation.addons.directFlights.forEach((addonData, addonIndex) => {
          setTimeout(() => {
            // Open the direct flight panel
            const directFlightPanel = document.getElementById('directFlightPanel');
            if (directFlightPanel && directFlightPanel.style.display === 'none') {
              togglePanel('directFlightPanel', document.querySelector('.addon-header'));
            }
            
            // Trigger the addDirectFlightAddon function
            document.querySelector('.addon-panel button[onclick*="addDirectFlightAddon"]').click();
            
            // Wait a moment for the add-on to be added
            setTimeout(() => {
              const idx = dfIndex;
              
              // Fill add-on data
              const addonElement = document.getElementById(`dfAddon_${idx}`);
              if (addonElement) {
                const textarea = addonElement.querySelector('textarea');
                if (textarea) textarea.value = addonData.itinerary || "";
                
                const airlineInput = addonElement.querySelector("input[list='airlist']");
                if (airlineInput) airlineInput.value = addonData.airline || "";
                
                const currencySelect = addonElement.querySelector('select');
                if (currencySelect) currencySelect.value = addonData.currency || "USD";
                
                // Fill costs
                if (addonData.costs) {
                  if (document.getElementById(`upgradeFlightCostAdult_${idx}`)) 
                    document.getElementById(`upgradeFlightCostAdult_${idx}`).value = addonData.costs.adult?.cost || 0;
                  if (document.getElementById(`upgradeFlightSvcAdult_${idx}`)) 
                    document.getElementById(`upgradeFlightSvcAdult_${idx}`).value = addonData.costs.adult?.service || 0;
                  if (document.getElementById(`upgradeFlightCostChildBed_${idx}`)) 
                    document.getElementById(`upgradeFlightCostChildBed_${idx}`).value = addonData.costs.childBed?.cost || 0;
                  if (document.getElementById(`upgradeFlightSvcChildBed_${idx}`)) 
                    document.getElementById(`upgradeFlightSvcChildBed_${idx}`).value = addonData.costs.childBed?.service || 0;
                  if (document.getElementById(`upgradeFlightCostChildNoBed_${idx}`)) 
                    document.getElementById(`upgradeFlightCostChildNoBed_${idx}`).value = addonData.costs.childNoBed?.cost || 0;
                  if (document.getElementById(`upgradeFlightSvcChildNoBed_${idx}`)) 
                    document.getElementById(`upgradeFlightSvcChildNoBed_${idx}`).value = addonData.costs.childNoBed?.service || 0;
                  if (document.getElementById(`upgradeFlightCostInf_${idx}`)) 
                    document.getElementById(`upgradeFlightCostInf_${idx}`).value = addonData.costs.infant?.cost || 0;
                  if (document.getElementById(`upgradeFlightSvcInf_${idx}`)) 
                    document.getElementById(`upgradeFlightSvcInf_${idx}`).value = addonData.costs.infant?.service || 0;
                }
              }
            }, 100);
          }, 300 * (addonIndex + 1));
        });
      }
      
      // Load meal add-ons
      if (quotation.addons.meals && Array.isArray(quotation.addons.meals)) {
        quotation.addons.meals.forEach((addonData, addonIndex) => {
          setTimeout(() => {
            // Open the meal type panel
            const mealTypePanel = document.getElementById('mealTypePanel');
            if (mealTypePanel && mealTypePanel.style.display === 'none') {
              togglePanel('mealTypePanel', document.querySelectorAll('.addon-header')[1]);
            }
            
            // Trigger the addMealTypeAddon function
            document.querySelectorAll('.addon-panel button[onclick*="addMealTypeAddon"]')[0].click();
            
            // Wait a moment for the add-on to be added
            setTimeout(() => {
              const idx = mealIndex;
              
              // Fill add-on data
              const addonElement = document.getElementById(`mealAddon_${idx}`);
              if (addonElement) {
                const selects = addonElement.querySelectorAll('select');
                const inputs = addonElement.querySelectorAll("input[type='number']");
                
                if (selects[0]) selects[0].value = addonData.hotelIndex || "";
                if (selects[1]) selects[1].value = addonData.mealType || "";
                if (inputs[0]) inputs[0].value = addonData.cost || 0;
                if (inputs[1]) inputs[1].value = addonData.service || 0;
                if (selects[2]) selects[2].value = addonData.currency || "USD";
              }
            }, 100);
          }, 300 * (addonIndex + 1));
        });
      }
      
      // Load tour add-ons
      if (quotation.addons.tours && Array.isArray(quotation.addons.tours)) {
        quotation.addons.tours.forEach((addonData, addonIndex) => {
          setTimeout(() => {
            // Open the tours panel
            const toursPanel = document.getElementById('toursPanel');
            if (toursPanel && toursPanel.style.display === 'none') {
              togglePanel('toursPanel', document.querySelectorAll('.addon-header')[2]);
            }
            
            // Trigger the addTourAddon function
            document.querySelectorAll('.addon-panel button[onclick*="addTourAddon"]')[0].click();
            
            // Wait a moment for the add-on to be added
            setTimeout(() => {
              const idx = tourIndex;
              
              // Fill add-on data
              if (document.getElementById(`tourAddonDate_${idx}`)) 
                document.getElementById(`tourAddonDate_${idx}`).value = addonData.date || "";
              if (document.getElementById(`tourAddonName_${idx}`)) 
                document.getElementById(`tourAddonName_${idx}`).value = addonData.name || "";
              if (document.getElementById(`tourAddonCity_${idx}`)) {
                // Update city options first, then set value
                const availableCities = getAvailableCities();
                const citySelect = document.getElementById(`tourAddonCity_${idx}`);
                if (availableCities.length > 0) {
                  citySelect.innerHTML = availableCities.map(city => `<option value="${city}">${city}</option>`).join('');
                }
                citySelect.value = addonData.city || "";
              }
              if (document.getElementById(`tourAddonDuration_${idx}`)) 
                document.getElementById(`tourAddonDuration_${idx}`).value = addonData.duration || "";
              if (document.getElementById(`tourAddonMode_${idx}`)) 
                document.getElementById(`tourAddonMode_${idx}`).value = addonData.mode || "";
              if (document.getElementById(`tourAddonVehicle_${idx}`)) 
                document.getElementById(`tourAddonVehicle_${idx}`).value = addonData.vehicle || "";
              if (document.getElementById(`tourAddonCost_${idx}`)) 
                document.getElementById(`tourAddonCost_${idx}`).value = addonData.cost || 0;
              if (document.getElementById(`tourAddonCurrency_${idx}`)) 
                document.getElementById(`tourAddonCurrency_${idx}`).value = addonData.currency || "USD";
              if (document.getElementById(`tourAddonSvc_${idx}`)) 
                document.getElementById(`tourAddonSvc_${idx}`).value = addonData.service || 0;
            }, 100);
          }, 300 * (addonIndex + 1));
        });
      }
    }
    
    // Show status section
    showStatusSection();
    
    showNotification("Quotation loaded successfully!", "success");
    
  } catch (error) {
    console.error('Error loading quotation:', error);
    showNotification("Failed to load quotation. Please try again.", "error");
  }
}

// Load Quotation functionality
document.getElementById('btnLoadQuotation').addEventListener('click', () => {
  // Get current agent
  const currentAgent = getCurrentAgent();
  if (!currentAgent) {
    showAlert("Please login to load quotations.");
    return;
  }
  
  // Get all quotations
  const allSavedQuotations = JSON.parse(localStorage.getItem('savedQuotations_international')) || [];
  
  // Filter quotations for current agent only
  const userQuotations = allSavedQuotations.filter(q => q.agentData && q.agentData.id === currentAgent.id);
  
  if (userQuotations.length === 0) {
    showAlert("No saved quotations found for your account.");
    return;
  }

  // Create modal content
  const modal = document.getElementById('custom-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const modalButtons = document.getElementById('modal-buttons');
  
  modalTitle.textContent = 'Load Saved Quotation';
  
  // Create a table of quotations
  let tableHTML = `
    <div style="max-height: 400px; overflow-y: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f2f2f2;">
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">ID</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Client</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Destination</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Date</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Total (PKR)</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Status</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Action</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  userQuotations.forEach(quotation => {
    const statusColor = {
      'pending': '#ffc107',
      'followup': '#17a2b8',
      'booked': '#28a745',
      'cancelled': '#dc3545'
    };
    
    tableHTML += `
      <tr>
        <td style="padding: 8px; border: 1px solid #ddd;">${quotation.id}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${quotation.clientData.name}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${quotation.clientData.tourDestination}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${formatDateToDMY(quotation.clientData.dateFrom)} - ${formatDateToDMY(quotation.clientData.dateTo)}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${fmt(quotation.totalAmount)}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <span style="background-color: ${statusColor[quotation.status] || '#6c757d'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
            ${quotation.status}
          </span>
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <button class="load-quotation-btn" data-id="${quotation.id}" style="padding: 4px 8px; font-size: 12px;">Load</button>
        </td>
      </tr>
    `;
  });
  
  tableHTML += `
        </tbody>
      </table>
    </div>
  `;
  
  modalMessage.innerHTML = tableHTML;
  
  // Clear and add buttons
  modalButtons.innerHTML = '';
  
  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close';
  closeBtn.onclick = () => {
    modal.classList.remove('visible');
  };
  modalButtons.appendChild(closeBtn);
  
  // Show modal
  modal.classList.add('visible');
  
// Add event listeners to load buttons
document.querySelectorAll('.load-quotation-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    // Get the quotation ID from the button's data attribute
    const quotationId = btn.getAttribute('data-id');
    
    // Close modal
    modal.classList.remove('visible');
    
    // Load the quotation
    loadQuotation(quotationId);
  });
});
});
      
function handleUrlParameters() {
  const urlParams = new URLSearchParams(window.location.search);
  const viewId = urlParams.get('view');
  const editId = urlParams.get('edit');
  const selectedId = localStorage.getItem('selectedQuotationId');
  
  // Use URL parameter first, then localStorage
  const quotationIdToLoad = viewId || editId || selectedId;
  
  if (quotationIdToLoad) {
    console.log('Loading quotation:', quotationIdToLoad); // Debug log
    
    // Wait for page to fully load
    setTimeout(() => {
      // Load the quotation
      loadQuotation(quotationIdToLoad);
      
      // If viewing, show quotation modal after loading
      if (viewId) {
        setTimeout(() => {
          showQuotationModal();
        }, 2000);
      }
    }, 1000);
    
    // Add this at the end to ensure status is shown
    setTimeout(() => {
      showStatusSection();
    }, 1500);
  }
}

// Add event listeners for auto-save
document.addEventListener('DOMContentLoaded', () => {
  // Add auto-save to all input fields
  document.querySelectorAll('input, select, textarea').forEach(element => {
    element.addEventListener('change', setupAutoSave);
  });
  
  // Handle URL parameters for view/edit
  handleUrlParameters();
});

// Update agent display in header
function updateAgentDisplay() {
  const agent = JSON.parse(localStorage.getItem("loggedInAgent"));
  if (agent) {
    document.getElementById("agentNameDisplay").textContent = agent.name;
    document.getElementById("agentPhoneDisplay").textContent = agent.phone;
  } else {
    document.getElementById("agentNameDisplay").textContent = '—';
    document.getElementById("agentPhoneDisplay").textContent = '';
  }
}
// Call this function after successful login
updateAgentDisplay();

// Save Quotation button event listener
document.getElementById('btnSaveQuotation').addEventListener('click', () => {
  saveQuotation();
});

// Function to setup auto-save for form elements
function setupAutoSave() {
  // This function can be used to implement auto-save functionality
  // For now, it's just a placeholder to prevent errors
  console.log("Auto-save setup called");
}

// Content Editor Function with Rich Text Editor and Section Toggles
const visaOptions = [
  {
    name: 'Malaysia Tourist Visa Requirements',
    content: `
✅ Required Documents
* Passport – Must be valid for at least 8 months.
* Valid CNIC – (National Identity Card)
* Two recent passport-size photos – White background only.
* Bank Statement (Last 6 months) – Minimum maintained balance of PKR 350,000 per person.
* Bank Maintenance Certificate – Must include branch manager's visiting card.
* Employment Letter (for salaried individuals) or Self-Employment Work Detail Letter (for business owners/freelancers).
* Family Registration Certificate (FRC) – Issued by NADRA.
🕒 Processing Time
E-Visa: 10–20 working days
Sticker Visa: 8–10 working days
(Excludes Saturday & Sunday)
📤 Submission Instructions
For E-Visa:
Send scanned copies of all required documents along with the visa fee deposit receipt.
For Sticker Visa:
Submit original documents at our office during working hours.
🛂 Visa Details
Visa Validity: 6 months (from date of issue)
Stay Validity: 30 days (per entry)
`
  },
  {
    name: 'Indonesia Tourist Visa Requirements',
    content: `
Original passport valid for at least 6 months with 2 blank visa pages.
One recent passport-size color photograph.
Copy of passport pages 1 and 2.
Copy of valid or latest national identity card (NIC).
Copy of previous Indonesia visa (if any).
Bank statement and account maintenance certificate for last 6 months.
Apply within 30 days of intended travel date.
Processing Time:
7–8 working days
🛂 Visa Details
Visa Validity: 90 days (from date of issue)
Stay Validity: Up to 60 days (as granted)
Important Notes:
In some cases, the embassy may require personal appearance or additional documentation.
`
  },
  {
    name: 'Thailand Tourist Visa Requirements',
    content: `
✅ Required Documents
 • Passport – Valid for at least 6 months.
 • Valid CNIC – Front & back scanned on the same page.
 • Two recent passport-size photos – Blue or white background (taken within the last 6 months).
 • Bank Statement stamped  (Last 3 months) – Maintained minimum balance of PKR 300,000 per applicant + account maintenance letter.
• Bank Maintenance Certificate – Must include branch manager's visiting card.
• Employment Letter (for salaried individuals) or Self-Employment Work Detail Letter (for business owners/freelancers).
 
🕒 Processing Time
 7–10 working days
 (Excludes Saturday & Sunday)
📤 Submission Instructions
 Send scanned copies of all required documents along with visa fee receipt via WhatsApp or email.
🛂 Visa Details
Visa Validity: 
Single Entry: 3 months (from date of issue)
Multiple Entry: 6 months (from date of issue) 
Stay Validity: Up to 30 days (as granted)
`
  },
  {
    name: 'Sri Lanka E-Visa Requirements',
    content: `
✅ Required Documents (Clear Scans Only)
 • Passport – 1st page
 • CNIC – Front & back
🕒 Processing Time
 2–4 working days
🛂 Visa Details
 • Entry Type: Double Entry
 • Travel Validity: 90 days from date of issue
 • Stay Validity: 30 days
🇦🇿 Azerbaijan, Baku E-Visa Requirements
✅ Required Documents (Clear Scans Only)
 • Passport – 1st page
 • CNIC – Front & back
🛂 Visa Details
 • Entry Type: Single Entry
 • Travel Validity: 60 days from date of issue
 • Stay Validity: 30 days
`
  },
  {
    name: 'Singapore E-Visa Requirements',
    content: `
✅ Required Documents (Clear Scans Only)
 • Passport – 1st, 2nd & 3rd pages
 • CNIC – Front & back
 • Recent photo – White background
 • Employment Letter (for salaried individuals)
 • Business Letterhead (if self-employed)
📄 Additional Info Required
 • Name
 • Marital Status
 • Occupation & Designation
 • Yearly Income
 • Education
 • Email Address
 • Contact Number
🕒 Processing Time
 8–10 working days normally, 
In some cases take 15 - 20 days as well.
🛂 Visa Details
 • Entry Type: Single/Double (Subject to Immigration Approval)
 • Travel Validity: 60 days from date of issue
 • Stay Validity: 30 days
📌 In case of rejection, only a consulate receipt image with "unsuccessful" stamp will be shared.
`
  },
  {
    name: 'Requirements for Visa on Arrival (Qatar) – Pakistani Passport',
    content: `
• Passport must have minimum 6 months validity.
• Confirmed return or onward ticket required.
• Minimum 2 nights hotel must be booked via Discover Qatar only.
• We can book Discover Qatar hotels at the same rates shown on the website, calculated on the current rate of exchange.
• Qatar-approved travel insurance required – PKR 7,500 per person.
• Debit/credit card under passenger's name may be asked as proof of funds.
• Stay allowed 30 days, extendable once for another 30 days.
• Visa/entry always depends on final approval by Qatar Immigration.
`
  }
];

function showContentEditor() {
  if (!localStorage.getItem('sectionDisabled_2')) {
    localStorage.setItem('sectionDisabled_2', 'true');
  }
  
  const modal = document.getElementById('contentEditorModal');
  const modalTitle = document.getElementById('contentEditorModalTitle');
  const modalContent = document.getElementById('contentEditorModalContent');
  const modalButtons = document.getElementById('contentEditorModalButtons');
  
  modalTitle.textContent = 'Edit Content';
  
  // Create tabs for different content types
  const tabsContainer = document.createElement('div');
  tabsContainer.style.display = 'flex';
  tabsContainer.style.marginBottom = '15px';
  tabsContainer.style.borderBottom = '1px solid #ddd';
  
  const tabs = ['Terms & Conditions', 'Section 1', 'Section 2'];
  const tabContents = [];
  const editors = {}; // Store references to editors
  const headingInputs = {}; // Store references to heading inputs
  const sectionToggles = {}; // Store references to section toggles
  
  tabs.forEach((tab, index) => {
    const tabButton = document.createElement('button');
    tabButton.textContent = tab;
    tabButton.style.padding = '8px 15px';
    tabButton.style.border = 'none';
    tabButton.style.background = index === 0 ? 'var(--accent)' : 'transparent';
    tabButton.style.color = index === 0 ? 'white' : '#666';
    tabButton.style.cursor = 'pointer';
    tabButton.style.borderBottom = index === 0 ? '2px solid var(--accent)' : 'none';
    
    tabButton.addEventListener('click', () => {
      // Hide all content areas
      tabContents.forEach(content => content.style.display = 'none');
      
      // Show selected content
      tabContents[index].style.display = 'block';
      
      // Update tab styles
      tabs.forEach((_, i) => {
        tabsContainer.children[i].style.background = i === index ? 'var(--accent)' : 'transparent';
        tabsContainer.children[i].style.color = i === index ? 'white' : '#666';
        tabsContainer.children[i].style.borderBottom = i === index ? '2px solid var(--accent)' : 'none';
      });
    });
    
    tabsContainer.appendChild(tabButton);
  });
  
  // Create content areas for each tab
  const contentContainer = document.createElement('div');
  
  // Function to create rich editor with editable heading and toggle
  function createRichEditorWithHeadingAndToggle(content, tabIndex, defaultHeading) {
    const editorContainer = document.createElement('div');
    
    // Create section toggle (except for Terms & Conditions)
    let toggleContainer = null;
    if (tabIndex !== 0) { // Not Terms & Conditions
      toggleContainer = document.createElement('div');
      toggleContainer.className = 'section-toggle-container';
      
      const toggleLabel = document.createElement('div');
      toggleLabel.className = 'section-toggle-label';
      toggleLabel.innerHTML = `
        <span>Include this section in quotation?</span>
        <span class="section-status" id="status_${tabIndex}">Section will be included</span>
      `;
      
      const toggleSwitch = document.createElement('div');
      toggleSwitch.className = 'toggle-switch active';
      toggleSwitch.id = `toggle_${tabIndex}`;
      
      // Check if section is currently disabled
      const isDisabled = localStorage.getItem(`sectionDisabled_${tabIndex}`) === 'true';
      if (isDisabled) {
        toggleSwitch.classList.remove('active');
        toggleLabel.querySelector('.section-status').textContent = 'Section will be hidden';
      }
      
      toggleSwitch.addEventListener('click', () => {
        toggleSwitch.classList.toggle('active');
        const isActive = toggleSwitch.classList.contains('active');
        
        // Update status text
        const statusText = toggleLabel.querySelector('.section-status');
        statusText.textContent = isActive ? 'Section will be included' : 'Section will be hidden';
        
        // Enable/disable editor
        const editorSection = editorContainer.querySelector('.editor-section');
        if (isActive) {
          editorSection.classList.remove('section-disabled');
          localStorage.setItem(`sectionDisabled_${tabIndex}`, 'false');
        } else {
          editorSection.classList.add('section-disabled');
          localStorage.setItem(`sectionDisabled_${tabIndex}`, 'true');
        }
      });
      
      toggleContainer.appendChild(toggleLabel);
      toggleContainer.appendChild(toggleSwitch);
      editorContainer.appendChild(toggleContainer);
      sectionToggles[tabIndex] = toggleSwitch;
    }
    
    // Create editor section wrapper
    const editorSection = document.createElement('div');
    editorSection.className = 'editor-section';
    
    // Apply disabled state if needed
    if (tabIndex !== 0 && localStorage.getItem(`sectionDisabled_${tabIndex}`) === 'true') {
      editorSection.classList.add('section-disabled');
    }
    
    // Create heading input (except for Terms & Conditions)
    let headingInput = null;
    if (tabIndex !== 0) { // Not Terms & Conditions
      const headingContainer = document.createElement('div');
      headingContainer.style.marginBottom = '15px';
      
      const headingLabel = document.createElement('label');
      headingLabel.textContent = 'Section Heading:';
      headingLabel.style.display = 'block';
      headingLabel.style.marginBottom = '5px';
      headingLabel.style.fontWeight = 'bold';
      headingLabel.style.color = '#333';
      
      headingInput = document.createElement('input');
      headingInput.type = 'text';
      headingInput.className = 'heading-input';
      headingInput.style.width = '100%';
      headingInput.style.padding = '10px';
      headingInput.style.border = '1px solid #ddd';
      headingInput.style.borderRadius = '4px';
      headingInput.style.fontSize = '16px';
      headingInput.style.fontWeight = 'bold';
      
      // Extract current heading from content or use default
      const headingMatch = content.match(/<h3[^>]*>(.*?)<\/h3>/);
      if (headingMatch) {
        headingInput.value = headingMatch[1].replace(/<[^>]*>/g, '').trim();
      } else {
        headingInput.value = defaultHeading;
      }
      
      headingContainer.appendChild(headingLabel);
      headingContainer.appendChild(headingInput);
      editorSection.appendChild(headingContainer);
      headingInputs[tabIndex] = headingInput;
    }
    
    // Create visa requirements dropdown for Section 1
    if (tabIndex === 1) {
      const select = document.createElement('select');
      select.style.width = '100%';
      select.style.padding = '10px';
      select.style.border = '1px solid #ddd';
      select.style.borderRadius = '4px';
      select.style.marginBottom = '15px';
      select.innerHTML = '<option value="">Select Visa Requirements</option>';
      visaOptions.forEach((option, index) => {
        select.innerHTML += `<option value="${index}">${option.name}</option>`;
      });
      select.addEventListener('change', () => {
        if (select.value !== '') {
          const opt = visaOptions[parseInt(select.value)];
          headingInputs[1].value = opt.name;
          editors[1].innerHTML = opt.content.replace(/\n/g, '<br>');
        }
      });
      editorSection.appendChild(select);
    }
    
    // Create toolbar
    const toolbar = document.createElement('div');
    toolbar.className = 'rich-editor-toolbar';
    toolbar.style.backgroundColor = '#f5f5f5';
    toolbar.style.padding = '10px';
    toolbar.style.border = '1px solid #ddd';
    toolbar.style.borderBottom = 'none';
    toolbar.style.borderRadius = '4px 4px 0 0';
    toolbar.style.display = 'flex';
    toolbar.style.flexWrap = 'wrap';
    toolbar.style.gap = '5px';
    
    // Formatting buttons
    const buttons = [
      { icon: 'B', title: 'Bold', command: 'bold' },
      { icon: 'I', title: 'Italic', command: 'italic' },
      { icon: 'U', title: 'Underline', command: 'underline' },
      { separator: true },
      { icon: '🔤', title: 'Font Family', command: 'fontFamily', type: 'select' },
      { icon: '📏', title: 'Font Size', command: 'fontSize', type: 'select' },
      { separator: true },
      { icon: '•', title: 'Bullet List', command: 'insertUnorderedList' },
      { icon: '1.', title: 'Numbered List', command: 'insertOrderList' },
      { separator: true },
      { icon: '◀', title: 'Align Left', command: 'justifyLeft' },
      { icon: '▬', title: 'Align Center', command: 'justifyCenter' },
      { icon: '▶', title: 'Align Right', command: 'justifyRight' },
      { separator: true },
      { icon: '🔗', title: 'Insert Link', command: 'createLink' },
      { icon: '✖', title: 'Remove Formatting', command: 'removeFormat' }
    ];
    
    buttons.forEach(btn => {
      if (btn.separator) {
        const separator = document.createElement('div');
        separator.className = 'rich-editor-separator';
        separator.style.cssText = 'width: 1px; background: #ccc; margin: 0 5px;';
        toolbar.appendChild(separator);
      } else if (btn.type === 'select') {
        // Create dropdown for font family or font size
        const select = document.createElement('select');
        select.style.cssText = 'padding: 6px 8px; border: 1px solid #1a237e; background: #1a237e; color: white; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 5px;';
        
        if (btn.command === 'fontFamily') {
          select.innerHTML = `
            <option value="">Font</option>
            <option value="Arial, sans-serif">Arial</option>
            <option value="Times New Roman, serif">Times</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="Courier New, monospace">Courier</option>
            <option value="Verdana, sans-serif">Verdana</option>
            <option value="Helvetica, sans-serif">Helvetica</option>
            <option value="Tahoma, sans-serif">Tahoma</option>
            <option value="Trebuchet MS, sans-serif">Trebuchet</option>
          `;
          
          select.addEventListener('change', () => {
            if (select.value) {
              document.execCommand('fontName', false, select.value);
            }
          });
          
        } else if (btn.command === 'fontSize') {
          select.innerHTML = `
            <option value="">Size</option>
            <option value="1">Very Small (8pt)</option>
            <option value="2">Small (10pt)</option>
            <option value="3">Normal (12pt)</option>
            <option value="4">Medium (14pt)</option>
            <option value="5">Large (18pt)</option>
            <option value="6">Extra Large (24pt)</option>
            <option value="7">Huge (36pt)</option>
          `;
          
          select.addEventListener('change', () => {
            if (select.value) {
              document.execCommand('fontSize', false, select.value);
            }
          });
        }
        
        // Style the select options
        Array.from(select.options).forEach(option => {
          if (option.value) {
            option.style.background = '#1a237e';
            option.style.color = 'white';
          }
        });
        
        toolbar.appendChild(select);
        
      } else {
        // Regular buttons
        const button = document.createElement('button');
        button.className = 'rich-editor-btn';
        button.textContent = btn.icon;
        button.title = btn.title;
        button.type = 'button';
        button.style.cssText = 'padding: 8px 12px; border: 1px solid #1a237e; background: #1a237e; cursor: pointer; border-radius: 4px; font-size: 14px; font-weight: bold; transition: all 0.2s; min-width: 30px; text-align: center; color: white !important; box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);';
        
        // Apply specific styling for each button type
        if (btn.command === 'bold') {
          button.style.fontWeight = 'bold';
        } else if (btn.command === 'italic') {
          button.style.fontStyle = 'italic';
        } else if (btn.command === 'underline') {
          button.style.textDecoration = 'underline';
        } else if (btn.command === 'insertUnorderedList') {
          button.style.fontSize = '16px';
        } else if (btn.command === 'insertOrderedList') {
          button.style.fontWeight = 'bold';
        } else if (btn.icon === '▬') {
          button.style.fontSize = '12px';
          button.style.letterSpacing = '2px';
        }
        
        button.addEventListener('click', (e) => {
          e.preventDefault();
          
          if (btn.command === 'createLink') {
            const url = prompt('Enter URL:');
            if (url) {
              document.execCommand(btn.command, false, url);
            }
          } else {
            document.execCommand(btn.command, false, null);
          }
          
          // Update button states
          updateToolbarState(toolbar, editorContent);
        });
        
        button.addEventListener('mouseenter', () => {
          button.style.background = '#283593';
          button.style.borderColor = '#3949ab';
          button.style.transform = 'translateY(-1px)';
          button.style.boxShadow = '0 4px 8px rgba(26, 35, 126, 0.4)';
        });
        
        button.addEventListener('mouseleave', () => {
          button.style.background = '#1a237e';
          button.style.borderColor = '#1a237e';
          button.style.transform = 'translateY(0)';
          button.style.boxShadow = '0 2px 4px rgba(26, 35, 126, 0.3)';
        });
        
        toolbar.appendChild(button);
      }
    });
    
    // Add quick font size buttons
    const fontSizes = [
      { label: 'A-', title: 'Decrease Font', command: 'decreaseFontSize' },
      { label: 'A', title: 'Normal Font', command: 'normalFontSize' },
      { label: 'A+', title: 'Increase Font', command: 'increaseFontSize' }
    ];
    
    fontSizes.forEach(fontBtn => {
      const sizeButton = document.createElement('button');
      sizeButton.className = 'rich-editor-btn';
      sizeButton.textContent = fontBtn.label;
      sizeButton.title = fontBtn.title;
      sizeButton.type = 'button';
      sizeButton.style.cssText = 'padding: 6px 10px; border: 1px solid #1a237e; background: #1a237e; cursor: pointer; border-radius: 4px; font-size: 12px; font-weight: bold; transition: all 0.2s; color: white !important; margin-right: 3px;';
      
      sizeButton.addEventListener('click', (e) => {
        e.preventDefault();
        
        if (fontBtn.command === 'decreaseFontSize') {
          document.execCommand('fontSize', false, '2');
        } else if (fontBtn.command === 'normalFontSize') {
          document.execCommand('fontSize', false, '3');
        } else if (fontBtn.command === 'increaseFontSize') {
          document.execCommand('fontSize', false, '5');
        }
      });
      
      sizeButton.addEventListener('mouseenter', () => {
        sizeButton.style.background = '#283593';
        sizeButton.style.transform = 'translateY(-1px)';
      });
      
      sizeButton.addEventListener('mouseleave', () => {
        sizeButton.style.background = '#1a237e';
        sizeButton.style.transform = 'translateY(0)';
      });
      
      toolbar.appendChild(sizeButton);
    });
    
    // Create editable content area
    const editorContent = document.createElement('div');
    editorContent.className = 'rich-editor-content';
    editorContent.contentEditable = true;
    editorContent.style.whiteSpace = 'pre-wrap';
    editorContent.style.fontFamily = 'Arial, sans-serif';
    editorContent.style.fontSize = '14px';
    editorContent.style.lineHeight = '1.5';
    editorContent.style.minHeight = '300px';
    editorContent.style.padding = '15px';
    editorContent.style.border = '1px solid #ddd';
    editorContent.style.borderRadius = '4px';
    editorContent.style.overflowY = 'auto';
    editorContent.style.width = '100%';
    editorContent.style.textAlign = 'left';
    
    // Remove existing heading from content for editing
    let cleanContent = content.replace(/<h3[^>]*>.*?<\/h3>/g, '');
    editorContent.innerHTML = cleanContent;
    
    // Update toolbar state when selection changes
    editorContent.addEventListener('mouseup', () => updateToolbarState(toolbar, editorContent));
    editorContent.addEventListener('keyup', () => updateToolbarState(toolbar, editorContent));
    
    editorSection.appendChild(toolbar);
    editorSection.appendChild(editorContent);
    editorContainer.appendChild(editorSection);
    
    // Store reference
    editors[tabIndex] = editorContent;
    
    return editorContainer;
  }
  
  // Function to update toolbar button states
  function updateToolbarState(toolbar, editor) {
    const buttons = toolbar.querySelectorAll('.rich-editor-btn');
    buttons.forEach(btn => {
      const command = btn.getAttribute('data-command') || 
                     (btn.textContent === 'B' ? 'bold' :
                      btn.textContent === 'I' ? 'italic' :
                      btn.textContent === 'U' ? 'underline' :
                      btn.textContent === '•' ? 'insertUnorderedList' :
                      btn.textContent === '1.' ? 'insertOrderedList' :
                      btn.textContent === '◀' ? 'justifyLeft' :
                      btn.textContent === '▬' ? 'justifyCenter' :
                      btn.textContent === '▶' ? 'justifyRight' :
                      btn.textContent === '🔗' ? 'createLink' :
                      btn.textContent === '✖' ? 'removeFormat' : '');
      
      if (command && command !== 'createLink' && command !== 'removeFormat') {
        try {
          if (document.queryCommandState(command)) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        } catch (e) {
          // Ignore errors for unsupported commands
        }
      }
    });
  }

    // Get saved content for each section
  const savedTerms = localStorage.getItem('customTerms_international') || defaultTerms;
  const savedSection1Content = localStorage.getItem('section1Content_international') || '';
  const savedSection2Content = localStorage.getItem('section2Content_international') || '';
  
  // Terms & Conditions Tab (no toggle or editable heading)
const termsContent = document.createElement('div');
const termsHtml = customTerms || defaultTerms;
const termsEditor = createRichEditorWithHeadingAndToggle(termsHtml, 0, 'Terms and Conditions');
termsContent.appendChild(termsEditor);

// Add reset to default button for Terms & Conditions
const resetBtn = document.createElement('button');
resetBtn.textContent = 'Reset to Default';
resetBtn.style.marginTop = '10px';
resetBtn.addEventListener('click', () => {
  editors[0].innerHTML = defaultTerms;
});
termsContent.appendChild(resetBtn);

contentContainer.appendChild(termsContent);
tabContents.push(termsContent);

// Section 1 Tab (with toggle and editable heading)
const section1Content = document.createElement('div');
section1Content.style.display = 'none';
const section1Html = localStorage.getItem('section1Content_international') || '';
const section1Editor = createRichEditorWithHeadingAndToggle(section1Html, 1, 'Section 1 Heading');
section1Content.appendChild(section1Editor);

// Add reset to default button for Section 1
const resetBtn1 = document.createElement('button');
resetBtn1.textContent = 'Reset to Default';
resetBtn1.style.marginTop = '10px';
resetBtn1.addEventListener('click', () => {
  headingInputs[1].value = 'Section 1 Heading';
  editors[1].innerHTML = '';
});
section1Content.appendChild(resetBtn1);

contentContainer.appendChild(section1Content);
tabContents.push(section1Content);

// Section 2 Tab (with toggle and editable heading)
const section2Content = document.createElement('div');
section2Content.style.display = 'none';
const section2Html = localStorage.getItem('section2Content_international') || '';
const section2Editor = createRichEditorWithHeadingAndToggle(section2Html, 2, 'Section 2 Heading');
section2Content.appendChild(section2Editor);

// Add reset to default button for Section 2
const resetBtn2 = document.createElement('button');
resetBtn2.textContent = 'Reset to Default';
resetBtn2.style.marginTop = '10px';
resetBtn2.addEventListener('click', () => {
  headingInputs[2].value = 'Section 2 Heading';
  editors[2].innerHTML = '';
});
section2Content.appendChild(resetBtn2);

contentContainer.appendChild(section2Content);
tabContents.push(section2Content);

modalContent.innerHTML = '';
modalContent.appendChild(tabsContainer);
modalContent.appendChild(contentContainer);

modalButtons.innerHTML = '';

const saveBtn = document.createElement('button');
saveBtn.textContent = 'Save Changes';
saveBtn.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  
  // Get the active tab
  const activeTabIndex = Array.from(tabsContainer.children).findIndex(tab => 
    tab.style.background === 'var(--accent)'
  );
  
  // Save the content based on the active tab
  if (activeTabIndex === 0) { // Terms & Conditions
  // Get the clean content from the editor without any extra wrapping
  const editorContent = editors[0].innerHTML;
  // Construct the full HTML with the heading
  const fullTermsHtml = `<h3 style="margin-top: 0; color: #0b76d1; text-align: center;">Terms and Conditions</h3>${editorContent}`;
  // Save to localStorage
  localStorage.setItem('customTerms_international', fullTermsHtml);
  // Save to Firebase
  (async () => {
    try {
      const agent = getCurrentAgent();
      if (agent && agent.uid) {
        await window.firebaseDB.saveData('agents/' + agent.uid + '/data', 'customTerms_international', { value: fullTermsHtml });
      }
    } catch (error) {
      console.log('Could not save custom terms to Firebase:', error);
    }
  })();
  // Update the global variable to keep it in sync during the session
  customTerms = fullTermsHtml;
  showNotification('Terms & Conditions updated successfully!', 'success');
  } else if (activeTabIndex === 1) { // Section 1
    const section1Heading = headingInputs[1] ? headingInputs[1].value : '';
    const isSection1Disabled = localStorage.getItem('sectionDisabled_1') === 'true';
    
    if (!isSection1Disabled) {
      // Only save content if section is enabled
      let section1Content = '';
      if (section1Heading.trim() !== '') {
        let cleanSection1Content = editors[1].innerHTML.replace(/<h3[^>]*>.*?<\/h3>/gi, '');
        section1Content = `<h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px;">${section1Heading}</h3>${cleanSection1Content}`;
      } else {
        section1Content = editors[1].innerHTML;
      }
      localStorage.setItem('section1Content_international', section1Content); // Fixed key name
    } else {
      // Save empty content if section is disabled
      localStorage.setItem('section1Content_international', '<!-- SECTION 1 HIDDEN BY USER -->');
    }
    showNotification('Section 1 updated successfully!', 'success');
  } else if (activeTabIndex === 2) { // Section 2
    const section2Heading = headingInputs[2] ? headingInputs[2].value : '';
    const isSection2Disabled = localStorage.getItem('sectionDisabled_2') === 'true';
    
    if (!isSection2Disabled) {
      // Only save content if section is enabled
      let section2Content = '';
      if (section2Heading.trim() !== '') {
        let cleanSection2Content = editors[2].innerHTML.replace(/<h3[^>]*>.*?<\/h3>/gi, '');
        section2Content = `<h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px;">${section2Heading}</h3>${cleanSection2Content}`;
      } else {
        section2Content = editors[2].innerHTML;
      }
      localStorage.setItem('section2Content_international', section2Content); // Fixed key name
    } else {
      // Save empty content if section is disabled
      localStorage.setItem('section2Content_international', '<!-- SECTION 2 HIDDEN BY USER -->');
    }
    showNotification('Section 2 updated successfully!', 'success');
  }
  
  modal.classList.remove('visible');
  // Reopen the quotation modal after saving
  setTimeout(() => {
    showQuotationModal();
  }, 300);
});
modalButtons.appendChild(saveBtn);

// Add cancel button
const cancelBtn = document.createElement('button');
cancelBtn.textContent = 'Cancel';
cancelBtn.className = 'ghost';
cancelBtn.addEventListener('click', () => {
  modal.classList.remove('visible');
  // Reopen the quotation modal after canceling
  setTimeout(() => {
    showQuotationModal();
  }, 300);
});
modalButtons.appendChild(cancelBtn);

// Show modal
modal.classList.add('visible');
}

// Add this code after the existing initialization code
document.addEventListener('DOMContentLoaded', function() {
  // Load saved content for Section 1 and Section 2
  const savedSection1Content = localStorage.getItem('section1Content_international');
  const savedSection2Content = localStorage.getItem('section2Content_international');
  
  if (savedSection1Content) {
    // Set the content for Section 1
    const section1Element = document.querySelector('#section1Content_international');
    if (section1Element) {
      section1Element.innerHTML = savedSection1Content;
    }
  }
  
  if (savedSection2Content) {
    // Set the content for Section 2
    const section2Element = document.querySelector('#section2Content_international');
    if (section2Element) {
      section2Element.innerHTML = savedSection2Content;
    }
  }
  
  // Check if sections are disabled
  const isSection1Disabled = localStorage.getItem('sectionDisabled_1') === 'true';
  const isSection2Disabled = localStorage.getItem('sectionDisabled_2') === 'true';
  
  // Update toggle switches if they exist
  const toggle1 = document.getElementById('toggle_1');
  if (toggle1) {
    if (isSection1Disabled) {
      toggle1.classList.remove('active');
    } else {
      toggle1.classList.add('active');
    }
  }
  
  const toggle2 = document.getElementById('toggle_2');
  if (toggle2) {
    if (isSection2Disabled) {
      toggle2.classList.remove('active');
    } else {
      toggle2.classList.add('active');
    }
  }
});

</script>
</form>
</div>
</body>
</html>