<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agent Dashboard - Flight Connection</title>
<style>
  :root{--accent:#0b76d1;--muted:#666;--success:#28a745;--warning:#f39c12;--danger:#e74c3c;--info:#17a2b8}
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;margin:10px;color:#111}
  .wrap{max-width:1200px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 8px 24px rgba(12,20,40,0.06)}
  h1{margin:0 0 20px;font-size:24px;color:var(--accent)}
  h2{margin:0 0 15px;font-size:18px;color:var(--accent)}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px}
  .stat-card{background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,0.05);border-left:4px solid var(--accent)}
  .stat-card.success{border-left-color:var(--success)}
  .stat-card.warning{border-left-color:var(--warning)}
  .stat-card.danger{border-left-color:var(--danger)}
  .stat-card.info{border-left-color:var(--info)}
  .stat-value{font-size:28px;font-weight:bold;margin:5px 0}
  .stat-label{font-size:14px;color:var(--muted)}
  .filters-section{display:flex;gap:10px;align-items:center;margin-bottom:20px;flex-wrap:wrap;background:#f8f9fa;padding:15px;border-radius:8px}
  .filters-section input, .filters-section select{padding:8px;border:1px solid #ddd;border-radius:4px}
  .filters-section button{background:var(--accent);color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer}
  .filters-section button:hover{background:#085ea3}
  .quotation-table{width:100%;border-collapse:collapse;margin-top:15px}
  .quotation-table th, .quotation-table td{padding:10px;text-align:left;border-bottom:1px solid #eee}
  .quotation-table th{background:#f8f9fa;font-weight:bold}
  .expiring-soon{color:var(--warning);font-weight:bold}
  .expired{color:var(--danger);font-weight:bold}
  .action-buttons{display:flex;gap:5px}
  .action-buttons button{padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:12px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  .header-right{display:flex;gap:10px}
  .no-print{display:block}
  .status-select{padding:4px 8px;border:1px solid #ddd;border-radius:4px;font-size:12px;cursor:pointer}
  .quotation-type-badge{padding:2px 6px;border-radius:4px;font-size:11px;font-weight:bold;margin-left:5px}
  .umrah-badge{background:#007bff;color:white}
  .international-badge{background:#28a745;color:white}
  @media print{.no-print{display:none}}
  @media (max-width:768px){.stats-grid{grid-template-columns:1fr}.filters-section{flex-direction:column;align-items:stretch}}
  .btn-primary {
  background: linear-gradient(135deg, #0b76d1, #085ea3);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(11, 118, 209, 0.3);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #085ea3, #064c8a);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(11, 118, 209, 0.4);
}

.btn-logout {
  background: linear-gradient(135deg, #dc3545, #c82333);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
}

.btn-logout:hover {
  background: linear-gradient(135deg, #c82333, #a71e2a);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
}

.btn-action {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.2s ease;
  text-decoration: none;
  display: inline-block;
}

.btn-view {
  background: linear-gradient(135deg, #17a2b8, #138496);
  color: white;
}

.btn-view:hover {
  background: linear-gradient(135deg, #138496, #117a8b);
  transform: translateY(-1px);
}

.btn-edit {
  background: linear-gradient(135deg, #ffc107, #e0a800);
  color: #212529;
}

.btn-edit:hover {
  background: linear-gradient(135deg, #e0a800, #d39e00);
  transform: translateY(-1px);
}

.btn-delete {
  background: linear-gradient(135deg, #dc3545, #c82333);
  color: white;
}

.btn-delete:hover {
  background: linear-gradient(135deg, #c82333, #a71e2a);
  transform: translateY(-1px);
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.modal-overlay.visible {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  transform: translateY(-20px);
  transition: transform 0.3s ease;
}

.modal-overlay.visible .modal-content {
  transform: translateY(0);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.modal-title {
  font-size: 18px;
  font-weight: bold;
  color: var(--accent);
}

.modal-close {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: var(--muted);
}

.modal-body {
  margin-bottom: 20px;
}

.pagination {
  display: flex;
  justify-content: center;
  gap: 5px;
  margin-top: 20px;
}

.pagination button {
  padding: 5px 10px;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
}

.pagination button.active {
  background: var(--accent);
  color: white;
}

.pagination button:hover {
  background: #f0f0f0;
}

.search-box {
  position: relative;
  flex: 1;
  max-width: 300px;
}

.search-box input {
  width: 100%;
  padding-left: 35px;
}

.search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>Agent Dashboard</h1>
      <div class="small" id="agentInfo">Loading agent information...</div>
    </div>
    <div class="header-right no-print">
      <button onclick="showQuotationTypeModal()" class="btn-primary">Create Quotation</button>
      <button id="btnLogout" class="btn-logout">Logout</button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Quotations</div>
      <div class="stat-value" id="totalQuotations">0</div>
    </div>
    <div class="stat-card success">
      <div class="stat-label">Booked</div>
      <div class="stat-value" id="bookedQuotations">0</div>
    </div>
    <div class="stat-card info">
      <div class="stat-label">Pending</div>
      <div class="stat-value" id="pendingQuotations">0</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-label">Follow-up Required</div>
      <div class="stat-value" id="followupQuotations">0</div>
    </div>
    <div class="stat-card danger">
      <div class="stat-label">Cancelled</div>
      <div class="stat-value" id="cancelledQuotations">0</div>
    </div>
    <div class="stat-card info">
      <div class="stat-label">Expiring Soon</div>
      <div class="stat-value" id="expiringQuotations">0</div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section no-print">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="Search by client name or quotation ID...">
    </div>
    <select id="statusFilter">
      <option value="">All Status</option>
      <option value="pending">Pending</option>
      <option value="followup">Follow-up Required</option>
      <option value="booked">Booked</option>
      <option value="cancelled">Cancelled</option>
    </select>
    <select id="typeFilter">
      <option value="">All Types</option>
      <option value="umrah">Umrah</option>
      <option value="international">International</option>
    </select>
    <select id="filterPeriod">
      <option value="maximum" selected>Maximum (All Quotations)</option>
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="lastweek">Last Week</option>
      <option value="last30days">Last 30 Days</option>
      <option value="month">This Month</option>
      <option value="custom">Custom Range</option>
    </select>
    <div id="customDateRange" style="display:none; gap:10px;">
      <input type="date" id="filterStartDate">
      <input type="date" id="filterEndDate">
    </div>
    <button onclick="applyFilter()">Apply</button>
    <button onclick="resetFilter()">Reset</button>
  </div>

  <!-- Quotations Table -->
  <div class="section">
    <h2>All Quotations</h2>
    <table class="quotation-table">
      <thead>
        <tr>
          <th>Quotation #</th>
          <th>Type</th>
          <th>Client Name</th>
          <th>Destination</th>
          <th>Date Created</th>
          <th>Expiry Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="allQuotationsTableBody">
        <tr>
          <td colspan="8" style="text-align:center;">Loading quotations...</td>
        </tr>
      </tbody>
    </table>
    
    <!-- Pagination -->
    <div class="pagination no-print" id="allPagination">
      <!-- Pagination buttons will be added dynamically -->
    </div>
  </div>
</div>


<!-- Quotation Type Selection Modal (moved to end of body for proper overlay) -->
</div> <!-- close .wrap -->
<div id="quotationTypeModal" class="modal-overlay no-print">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Select Quotation Type</h3>
      <button class="modal-close" onclick="closeQuotationTypeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Choose the type of quotation you want to create:</p>
      <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
        <button class="btn-primary" onclick="createUmrahQuotation()" style="width: 100%;">
          Umrah Quotation
        </button>
        <button class="btn-primary" onclick="createInternationalQuotation()" style="width: 100%;">
          International Quotation
        </button>
      </div>
    </div>
  </div>
</div>

<script type="module">
// Dashboard JavaScript
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

let currentPage = 1;
const itemsPerPage = 10;
let filteredAllQuotations = [];
let allUmrahQuotations = [];
let allInternationalQuotations = [];

// Make functions globally accessible immediately
window.showQuotationTypeModal = function() {
  document.getElementById('quotationTypeModal').classList.add('visible');
}

window.closeQuotationTypeModal = function() {
  document.getElementById('quotationTypeModal').classList.remove('visible');
}

window.createUmrahQuotation = function() {
  window.closeQuotationTypeModal();
  localStorage.removeItem('selectedQuotationId');
  window.open('index.html', '_blank');
}

window.createInternationalQuotation = function() {
  window.closeQuotationTypeModal();
  localStorage.removeItem('selectedQuotationId');
  window.open('International Quotation Tool.html', '_blank');
}

const firebaseConfig = {
  apiKey: "AIzaSyDx3Qxt84vJlz_-mXuxiC0W2flaLadr9Ws",
  authDomain: "fc-quotation-tool.firebaseapp.com",
  projectId: "fc-quotation-tool",
  storageBucket: "fc-quotation-tool.appspot.com",
  messagingSenderId: "370566945624",
  appId: "1:370566945624:web:a84b20d5a8f99d20a6e32d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let agentProfile = null;

function checkAgentLogin(callback) {
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      showNotification("Please login to access dashboard", "error");
      setTimeout(() => {
        window.location.href = "login.html";
      }, 2000);
      return;
    }
    // Load agent profile from Firestore
    console.log('Loading profile for UID:', user.uid);
    console.log('User email:', user.email);
    try {
      const userDocRef = doc(db, "users", user.uid);
      console.log('Document reference:', userDocRef.path);
      
      const userDoc = await getDoc(userDocRef);
      console.log('User document exists:', userDoc.exists());
      
      if (userDoc.exists()) {
        agentProfile = userDoc.data();
        console.log('Loaded agent profile:', agentProfile);
        
        // Ensure agentProfile has the necessary fields for matching
        if (!agentProfile.id && agentProfile.agentId) {
          agentProfile.id = agentProfile.agentId;
        }
        if (!agentProfile.agentId && agentProfile.id) {
          agentProfile.agentId = agentProfile.id;
        }
        
        console.log('Final agent profile for matching:', {
          id: agentProfile.id,
          agentId: agentProfile.agentId,
          name: agentProfile.name
        });
        
        callback(agentProfile);
      } else {
        console.error('No profile found for UID:', user.uid);
        console.error('Document path checked:', userDocRef.path);
        
        // Try to create a temporary profile from user data
        const tempProfile = {
          id: user.email,
          name: user.email.split('@')[0],
          phone: 'Not provided',
          registeredAt: new Date().toISOString()
        };
        
        console.log('Creating temporary profile:', tempProfile);
        await setDoc(userDocRef, tempProfile);
        
        agentProfile = tempProfile;
        showNotification("Profile created from login data. Please update your details.", "warning");
        callback(agentProfile);
      }
    } catch (error) {
      console.error('Error loading profile:', error);
      console.error('Error details:', error.code, error.message);
      showNotification("Error loading profile: " + error.message, "error");
      setTimeout(() => {
        window.location.href = "login.html";
      }, 2000);
    }
  });
}

// Make other functions globally accessible for HTML onclick handlers
window.applyFilter = function() { applyFilter(); };
window.resetFilter = function() { resetFilter(); };
window.updateStatusFromTable = function(quotationId, quotationType, newStatus) { 
  updateStatusFromTable(quotationId, quotationType, newStatus); 
};
window.viewQuotation = function(quotationId, quotationType) { 
  viewQuotation(quotationId, quotationType); 
};
window.editQuotation = function(quotationId, quotationType) { 
  editQuotation(quotationId, quotationType); 
};
window.deleteQuotation = function(quotationId, quotationType) { 
  deleteQuotation(quotationId, quotationType); 
};

// Show notification function
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    z-index: 1000;
    transition: opacity 0.3s;
  `;
  
  if (type === 'error') {
    notification.style.backgroundColor = '#e74c3c';
  } else if (type === 'success') {
    notification.style.backgroundColor = '#28a745';
  } else if (type === 'warning') {
    notification.style.backgroundColor = '#f39c12';
  } else {
    notification.style.backgroundColor = '#17a2b8';
  }
  
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

// Show quotation type selection modal
function showQuotationTypeModal() {
  document.getElementById('quotationTypeModal').classList.add('visible');
}

// Close quotation type selection modal
function closeQuotationTypeModal() {
  document.getElementById('quotationTypeModal').classList.remove('visible');
}

// Create Umrah quotation
function createUmrahQuotation() {
  closeQuotationTypeModal();
  localStorage.removeItem('selectedQuotationId');
  window.open('index.html', '_blank');
}

// Create International quotation
function createInternationalQuotation() {
  closeQuotationTypeModal();
  localStorage.removeItem('selectedQuotationId');
  window.open('International Quotation Tool.html', '_blank');
}

// Load agent information

function loadAgentInfo() {
  if (agentProfile) {
    document.getElementById("agentInfo").textContent = `Logged in as: ${agentProfile.name} (${agentProfile.phone})`;
  }
}

// Load all quotations

async function loadAllQuotations() {
  if (!agentProfile) {
    console.log('No agent profile loaded yet');
    return;
  }
  
  // Show loading indicator
  const tableBody = document.getElementById('allQuotationsTableBody');
  tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Loading quotations...</td></tr>`;
  
  try {
    // Load quotations from Firebase Firestore
    const user = auth.currentUser;
    if (!user) {
      console.error('No authenticated user');
      return;
    }
    
    const quotationRef = doc(db, "quotations", user.uid);
    const quotationDoc = await getDoc(quotationRef);
    
    let allFirebaseQuotations = [];
    if (quotationDoc.exists()) {
      const data = quotationDoc.data();
      console.log('Quotations document data:', data);
      
      if (data.quotations) {
        allFirebaseQuotations = Object.values(data.quotations);
        console.log('Found quotations:', allFirebaseQuotations.length);
        
        // Log each quotation for debugging
        allFirebaseQuotations.forEach((q, index) => {
          console.log(`Quote ${index + 1}:`, {
            id: q.id,
            client: q.clientData?.name,
            agentId: q.agentData?.agentId,
            agentDataId: q.agentData?.id
          });
        });
      } else {
        console.log('No quotations field in document');
      }
    } else {
      console.log('No quotations document found for user');
    }
    
    // Filter quotations for the current agent and add type
    console.log('Filtering quotations for agent:', {
      profileId: agentProfile.id,
      profileAgentId: agentProfile.agentId,
      profileEmail: agentProfile.email
    });
    
    allUmrahQuotations = allFirebaseQuotations.filter(q => {
      if (!q.agentData) return false;
      
      // More flexible agent matching
      const agentIds = [
        agentProfile.id,
        agentProfile.agentId, 
        agentProfile.email,
        agentProfile.name
      ].filter(Boolean);
      
      const quoteIds = [
        q.agentData.id,
        q.agentData.agentId,
        q.agentData.email,
        q.agentData.name
      ].filter(Boolean);
      
      // Check if any profile ID matches any quote ID
      const match = agentIds.some(profileId => 
        quoteIds.some(quoteId => 
          profileId && quoteId && profileId.toString().toLowerCase() === quoteId.toString().toLowerCase()
        )
      );
      
      console.log('Quote match check:', {
        quoteId: q.id,
        match: match,
        profileIds: agentIds,
        quoteIds: quoteIds
      });
      return match;
    }).map(q => ({...q, type: 'umrah'}));
    
    console.log('Filtered umrah quotations:', allUmrahQuotations.length);
    
    // If no quotations match the agent filter, show all quotations as fallback
    if (allUmrahQuotations.length === 0 && allFirebaseQuotations.length > 0) {
      console.log('No agent matches found, showing all quotations as fallback');
      allUmrahQuotations = allFirebaseQuotations.map(q => ({...q, type: 'umrah'}));
    }
    
    // For now, all quotations are treated as umrah type
    // You can add logic later to distinguish between umrah and international
    allInternationalQuotations = [];
    
    console.log('About to apply filters and update display...');
    applyFilter();
    console.log('Filters applied, updating stats and table...');
    updateStatistics();
    renderQuotationsTable();
    console.log('Dashboard update complete');
    
  } catch (error) {
    console.error('Error loading quotations from Firebase:', error);
    // Fallback to localStorage if Firebase fails
    const savedUmrahQuotations = JSON.parse(localStorage.getItem('savedQuotations')) || [];
    const savedInternationalQuotations = JSON.parse(localStorage.getItem('savedQuotations_international')) || [];
    allUmrahQuotations = savedUmrahQuotations.filter(q => {
      return q.agentData && q.agentData.id === agentProfile.id;
    }).map(q => ({...q, type: 'umrah'}));
    allInternationalQuotations = savedInternationalQuotations.filter(q => {
      return q.agentData && q.agentData.id === agentProfile.id;
    }).map(q => ({...q, type: 'international'}));
    applyFilter();
  }
}

// Apply filters
function applyFilter() {
  const filterPeriod = document.getElementById('filterPeriod').value;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let startDate = new Date(today);
  let endDate = new Date(today);
  endDate.setHours(23, 59, 59, 999);
  
  if (filterPeriod === 'maximum') {
    // Set to very wide range to include all quotations
    startDate = new Date(2000, 0, 1); // January 1, 2000
    endDate = new Date();
    endDate.setFullYear(endDate.getFullYear() + 10); // 10 years in the future
  } else if (filterPeriod === 'today') {
    // Already set to today
  } else if (filterPeriod === 'yesterday') {
    startDate.setDate(today.getDate() - 1);
    endDate.setDate(today.getDate() - 1);
  } else if (filterPeriod === 'lastweek') {
    startDate.setDate(today.getDate() - 7);
    endDate.setDate(today.getDate() - 1);
  } else if (filterPeriod === 'last30days') {
    startDate.setDate(today.getDate() - 30);
    endDate.setDate(today.getDate() - 1);
  } else if (filterPeriod === 'month') {
    startDate.setDate(1);
    endDate.setMonth(today.getMonth() + 1, 0);
  } else if (filterPeriod === 'custom') {
    const customStartDate = document.getElementById('filterStartDate').value;
    const customEndDate = document.getElementById('filterEndDate').value;
    
    if (customStartDate && customEndDate) {
      startDate = new Date(customStartDate);
      endDate = new Date(customEndDate);
      endDate.setHours(23, 59, 59, 999);
    } else {
      showNotification('Please select both start and end dates', 'error');
      return;
    }
  }
  
  // Combine and filter quotations
  const allQuotations = [...allUmrahQuotations, ...allInternationalQuotations];
  filteredAllQuotations = allQuotations.filter(q => {
    const createdDate = new Date(q.createdAt);
    return createdDate >= startDate && createdDate <= endDate;
  });
  
  // Apply search and additional filters
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const statusFilter = document.getElementById('statusFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  
  filteredAllQuotations = filteredAllQuotations.filter(q => {
    const matchesSearch = !searchTerm || 
      q.id.toLowerCase().includes(searchTerm) || 
      (q.clientData.name && q.clientData.name.toLowerCase().includes(searchTerm));
    
    const matchesStatus = !statusFilter || q.status === statusFilter;
    const matchesType = !typeFilter || q.type === typeFilter;
    
    return matchesSearch && matchesStatus && matchesType;
  });
  
  // Sort by creation date (newest first)
  filteredAllQuotations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  updateStatistics();
  currentPage = 1;
  renderQuotationsTable();
}

// Reset filters
function resetFilter() {
  document.getElementById('filterPeriod').value = 'maximum';
  document.getElementById('customDateRange').style.display = 'none';
  document.getElementById('searchInput').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('typeFilter').value = '';
  applyFilter();
}

// Update statistics
function updateStatistics() {
  const total = filteredAllQuotations.length;
  const booked = filteredAllQuotations.filter(q => q.status === 'booked').length;
  const pending = filteredAllQuotations.filter(q => q.status === 'pending').length;
  const followup = filteredAllQuotations.filter(q => q.status === 'followup').length;
  const cancelled = filteredAllQuotations.filter(q => q.status === 'cancelled').length;
  
  // Calculate expiring soon (within 5 days)
  const today = new Date();
  const fiveDaysFromNow = new Date(today);
  fiveDaysFromNow.setDate(today.getDate() + 5);
  
  const expiring = filteredAllQuotations.filter(q => {
    const expiryDate = new Date(q.expiresAt);
    return expiryDate >= today && expiryDate <= fiveDaysFromNow;
  }).length;
  
  document.getElementById('totalQuotations').textContent = total;
  document.getElementById('bookedQuotations').textContent = booked;
  document.getElementById('pendingQuotations').textContent = pending;
  document.getElementById('followupQuotations').textContent = followup;
  document.getElementById('cancelledQuotations').textContent = cancelled;
  document.getElementById('expiringQuotations').textContent = expiring;
}

// Render quotations table
function renderQuotationsTable() {
  const tableBody = document.getElementById('allQuotationsTableBody');
  const quotations = filteredAllQuotations;
  
  if (quotations.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No quotations found</td></tr>`;
    document.getElementById('allPagination').innerHTML = '';
    return;
  }
  
  // Calculate pagination
  const totalPages = Math.ceil(quotations.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageQuotations = quotations.slice(startIndex, endIndex);
  
  // Clear table
  tableBody.innerHTML = '';
  
  // Add rows
  pageQuotations.forEach(quotation => {
    const row = document.createElement('tr');
    
    // Format dates
    const createdDate = new Date(quotation.createdAt).toLocaleDateString();
    const expiryDate = new Date(quotation.expiresAt).toLocaleDateString();
    
    // Check if expiring soon or expired (within 5 days)
    const today = new Date();
    const expiry = new Date(quotation.expiresAt);
    const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    
    let expiryClass = '';
    if (daysUntilExpiry < 0) {
      expiryClass = 'expired';
    } else if (daysUntilExpiry <= 5) {
      expiryClass = 'expiring-soon';
    }
    
    // Create type badge
    const typeBadge = quotation.type === 'umrah' 
      ? '<span class="quotation-type-badge umrah-badge">Umrah</span>'
      : '<span class="quotation-type-badge international-badge">International</span>';
    
    // Get destination based on type
    const destination = quotation.type === 'umrah' 
      ? 'Umrah' 
      : (quotation.clientData.tourDestination || 'N/A');
    
    // Build row HTML
    const rowHTML = `
      <td>${quotation.id}</td>
      <td>${typeBadge}</td>
      <td>${quotation.clientData.name || 'N/A'}</td>
      <td>${destination}</td>
      <td>${createdDate}</td>
      <td class="${expiryClass}">${expiryDate}</td>
      <td>
        <select class="status-select" onchange="updateStatusFromTable('${quotation.id}', '${quotation.type}', this.value)">
          <option value="pending" ${quotation.status === 'pending' ? 'selected' : ''}>Pending</option>
          <option value="followup" ${quotation.status === 'followup' ? 'selected' : ''}>Follow-up Required</option>
          <option value="booked" ${quotation.status === 'booked' ? 'selected' : ''}>Booked</option>
          <option value="cancelled" ${quotation.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
        </select>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn-action btn-view" onclick="viewQuotation('${quotation.id}', '${quotation.type}')">View</button>
          <button class="btn-action btn-edit" onclick="editQuotation('${quotation.id}', '${quotation.type}')">Edit</button>
          <button class="btn-action btn-delete" onclick="deleteQuotation('${quotation.id}', '${quotation.type}')">Delete</button>
        </div>
      </td>
    `;
    
    row.innerHTML = rowHTML;
    tableBody.appendChild(row);
  });
  
  // Render pagination
  renderPagination(totalPages);
}

// Render pagination
function renderPagination(totalPages) {
  const pagination = document.getElementById('allPagination');
  pagination.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  // Previous button
  const prevBtn = document.createElement('button');
  prevBtn.textContent = 'Previous';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      renderQuotationsTable();
    }
  };
  pagination.appendChild(prevBtn);
  
  // Page numbers
  for (let i = 1; i <= totalPages; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.textContent = i;
    pageBtn.className = i === currentPage ? 'active' : '';
    pageBtn.onclick = () => {
      currentPage = i;
      renderQuotationsTable();
    };
    pagination.appendChild(pageBtn);
  }
  
  // Next button
  const nextBtn = document.createElement('button');
  nextBtn.textContent = 'Next';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderQuotationsTable();
    }
  };
  pagination.appendChild(nextBtn);
}

// Update status from table
async function updateStatusFromTable(quotationId, quotationType, newStatus) {
  try {
    const user = auth.currentUser;
    if (!user) {
      showNotification('Please login to update quotation status', 'error');
      return;
    }
    
    const quotationRef = doc(db, "quotations", user.uid);
    const quotationDoc = await getDoc(quotationRef);
    
    if (quotationDoc.exists()) {
      const data = quotationDoc.data();
      const quotations = data.quotations || {};
      
      if (quotations[quotationId]) {
        quotations[quotationId].status = newStatus;
        quotations[quotationId].updatedAt = new Date().toISOString();
        
        await setDoc(quotationRef, { quotations }, { merge: true });
        
        loadAllQuotations();
        showNotification('Status updated successfully', 'success');
      } else {
        showNotification('Quotation not found', 'error');
      }
    }
  } catch (error) {
    console.error('Error updating quotation status:', error);
    showNotification('Failed to update status', 'error');
  }
}

function viewQuotation(quotationId, quotationType) {
  localStorage.setItem('selectedQuotationId', quotationId);
  
  if (quotationType === 'umrah') {
    window.open('index.html?view=' + quotationId, '_blank');
  } else {
    window.open('International Quotation Tool.html?view=' + quotationId, '_blank');
  }
}

function editQuotation(quotationId, quotationType) {
  localStorage.setItem('selectedQuotationId', quotationId);
  
  if (quotationType === 'umrah') {
    window.open('index.html?edit=' + quotationId, '_blank');
  } else {
    window.open('International Quotation Tool.html?edit=' + quotationId, '_blank');
  }
}

async function deleteQuotation(quotationId, quotationType) {
  if (confirm('Are you sure you want to delete this quotation?')) {
    try {
      const user = auth.currentUser;
      if (!user) {
        showNotification('Please login to delete quotations', 'error');
        return;
      }
      
      const quotationRef = doc(db, "quotations", user.uid);
      const quotationDoc = await getDoc(quotationRef);
      
      if (quotationDoc.exists()) {
        const data = quotationDoc.data();
        const quotations = data.quotations || {};
        
        if (quotations[quotationId]) {
          delete quotations[quotationId];
          await setDoc(quotationRef, { quotations }, { merge: true });
          
          loadAllQuotations();
          showNotification('Quotation deleted successfully', 'success');
        } else {
          showNotification('Quotation not found', 'error');
        }
      }
    } catch (error) {
      console.error('Error deleting quotation:', error);
      showNotification('Failed to delete quotation', 'error');
    }
  }
}

// Event listeners
document.getElementById('filterPeriod').addEventListener('change', function() {
  const customDateRange = document.getElementById('customDateRange');
  if (this.value === 'custom') {
    customDateRange.style.display = 'flex';
  } else {
    customDateRange.style.display = 'none';
  }
});

document.getElementById('searchInput').addEventListener('input', applyFilter);
document.getElementById('statusFilter').addEventListener('change', applyFilter);
document.getElementById('typeFilter').addEventListener('change', applyFilter);

document.getElementById('btnLogout').addEventListener('click', function() {
  if (confirm('Are you sure you want to logout?')) {
    signOut(auth).then(() => {
      localStorage.removeItem("selectedQuotationId");
      showNotification('Logged out successfully', 'success');
      setTimeout(() => {
        window.location.href = "login.html";
      }, 1000);
    });
  }
});


// Initialize dashboard with Firebase Auth session
document.addEventListener('DOMContentLoaded', function() {
  checkAgentLogin(() => {
    loadAgentInfo();
    loadAllQuotations();
    if (sessionStorage.getItem('refreshDashboard')) {
      sessionStorage.removeItem('refreshDashboard');
      loadAllQuotations();
    }
  });
});
</script>
</body>

</html>

