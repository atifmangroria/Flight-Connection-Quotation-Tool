<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Umrah Quotation Tool — Flight Connection</title>

<!-- Libraries for PDF/Image/Excel -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDx3Qxt84vJlz_-mXuxiC0W2flaLadr9Ws",
    authDomain: "fc-quotation-tool.firebaseapp.com",
    projectId: "fc-quotation-tool",
    storageBucket: "fc-quotation-tool.firebasestorage.app",
    messagingSenderId: "370566945624",
    appId: "1:370566945624:web:a84b20d5a8f99d20a6e32d"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Make db and auth global
  window.db = db;
  window.auth = auth;

  // ========== Firebase Cloud Storage Utility Functions ==========
  window.firebaseDB = {
    // Save data to Firestore
    async saveData(collection_name, docId, data) {
      try {
        await setDoc(doc(db, collection_name, docId), data, { merge: true });
        return true;
      } catch (error) {
        console.error(`Error saving to ${collection_name}:`, error);
        return false;
      }
    },

    // Get data from Firestore
    async getData(collection_name, docId) {
      try {
        const docSnap = await getDoc(doc(db, collection_name, docId));
        return docSnap.exists() ? docSnap.data() : null;
      } catch (error) {
        console.error(`Error getting from ${collection_name}:`, error);
        return null;
      }
    },

    // Get all documents from a collection
    async getAll(collection_name) {
      try {
        const snapshot = await getDocs(collection(db, collection_name));
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error(`Error getting all from ${collection_name}:`, error);
        return [];
      }
    },

    // Delete data from Firestore
    async deleteData(collection_name, docId) {
      try {
        await deleteDoc(doc(db, collection_name, docId));
        return true;
      } catch (error) {
        console.error(`Error deleting from ${collection_name}:`, error);
        return false;
      }
    },

    // Update specific fields
    async updateData(collection_name, docId, updates) {
      try {
        await updateDoc(doc(db, collection_name, docId), updates);
        return true;
      } catch (error) {
        console.error(`Error updating ${collection_name}:`, error);
        return false;
      }
    }
  };

  // Make collection functions available
  window.collection = collection;
  window.doc = doc;
  window.deleteDoc = deleteDoc;
  window.updateDoc = updateDoc;
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
  :root{--accent:#0b76d1;--muted:#666;--success-bg:#d4edda;--success-text:#155724;--error-bg:#f8d7da;--error-text:#721c24}
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;margin:10px;color:#111}
  .wrap{max-width:1150px;margin:0 auto;background:#fff;padding:14px;border-radius:8px;box-shadow:0 8px 24px rgba(12,20,40,0.06)}
  h1{margin:0 0 6px;font-size:20px}
  label{display:block;font-size:13px;color:#222;margin-top:8px}
  input,select,textarea,button{font-family:inherit}
input[type="text"], input[type="number"], input[type="date"], input[type="password"], select, textarea{
  width:100%;padding:10px 12px;border:1px solid #d6dbe2;border-radius:6px;font-size:14px;background:#fff;
  box-sizing:border-box;transition:border-color 0.3s ease, box-shadow 0.3s ease;
}
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="password"]:focus, select:focus, textarea:focus{
  border-color:var(--accent);box-shadow:0 0 0 3px rgba(11, 118, 209, 0.1);outline:none;
}
  textarea{min-height:70px;resize:vertical}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .full{grid-column:1/-1}
  .section{border:1px solid #e6eef8;padding:12px;border-radius:8px;margin-top:12px;background:#fbfdff}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--accent);color:#fff;border:0;padding:8px 8px;border-radius:6px;cursor:pointer;transition:background-color 0.2s}
  button.ghost{background:#eef5fb;color:var(--accent);border:1px solid #d6e8fb}
  button:hover{background-color: #085ea3;}
  button.ghost:hover{background-color: #d6e8fb;}
  .small{font-size:12px;color:var(--muted)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header img{height:56px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:6px;border-bottom:1px solid #eee;font-size:13px;text-align:left}
  .saved-list{max-height:220px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px}
  .no-print{display:block}
  .center{text-align:center}
  pre{background:#ffffff;padding:8px;border-radius:6px;border:1px solid #eee;white-space:pre-wrap}
  
  .input-error { border: 2px solid red !important; }
  .flight-header, .hotel-header, .transfer-header, .visa-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .flight-header h3, .hotel-header h3, .transfer-header h3, .visa-header h3 { margin: 0; }
  .add-btn { background: #4CAF50; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; }
  .add-btn:hover { background: #45a049; }
  .remove-btn { background: #e74c3c; color: #fff; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px; }
  .remove-btn:hover { background: #c0392b; }
  
/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal-overlay.visible {
  opacity: 1;
  visibility: visible;
}
.modal-content {
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  max-width: 600px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  transform: translateY(-20px);
  transition: transform 0.3s ease;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-overlay.visible .modal-content {
  transform: translateY(0);
}
.modal-content h3 {
  margin: 0 0 10px;
  font-size: 22px;
  color: #333;
}
.modal-content p {
  color: #666;
  margin-bottom: 20px;
}
.modal-buttons button {
  padding: 10px 20px;
  font-size: 14px;
  margin: 5px;
}
#registerModal .modal-content {
  max-width: 500px;
}

#registerModal .grid {
  gap: 15px;
  margin-top: 15px;
}

#registerModal input {
  margin-bottom: 5px;
}

.upgrade-flight-costs {
  background: #f8f9fa;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.upgrade-flight-costs h5 {
  margin: 0 0 10px 0;
  font-size: 14px;
}

.upgrade-difference {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

  /* Temporary Notification Styles */
  .temp-notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .temp-notification-overlay.visible {
    opacity: 1;
    visibility: visible;
  }
  .temp-notification {
    background: #ffff;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    color: #333;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    min-width: 300px;
    font-size: 16px;
  }
  .temp-notification-overlay.visible .temp-notification {
    transform: scale(1);
  }
  .temp-notification.success { background-color: var(--success-bg); color: var(--success-text); border: 2px solid #28a745; }
  .temp-notification.error { background-color: var(--error-bg); color: var(--error-text); border: 2px solid #dc3545; }
  .temp-notification.info { background-color: #e2f2ff; color: #004085; border: 2px solid #007bff; }

  /* Add-ons Section Styles */
  .addon-header {
    background:#f5f5f5;
    padding:8px 12px;
    cursor:pointer;
    border-radius:6px;
    margin-top:6px;
    font-weight:bold;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .addon-panel {
    padding:8px 12px;
    border:1px solid #ddd;
    border-radius:6px;
    margin-top:4px;
  }
  .panel-icon {
    font-weight:bold;
  }
  .green-btn { background:#4CAF50; }
  .green-btn:hover { background:#45a049; }
  .orange-btn { background:#f39c12; }
  .orange-btn:hover { background:#d68910; }
  .blue-btn { background:#3498db; }
  .blue-btn:hover { background:#2980b9; }
  .whatsapp-btn { background:#25D366; }
  .whatsapp-btn:hover { background:#128C7E; }
  
  .section-entry { border:1px solid #ddd; padding:10px; margin-top:8px; border-radius:6px; }
  .section-entry h4 { display:flex; justify-content:space-between; align-items:center; margin:0 0 6px 0; }
  .inline-input { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .inline-input input { width:120px; }
  .inline-input label { width:140px; }

  <!-- Add this after your existing header >
<div class="progress-container no-print">
  <div class="progress-bar">
    <div class="progress-step active" data-step="1">1. Client Info</div>
    <div class="progress-step" data-step="2">2. Flights</div>
    <div class="progress-step" data-step="3">3. Hotels</div>
    <div class="progress-step" data-step="4">4. Add-ons</div>
    <div class="progress-step" data-step="5">5. Calculate</div>
  </div>
</div>

  /* Quotation Search Styles */
  .search-container {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
  }
  .search-input {
    flex: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .search-btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
  }
  .search-btn:hover {
    background: #085ea3;
  }

  /* Terms Edit Styles */
  .terms-editor {
    width: 100%;
    min-height: 200px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 15px;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }

  /* Certifications Styles */
  .certifications {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  .certification {
    text-align: center;
    margin: 10px;
    max-width: 150px;
  }
  .certification img {
    max-width: 100px;
    max-height: 100px;
    margin-bottom: 5px;
  }
  .certification p {
    font-size: 12px;
    margin: 0;
  }

  /* Add this at the end of your existing CSS */
@media (max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
  }
  
  .modal-content {
    width: 95%;
    max-height: 90vh;
    padding: 15px;
  }
  
  .actions {
    flex-direction: column;
  }
  
  button {
    width: 100%;
    margin-bottom: 8px;
  }
  
  .inline-input {
    flex-direction: column;
    align-items: stretch;
  }
  
  .inline-input label {
    margin-bottom: 5px;
  }
/* Progress Bar */
.progress-container {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.progress-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #e9ecef;
  padding: 10px;
  border-radius: 25px;
  position: relative;
}

.progress-step {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
  color: #6c757d;
  background: white;
  border: 2px solid #dee2e6;
  position: relative;
  z-index: 1;
}

.progress-step.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

.progress-step.completed {
  background: #28a745;
  color: white;
  border-color: #28a745;
}

.progress-step::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 100%;
  width: 20px;
  height: 2px;
  background: #dee2e6;
  z-index: 0;
}

.progress-step:last-child::after {
  display: none;
}

}

  @media (max-width:800px){ .grid{grid-template-columns:1fr} }
  @media print{ .no-print{display:none} }

#calcSummaryTable thead th {
  background-color: #0b76d1;
  color: white;
  font-weight: bold;
}

#calcSummaryTable tfoot tr {
  border-top: 2px solid #0b76d1;
}

.package-total-row {
  background-color: #e3f2fd !important;
}

.addon-header-row {
  background-color: #f8f9fa !important;
  text-align: center;
  font-style: italic;
}

/* Rich Text Editor Styles */
.rich-editor-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 10px;
  background: #f5f5f5;
  border: 1px solid #ddd;
  border-bottom: none;
  border-radius: 6px 6px 0 0;
}

/* Rich Text Editor Styles */
.rich-editor-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 10px;
  background: #f5f5f5;
  border: 1px solid #ddd;
  border-bottom: none;
  border-radius: 6px 6px 0 0;
}

.rich-editor-btn {
  padding: 8px 12px;
  border: 1px solid #1a237e;
  background: #1a237e; /* Navy blue background */
  cursor: pointer;
  border-radius: 4px;
  font-size: 14px;
  font-weight: bold;
  transition: all 0.2s;
  min-width: 30px;
  text-align: center;
  color: white !important; /* White text for contrast */
  background-image: none !important; /* Remove any background images */
  box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3); /* Navy shadow */
}

.rich-editor-btn:hover {
  background: #283593; /* Slightly lighter navy on hover */
  border-color: #3949ab;
  transform: translateY(-1px); /* Slight lift effect */
  box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
}

.rich-editor-btn.active {
  background: #0d47a1; /* Darker navy for active state */
  color: white !important;
  border-color: #0d47a1;
  box-shadow: 0 2px 6px rgba(13, 71, 161, 0.4);
  border: 1px solid #0d47a1;
}

.rich-editor-separator {
  width: 1px;
  background: #ccc;
  margin: 0 5px;
}

/* Specific fixes for button text */
.rich-editor-btn::before,
.rich-editor-btn::after {
  content: none !important; /* Remove any pseudo-elements */
}

/* Force the button text to show correctly */
.rich-editor-btn:empty::before {
  content: attr(title);
  font-size: 12px;
}

/* Section Toggle Styles */
.section-toggle-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
  padding: 10px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
}

.section-toggle-label {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: bold;
  color: #333;
}

.toggle-switch {
  position: relative;
  width: 50px;
  height: 24px;
  background: #ccc;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.3s;
}

.toggle-switch.active {
  background: var(--accent);
}

.toggle-switch::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  transition: transform 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch.active::after {
  transform: translateX(26px);
}

.section-disabled {
  opacity: 0.5;
  pointer-events: none;
}

.section-status {
  font-size: 12px;
  color: #666;
  font-style: italic;
}

/* Login Panel Specific Styles */
#loginPanel {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 20px;
  margin-top: 15px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

#loginPanel .grid {
  gap: 15px;
}

#loginPanel label {
  font-weight: 600;
  color: #495057;
  margin-bottom: 5px;
}

#loginPanel input[type="text"],
#loginPanel input[type="password"] {
  height: 44px;
  font-size: 14px;
  border: 1px solid #ced4da;
  background: #fff;
}

#loginPanel input[type="text"]:hover,
#loginPanel input[type="password"]:hover {
  border-color: #adb5bd;
}

#loginPanel .actions {
  margin-top: 20px;
}

#loginPanel button {
  height: 44px;
  font-size: 14px;
  font-weight: 600;
  padding: 0 24px;
  border-radius: 6px;
  transition: all 0.3s ease;
}

#loginPanel button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(11, 118, 209, 0.3);
}

#loginPanel .small {
  color: #6c757d;
  font-size: 12px;
  line-height: 1.4;
  margin-top: 10px;
  padding: 8px 12px;
  background: #e9ecef;
  border-radius: 4px;
}

/* Add this to your main <style> section */
@media print {
  * {
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
}

@media print {
  button[onclick*="toggle"] {
    display: none !important;
  }
}

</style>
</head>
<body>

<!-- Temporary Notification HTML -->
<div id="temp-notification-overlay" class="temp-notification-overlay no-print">
  <div id="temp-notification" class="temp-notification"></div>
</div>

<div id="custom-modal" class="modal-overlay no-print">
  <div class="modal-content">
    <h3 id="modal-title"></h3>
    <p id="modal-message"></p>
    <div id="modal-buttons" class="modal-buttons"></div>
  </div>
</div>

<div class="wrap">

<!-- HEADER -->
<div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
  <div>
    <h1>Umrah Quotation</h1>
    <div class="small">Use Chrome/Edge.</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center" class="no-print">
    <div id="agentInfoDisplay" class="small"></div>
    <button id="btnSaveQuotation" class="ghost">Save Quotation</button>
    <button id="btnLoadQuotation" class="ghost">Load Quotation</button>
    <button id="btnDashboard" class="ghost">Dashboard</button>
  </div>
</div>

  <script>
    // --- Custom UI functions for Notifications and Modals ---
    const tempNotificationOverlay = document.getElementById("temp-notification-overlay");
    const tempNotification = document.getElementById("temp-notification");

    function showNotification(message, type = 'info', duration = 3000) {
        tempNotification.textContent = message;
        tempNotification.className = `temp-notification ${type}`;
        tempNotificationOverlay.classList.add("visible");

        setTimeout(() => {
            tempNotificationOverlay.classList.remove("visible");
        }, duration);
    }
    
    const customModal = document.getElementById("custom-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalMessage = document.getElementById("modal-message");
    const modalButtons = document.getElementById("modal-buttons");

    function showAlert(message, title = 'Alert') {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            const okBtn = document.createElement("button");
            okBtn.textContent = 'OK';
            okBtn.addEventListener("click", () => {
                customModal.classList.remove("visible");
                resolve();
            });
            modalButtons.appendChild(okBtn);
            customModal.classList.add("visible");
        });
    }

    function showConfirm(message, title = 'Confirm') {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            const yesBtn = document.createElement("button");
            yesBtn.textContent = 'Yes';
            yesBtn.addEventListener("click", () => {
                customModal.classList.remove("visible");
                resolve(true);
            });
            const noBtn = document.createElement("button");
            noBtn.textContent = 'No';
            noBtn.classList.add("ghost");
            noBtn.addEventListener("click", () => {
                customModal.classList.remove("visible");
                resolve(false);
            });
            modalButtons.appendChild(yesBtn);
            modalButtons.appendChild(noBtn);
            customModal.classList.add("visible");
        });
    }
    
    // --- SIMPLE AUTHENTICATION CHECK ---
function checkAuthentication() {
  let agent = null;
  const user = auth.currentUser;
  if (user) {
    // Get agent data from Firestore
    return db.collection('agents').doc(user.uid).get().then(doc => {
      if (doc.exists) {
        agent = { uid: user.uid, ...doc.data() };
        return agent;
      } else {
        showNotification("Agent data not found", "error");
        return null;
      }
    });
  } else {
    // Check localStorage for predefined
    agent = JSON.parse(localStorage.getItem("loggedInAgent"));
    if (!agent) {
      showNotification("Please login to access the quotation tool", "error");
      setTimeout(() => {
        window.location.href = 'dashboard.html';
      }, 2000);
      return null;
    }
    return agent;
  }
}

// Add these missing helper functions
function getCurrentAgent() {
  const agentData = localStorage.getItem("loggedInAgent");
  return agentData ? JSON.parse(agentData) : null;
}

// Save data to Firebase Cloud (async)
async function saveToFirebase(key, data) {
  try {
    const agent = getCurrentAgent();
    if (!agent || !agent.uid) {
      console.warn('User not authenticated, falling back to localStorage');
      localStorage.setItem(key, JSON.stringify(data));
      return true;
    }
    
    // Save to Firestore under user's data collection
    await window.firebaseDB.saveData('agents/' + agent.uid + '/data', key, { value: data, updatedAt: new Date() });
    return true;
  } catch (error) {
    console.error('Error saving to Firebase:', error);
    // Fallback to localStorage
    localStorage.setItem(key, JSON.stringify(data));
    return false;
  }
}

// Synchronous wrapper for compatibility
function saveToLocalStorage(key, data) {
  // This now tries Firebase first, falls back to localStorage
  saveToFirebase(key, data).catch(err => {
    console.error('Failed to save:', err);
  });
  // Also keep in localStorage for immediate access
  try {
    localStorage.setItem(key, JSON.stringify(data));
    return true;
  } catch (error) {
    console.error('Error saving to localStorage:', error);
    return false;
  }
}

function showStatusSection() {
  // This function shows the status section - simplified version
  const statusSection = document.getElementById('statusSection');
  if (statusSection) {
    statusSection.style.display = 'block';
  }
}

function formatDateToDMY(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const day = date.getDate().toString().padStart(2, '0');
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// --- AGENT UI UPDATE ---
function updateAgentUI() {
  const agent = JSON.parse(localStorage.getItem("loggedInAgent"));
  const agentInfoDisplay = document.getElementById("agentInfoDisplay");
  const agentNameDisplay = document.getElementById("agentNameDisplay");
  const agentPhoneDisplay = document.getElementById("agentPhoneDisplay");
  const btnSaveQuotation = document.getElementById("btnSaveQuotation");
  
  if (agent) {
    if (agentInfoDisplay) agentInfoDisplay.innerText = `Logged in as: ${agent.name} (${agent.phone})`;
    if (agentNameDisplay) agentNameDisplay.textContent = agent.name;
    if (agentPhoneDisplay) agentPhoneDisplay.textContent = agent.phone;
    if (btnSaveQuotation) btnSaveQuotation.style.display = "inline-block";

        // Add this at the end of the function
    showStatusSection();
  } else {
    if (agentInfoDisplay) agentInfoDisplay.innerText = "";
    if (agentNameDisplay) agentNameDisplay.textContent = '—';
    if (agentPhoneDisplay) agentPhoneDisplay.textContent = '';
    if (btnSaveQuotation) btnSaveQuotation.style.display = "none";
  }
}

// --- DASHBOARD BUTTON ---
document.getElementById('btnDashboard').addEventListener('click', () => {
  window.location.href = 'dashboard.html';
});

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', function() {
  checkAuthentication().then(agent => {
    if (agent) {
      // Ensure localStorage has agent
      localStorage.setItem("loggedInAgent", JSON.stringify(agent));
      updateAgentUI();
      
      // Load quotations from Firebase
      window.firebaseDB.getData('umrah_quotations', agent.id).then(firebaseData => {
        if (firebaseData && firebaseData.quotations) {
          localStorage.setItem('savedQuotations', JSON.stringify(firebaseData.quotations));
          savedQuotations = firebaseData.quotations;
        }
      }).catch(err => console.error('Load error:', err));
      
      // Clear any old quotation IDs to prevent errors
      localStorage.removeItem('selectedQuotationId');
      localStorage.removeItem('umrahSelectedQuotationId');
      
      // Show status section
      showStatusSection();
    }
  });
});

  </script>

  <!-- MAIN FORM -->
  <form id="mainForm" onsubmit="return false;">

    <!-- COMPANY HEADER / AGENT -->
    <div class="section">
      <header style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="companyLogo" src="https://flightconnection.net.pk/wp-content/uploads/2018/09/cropped-cropped-Flight-Connection-Travel-1.png" alt="logo">
        </div>
        <div style="text-align:right">
          <div id="agentNameDisplay" style="font-weight:700">—</div>
          <div id="agentPhoneDisplay" class="small"></div>
        </div>
      </header>
    </div>


  <!-- CLIENT & PAX -->
<div class="section">
  <h3>Client & Pax</h3>
  <div class="grid">
    <div>
      <label for="clientName">Client Name</label>
      <input id="clientName" type="text" aria-required="true">
    </div>
    <div>
      <label for="reference">Reference</label>
      <select id="reference" aria-required="true">
        <option value="">-- Select --</option>
        <option value="Campaign">Campaign</option>
        <option value="Walkin">Walkin</option>
        <option value="Call">Call</option>
        <option value="Careoff">Careoff</option>
      </select>
    </div>

    <div id="refExtraDiv" class="full" style="display:none">
      <label id="refExtraLabel"></label>
      <input id="refExtra" type="text">
    </div>

    <div>
      <label for="clientPhone">Phone Number</label>
      <input id="clientPhone" type="text" aria-required="true">
    </div>
    <div>
      <label for="depCity">Departure City</label>
      <select id="depCity" aria-required="true">
        <option>Karachi</option>
        <option>Islamabad</option>
        <option>Lahore</option>
        <option>Multan</option>
        <option>Peshawar</option>
      </select>
    </div>

    <div>
      <label for="numAdult">Adults</label>
      <input id="numAdult" type="number" value="1" min="0" aria-required="true">
    </div>
    <div>
      <label for="numChildBed">Children (With Bed)</label>
      <input id="numChildBed" type="number" value="0" min="0">
    </div>
    <div>
      <label for="numChildNoBed">Children (Without Bed)</label>
      <input id="numChildNoBed" type="number" value="0" min="0">
    </div>
    <div>
      <label for="numInfant">Infants</label>
      <input id="numInfant" type="number" value="0" min="0">
    </div>

    <div class="full">
      <label for="dateFrom">Travel Dates (From — To)</label>
      <div style="display:flex;gap:8px">
        <input id="dateFrom" type="date" aria-required="true">
        <input id="dateTo" type="date" aria-required="true">
      </div>
      <div id="dateWarning" class="small" style="margin-top:6px;color:red;display:none" role="alert">
        Please select valid dates. "From" cannot be before today. "To" must be after "From".
      </div>
      <div id="dateSummary" class="small" style="margin-top:6px;font-weight:bold;color:green;display:none"></div>
    </div>

    <div>
      <label for="nightsMakkah">Number of nights in Makkah</label>
      <input id="nightsMakkah" type="number" value="0" min="0" aria-required="true">
    </div>
    <div>
      <label for="nightsMadina">Number of nights in Madina</label>
      <input id="nightsMadina" type="number" value="0" min="0" aria-required="true">
    </div>
  </div>
  <div id="nightsWarning" class="small" style="margin-top:6px;color:red;display:none" role="alert">
    Total nights in Makkah + Madina must match Travel duration.
  </div>

  <div class="actions" style="margin-top:10px">
    <button id="btnSaveClient" type="button">Save Client & Pax</button>
    <button id="btnCheckClient" type="button">Check Data</button>
  </div>

  <!-- Output data -->
  <pre id="outputData" style="margin-top:10px;padding:10px;border:1px solid #ccc;background:#f9f9f9;display:none"></pre>
</div>

<script>
  // A global flag to track if Client & Pax data has been saved.
  let isClientDataSaved = false;
  let lastSavedPax = {};
  let lastSavedDates = {};
  let lastSavedClientInfo = {};
  let currentQuotationId = null;
  let savedQuotations = [];

  // Format date to DD/MM/YYYY
  function formatDateToDMY(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // Sanitize input to prevent XSS
  function sanitizeInput(input) {
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
  }

  // Reference logic
  const reference = document.getElementById("reference");
  const refExtraDiv = document.getElementById("refExtraDiv");
  const refExtraLabel = document.getElementById("refExtraLabel");

  reference.addEventListener("change", () => {
    if (reference.value === "Campaign") {
      refExtraDiv.style.display = "block";
      refExtraLabel.innerText = "Campaign Name";
    } else if (reference.value === "Careoff") {
      refExtraDiv.style.display = "block";
      refExtraLabel.innerText = "Person Name (Careoff)";
    } else {
      refExtraDiv.style.display = "none";
      refExtraLabel.innerText = "";
    }
  });

  // Date validation
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");
  const dateWarning = document.getElementById("dateWarning");
  const dateSummary = document.getElementById("dateSummary");

  function updateDateSummary() {
    if (dateFrom.value && dateTo.value && dateTo.value > dateFrom.value) {
      const d1 = new Date(dateFrom.value);
      const d2 = new Date(dateTo.value);
      const diffNights = Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
      const totalDays = diffNights + 1;
      dateSummary.style.display = "block";
      dateSummary.innerText = `Total: ${diffNights} Nights / ${totalDays} Days (${formatDateToDMY(dateFrom.value)} - ${formatDateToDMY(dateTo.value)})`;
    } else {
      dateSummary.style.display = "none";
    }
  }

  dateFrom.addEventListener("change", () => {
    const today = new Date().toISOString().split("T")[0];
    if (dateFrom.value < today) {
      dateWarning.style.display = "block";
      dateFrom.classList.add("input-error");
    } else {
      dateWarning.style.display = "none";
      dateFrom.classList.remove("input-error");
      dateTo.min = dateFrom.value;
    }
    updateDateSummary();
    validateNights();
    if(isClientDataSaved) {
      checkDateChanges();
    }
  });

  dateTo.addEventListener("change", () => {
    if (dateTo.value <= dateFrom.value) {
      dateWarning.style.display = "block";
      dateTo.classList.add("input-error");
    } else {
      dateWarning.style.display = "none";
      dateTo.classList.remove("input-error");
    }
    updateDateSummary();
    validateNights();
    if(isClientDataSaved) {
      checkDateChanges();
    }
  });

  // Nights validation
  const nightsMakkah = document.getElementById("nightsMakkah");
  const nightsMadina = document.getElementById("nightsMadina");
  const nightsWarning = document.getElementById("nightsWarning");

  function validateNights() {
    if (dateFrom.value && dateTo.value) {
      const d1 = new Date(dateFrom.value);
      const d2 = new Date(dateTo.value);
      const diffDays = Math.round((d2 - d1) / (1000 * 60 * 60 * 24)); // nights
      const totalNights = parseInt(nightsMakkah.value || 0) + parseInt(nightsMadina.value || 0);

      if (totalNights !== diffDays) {
        nightsWarning.style.display = "block";
        nightsMakkah.classList.add("input-error");
        nightsMadina.classList.add("input-error");
        return false;
      } else {
        nightsWarning.style.display = "none";
        nightsMakkah.classList.remove("input-error");
        nightsMadina.classList.remove("input-error");
        return true;
      }
    }
    return false;
  }

  nightsMakkah.addEventListener("input", validateNights);
  nightsMadina.addEventListener("input", validateNights);

  // --- SAVE CLIENT & PAX DATA WITH VALIDATION ---
  const btnSaveClient = document.getElementById("btnSaveClient");

  async function validateAndSaveClientData() {
    let isValid = true;
    let errorMessage = "";

    // Function to clear all input error classes
    function clearErrors() {
      const inputs = document.querySelectorAll('#mainForm input, #mainForm select');
      inputs.forEach(input => input.classList.remove('input-error'));
      document.getElementById('nightsWarning').style.display = 'none';
      document.getElementById('dateWarning').style.display = 'none';
    }

    clearErrors();

    const clientName = document.getElementById("clientName");
    const reference = document.getElementById("reference");
    const clientPhone = document.getElementById("clientPhone");
    const numAdult = document.getElementById("numAdult");
    const dateFrom = document.getElementById("dateFrom");
    const dateTo = document.getElementById("dateTo");
    const nightsMakkah = document.getElementById("nightsMakkah");
    const nightsMadina = document.getElementById("nightsMadina");
    
    // Check fields and set isValid flag
    if (!clientName.value.trim()) {
      clientName.classList.add('input-error');
      errorMessage += "Client Name is required.\n";
      isValid = false;
    }

    if (reference.value === "") {
      reference.classList.add('input-error');
      errorMessage += "Reference is required.\n";
      isValid = false;
    }

    if (!clientPhone.value.trim()) {
      clientPhone.classList.add('input-error');
      errorMessage += "Phone Number is required.\n";
      isValid = false;
    }

    if (parseInt(numAdult.value) < 1) {
      numAdult.classList.add('input-error');
      errorMessage += "At least 1 Adult must be entered.\n";
      isValid = false;
    }

    if (!dateFrom.value || !dateTo.value) {
      dateFrom.classList.add('input-error');
      dateTo.classList.add('input-error');
      errorMessage += "Travel Dates are required.\n";
      isValid = false;
    }

    // Call the existing nights validation and check its result
    if (!validateNights()) {
      errorMessage += "Total nights in Makkah and Madina must match the travel duration.\n";
      isValid = false;
    }

    if (isValid) {
      const clientData = {
        name: sanitizeInput(clientName.value.trim()),
        reference: sanitizeInput(reference.value),
        refExtra: sanitizeInput(document.getElementById("refExtra").value.trim()),
        phone: sanitizeInput(clientPhone.value.trim()),
        depCity: sanitizeInput(document.getElementById("depCity").value),
        adults: parseInt(numAdult.value || 0),
        childBed: parseInt(document.getElementById("numChildBed").value || 0),
        childNoBed: parseInt(document.getElementById("numChildNoBed").value || 0),
        infants: parseInt(document.getElementById("numInfant").value || 0),
        dateFrom: dateFrom.value,
        dateTo: dateTo.value,
        nightsMakkah: parseInt(nightsMakkah.value || 0),
        nightsMadina: parseInt(nightsMadina.value || 0),
      };

      try {
  saveToLocalStorage("savedClientData", clientData);
  showNotification("Client & Pax data saved successfully!", 'success');
} catch (error) {
  showAlert("Failed to save data: " + error.message, "Error");
}
      isClientDataSaved = true;

      // Update the last saved data for change detection
      lastSavedPax = getCurrentPaxData();
      lastSavedDates = { dateFrom: dateFrom.value, dateTo: dateTo.value };
      lastSavedClientInfo = { name: clientName.value, phone: clientPhone.value };
      
    } else {
      showAlert(errorMessage, "Validation Error");
      isClientDataSaved = false;
    }
  }

  btnSaveClient.addEventListener("click", validateAndSaveClientData);

  // --- CHECK CLIENT DATA ---
  const btnCheckClient = document.getElementById("btnCheckClient");
  const outputData = document.getElementById("outputData");

  btnCheckClient.addEventListener("click", () => {
    const saved = localStorage.getItem("savedClientData");
    if (saved) {
      outputData.style.display = "block";
      outputData.textContent = saved;
    } else {
      outputData.style.display = "block";
      outputData.textContent = "No data saved yet!";
    }
  });

  // Event listeners for PAX changes
  const paxInputs = ['numAdult', 'numChildBed', 'numChildNoBed', 'numInfant'];
  paxInputs.forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
      if (isClientDataSaved) {
        checkPaxChanges();
      }
    });
  });

  // Event listeners for Client Info changes
  const clientInfoInputs = ['clientName', 'clientPhone'];
  clientInfoInputs.forEach(id => {
    document.getElementById(id).addEventListener('input', () => {
      if (isClientDataSaved) {
        checkClientInfoChanges();
      }
    });
  });

  // Event listeners for Date changes
  dateFrom.addEventListener('change', () => { if(isClientDataSaved) { checkDateChanges(); } });
  dateTo.addEventListener('change', () => { if(isClientDataSaved) { checkDateChanges(); } });

  function checkPaxChanges() {
    const newPax = getCurrentPaxData();
    let changes = [];
    if (newPax.adults !== lastSavedPax.adults) changes.push(`Adults from ${lastSavedPax.adults} to ${newPax.adults}`);
    if (newPax.childBed !== lastSavedPax.childBed) changes.push(`Children (with bed) from ${lastSavedPax.childBed} to ${newPax.childBed}`);
    if (newPax.childNoBed !== lastSavedPax.childNoBed) changes.push(`Children (without bed) from ${lastSavedPax.childNoBed} to ${newPax.childNoBed}`);
    if (newPax.infants !== lastSavedPax.infants) changes.push(`Infants from ${lastSavedPax.infants} to ${newPax.infants}`);

    if (changes.length > 0) {
      const changeMsg = "Client & Pax data has been modified:\n" + changes.join("\n") + "\nUpdating flight and hotel sections accordingly.";
      showNotification(changeMsg, 'info', 5000);
      updateFlightsPaxFields();
      updateHotelRoomTypes();
      updateDirectFlightAddonsPaxFields();
      lastSavedPax = newPax;
    }
  }

  function checkClientInfoChanges() {
    const newClientName = document.getElementById("clientName").value;
    const newClientPhone = document.getElementById("clientPhone").value;
    const changes = [];

    if (newClientName !== lastSavedClientInfo.name) {
      changes.push(`Client Name from "${lastSavedClientInfo.name}" to "${newClientName}"`);
    }
    if (newClientPhone !== lastSavedClientInfo.phone) {
      changes.push(`Phone from "${lastSavedClientInfo.phone}" to "${newClientPhone}"`);
    }

    if (changes.length > 0) {
      const changeMsg = "Client data has been modified:\n" + changes.join("\n");
      showNotification(changeMsg, 'info', 5000);
    }
    lastSavedClientInfo = { name: newClientName, phone: newClientPhone };
  }

  function checkDateChanges() {
    const newDates = { dateFrom: dateFrom.value, dateTo: dateTo.value };
    if (newDates.dateFrom !== lastSavedDates.dateFrom || newDates.dateTo !== lastSavedDates.dateTo) {
      const dateChangeMsg = "Travel dates have been modified. Updating hotel section accordingly.";
      showNotification(dateChangeMsg, 'info', 5000);
      updateHotelDates();
      lastSavedDates = newDates;
    }
  }
</script>


<!-- FLIGHT -->
<div class="section" id="flightContainerWrapper">
  <div class="flight-header">
    <h3>Flight</h3>
    <button type="button" id="btnAddFlight" class="add-btn">+ Add Flight</button>
  </div>
  <div id="flightContainer"></div>
</div>

<script>
let nextFlightNumber = 0;
let flights = [];

// Get current Pax from input fields
function getCurrentPaxData() {
  return {
    adults: parseInt(document.getElementById("numAdult")?.value || 0),
    childBed: parseInt(document.getElementById("numChildBed")?.value || 0),
    childNoBed: parseInt(document.getElementById("numChildNoBed")?.value || 0),
    infants: parseInt(document.getElementById("numInfant")?.value || 0),
  };
}

// Get main flight costs for comparison
function getMainFlightCosts() {
  const mainFlights = [];
  document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const pax = getCurrentPaxData();
    
    const flightData = {
      adultCost: parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0),
      adultSvc: parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0),
      childBedCost: parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0),
      childBedSvc: parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0),
      childNoBedCost: parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0),
      childNoBedSvc: parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0),
      infantCost: parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0),
      infantSvc: parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0)
    };
    
    mainFlights.push(flightData);
  });
  
  return mainFlights;
}

// Calculate difference between upgrade and main flight
function calculateUpgradeDifference(upgradeIndex) {
  const mainFlights = getMainFlightCosts();
  if (mainFlights.length === 0) {
    showAlert("Please add main flight details first.");
    return { adultDiff: 0, childBedDiff: 0, childNoBedDiff: 0, infantDiff: 0 };
  }
  
  // Use the first main flight for comparison
  const mainFlight = mainFlights[0];
  
  // Get upgrade flight costs
  const upgradeAdultCost = parseFloat(document.getElementById(`upgradeFlightCostAdult_${upgradeIndex}`)?.value || 0);
  const upgradeAdultSvc = parseFloat(document.getElementById(`upgradeFlightSvcAdult_${upgradeIndex}`)?.value || 0);
  const upgradeChildBedCost = parseFloat(document.getElementById(`upgradeFlightCostChildBed_${upgradeIndex}`)?.value || 0);
  const upgradeChildBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildBed_${upgradeIndex}`)?.value || 0);
  const upgradeChildNoBedCost = parseFloat(document.getElementById(`upgradeFlightCostChildNoBed_${upgradeIndex}`)?.value || 0);
  const upgradeChildNoBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildNoBed_${upgradeIndex}`)?.value || 0);
  const upgradeInfantCost = parseFloat(document.getElementById(`upgradeFlightCostInf_${upgradeIndex}`)?.value || 0);
  const upgradeInfantSvc = parseFloat(document.getElementById(`upgradeFlightSvcInf_${upgradeIndex}`)?.value || 0);
  
  // Calculate differences
  const differences = {
    adultDiff: (upgradeAdultCost + upgradeAdultSvc) - (mainFlight.adultCost + mainFlight.adultSvc),
    childBedDiff: (upgradeChildBedCost + upgradeChildBedSvc) - (mainFlight.childBedCost + mainFlight.childBedSvc),
    childNoBedDiff: (upgradeChildNoBedCost + upgradeChildNoBedSvc) - (mainFlight.childNoBedCost + mainFlight.childNoBedSvc),
    infantDiff: (upgradeInfantCost + upgradeInfantSvc) - (mainFlight.infantCost + mainFlight.infantSvc)
  };
  
  // Store differences in the element for later use
  const upgradeElement = document.getElementById(`dfAddon_${upgradeIndex}`);
  if (upgradeElement) {
    upgradeElement.dataset.adultDifference = differences.adultDiff;
    upgradeElement.dataset.childBedDifference = differences.childBedDiff;
    upgradeElement.dataset.childNoBedDifference = differences.childNoBedDiff;
    upgradeElement.dataset.infantDifference = differences.infantDiff;
  }
  
  return differences;
}

// Generate pax input fields for a flight
function generatePaxFields(index) {
  const pax = getCurrentPaxData();
  const fields = [];
  function addField(id, label) {
    fields.push(`<div><label>${label}</label><input id="${id}" type="number" value="0" min="0"></div>`);
  }

  if(pax.adults > 0){
    addField(`flightCostAdult_${index}`, "Cost per Adult (PKR)");
    addField(`flightSvcAdult_${index}`, "Service fee per Adult (PKR)");
  }
  if(pax.childBed > 0){
    addField(`flightCostChildBed_${index}`, "Cost per Child (with bed) (PKR)");
    addField(`flightSvcChildBed_${index}`, "Service fee per Child (with bed) (PKR)");
  }
  if(pax.childNoBed > 0){
    addField(`flightCostChildNoBed_${index}`, "Cost per Child (no bed) (PKR)");
    addField(`flightSvcChildNoBed_${index}`, "Service fee per Child (no bed) (PKR)");
  }
  if(pax.infants > 0){
    addField(`flightCostInf_${index}`, "Cost per Infant (PKR)");
    addField(`flightSvcInf_${index}`, "Service fee per Infant (PKR)");
  }

  return fields.join("");
}

// Update existing flights when pax changes
function updateFlightsPaxFields() {
  flights.forEach(index => {
    const flightBlock = document.getElementById(`flightBlock_${index}`);
    if(!flightBlock) return;

    // Get the HTML content excluding the PAX fields part
    const paxFieldsStart = `<!-- PAX-FIELDS-START -->`;
    const paxFieldsEnd = `<!-- PAX-FIELDS-END -->`;
    const existingHtml = flightBlock.innerHTML;

    const beforePax = existingHtml.split(paxFieldsStart)[0];
    const afterPax = existingHtml.split(paxFieldsEnd)[1];

    const newPaxFields = generatePaxFields(index);
    flightBlock.innerHTML = beforePax + paxFieldsStart + newPaxFields + paxFieldsEnd + afterPax;
  });
}

// Validate flight
function validateFlight(index){
  const itinerary = document.getElementById("flightItinerary_" + index);
  const airline = document.getElementById("airline_" + index);
  let valid = true;

  if(!itinerary.value.trim()){ itinerary.classList.add("input-error"); valid=false; } else { itinerary.classList.remove("input-error"); }
  if(!airline.value.trim()){ airline.classList.add("input-error"); valid=false; } else { airline.classList.remove("input-error"); }

  return valid;
}

// Add new flight
async function addFlight() {
  if(flights.length > 0 && !validateFlight(flights[flights.length-1])){
    await showAlert("Please complete all mandatory fields of the previous flight first.");
    return;
  }

  nextFlightNumber++;
  flights.push(nextFlightNumber);
  const container = document.getElementById("flightContainer");
  const paxFields = generatePaxFields(nextFlightNumber);

  const flightDiv = document.createElement("div");
  flightDiv.className = "section";
  flightDiv.style.marginTop = "10px";
  flightDiv.setAttribute("id", "flightBlock_" + nextFlightNumber);

  flightDiv.innerHTML = `
    <h4>
      Flight ${nextFlightNumber}
      <button type="button" onclick="removeFlight(${nextFlightNumber})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div class="full">
        <label>Flight itinerary (paste full itinerary)</label>
        <textarea id="flightItinerary_${nextFlightNumber}" placeholder="Paste flight details..."></textarea>
      </div>
      <div>
        <label>Airline</label>
        <input id="airline_${nextFlightNumber}" list="airlist">
        <datalist id="airlist">
          <option>Saudia (SV)</option>
          <option>Emirates (EK)</option>
          <option>Flydubai (FZ)</option>
          <option>PIA</option>
          <option>AirBlue</option>
          <option>Qatar (QR)</option>
        </datalist>
      </div>
      <div>
        <label>Direct / Indirect</label>
        <select id="flightDirect_${nextFlightNumber}">
          <option>Stopover</option>
          <option>Direct</option>
        </select>
      </div>
      <!-- PAX-FIELDS-START -->
      ${paxFields}
      <!-- PAX-FIELDS-END -->
    </div>
  `;

  container.appendChild(flightDiv);
}

// Remove flight
function removeFlight(index){
  const block = document.getElementById("flightBlock_" + index);
  if(block) block.remove();
  flights = flights.filter(f => f !== index);
  if (flights.length === 0) {
      nextFlightNumber = 0;
  }
}

// Event listeners
document.getElementById("btnAddFlight").addEventListener("click", async () => {
    if(!isClientDataSaved) {
        await showAlert("Please save the Client & Pax data before adding flights.");
        return;
    }
    addFlight();
});
</script>


<!-- HOTEL MAKKAH -->
<div class="section" id="hotelContainerM">
  <div class="hotel-header">
    <h3>Hotel - Makkah</h3>
    <button type="button" id="btnAddHotelM" class="add-btn">+ Add Hotel</button>
  </div>
</div>

<script>
const hotelLimit = 3;
let nextHotelNumberM = 0;
let hotelsMakkah = [];

const roomConfig = {
  "Double": { adults: 2, childNoBed: 1 },
  "Triple": { adults: 3, childNoBed: 1 },
  "Quad": { adults: 4, childNoBed: 1 },
  "Quint": { adults: 5, childNoBed: 1 },
  "6 Bed": { adults: 6, childNoBed: 2 },
  "8 Bed": { adults: 8, childNoBed: 2 }
};

// Get Client & Pax data
function getClientData() {
  const data = JSON.parse(localStorage.getItem("savedClientData")) || {};
  data.adults = parseInt(data.adults) || 0;
  data.childBed = parseInt(data.childBed) || 0;
  data.childNoBed = parseInt(data.childNoBed) || 0;
  data.infants = parseInt(data.infants) || 0;
  data.totalPax = data.adults + data.childBed; // Adults & Children with beds
  data.totalChildNoBed = data.childNoBed;

  // parse dates safely
  data.dateFromObj = data.dateFrom && data.dateFrom.trim() !== "" ? new Date(data.dateFrom) : null;
  data.dateToObj = data.dateTo && data.dateTo.trim() !== "" ? new Date(data.dateTo) : null;
  data.nightsMakkah = data.nightsMakkah || 0;
  data.nightsMadina = data.nightsMadina || 0;
  return data;
}

// Validate date object
function isValidDate(d){
  return d instanceof Date && !isNaN(d.getTime());
}

// Format date for input fields
function formatDate(d){
  if(!isValidDate(d)) return "";
  const yyyy = d.getFullYear();
  let mm = d.getMonth()+1; if(mm<10) mm="0"+mm;
  let dd = d.getDate(); if(dd<10) dd="0"+dd;
  return `${yyyy}-${mm}-${dd}`;
}

// Validate last hotel fields before adding new
function isHotelFilled(index, prefix){
  const fields = [
    `hkName${prefix}_${index}`,
    `hkDist${prefix}_${index}`,
    `hkCheckIn${prefix}_${index}`,
    `hkCheckOut${prefix}_${index}`
  ];
  let valid = true;
  fields.forEach(id=>{
    const el = document.getElementById(id);
    if(el && !el.value.trim()){
      el.classList.add('input-error');
      valid = false;
    } else if (el) {
      el.classList.remove("input-error");
    }
  });
  return valid;
}

async function saveToFirebaseHotel(key, data) {
    try {
        const agent = getCurrentAgent();
        if (!agent || !agent.uid) {
            console.warn('User not authenticated, using localStorage');
            localStorage.setItem(key, JSON.stringify(data));
            return true;
        }
        // Save to Firestore
        await window.firebaseDB.saveData('agents/' + agent.uid + '/data', key, { value: data, updatedAt: new Date() });
        return true;
    } catch (error) {
        console.error('Error saving to Firebase:', error);
        // Fallback
        localStorage.setItem(key, JSON.stringify(data));
        return false;
    }
}

function saveToLocalStorage(key, data) {
    try {
        saveToFirebaseHotel(key, data).catch(err => {
            console.error('Firebase save failed:', err);
        });
        // Keep in localStorage for immediate access
        localStorage.setItem(key, JSON.stringify(data));
        return true;
    } catch (error) {
        console.error('Error saving to localStorage:', error);
        showAlert("Failed to save data. Your browser's storage might be full.", "Error");
        return false;
    }
}

// Function to calculate total pax for rooms (adults + children with bed)
function getTotalPaxForRooms() {
    const adults = parseInt(document.getElementById("numAdult")?.value || 0);
    const childBed = parseInt(document.getElementById("numChildBed")?.value || 0);
    return adults + childBed;
}

// Function to recommend a room type based on total pax for rooms
function getRecommendedRoomType() {
    const totalPax = getTotalPaxForRooms();
    if (totalPax <= 2) return "Double";
    if (totalPax === 3) return "Triple";
    if (totalPax === 4) return "Quad";
    if (totalPax === 5) return "Quint";
    if (totalPax >= 6) return "6 Bed";
    return "Double";
}

// Function to update all hotel room types based on current pax
function updateHotelRoomTypes() {
  const recommendedType = getRecommendedRoomType();
  hotelsMakkah.forEach(index => {
    const roomTypeSelect = document.getElementById(`hkRoomTypeM_${index}`);
    if (roomTypeSelect) {
      roomTypeSelect.value = recommendedType;
    }
  });
  hotelsMadina.forEach(index => {
    const roomTypeSelect = document.getElementById(`hkRoomTypeA_${index}`);
    if (roomTypeSelect) {
      roomTypeSelect.value = recommendedType;
    }
  });
}

// Function to calculate total capacity across ALL hotels (Makkah and Madina)
function calculateTotalHotelCapacity() {
    let totalCapacity = 0;
    let totalChildNoBedCapacity = 0;

    const allHotelIds = [...hotelsMakkah, ...hotelsMadina];
    
    allHotelIds.forEach(index => {
        let prefix = hotelsMakkah.includes(index) ? 'M' : 'A';
        const roomTypeSelect = document.getElementById(`hkRoomType${prefix}_${index}`);
        const roomsCountInput = document.getElementById(`hkRooms${prefix}_${index}`);
        
        if (roomTypeSelect && roomsCountInput) {
            const roomType = roomTypeSelect.value;
            const numRooms = parseInt(roomsCountInput.value) || 0;
            const roomCapacity = roomConfig[roomType];
            
            if (roomCapacity) {
                totalCapacity += roomCapacity.adults * numRooms;
                totalChildNoBedCapacity += roomCapacity.childNoBed * numRooms;
            }
        }
    });

    return { totalCapacity, totalChildNoBedCapacity };
}

/// New function to validate ALL hotel configurations
function validateAllHotels() {
    const clientData = getClientData();
    if (!clientData) return false;
    
    const totalPax = clientData.totalPax;
    const totalChildNoBed = clientData.totalChildNoBed;
    const { totalCapacity, totalChildNoBedCapacity } = calculateTotalHotelCapacity();

    let isValid = true;
    let errorMessage = '';

    // Check if total rooms are enough for total pax
    if (totalPax > totalCapacity) {
        errorMessage += `Total rooms booked can only accommodate ${totalCapacity} people, but your group has ${totalPax}.\n`;
        isValid = false;
    }

    // Check if total rooms are enough for children without bed
    if (totalChildNoBed > totalChildNoBedCapacity) {
        errorMessage += `Total rooms booked can only accommodate ${totalChildNoBedCapacity} children without a bed. Your group has ${totalChildNoBed}.\n`;
        isValid = false;
    }
    
    // Only show error message if there's an actual validation error
    if (!isValid) {
        const allRoomsInputs = document.querySelectorAll('[id^="hkRoomsM_"], [id^="hkRoomsA_"]');
        allRoomsInputs.forEach(input => input.classList.add("input-error"));
        showAlert(errorMessage, "Room Configuration Error");
    } else {
        const allRoomsInputs = document.querySelectorAll('[id^="hkRoomsM_"], [id^="hkRoomsA_"]');
        allRoomsInputs.forEach(input => input.classList.remove("input-error"));
    }

    return isValid;
}

// Create hotel section
async function createHotelSectionM(index){
  const clientData = getClientData();

  // Validate travel dates again
  if(!isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
    await showAlert("Cannot create hotel form. Please provide valid From/To dates in Client & Pax data.");
    return;
  }

  const container = document.getElementById("hotelContainerM");
  const hotelDiv = document.createElement("div");
  hotelDiv.className = "section";
  hotelDiv.id = "hotelBlockM_" + index;
  hotelDiv.style.marginTop = "10px";

  const roomOptions = Object.keys(roomConfig).map(rt=>`<option>${rt}</option>`).join("");

  hotelDiv.innerHTML = `
    <h4>
      Hotel ${index}
      <button type="button" onclick="removeHotelM(${index})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div><label>Hotel Name</label><input id="hkNameM_${index}" type="text"></div>
      <div><label>Distance from Haram</label><input id="hkDistM_${index}" type="text"></div>
      <div><label>Check-in</label>
        <input id="hkCheckInM_${index}" type="date"
               min="${formatDate(clientData.dateFromObj)}"
               max="${formatDate(clientData.dateToObj)}">
      </div>
      <div><label>Check-out</label>
        <input id="hkCheckOutM_${index}" type="date"
               min="${formatDate(clientData.dateFromObj)}"
               max="${formatDate(clientData.dateToObj)}">
      </div>
      <div><label>Total in Makkah</label><input id="hkNightsM_${index}" type="number" value="0" min="0"></div>
      <div><label>Room Type</label><select id="hkRoomTypeM_${index}">${roomOptions}</select></div>
      <div><label>Rooms count</label><input id="hkRoomsM_${index}" type="number" value="1" min="1"></div>
      <div><label>Service Type</label><select id="hkServiceM_${index}"><option>Without Breakfast</option><option>With Breakfast</option></select></div>
      <div><label>Cost per night (SAR)</label><input id="hkCostNightM_${index}" type="number" value="0" min="0"></div>
      <div><label>Service per night (SAR)</label><input id="hkSvcNightM_${index}" type="number" value="0" min="0"></div>
    </div>
  `;
  container.appendChild(hotelDiv);
  hotelsMakkah.push(index);

  const chkIn = document.getElementById(`hkCheckInM_${index}`);
  const chkOut = document.getElementById(`hkCheckOutM_${index}`);
  const nights = document.getElementById(`hkNightsM_${index}`);
  const roomTypeSelect = document.getElementById(`hkRoomTypeM_${index}`);
  const roomsCountInput = document.getElementById(`hkRoomsM_${index}`);

  // Set the default room type based on pax
  if (roomTypeSelect) {
    roomTypeSelect.value = getRecommendedRoomType();
  }

  function updateNights(){
    if(chkIn.value && chkOut.value){
      const diff = Math.round((new Date(chkOut.value) - new Date(chkIn.value))/(1000*60*60*24));
      nights.value = diff>0 ? diff : 0;
      if(diff !== clientData.nightsMakkah){
        nights.classList.add("input-error");
        showAlert(`Total nights must match "Number of nights in Makkah" (${clientData.nightsMakkah}) from Client & Pax`);
      } else {
        nights.classList.remove("input-error");
      }
    } else {
      nights.value = clientData.nightsMakkah;
    }
  }

  if (chkIn) chkIn.addEventListener("change", updateNights);
  if (chkOut) chkOut.addEventListener("change", updateNights);

  // Add event listeners for room validation
  if (roomTypeSelect) roomTypeSelect.addEventListener('change', validateAllHotels);
  if (roomsCountInput) roomsCountInput.addEventListener('input', validateAllHotels);
}

// Remove hotel
function removeHotelM(index){
  const block = document.getElementById("hotelBlockM_" + index);
  if(block) block.remove();
  hotelsMakkah = hotelsMakkah.filter(h => h !== index);
  if (hotelsMakkah.length === 0) {
      nextHotelNumberM = 0;
  }
  validateAllHotels();
}

// Add Hotel button
document.getElementById("btnAddHotelM").addEventListener("click", async ()=>{
    if(!isClientDataSaved) {
        await showAlert("Please save the Client & Pax data before adding hotels.");
        return;
    }

    const clientData = getClientData();
    // Strict check for missing/empty/invalid From-To dates
    if(!clientData.dateFrom || clientData.dateFrom.trim() === "" ||
       !clientData.dateTo || clientData.dateTo.trim() === "" ||
       !isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
      await showAlert("Cannot add hotel. Please provide valid From/To dates in Client & Pax data.");
      return;
    }

    // Prevent adding new hotel if last one is incomplete
    if(hotelsMakkah.length > 0 && !isHotelFilled(hotelsMakkah[hotelsMakkah.length-1], 'M')){
      await showAlert("Please complete all mandatory fields of the previous hotel first.");
      return;
    }

    if(nextHotelNumberM >= hotelLimit){
      await showAlert("Max 3 hotels only.");
      return;
    }

    nextHotelNumberM++;
    createHotelSectionM(nextHotelNumberM);
});
</script>

<!-- HOTEL MADINA -->
<div class="section" id="hotelContainerA">
  <div class="hotel-header">
    <h3>Hotel - Madina</h3>
    <button type="button" id="btnAddHotelA" class="add-btn">+ Add Hotel</button>
  </div>
</div>

<script>
const hotelLimitA = 3;
let nextHotelNumberA = 0;
let hotelsMadina = [];

// Create hotel section
async function createHotelSectionA(index){
  const clientData = getClientData();
  if(!isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
    await showAlert("Cannot create hotel form. Please provide valid From/To dates in Client & Pax data.");
    return;
  }

  const container = document.getElementById("hotelContainerA");
  const hotelDiv = document.createElement("div");
  hotelDiv.className = "section";
  hotelDiv.id = "hotelBlockA_" + index;
  hotelDiv.style.marginTop = "10px";

  const roomOptions = Object.keys(roomConfig).map(rt=>`<option>${rt}</option>`).join("");

  hotelDiv.innerHTML = `
    <h4>
      Hotel ${index}
      <button type="button" onclick="removeHotelA(${index})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div><label>Hotel Name</label><input id="hkNameA_${index}" type="text"></div>
      <div><label>Distance from Haram</label><input id="hkDistA_${index}" type="text"></div>
      <div><label>Check-in</label>
        <input id="hkCheckInA_${index}" type="date"
               min="${formatDate(clientData.dateFromObj)}"
               max="${formatDate(clientData.dateToObj)}">
      </div>
      <div><label>Check-out</label>
        <input id="hkCheckOutA_${index}" type="date"
               min="${formatDate(clientData.dateFromObj)}"
               max="${formatDate(clientData.dateToObj)}">
      </div>
      <div><label>Total in Madina</label><input id="hkNightsA_${index}" type="number" value="0" min="0"></div>
      <div><label>Room Type</label><select id="hkRoomTypeA_${index}">${roomOptions}</select></div>
      <div><label>Rooms count</label><input id="hkRoomsA_${index}" type="number" value="1" min="1"></div>
      <div><label>Service Type</label><select id="hkServiceA_${index}"><option>Without Breakfast</option><option>With Breakfast</option></select></div>
      <div><label>Cost per night (SAR)</label><input id="hkCostNightA_${index}" type="number" value="0" min="0"></div>
      <div><label>Service per night (SAR)</label><input id="hkSvcNightA_${index}" type="number" value="0" min="0"></div>
    </div>
  `;
  container.appendChild(hotelDiv);
  hotelsMadina.push(index);

  const chkIn = document.getElementById(`hkCheckInA_${index}`);
  const chkOut = document.getElementById(`hkCheckOutA_${index}`);
  const nights = document.getElementById(`hkNightsA_${index}`);
  const roomTypeSelect = document.getElementById(`hkRoomTypeA_${index}`);
  const roomsCountInput = document.getElementById(`hkRoomsA_${index}`);


  // Set the default room type based on pax
  if (roomTypeSelect) {
    roomTypeSelect.value = getRecommendedRoomType();
  }

  function updateNights(){
    if(chkIn.value && chkOut.value){
      const diff = Math.round((new Date(chkOut.value) - new Date(chkIn.value))/(1000*60*60*24));
      nights.value = diff>0 ? diff : 0;
      if(diff !== clientData.nightsMadina){
        nights.classList.add("input-error");
        showAlert(`Total nights must match "Number of nights in Madina" (${clientData.nightsMadina}) from Client & Pax`);
      } else {
        nights.classList.remove("input-error");
      }
    } else {
      nights.value = clientData.nightsMadina;
    }
  }

  if (chkIn) chkIn.addEventListener("change", updateNights);
  if (chkOut) chkOut.addEventListener("change", updateNights);

  // Add event listeners for room validation
  if (roomTypeSelect) roomTypeSelect.addEventListener('change', validateAllHotels);
  if (roomsCountInput) roomsCountInput.addEventListener('input', validateAllHotels);
}

// Update all hotel date ranges
function updateHotelDates() {
  const clientData = getClientData();
  hotelsMakkah.forEach(index => {
    const chkIn = document.getElementById(`hkCheckInM_${index}`);
    const chkOut = document.getElementById(`hkCheckOutM_${index}`);
    if (chkIn) chkIn.setAttribute('min', formatDate(clientData.dateFromObj));
    if (chkOut) chkOut.setAttribute('max', formatDate(clientData.dateToObj));
  });
  hotelsMadina.forEach(index => {
    const chkIn = document.getElementById(`hkCheckInA_${index}`);
    const chkOut = document.getElementById(`hkCheckOutA_${index}`);
    if (chkIn) chkIn.setAttribute('min', formatDate(clientData.dateFromObj));
    if (chkOut) chkOut.setAttribute('max', formatDate(clientData.dateToObj));
  });
}

// Remove hotel
function removeHotelA(index){
  const block = document.getElementById("hotelBlockA_" + index);
  if(block) block.remove();
  hotelsMadina = hotelsMadina.filter(h => h !== index);
  if (hotelsMadina.length === 0) {
      nextHotelNumberA = 0;
  }
  validateAllHotels();
}

document.getElementById("btnAddHotelA").addEventListener("click", async ()=>{
    if(!isClientDataSaved) {
        await showAlert("Please save the Client & Pax data before adding hotels.");
        return;
    }
    const clientData = getClientData();
    if(!clientData.dateFrom || clientData.dateFrom.trim() === "" ||
       !clientData.dateTo || clientData.dateTo.trim() === "" ||
       !isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
      await showAlert("Cannot add hotel. Please provide valid From/To dates in Client & Pax data.");
      return;
    }
    if(hotelsMadina.length > 0 && !isHotelFilled(hotelsMadina[hotelsMadina.length-1], 'A')){
      await showAlert("Please complete all mandatory fields of the previous hotel before adding a new one.");
      return;
    }
    if(nextHotelNumberA >= hotelLimitA){
      await showAlert("Max 3 hotels only.");
      return;
    }

    nextHotelNumberA++;
    createHotelSectionA(nextHotelNumberA);
});
</script>

<!-- TRANSFERS -->
<div class="section" id="transferWrapper">
  <div class="transfer-header">
    <h3>Transfers</h3>
    <button type="button" id="btnAddTrans" class="add-btn">+ Add Transfer</button>
  </div>
  <div id="transferContainer"></div>
</div>

<script>
let nextTransferNumber = 0;
let transfers = [];

// Helper: check valid date
function isValidDate(d){
  return d instanceof Date && !isNaN(d.getTime());
}

// Helper: get saved Client data (dates & pax)
function getClientData() {
  const saved = localStorage.getItem("savedClientData");
  if(!saved) return null;
  const data = JSON.parse(saved);
  data.dateFromObj = new Date(data.dateFrom);
  data.dateToObj = new Date(data.dateTo);
  return data;
}

// Pax total (excluding infants)
function getTotalPax() {
  const adults = parseInt(document.getElementById("numAdult")?.value || 0);
  const cBed = parseInt(document.getElementById("numChildBed")?.value || 0);
  const cNoBed = parseInt(document.getElementById("numChildNoBed")?.value || 0);
  const infants = parseInt(document.getElementById("numInfant")?.value || 0);
  return adults + cBed + cNoBed + infants;
}

// Function to determine the best-fit vehicle
function getRecommendedVehicle() {
  const totalPax = getTotalPax();
  if (totalPax <= 3) return 'Car';
  if (totalPax <= 4) return 'H1/Staria';
  if (totalPax <= 9) return 'Hiace';
  if (totalPax <= 20) return 'Coaster';
  if (totalPax <= 40) return 'Bus';
  if (totalPax > 40) return 'Bullet Train';
  return 'Car';
}

// Added function to check if transfer date is within travel dates
function checkDateRange(dateInput, clientData) {
  const transferDate = new Date(dateInput.value);
  if (transferDate < clientData.dateFromObj || transferDate > clientData.dateToObj) {
    dateInput.classList.add("input-error");
    showAlert(`The transfer date must be between ${formatDateToDMY(clientData.dateFrom)} and ${formatDateToDMY(clientData.dateTo)}.`);
    return false;
  } else {
    dateInput.classList.remove("input-error");
    return true;
  }
}

// Added function to validate transfer vehicle capacity
function validateTransferCapacity(carSelect) {
  const car = carSelect.value;
  const capacityMap = {
    'Car': 3,
    'H1/Staria': 4,
    'Hiace': 9,
    'Coaster': 20,
    'Bus': 40,
    'Bullet Train': 100 // Using a high number to represent unlimited
  };
  const capacity = capacityMap[car] || 0;
  const totalPax = getTotalPax();

  // Check for under-capacity (over-vehicle)
  if (totalPax > 0 && totalPax <= 2 && capacity > (totalPax + 2)) {
     carSelect.classList.add("input-error");
     showAlert(`The selected vehicle (${car}) has a capacity of ${capacity}, which is more than your group of ${totalPax} requires. Please consider a smaller vehicle.`);
     return false;
  }

  // Check for over-capacity (too small vehicle)
  if (totalPax > capacity) {
    carSelect.classList.add("input-error");
    showAlert(`The selected vehicle (${car}) can only hold ${capacity} people. Please choose a larger vehicle for your group of ${totalPax}.`);
    return false;
  } else {
    carSelect.classList.remove("input-error");
    return true;
  }
}

// Validate a transfer section
function validateTransfer(index){
  const date = document.getElementById(`tDate_${index}`);
  const from = document.getElementById(`tFrom_${index}`);
  const to = document.getElementById(`tTo_${index}`);
  let valid = true;

  if(!date.value.trim()){ date.classList.add("input-error"); valid=false; } else { date.classList.remove("input-error"); }
  if(!from.value.trim()){ from.classList.add("input-error"); valid=false; } else { from.classList.remove("input-error"); }
  if(!to.value.trim()){ to.classList.add("input-error"); valid=false; } else { to.classList.remove("input-error"); }
  
  return valid;
}

// Add new transfer
async function addTransfer(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding transfers.");
    return;
  }
  
  const clientData = getClientData();
  if(!clientData || !isValidDate(clientData.dateFromObj) || !isValidDate(clientData.dateToObj)){
    await showAlert("Please save valid From/To dates in Client & Pax first.");
    return;
  }
  
  // Prevent adding new transfer if last one is incomplete
  if(transfers.length > 0 && !validateTransfer(transfers[transfers.length-1])){
    await showAlert("Please complete all mandatory fields of the previous transfer first.");
    return;
  }

  nextTransferNumber++;
  transfers.push(nextTransferNumber);

  const container = document.getElementById("transferContainer");
  const div = document.createElement("div");
  div.className = "section";
  div.style.marginTop = "10px";
  div.id = "transferBlock_" + nextTransferNumber;

  div.innerHTML = `
    <h4>
      Transfer ${nextTransferNumber}
      <button type="button" onclick="removeTransfer(${nextTransferNumber})" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div>
        <label>Date</label>
        <input id="tDate_${nextTransferNumber}" type="date">
      </div>
      <div>
        <label>From</label>
        <select id="tFrom_${nextTransferNumber}">
          <option>Jeddah Airport</option>
          <option>Makkah Hotel</option>
          <option>Medina Hotel</option>
          <option>Medina Airport</option>
        </select>
      </div>
      <div>
        <label>To</label>
        <select id="tTo_${nextTransferNumber}">
          <option>Makkah Hotel</option>
          <option>Medina Hotel</option>
          <option>Jeddah Airport</option>
          <option>Medina Airport</option>
        </select>
      </div>
      <div>
        <label>Vehicle</label>
        <select id="tCar_${nextTransferNumber}">
          <option>Car</option>
          <option>H1/Staria</option>
          <option>Hiace</option>
          <option>Coaster</option>
          <option>Bus</option>
          <option>Bullet Train</option>
        </select>
      </div>
      <div>
        <label>Type</label>
        <select id="tType_${nextTransferNumber}">
          <option>Private</option>
          <option>Sharing</option>
        </select>
      </div>
      <div>
        <label>Cost (SAR)</label>
        <input id="tCostSAR_${nextTransferNumber}" type="number" placeholder="Cost">
      </div>
      <div>
        <label>Service (SAR)</label>
        <input id="tSvcSAR_${nextTransferNumber}" type="number" placeholder="Service">
      </div>
    </div>
  `;

  container.appendChild(div);

  // Set the default vehicle based on pax count
  const carSelect = document.getElementById(`tCar_${nextTransferNumber}`);
  const recommendedVehicle = getRecommendedVehicle();
  carSelect.value = recommendedVehicle;

  // Capacity + Date validation on change
  const dateInput = div.querySelector(`#tDate_${nextTransferNumber}`);
  
  if (dateInput) {
    dateInput.addEventListener("change", () => {
      checkDateRange(dateInput, clientData);
    });
    dateInput.setAttribute('min', formatDate(clientData.dateFromObj));
    dateInput.setAttribute('max', formatDate(clientData.dateToObj));
  }

  if (carSelect) {
    carSelect.addEventListener("change", () => validateTransferCapacity(carSelect));
  }
}

// Remove transfer
function removeTransfer(index){
  const block = document.getElementById("transferBlock_" + index);
  if(block) block.remove();
  transfers = transfers.filter(t => t !== index);
  if (transfers.length === 0) {
      nextTransferNumber = 0;
  }
}

// Event listener
document.getElementById("btnAddTrans").addEventListener("click", addTransfer);
</script>

<!-- VISA -->
<div class="section" id="visaWrapper">
  <div class="visa-header">
    <h3>Visa</h3>
    <button type="button" id="btnAddVisa" class="add-btn">+ Add Visa</button>
  </div>
  <div id="visaContainer"></div>
</div>

<script>
let visaAdded = false;

// Calculate total pax
function getTotalPax(){
  const adults = parseInt(document.getElementById("numAdult")?.value || 0);
  const cBed = parseInt(document.getElementById("numChildBed")?.value || 0);
  const cNoBed = parseInt(document.getElementById("numChildNoBed")?.value || 0);
  const infants = parseInt(document.getElementById("numInfant")?.value || 0);
  return adults + cBed + cNoBed + infants;
}

// Add Visa section (only once)
async function addVisa(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding visa details.");
    return;
  }
  
  if(visaAdded){
    await showAlert("Visa section already added.");
    return;
  }
  visaAdded = true;

  const container = document.getElementById("visaContainer");
  const div = document.createElement("div");
  div.className = "section";
  div.style.marginTop = "10px";
  div.id = "visaBlock";

  const totalPax = getTotalPax();

  div.innerHTML = `
    <h4>
      Visa
      <button type="button" onclick="removeVisa()" class="remove-btn">❌ Remove</button>
    </h4>
    <div class="grid">
      <div>
        <label>No. of Visas (auto)</label>
        <input id="visaCount" type="number" value="${totalPax}" readonly>
      </div>
      <div>
        <label>Cost per Visa (SAR)</label>
        <input id="visaCost" type="number" value="0">
      </div>
      <div>
        <label>Service Fee per Visa (SAR)</label>
        <input id="visaSvc" type="number" value="0">
      </div>
    </div>
    <div class="small">Visa count updates automatically if pax changes.</div>
  `;

  container.appendChild(div);

  // auto update if pax fields change
  ["numAdult","numChildBed","numChildNoBed","numInfant"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.addEventListener("input", ()=>{
        document.getElementById("visaCount").value = getTotalPax();
      });
    }
  });
}

// Remove Visa
function removeVisa(){
  const block = document.getElementById("visaBlock");
  if(block) block.remove();
  visaAdded = false;
}

// Event listener
document.getElementById("btnAddVisa").addEventListener("click", addVisa);
</script>


<!-- ADD-ONS -->
<div class="section" id="addonsWrapper">
  <h3>Add Extras</h3>

  <!-- Upgraded Flight Panel -->
  <div class="addon-category">
    <div class="addon-header" onclick="togglePanel('directFlightPanel', this)">
      <span class="panel-icon">+</span> Upgraded Flight
    </div>
    <div id="directFlightPanel" class="addon-panel" style="display:none;">
      <div id="directFlightContainer"></div>
      <button type="button" class="add-btn green-btn" onclick="addDirectFlightAddon()">+ Add Upgraded Flight</button>
    </div>
  </div>

  <!-- Meal Type Panel -->
  <div class="addon-category">
    <div class="addon-header" onclick="togglePanel('mealTypePanel', this)">
      <span class="panel-icon">+</span> Meal Type
    </div>
    <div id="mealTypePanel" class="addon-panel" style="display:none;">
      <div id="mealTypeContainer"></div>
      <button type="button" class="add-btn orange-btn" onclick="addMealTypeAddon()">+ Add Meal</button>
    </div>
  </div>

  <!-- Ziyarah Panel -->
  <div class="addon-category">
    <div class="addon-header" onclick="togglePanel('ziyarahPanel', this)">
      <span class="panel-icon">+</span> Ziyarah
    </div>
    <div id="ziyarahPanel" class="addon-panel" style="display:none;">
      <div id="ziyarahContainer"></div>
      <button type="button" class="add-btn blue-btn" onclick="addZiyarahAddon()">+ Add Ziyarah</button>
    </div>
  </div>
</div>

<script>
// ----------------- Toggle Panel with + / - -----------------
function togglePanel(id, header){
  const panel=document.getElementById(id);
  const icon=header.querySelector(".panel-icon");
  if(panel.style.display==='none'){
    panel.style.display='block';
    icon.textContent='-';
  } else{
    panel.style.display='none';
    icon.textContent='+';
  }
}

// ----------------- Upgraded Flight -----------------
let dfIndex = 0;

// Helper to generate the pax fields HTML for addons
function generateAddonPaxFieldsHTML(pax) {
    let html = '';
    if (pax.adults > 0) html += `<div class="inline-input"><label>Adult - Difference</label><input type="number" value="0"><label>Service Fee</label><input type="number" value="0"></div>`;
    if (pax.childBed > 0) html += `<div class="inline-input"><label>Child (with bed) - Difference</label><input type="number" value="0"><label>Service Fee</label><input type="number" value="0"></div>`;
    if (pax.childNoBed > 0) html += `<div class="inline-input"><label>Child (no bed) - Difference</label><input type="number" value="0"><label>Service Fee</label><input type="number" value="0"></div>`;
    if (pax.infants > 0) html += `<div class="inline-input"><label>Infant - Difference</label><input type="number" value="0"><label>Service Fee</label><input type="number" value="0"></div>`;
    return html;
}

// Generate upgrade flight cost fields (not difference)
function generateUpgradeFlightPaxFieldsHTML(pax) {
  const fields = [];
  function addField(id, label) {
    fields.push(`<div class="inline-input"><label>${label}</label><input id="${id}" type="number" value="0" min="0"></div>`);
  }

  if(pax.adults > 0){
    addField(`upgradeFlightCostAdult_${dfIndex}`, "Adult Cost (PKR)");
    addField(`upgradeFlightSvcAdult_${dfIndex}`, "Adult Service (PKR)");
  }
  if(pax.childBed > 0){
    addField(`upgradeFlightCostChildBed_${dfIndex}`, "Child (with bed) Cost (PKR)");
    addField(`upgradeFlightSvcChildBed_${dfIndex}`, "Child (with bed) Service (PKR)");
  }
  if(pax.childNoBed > 0){
    addField(`upgradeFlightCostChildNoBed_${dfIndex}`, "Child (no bed) Cost (PKR)");
    addField(`upgradeFlightSvcChildNoBed_${dfIndex}`, "Child (no bed) Service (PKR)");
  }
  if(pax.infants > 0){
    addField(`upgradeFlightCostInf_${dfIndex}`, "Infant Cost (PKR)");
    addField(`upgradeFlightSvcInf_${dfIndex}`, "Infant Service (PKR)");
  }

  return fields.join("");
}

// New function to update existing direct flight addons
function updateDirectFlightAddonsPaxFields() {
    const pax = getCurrentPaxData();
    const addons = document.querySelectorAll('[id^="dfAddon_"]');
    addons.forEach(addon => {
        const existingHtml = addon.innerHTML;
        const paxFieldsStart = `<!-- PAX-FIELDS-START -->`;
        const paxFieldsEnd = `<!-- PAX-FIELDS-END -->`;
        
        // Split the HTML content to isolate the PAX fields section
        const beforePax = existingHtml.split(paxFieldsStart)[0];
        const afterPax = existingHtml.split(paxFieldsEnd)[1];
        
        // Generate the new HTML for pax fields
        const newPaxHtml = generateAddonPaxFieldsHTML(pax);
        
        // Reconstruct the full HTML
        addon.innerHTML = `${beforePax}${paxFieldsStart}${newPaxHtml}${paxFieldsEnd}${afterPax}`;
    });
}

async function addDirectFlightAddon(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding extras.");
    return;
  }
  dfIndex++;
  const container = document.getElementById("directFlightContainer");
  const pax = getCurrentPaxData();

  const div=document.createElement("div");
  div.className="section-entry";
  div.id="dfAddon_"+dfIndex;
  div.innerHTML=`
    <h4>Upgraded Flight
      <button type="button" onclick="removeAddon('dfAddon_${dfIndex}')" class="remove-btn">❌ Remove</button>
    </h4>
    <div>
      <label>Flight Itinerary</label><textarea placeholder="Paste flight details..."></textarea>
      <label>Airline</label><input list="airlist">
      <datalist id="airlist">
        <option>Saudia (SV)</option>
        <option>Emirates (EK)</option>
        <option>Flydubai (FZ)</option>
        <option>PIA</option>
        <option>AirBlue</option>
        <option>Qatar (QR)</option>
      </datalist>
      <label>Direct / Indirect</label>
      <select><option>Stopover</option><option>Direct</option></select>
<!-- PAX-FIELDS-START -->
<div class="upgrade-flight-costs">
  <h5 style="margin-bottom: 10px; color: #0b76d1;">Enter Upgrade Flight Costs (System will calculate difference)</h5>
  ${generateUpgradeFlightPaxFieldsHTML(pax)}
</div>
<!-- PAX-FIELDS-END -->
      <div class="small">Enter the difference in cost between base and upgraded flight.</div>
    </div>
  `;
  container.appendChild(div);
  
  // Add event listeners to calculate difference automatically
  const upgradeInputs = div.querySelectorAll('.upgrade-flight-costs input[type="number"]');
  upgradeInputs.forEach(input => {
    input.addEventListener('input', () => {
      const differences = calculateUpgradeDifference(dfIndex);
      
      // Show difference to user
      const pax = getCurrentPaxData();
      let diffMessage = "Upgrade Difference: ";
      
      if (pax.adults > 0 && differences.adultDiff > 0) {
        diffMessage += `Adult: +PKR ${differences.adultDiff.toLocaleString()} `;
      }
      if (pax.childBed > 0 && differences.childBedDiff > 0) {
        diffMessage += `Child: +PKR ${differences.childBedDiff.toLocaleString()} `;
      }
      if (pax.childNoBed > 0 && differences.childNoBedDiff > 0) {
        diffMessage += `Child: +PKR ${differences.childNoBedDiff.toLocaleString()} `;
      }
      if (pax.infants > 0 && differences.infantDiff > 0) {
        diffMessage += `Infant: +PKR ${differences.infantDiff.toLocaleString()}`;
      }
      
      // Update or create difference display
      let diffDisplay = div.querySelector('.upgrade-difference');
      if (!diffDisplay) {
        diffDisplay = document.createElement('div');
        diffDisplay.className = 'upgrade-difference';
        diffDisplay.style.cssText = 'margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px; font-weight: bold; color: #2e7d32;';
        div.querySelector('.upgrade-flight-costs').appendChild(diffDisplay);
      }
      diffDisplay.textContent = diffMessage;
    });
  });
}

// ----------------- Meal Type -----------------
let mealIndex=0;
async function addMealTypeAddon(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding extras.");
    return;
  }
  mealIndex++;
  const container=document.getElementById("mealTypeContainer");
  const div=document.createElement("div");
  div.className="section-entry";
  div.id="mealAddon_"+mealIndex;
  div.innerHTML=`
    <h4>Meal Type
      <button type="button" onclick="removeAddon('mealAddon_${mealIndex}')" class="remove-btn">❌ Remove</button>
    </h4>
    <div>
      <label>Select Hotel</label>
      <select><option>Makkah Hotel</option><option>Madina Hotel</option></select>
      <label>Meal Type</label>
      <select><option>Breakfast</option><option>Half Board</option><option>Full Board</option></select>
      <div class="inline-input">
        <label>Cost per pax/night (SAR)</label><input type="number" value="0">
        <label>Service per pax/night (SAR)</label><input type="number" value="0">
      </div>
    </div>
  `;
  container.appendChild(div);
}

// ----------------- Ziyarah -----------------
let ziyarahIndex=0;
async function addZiyarahAddon(){
  if(!isClientDataSaved) {
    await showAlert("Please save the Client & Pax data before adding extras.");
    return;
  }
  ziyarahIndex++;
  const container=document.getElementById("ziyarahContainer");
  const div=document.createElement("div");
  div.className="section-entry";
  div.id="ziyarahAddon_"+ziyarahIndex; // Fixed typo here
  div.innerHTML=`
    <h4>Ziyarah
      <button type="button" onclick="removeAddon('ziyarahAddon_${ziyarahIndex}')" class="remove-btn">❌ Remove</button>
    </h4>
    <div>
      <label>City</label>
      <select><option>Makkah</option><option>Madina</option></select>
      <label>Vehicle Type</label>
      <select><option>Car</option><option>H1/Staria</option><option>Hiace</option><option>Coaster</option><option>Bus</option></select>
      <label>Type</label>
      <select><option>Half Day</option><option>Full Day</option></select>
      <div class="inline-input">
        <label>Cost per vehicle (SAR)</label><input type="number" value="0">
        <label>Service per vehicle (SAR)</label><input type="number" value="0">
      </div>
      <small>Vehicle capacity validated based on total pax.</small>
    </div>
  `;
  container.appendChild(div);
}

// ----------------- Remove Addon -----------------
function removeAddon(id){
  const block=document.getElementById(id);
  if(block) {
    // Remove event listeners if any were added
    // For example: block.removeEventListener('click', handlerFunction);
    block.remove();
  }
}

</script>

<!-- ===============================
     Toast Notification System
     =============================== -->
<style>
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #444;
  color: #fff;
  padding: 10px 18px;
  border-radius: 6px;
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.35s ease, transform 0.35s ease;
  z-index: 999999;
  font-size: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.toast.show {
  opacity: 1;
  transform: translateY(0);
}
.toast.success { background: #2ecc71; }   /* Green */
.toast.warning { background: #f39c12; }   /* Orange */
.toast.error { background: #e74c3c; }     /* Red */
</style>

<script>
function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  requestAnimationFrame(() => toast.classList.add("show"));
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}
</script>

<!-- Quotation Status Section -->
<div class="section" id="statusSection" style="display:none;">
  <h3>Update Quotation Status</h3>
  <div class="grid">
    <div>
      <label for="quotationStatus">Current Status</label>
      <select id="quotationStatus">
        <option value="pending">Pending</option>
        <option value="followup">Follow-up Required</option>
        <option value="booked">Booked</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
  </div>
  <div class="actions" style="margin-top:10px">
    <button id="btnUpdateStatus" type="button">Update Status</button>
  </div>
</div>

<!-- ===============================
     Package Calculation Section
     =============================== -->

<div class="section" id="calcSectionWrapper">
  <div class="actions">
    <button type="button" id="btnCalculate" class="green-btn">💰 Calculate Package</button>
    <button type="button" id="btnGenerateQuotation" class="blue-btn" style="display:none;">📄 Generate Quotation</button>
  </div>
</div>

<div id="calcSummarySection" class="section" style="display:none;">
  <h3>📊 Package Calculation Summary</h3>

  <div class="grid">
    <div>
      <label>Rate of Exchange (SAR → PKR)</label>
      <input id="roeInput" type="number" value="79" min="1">
    </div>
  </div>

  <div style="overflow-x:auto;margin-top:12px;">
    <table id="calcSummaryTable" border="1" style="width:100%;border-collapse:collapse;">
      <thead style="background:#eef5fb;">
        <tr>
          <th>Section</th>
          <th>Description</th>
          <th>Cost (PKR)</th>
          <th>Service (PKR)</th>
          <th>Sell (PKR)</th>
          <th>Per Person</th>
        </tr>
      </thead>
      <tbody id="calcSummaryBody"></tbody>
      <tfoot id="calcSummaryFooter" style="font-weight:bold;background:#f5f5f5;"></tfoot>
    </table>
  </div>

  <div class="section" id="agentExtraSvc" style="margin-top: 20px; border: 1px dashed #ccc; padding: 15px; border-radius: 8px;">
  <h4>Agent Service Charge Options (Optional)</h4>
  <p class="small" style="color:#666; margin-top:-10px;">Choose one option for adding service fee to the final selling price.</p>
  
  <div style="margin-bottom: 15px;">
    <label style="display: flex; align-items: center; margin-bottom: 10px;">
      <input type="radio" name="svcOption" value="perPerson" onchange="toggleServiceOption('perPerson')" style="margin-right: 8px;">
      <span>Add Service Fee Per Person (PKR)</span>
    </label>
    <label style="display: flex; align-items: center;">
      <input type="radio" name="svcOption" value="none" checked onchange="toggleServiceOption('none')" style="margin-right: 8px;">
      <span>No Service Charge</span>
    </label>
  </div>
  
  <!-- Per Person Service Option -->
  <div id="perPersonSvcOption" class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 10px; display: none;">
    <div>
      <label>Service / Adult (PKR)</label>
      <input id="svcPerAdult" type="number" value="0" min="0" oninput="performCalculation()">
    </div>
    <div>
      <label>Service / Child (PKR)</label>
      <input id="svcPerChild" type="number" value="0" min="0" oninput="performCalculation()">
    </div>
    <div>
      <label>Service / Infant (PKR)</label>
      <input id="svcPerInfant" type="number" value="0" min="0" oninput="performCalculation()">
    </div>
  </div>
</div>
  
  <div id="calcTotals" style="margin-top:14px;font-weight:bold;"></div>

<div class="actions" style="margin-top:14px;">
  <button type="button" id="btnRecalculate" class="blue-btn">🔁 Recalculate</button>
  <button type="button" id="btnGenerateQuotation2" class="blue-btn" onclick="showQuotationModal()">📄 Generate Quotation</button>
  <button type="button" id="btnExportExcel" class="green-btn">📊 Export Cost Sheet</button>
  <button type="button" id="btnCloseSummary" class="ghost">❌ Close Summary</button>
</div>

<!-- Quotation Modal -->
<div id="quotationModal" class="modal-overlay no-print">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <h3 id="quotationModalTitle"></h3>
    <div id="quotationModalContent"></div>
    <div id="quotationModalButtons" class="modal-buttons"></div>
  </div>
</div>

<!-- Terms Edit Modal -->
<div id="termsModal" class="modal-overlay no-print">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <h3>Edit Terms & Conditions</h3>
    <textarea id="termsEditor" class="terms-editor"></textarea>
    <div id="termsModalButtons" class="modal-buttons"></div>
  </div>
</div>

<!-- Content Editor Modal -->
<div id="contentEditorModal" class="modal-overlay no-print">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <h3 id="contentEditorModalTitle"></h3>
    <div id="contentEditorModalContent"></div>
    <div id="contentEditorModalButtons" class="modal-buttons"></div>
  </div>
</div>

<script>
const btnCalculate = document.getElementById("btnCalculate");
const calcSummarySection = document.getElementById("calcSummarySection");
const calcSummaryBody = document.getElementById("calcSummaryBody");
const calcSummaryFooter = document.getElementById("calcSummaryFooter");
const calcTotalsDiv = document.getElementById("calcTotals");
const btnCloseSummary = document.getElementById("btnCloseSummary");
const btnRecalculate = document.getElementById("btnRecalculate");
const btnGenerateQuotation = document.getElementById("btnGenerateQuotation");
const btnExportExcel = document.getElementById("btnExportExcel");
const roeInput = document.getElementById("roeInput");

// Default terms and conditions
const defaultTerms = `
<ol>
  <li>This quotation is valid for 7 days from the date of issue.</li>
  <li>50% advance payment is required to confirm the booking.</li>
  <li>Remaining payment must be cleared 15 days before departure.</li>
  <li>All rates are subject to availability at the time of booking.</li>
  <li>Airline and hotel schedules are subject to change without prior notice.</li>
  <li>In case of visa rejection, 80% of the payment will be refunded after deducting processing fees.</li>
  <li>Package does not include personal expenses, laundry, or any services not mentioned in the itinerary.</li>
  <li>Company is not responsible for any delays or cancellations due to weather conditions or technical issues.</li>
</ol>
`;

// Store custom terms in Firebase Cloud / localStorage
let customTerms = localStorage.getItem('customTerms') || defaultTerms;

// Load custom terms from Firebase on startup
async function loadCustomTermsFromFirebase() {
  try {
    const agent = getCurrentAgent();
    if (agent && agent.uid) {
      const data = await window.firebaseDB.getData('agents/' + agent.uid + '/data', 'customTerms');
      if (data && data.value) {
        customTerms = data.value;
        localStorage.setItem('customTerms', data.value);
      }
    }
  } catch (error) {
    console.log('Could not load custom terms from Firebase, using local:', error);
  }
}

function fmt(num) {
  return num.toLocaleString("en-PK", { maximumFractionDigits: 0 });
}

// Toggle service charge options
function toggleServiceOption(option) {
  const perPersonOption = document.getElementById('perPersonSvcOption');
  
  if (option === 'perPerson') {
    perPersonOption.style.display = 'block';
  } else {
    perPersonOption.style.display = 'none';
  }
  
  // Reset values when switching options
  if (option === 'perPerson') {
    // No need to reset values when selecting perPerson
  } else {
    document.getElementById('svcPerAdult').value = 0;
    document.getElementById('svcPerChild').value = 0;
    document.getElementById('svcPerInfant').value = 0;
  }
  
  // Recalculate after changing options
  performCalculation();
}

function performCalculation() {
  // Check if the calculation was triggered by a button click
  const isButtonClick = document.activeElement === btnCalculate || document.activeElement === btnRecalculate;

  // --- VALIDATION 1: CLIENT & PAX ---
  const clientName = document.querySelector("#clientName, #client_name, #client")?.value?.trim() || "";
  const paxData = getCurrentPaxData();
  const totalPax = paxData ? (paxData.adults + paxData.childBed + paxData.childNoBed + paxData.infants) : 0;
  
  // --- VALIDATION 2: SERVICE CHECK FLAGS ---
  const hasFlights = document.querySelectorAll("[id^='flightCostAdult_']").length > 0;
  const hasMakkah = document.querySelectorAll("[id^='hkNameM_']").length > 0;
  const hasMadina = document.querySelectorAll("[id^='hkNameA_']").length > 0;
  const hasTransfers = document.querySelectorAll("[id^='tFrom_']").length > 0;
  const visaCost = parseFloat(document.getElementById("visaCost")?.value || 0);
  const hasExtras = document.querySelectorAll("[id^='dfAddon_']").length > 0 ||
    document.querySelectorAll("[id^='mealAddon_']").length > 0 ||
    document.querySelectorAll("[id^='ziyarahAddon_']").length > 0;
    
  // --- CORE VALIDATION LOGIC (Runs only on explicit button click) ---
  if (isButtonClick) {
    if (!clientName) {
      showToast("⚠️ Please enter client details!", "warning");
      return;
    }
    if (totalPax === 0) {
      showToast("⚠️ Please add Pax details before calculation!", "warning");
      return;
    }
    if (!(hasFlights || hasMakkah || hasMadina || hasTransfers || hasExtras || visaCost > 0)) {
      showToast("⚠️ Please add at least one service before calculating!", "warning");
      return;
    }
    
    // Success toast only shows if all checks pass
    showToast("✅ All details verified. Generating quotation...", "success");
  }

  // --- CALCULATION LOGIC ---
  const roe = parseFloat(roeInput.value || 0);
  let packageCostPKR = 0, packageServicePKR = 0;
  let addonCostPKR = 0, addonServicePKR = 0;

  // Pax Counts for Agent Service Fee Calculation
  const numAdult = parseInt(document.getElementById('numAdult')?.value || 0);
  const numChildBed = parseInt(document.getElementById('numChildBed')?.value || 0);
  const numChildNoBed = parseInt(document.getElementById('numChildNoBed')?.value || 0);
  const numChild = numChildBed + numChildNoBed; // Total children
  const numInfant = parseInt(document.getElementById('numInfant')?.value || 0);

  calcSummaryBody.innerHTML = "";

  const addDetailedRow = (section, desc, details, cost, svc, sell, perPerson = '', isAddon = false) => {
    if (isAddon) {
      addonCostPKR += cost;
      addonServicePKR += svc;
    } else {
      packageCostPKR += cost;
      packageServicePKR += svc;
    }
    calcSummaryBody.innerHTML += `
      <tr>
        <td>${section}</td>
        <td>
          <div style="font-weight: bold;">${desc}</div>
          <div class="small" style="color: #666;">${details}</div>
        </td>
        <td>${fmt(cost)}</td>
        <td>${fmt(svc)}</td>
        <td>${fmt(sell)}</td>
        <td>${perPerson}</td>
      </tr>`;
  };

  // --- FLIGHTS ---
  document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const p = paxData || { adults: 1, childBed: 0, childNoBed: 0, infants: 0 };
    
    // Get flight details
    const itinerary = document.getElementById(`flightItinerary_${idx}`)?.value || "Not specified";
    const airline = document.getElementById(`airline_${idx}`)?.value || "Not specified";
    const flightType = document.getElementById(`flightDirect_${idx}`)?.value || "Not specified";
    
    // Get costs
    const costAdult = parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0);
    const svcAdult = parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0);
    const costChildBed = parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0);
    const svcChildBed = parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0);
    const costChildNoBed = parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0);
    const svcChildNoBed = parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0);
    const costInf = parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0);
    const svcInf = parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0);

    // Calculate costs - ALL passenger types pay for flights
    const cost = (costAdult * p.adults) + 
                 (costChildBed * p.childBed) + 
                 (costChildNoBed * p.childNoBed) + 
                 (costInf * p.infants);
    const svc = (svcAdult * p.adults) + 
                (svcChildBed * p.childBed) + 
                (svcChildNoBed * p.childNoBed) + 
                (svcInf * p.infants);
    
    // Calculate per person pricing
    const perAdult = costAdult + svcAdult;
    const perChildBed = costChildBed + svcChildBed;
    const perChildNoBed = costChildNoBed + svcChildNoBed;
    const perInfant = costInf + svcInf;
    
    // Build per person text with counts and only show categories with passengers
    let perPersonText = [];
    if (p.adults > 0) perPersonText.push(`Adult x${p.adults}: PKR ${fmt(perAdult)}`);
    if (p.childBed > 0) perPersonText.push(`Child (with bed) x${p.childBed}: PKR ${fmt(perChildBed)}`);
    if (p.childNoBed > 0) perPersonText.push(`Child (no bed) x${p.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (p.infants > 0) perPersonText.push(`Infant x${p.infants}: PKR ${fmt(perInfant)}`);
    
    // Join the array with commas
    perPersonText = perPersonText.join(', ');
    
    // Create detailed description
    const details = `${airline} - ${flightType}<br>
                    Adults: ${p.adults} × PKR ${fmt(costAdult)}<br>
                    Children (with bed): ${p.childBed} × PKR ${fmt(costChildBed)}<br>
                    Children (no bed): ${p.childNoBed} × PKR ${fmt(costChildNoBed)}<br>
                    Infants: ${p.infants} × PKR ${fmt(costInf)}`;

    if (cost + svc > 0) {
      addDetailedRow(`Flight ${idx}`, airline, details, cost, svc, cost + svc, perPersonText, false);
    }
  });

  // --- MAKKAH HOTEL ---
  document.querySelectorAll("[id^='hotelBlockM_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`hkNameM_${idx}`)?.value || "Not specified";
    const distance = document.getElementById(`hkDistM_${idx}`)?.value || "Not specified";
    const checkIn = document.getElementById(`hkCheckInM_${idx}`)?.value || "Not specified";
    const checkOut = document.getElementById(`hkCheckOutM_${idx}`)?.value || "Not specified";
    const nights = parseFloat(document.getElementById(`hkNightsM_${idx}`)?.value || 0);
    const roomType = document.getElementById(`hkRoomTypeM_${idx}`)?.value || "Not specified";
    const rooms = parseFloat(document.getElementById(`hkRoomsM_${idx}`)?.value || 0);
    const serviceType = document.getElementById(`hkServiceM_${idx}`)?.value || "Not specified";
    const costNight = parseFloat(document.getElementById(`hkCostNightM_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hkSvcNightM_${idx}`)?.value || 0);

    // HOTEL COSTS: Only Adults and Children with bed pay for hotels
    const payingPax = paxData.adults + paxData.childBed;
    const cost = (costNight * nights * rooms) * roe;
    const svc = (svcNight * nights * rooms) * roe;
    
    // Calculate per person pricing - FIXED VERSION
    // Total cost is divided by total paying passengers
    const perPersonCost = payingPax > 0 ? (cost + svc) / payingPax : 0;
    
    // Each paying passenger type gets the same per-person cost
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = 0; // Children without bed don't pay for hotels
    const perInfant = 0; // Infants don't pay for hotels
    
    // Create detailed description
    const details = `${name} (${distance} from Haram)<br>
                    Check-in: ${formatDateToDMY(checkIn)}, Check-out: ${formatDateToDMY(checkOut)}<br>
                    ${nights} nights, ${roomType} × ${rooms} rooms<br>
                    Service: ${serviceType}<br>
                    Rate: SAR ${fmt(costNight)}/night × ${roe} = PKR ${fmt(costNight * roe)}/night<br>
                    Charged to: Adults (${paxData.adults}) + Children with bed (${paxData.childBed})`;

    // Build per person text with counts and only show categories with passengers
    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (paxData.infants > 0) perPersonText.push(`Infant x${paxData.infants}: PKR ${fmt(perInfant)}`);
    
    // Join the array with commas
    perPersonText = perPersonText.join(', ');

    if (cost + svc > 0) {
      addDetailedRow(`Makkah Hotel ${idx}`, name, details, cost, svc, cost + svc, perPersonText, false);
    }
  });

  // --- MADINA HOTEL ---
  document.querySelectorAll("[id^='hotelBlockA_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`hkNameA_${idx}`)?.value || "Not specified";
    const distance = document.getElementById(`hkDistA_${idx}`)?.value || "Not specified";
    const checkIn = document.getElementById(`hkCheckInA_${idx}`)?.value || "Not specified";
    const checkOut = document.getElementById(`hkCheckOutA_${idx}`)?.value || "Not specified";
    const nights = parseFloat(document.getElementById(`hkNightsA_${idx}`)?.value || 0);
    const roomType = document.getElementById(`hkRoomTypeA_${idx}`)?.value || "Not specified";
    const rooms = parseFloat(document.getElementById(`hkRoomsA_${idx}`)?.value || 0);
    const serviceType = document.getElementById(`hkServiceA_${idx}`)?.value || "Not specified";
    const costNight = parseFloat(document.getElementById(`hkCostNightA_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hkSvcNightA_${idx}`)?.value || 0);

    // HOTEL COSTS: Only Adults and Children with bed pay for hotels
    const payingPax = paxData.adults + paxData.childBed;
    const cost = (costNight * nights * rooms) * roe;
    const svc = (svcNight * nights * rooms) * roe;
    
    // Calculate per person pricing - FIXED VERSION
    // Total cost is divided by total paying passengers
    const perPersonCost = payingPax > 0 ? (cost + svc) / payingPax : 0;
    
    // Each paying passenger type gets the same per-person cost
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = 0; // Children without bed don't pay for hotels
    const perInfant = 0; // Infants don't pay for hotels
    
    // Create detailed description
    const details = `${name} (${distance} from Haram)<br>
                    Check-in: ${formatDateToDMY(checkIn)}, Check-out: ${formatDateToDMY(checkOut)}<br>
                    ${nights} nights, ${roomType} × ${rooms} rooms<br>
                    Service: ${serviceType}<br>
                    Rate: SAR ${fmt(costNight)}/night × ${roe} = PKR ${fmt(costNight * roe)}/night<br>
                    Charged to: Adults (${paxData.adults}) + Children with bed (${paxData.childBed})`;

    // Build per person text with counts and only show categories with passengers
    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (paxData.infants > 0) perPersonText.push(`Infant x${paxData.infants}: PKR ${fmt(perInfant)}`);
    
    // Join the array with commas
    perPersonText = perPersonText.join(', ');

    if (cost + svc > 0) {
      addDetailedRow(`Madina Hotel ${idx}`, name, details, cost, svc, cost + svc, perPersonText, false);
    }
  });

  // --- TRANSFERS ---
  document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const date = document.getElementById(`tDate_${idx}`)?.value || "Not specified";
    const from = document.getElementById(`tFrom_${idx}`)?.value || "Not specified";
    const to = document.getElementById(`tTo_${idx}`)?.value || "Not specified";
    const vehicle = document.getElementById(`tCar_${idx}`)?.value || "Not specified";
    const type = document.getElementById(`tType_${idx}`)?.value || "Not specified";
    const costSAR = parseFloat(document.getElementById(`tCostSAR_${idx}`)?.value || 0);
    const svcSAR = parseFloat(document.getElementById(`tSvcSAR_${idx}`)?.value || 0);

    const cost = costSAR * roe;
    const svc = svcSAR * roe;
    
    // TRANSFER COSTS: Adults, Children with bed, and Children without bed pay for transfers
    // Infants typically don't pay for transfers
    const payingPax = paxData.adults + paxData.childBed + paxData.childNoBed;
    
    // FIXED: Calculate per person cost by dividing by total paying passengers
    const perPersonCost = payingPax > 0 ? (cost + svc) / payingPax : 0;
    
    // Each paying passenger type gets the same per-person cost
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = paxData.childNoBed > 0 ? perPersonCost : 0;
    const perInfant = 0; // Infants don't pay for transfers
    
    // Create detailed description
    const details = `Date: ${formatDateToDMY(date)}<br>
                    Route: ${from} → ${to}<br>
                    Vehicle: ${vehicle} (${type})<br>
                    Rate: SAR ${fmt(costSAR)} × ${roe} = PKR ${fmt(cost)}<br>
                    Charged to: Adults (${paxData.adults}) + Children with bed (${paxData.childBed}) + Children without bed (${paxData.childNoBed})`;

    // Build per person text with counts and only show categories with passengers
    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (paxData.infants > 0) perPersonText.push(`Infant x${paxData.infants}: PKR ${fmt(perInfant)}`);
    
    // Join the array with commas
    perPersonText = perPersonText.join(', ');

    if (cost + svc > 0) {
      addDetailedRow(`Transfer ${idx}`, `${from} to ${to}`, details, cost, svc, cost + svc, perPersonText, false);
    }
  });

  // --- VISA ---
  const visaCostVal = parseFloat(document.getElementById("visaCost")?.value || 0);
  const visaSvc = parseFloat(document.getElementById("visaSvc")?.value || 0);
  const visaCount = parseFloat(document.getElementById("visaCount")?.value || 0);
  const visaType = "Standard Visa"; 

  if (visaCostVal > 0 || visaSvc > 0) {
    const cost = visaCostVal * visaCount * roe;
    const svc = visaSvc * visaCount * roe;
    
    // VISA COSTS: Adults, Children with bed, Children without bed, and Infants all pay for visa
    const payingPax = paxData.adults + paxData.childBed + paxData.childNoBed + paxData.infants;
    
    // FIXED: Calculate per person cost by dividing by total paying passengers
    const perPersonCost = payingPax > 0 ? (cost + svc) / payingPax : 0;
    
    // Each paying passenger type gets the same per-person cost
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = paxData.childNoBed > 0 ? perPersonCost : 0;
    const perInfant = paxData.infants > 0 ? perPersonCost : 0;
    
    // Build per person text with counts and only show categories with passengers
    let perPersonText = [];
    if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
    if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
    if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (paxData.infants > 0) perPersonText.push(`Infant x${paxData.infants}: PKR ${fmt(perInfant)}`);
    
    // Join the array with commas
    perPersonText = perPersonText.join(', ');
    
    addDetailedRow("Visa", `${visaType} (${visaCount} pax, Cost/Pax: ${fmt(visaCostVal)} SAR)`, 
                   `Cost: SAR ${fmt(visaCostVal)} × ${visaCount} × ${roe} = PKR ${fmt(cost)}<br>Service: SAR ${fmt(visaSvc)} × ${visaCount} × ${roe} = PKR ${fmt(svc)}`, 
                   cost, svc, cost + svc, 
                   perPersonText, false);
  }

  // --- AGENT EXTRA SERVICE CHARGE CALCULATION ---
  const svcOption = document.querySelector('input[name="svcOption"]:checked').value;
  let totalExtraServicePKR = 0;

  if (svcOption === 'perPerson') {
    const svcPerAdult = parseFloat(document.getElementById('svcPerAdult')?.value || 0);
    const svcPerChild = parseFloat(document.getElementById('svcPerChild')?.value || 0);
    const svcPerInfant = parseFloat(document.getElementById('svcPerInfant')?.value || 0);
    
    totalExtraServicePKR = (svcPerAdult * numAdult) + (svcPerChild * numChild) + (svcPerInfant * numInfant);
  }

  // Add a row for the extra service charge
  if (totalExtraServicePKR > 0) {
    const svcPerAdult = parseFloat(document.getElementById('svcPerAdult')?.value || 0);
    const svcPerChild = parseFloat(document.getElementById('svcPerChild')?.value || 0);
    const svcPerInfant = parseFloat(document.getElementById('svcPerInfant')?.value || 0);
    const svcDescription = `Per Person Service: Adult PKR ${fmt(svcPerAdult)}, Child PKR ${fmt(svcPerChild)}, Infant PKR ${fmt(svcPerInfant)}`;
    
    addDetailedRow(
        `Agent Service Fee`, 
        svcDescription,
        '',
        0, // Cost is 0
        totalExtraServicePKR, 
        totalExtraServicePKR,
        '',
        false
    );
  }

  // --- FINAL PACKAGE TOTALS & SUMMARY ---
  const finalPackageServicePKR = packageServicePKR;
  const finalPackageSellPKR = packageCostPKR + finalPackageServicePKR;

  // Calculate per person package price using the new function
  const perPersonCosts = calculatePerPersonCosts(packageCostPKR, finalPackageServicePKR, paxData);
  const { perAdult, perChildBed, perChildNoBed, perInfant } = perPersonCosts;

  // Build per person text for PACKAGE TOTALS row
  let packagePricingText = [];
  if (numAdult > 0) packagePricingText.push(`Adult x${numAdult}: PKR ${fmt(perAdult)}`);
  if (numChildBed > 0) packagePricingText.push(`Child (bed) x${numChildBed}: PKR ${fmt(perChildBed)}`);
  if (numChildNoBed > 0) packagePricingText.push(`Child (no bed) x${numChildNoBed}: PKR ${fmt(perChildNoBed)}`);
  if (numInfant > 0) packagePricingText.push(`Infant x${numInfant}: PKR ${fmt(perInfant)}`);
  packagePricingText = packagePricingText.join(', ');

  // Add PACKAGE TOTALS row before add-ons
  calcSummaryBody.innerHTML += `
    <tr style="font-weight: bold; background-color: #e3f2fd;">
      <td colspan="2">PACKAGE TOTALS</td>
      <td>${fmt(packageCostPKR)}</td>
      <td>${fmt(finalPackageServicePKR)}</td>
      <td>${fmt(finalPackageSellPKR)}</td>
      <td>${packagePricingText}</td>
    </tr>`;

  // --- UPGRADED FLIGHT ADD-ONS ---
  document.querySelectorAll("[id^='dfAddon_']").forEach((el, i) => {
    const idx = i + 1;
    const pax = paxData || { adults: 1, childBed: 0, childNoBed: 0, infants: 0 };
    
    // Get the upgrade index from the element ID
    const upgradeIndex = el.id.split('_')[1];
    
    // Get the differences stored in the element, or calculate them if not available
    let adultDifference = parseFloat(el.dataset.adultDifference || 0);
    let childBedDifference = parseFloat(el.dataset.childBedDifference || 0);
    let childNoBedDifference = parseFloat(el.dataset.childNoBedDifference || 0);
    let infantDifference = parseFloat(el.dataset.infantDifference || 0);
    
    // If differences are not set, calculate them
    if (adultDifference === 0 && childBedDifference === 0 && childNoBedDifference === 0 && infantDifference === 0) {
      const differences = calculateUpgradeDifference(upgradeIndex);
      adultDifference = differences.adultDiff;
      childBedDifference = differences.childBedDiff;
      childNoBedDifference = differences.childNoBedDiff;
      infantDifference = differences.infantDiff;
    }
    
    // Calculate total difference cost
    const cost = (adultDifference * pax.adults) + 
                 (childBedDifference * pax.childBed) + 
                 (childNoBedDifference * pax.childNoBed) + 
                 (infantDifference * pax.infants);
    
    // Get service fees (if any additional service for upgrade)
    let totalSvcPKR = 0;
    
    // Get service fees for each passenger type
    const upgradeAdultSvc = parseFloat(document.getElementById(`upgradeFlightSvcAdult_${upgradeIndex}`)?.value || 0);
    const upgradeChildBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildBed_${upgradeIndex}`)?.value || 0);
    const upgradeChildNoBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildNoBed_${upgradeIndex}`)?.value || 0);
    const upgradeInfantSvc = parseFloat(document.getElementById(`upgradeFlightSvcInf_${upgradeIndex}`)?.value || 0);
    
    totalSvcPKR = (upgradeAdultSvc * pax.adults) + 
                  (upgradeChildBedSvc * pax.childBed) + 
                  (upgradeChildNoBedSvc * pax.childNoBed) + 
                  (upgradeInfantSvc * pax.infants);
    
    // FIXED: Each passenger type pays their own difference, not divided by total pax
    const perAdult = adultDifference;
    const perChildBed = childBedDifference;
    const perChildNoBed = childNoBedDifference;
    const perInfant = infantDifference;
    
    // Build per person text with counts and only show categories with passengers
    let perPersonText = [];
    if (pax.adults > 0) perPersonText.push(`Adult x${pax.adults}: PKR ${fmt(perAdult)}`);
    if (pax.childBed > 0) perPersonText.push(`Child (with bed) x${pax.childBed}: PKR ${fmt(perChildBed)}`);
    if (pax.childNoBed > 0) perPersonText.push(`Child (no bed) x${pax.childNoBed}: PKR ${fmt(perChildNoBed)}`);
    if (pax.infants > 0) perPersonText.push(`Infant x${pax.infants}: PKR ${fmt(perInfant)}`);
    
    // Join the array with commas
    perPersonText = perPersonText.join(', ');
    
    // Get flight details for description
    const airline = el.querySelector("input[list='airlist']")?.value || "Unspecified";
    const flightType = el.querySelector('select')?.value || "Not specified";
    
    if (cost + totalSvcPKR > 0) {
      const details = `${airline} - ${flightType}<br>
                      Difference: Adult PKR ${fmt(adultDifference)}, Child (with bed) PKR ${fmt(perChildBed)}, Child (no bed) PKR ${fmt(perChildNoBed)}, Infant PKR ${fmt(perInfant)}`;
      
      addDetailedRow(`Add-on - Upgrade Flight ${idx}`, airline, details, cost, totalSvcPKR, cost + totalSvcPKR, perPersonText, true);
    }
  });

  // --- MEAL TYPE ADD-ONS ---
  document.querySelectorAll("[id^='mealAddon_']").forEach((el, i) => {
    const idx = i + 1;
    const selects = el.querySelectorAll('select');
    const inputs = el.querySelectorAll("input[type='number']");
    
    const name = "Meal Type";
    const hotel = selects[0]?.value || 'Not specified';
    const mealType = selects[1]?.value || "Not specified";
    
    let costPerPaxPerNightSAR = 0; 
    let svcPerPaxPerNightSAR = 0;
    
    if (inputs.length >= 2) {
      costPerPaxPerNightSAR = parseFloat(inputs[0].value || 0);
      svcPerPaxPerNightSAR = parseFloat(inputs[1].value || 0);
    }
    
    let cityNights = 0;
    if (hotel.includes('Madina')) {
      cityNights = parseInt(document.getElementById('nightsMadina')?.value || 0); 
    } else if (hotel.includes('Makkah')) {
      cityNights = parseInt(document.getElementById('nightsMakkah')?.value || 0);
    } else {
      // Fallback: Use total nights from date range
      const dateFrom = document.getElementById("dateFrom");
      const dateTo = document.getElementById("dateTo");
      if (dateFrom.value && dateTo.value) {
          const d1 = new Date(dateFrom.value);
          const d2 = new Date(dateTo.value);
          cityNights = Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
      }
    }
    
    const totalNights = cityNights > 0 ? cityNights : 0; 
    
    // FIXED: Only Adults and Children with bed pay for meals
    const payingPax = numAdult + numChildBed;
    const effectivePax = payingPax > 0 ? payingPax : 1; 

    const totalCostSAR = costPerPaxPerNightSAR * effectivePax * totalNights;
    const totalSvcSAR = svcPerPaxPerNightSAR * effectivePax * totalNights;

    const cost = totalCostSAR * roe;
    const svc = totalSvcSAR * roe;
    
    // FIXED: Calculate per person cost by dividing by total paying passengers (Adults + Children with bed)
    const perPersonCost = effectivePax > 0 ? (cost + svc) / effectivePax : 0;
    
    // Each paying passenger type gets the same per-person cost
    const perAdult = numAdult > 0 ? perPersonCost : 0;
    const perChildBed = numChildBed > 0 ? perPersonCost : 0;
    const perChildNoBed = 0; // Children without bed don't pay for meals
    const perInfant = 0; // Infants don't pay for meals
    
    if (cost + svc > 0 && totalNights > 0) {
      const details = `${hotel} - ${mealType}<br>
                      ${effectivePax} pax × ${totalNights} nights<br>
                      Cost: SAR ${fmt(costPerPaxPerNightSAR)}/pax/night<br>
                      Service: SAR ${fmt(svcPerPaxPerNightSAR)}/pax/night<br>
                      ROE: ${roe}<br>
                      Charged to: Adults (${numAdult}) + Children with bed (${numChildBed})`;
      
      // Build per person text with counts and only show categories with passengers
      let perPersonText = [];
      if (numAdult > 0) perPersonText.push(`Adult x${numAdult}: PKR ${fmt(perAdult)}`);
      if (numChildBed > 0) perPersonText.push(`Child (with bed) x${numChildBed}: PKR ${fmt(perChildBed)}`);
      // Children without bed and infants are not included in the per-person text since they don't pay
      
      // Join the array with commas
      perPersonText = perPersonText.join(', ');
      
      addDetailedRow(`Add-on - Meal Type ${idx}`, `${hotel} ${mealType}`, details, cost, svc, cost + svc, perPersonText, true);
    }
  });

  // --- ZIYARAH ADD-ONS ---
  document.querySelectorAll("[id^='ziyarahAddon_']").forEach((el, i) => {
    const idx = i + 1;
    const selects = el.querySelectorAll('select');
    const inputs = el.querySelectorAll(".inline-input input[type='number']");
    
    const name = "Ziyarah";
    const city = selects[0]?.value || "Not specified";
    const vehicle = selects[1]?.value || "Not specified";
    const type = selects[2]?.value || "Not specified";
    
    let totalCostSAR = 0;
    let totalSvcSAR = 0;
    
    if (inputs.length >= 2) {
      totalCostSAR += parseFloat(inputs[0].value || 0);
      totalSvcSAR += parseFloat(inputs[1].value || 0);
    }
    
    const cost = totalCostSAR * roe;
    const svc = totalSvcSAR * roe;
    
    // FIXED: Calculate per person cost by dividing by paying passengers only (excluding infants)
    const payingPax = paxData.adults + paxData.childBed + paxData.childNoBed;
    const perPersonCost = payingPax > 0 ? (cost + svc) / payingPax : 0;
    
    // Each paying passenger type gets the same per-person cost
    const perAdult = paxData.adults > 0 ? perPersonCost : 0;
    const perChildBed = paxData.childBed > 0 ? perPersonCost : 0;
    const perChildNoBed = paxData.childNoBed > 0 ? perPersonCost : 0;
    const perInfant = 0; // Infants don't pay for ziyarah
    
    if (cost + svc > 0) {
      const details = `${city} - ${vehicle} (${type})<br>
                      Cost: SAR ${fmt(totalCostSAR)}/vehicle<br>
                      Service: SAR ${fmt(totalSvcSAR)}/vehicle<br>
                      ROE: ${roe}<br>
                      Charged to: Adults (${paxData.adults}) + Children with bed (${paxData.childBed}) + Children without bed (${paxData.childNoBed})`;
      
      // Build per person text with counts and only show categories with passengers
      let perPersonText = [];
      if (paxData.adults > 0) perPersonText.push(`Adult x${paxData.adults}: PKR ${fmt(perAdult)}`);
      if (paxData.childBed > 0) perPersonText.push(`Child (with bed) x${paxData.childBed}: PKR ${fmt(perChildBed)}`);
      if (paxData.childNoBed > 0) perPersonText.push(`Child (no bed) x${paxData.childNoBed}: PKR ${fmt(perChildNoBed)}`);
      // Infants are not included in the per-person text since they don't pay
      
      // Join the array with commas
      perPersonText = perPersonText.join(', ');
      
      addDetailedRow(`Add-on - Ziyarah ${idx}`, `${city} ${type}`, details, cost, svc, cost + svc, perPersonText, true);
    }
  });

  // Final Footer Row - Only show add-ons header if there are add-ons
  if (addonCostPKR > 0 || addonServicePKR > 0) {
    calcSummaryFooter.innerHTML = `
      <tr style="background-color: #f8f9fa;">
        <td colspan="6" style="text-align: center; font-weight: bold; color: #666; padding: 10px;">
          OPTIONAL ADD-ONS (Customer can select as needed)
        </td>
      </tr>`;
  } else {
    calcSummaryFooter.innerHTML = '';
  }

  // Final Totals Div
  calcTotalsDiv.innerHTML = `
      <div style="margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 6px;">
        <h4 style="margin: 0 0 5px 0; color: #0b76d1;">Package Summary</h4>
        <div>Package Cost: PKR ${fmt(packageCostPKR)}</div>
        <div>Package Service: PKR ${fmt(finalPackageServicePKR)}</div>
        <div style="font-size: 18px; font-weight: bold; color: #0b76d1;">Package Total: PKR ${fmt(finalPackageSellPKR)}</div>
        <div style="margin-top: 5px; font-size: 14px;">${packagePricingText}</div>
      </div>
      ${addonCostPKR > 0 || addonServicePKR > 0 ? `
      <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
        <h4 style="margin: 0 0 5px 0; color: #666;">Optional Add-ons</h4>
        <div>Add-ons Cost: PKR ${fmt(addonCostPKR)}</div>
        <div>Add-ons Service: PKR ${fmt(addonServicePKR)}</div>
        <div style="font-size: 16px; font-weight: bold; color: #666;">Add-ons Total: PKR ${fmt(addonCostPKR + addonServicePKR)}</div>
      </div>
      <div style="padding: 10px; background: #e8f5e8; border-radius: 6px;">
        <h4 style="margin: 0 0 5px 0; color: #2e7d32;">Grand Total (Package + Selected Add-ons)</h4>
        <div style="font-size: 20px; font-weight: bold; color: #2e7d32;">PKR ${fmt(finalPackageSellPKR + addonCostPKR + addonServicePKR)}</div>
      </div>` : ''}
  `;
  showStatusSection();

  calcSummarySection.style.display = "block";
  btnGenerateQuotation.style.display = "inline-block";
  
  // Scroll to the total section only on explicit button click
  if (isButtonClick) {
    calcSummarySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  // At the end of performCalculation function, add this:
const btnGenerateQuotation2 = document.getElementById("btnGenerateQuotation2");
if (btnGenerateQuotation2) btnGenerateQuotation2.style.display = "inline-block";
}

// Function to calculate per person costs based on your requirements
function calculatePerPersonCosts(packageCostPKR, packageServicePKR, paxData) {
  const numAdult = paxData.adults || 0;
  const numChildBed = paxData.childBed || 0;
  const numChildNoBed = paxData.childNoBed || 0;
  const numInfant = paxData.infants || 0;
  const roe = parseFloat(roeInput.value || 0);
  
  // Initialize per person costs for each passenger type
  let perAdultCost = 0, perChildBedCost = 0, perChildNoBedCost = 0, perInfantCost = 0;
  
  // Calculate Flight costs per person
  document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    
    if (numAdult > 0) {
      const costAdult = parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0);
      const svcAdult = parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0);
      perAdultCost += (costAdult + svcAdult);
    }
    
    if (numChildBed > 0) {
      const costChildBed = parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0);
      const svcChildBed = parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0);
      perChildBedCost += (costChildBed + svcChildBed);
    }
    
    if (numChildNoBed > 0) {
      const costChildNoBed = parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0);
      const svcChildNoBed = parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0);
      perChildNoBedCost += (costChildNoBed + svcChildNoBed);
    }
    
    if (numInfant > 0) {
      const costInf = parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0);
      const svcInf = parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0);
      perInfantCost += (costInf + svcInf);
    }
  });
  
  // Calculate Hotel costs per person (only for adults and children with bed)
  const hotelPayingPax = numAdult + numChildBed;
  
  document.querySelectorAll("[id^='hotelBlockM_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const nights = parseFloat(document.getElementById(`hkNightsM_${idx}`)?.value || 0);
    const rooms = parseFloat(document.getElementById(`hkRoomsM_${idx}`)?.value || 0);
    const costNight = parseFloat(document.getElementById(`hkCostNightM_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hkSvcNightM_${idx}`)?.value || 0);
    
    if (hotelPayingPax > 0) {
      const totalCost = (costNight + svcNight) * nights * rooms * roe;
      const perPersonCost = totalCost / hotelPayingPax;
      
      if (numAdult > 0) perAdultCost += perPersonCost;
      if (numChildBed > 0) perChildBedCost += perPersonCost;
    }
  });
  
  document.querySelectorAll("[id^='hotelBlockA_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const nights = parseFloat(document.getElementById(`hkNightsA_${idx}`)?.value || 0);
    const rooms = parseFloat(document.getElementById(`hkRoomsA_${idx}`)?.value || 0);
    const costNight = parseFloat(document.getElementById(`hkCostNightA_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hkSvcNightA_${idx}`)?.value || 0);
    
    if (hotelPayingPax > 0) {
      const totalCost = (costNight + svcNight) * nights * rooms * roe;
      const perPersonCost = totalCost / hotelPayingPax;
      
      if (numAdult > 0) perAdultCost += perPersonCost;
      if (numChildBed > 0) perChildBedCost += perPersonCost;
    }
  });
  
  // Calculate Visa costs per person
  const visaCostVal = parseFloat(document.getElementById("visaCost")?.value || 0);
  const visaSvc = parseFloat(document.getElementById("visaSvc")?.value || 0);
  const visaPerPerson = (visaCostVal + visaSvc) * roe;
  
  if (numAdult > 0) perAdultCost += visaPerPerson;
  if (numChildBed > 0) perChildBedCost += visaPerPerson;
  if (numChildNoBed > 0) perChildNoBedCost += visaPerPerson;
  if (numInfant > 0) perInfantCost += visaPerPerson;
  
  // Calculate Transfer costs per person
  const transferPayingPax = numAdult + numChildBed + numChildNoBed;
  
  document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const costSAR = parseFloat(document.getElementById(`tCostSAR_${idx}`)?.value || 0);
    const svcSAR = parseFloat(document.getElementById(`tSvcSAR_${idx}`)?.value || 0);
    const totalTransferCost = (costSAR + svcSAR) * roe;
    
    if (transferPayingPax > 0) {
      const perPersonCost = totalTransferCost / transferPayingPax;
      
      if (numAdult > 0) perAdultCost += perPersonCost;
      if (numChildBed > 0) perChildBedCost += perPersonCost;
      if (numChildNoBed > 0) perChildNoBedCost += perPersonCost;
    }
  });
  
  // Add agent service fee per person if applicable
  const svcOption = document.querySelector('input[name="svcOption"]:checked').value;
  if (svcOption === 'perPerson') {
    const svcPerAdult = parseFloat(document.getElementById('svcPerAdult')?.value || 0);
    const svcPerChild = parseFloat(document.getElementById('svcPerChild')?.value || 0);
    const svcPerInfant = parseFloat(document.getElementById('svcPerInfant')?.value || 0);
    
    if (numAdult > 0) perAdultCost += svcPerAdult;
    if (numChildBed > 0) perChildBedCost += svcPerChild;
    if (numChildNoBed > 0) perChildNoBedCost += svcPerChild;
    if (numInfant > 0) perInfantCost += svcPerInfant;
  } else if (svcOption === 'total') {
    const totalExtraServicePKR = parseFloat(document.getElementById('extraSvcTotal')?.value || 0);
    const totalPax = numAdult + numChildBed + numChildNoBed + numInfant;
    
    if (totalPax > 0) {
      const perPersonService = totalExtraServicePKR / totalPax;
      
      if (numAdult > 0) perAdultCost += perPersonService;
      if (numChildBed > 0) perChildBedCost += perPersonService;
      if (numChildNoBed > 0) perChildNoBedCost += perPersonService;
      if (numInfant > 0) perInfantCost += perPersonService;
    }
  }
  
  return {
    perAdult: perAdultCost,
    perChildBed: perChildBedCost,
    perChildNoBed: perChildNoBedCost,
    perInfant: perInfantCost
  };
}

// --- EVENTS ---
btnCalculate.addEventListener("click", performCalculation);
btnRecalculate.addEventListener("click", performCalculation);
btnCloseSummary.addEventListener("click", () => (calcSummarySection.style.display = "none"));
roeInput.addEventListener("input", performCalculation);

// Service Details Function
function getFlightDetails() {
  let airline = "Not specified";
  let direct = "Not specified";
  let itinerary = "Not specified";
  
  // Get details from the first flight
  const firstFlight = document.querySelector("[id^='flightBlock_']");
  if (firstFlight) {
    const idx = firstFlight.id.split("_")[1];
    airline = document.getElementById(`airline_${idx}`)?.value || "Not specified";
    direct = document.getElementById(`flightDirect_${idx}`)?.value || "Not specified";
    itinerary = document.getElementById(`flightItinerary_${idx}`)?.value || "Not specified";
  }
  
  return { airline, direct, itinerary };
}

function getMakkahHotelDetails() {
  let name = "Not specified";
  let distance = "Not specified";
  let checkIn = "";
  let checkOut = "";
  let nights = 0;
  let roomType = "Not specified";
  let serviceType = "Not specified";
  let rooms = 0;
  
  // Get details from the first Makkah hotel
  const firstHotel = document.querySelector("[id^='hotelBlockM_']");
  if (firstHotel) {
    const idx = firstHotel.id.split("_")[1];
    name = document.getElementById(`hkNameM_${idx}`)?.value || "Not specified";
    distance = document.getElementById(`hkDistM_${idx}`)?.value || "Not specified";
    checkIn = document.getElementById(`hkCheckInM_${idx}`)?.value || "";
    checkOut = document.getElementById(`hkCheckOutM_${idx}`)?.value || "";
    nights = parseInt(document.getElementById(`hkNightsM_${idx}`)?.value || 0);
    roomType = document.getElementById(`hkRoomTypeM_${idx}`)?.value || "Not specified";
    serviceType = document.getElementById(`hkServiceM_${idx}`)?.value || "Not specified";
    rooms = parseInt(document.getElementById(`hkRoomsM_${idx}`)?.value || 0);
  }
  
  return { name, distance, checkIn, checkOut, nights, roomType, serviceType, rooms };
}

function getMadinaHotelDetails() {
  let name = "Not specified";
  let distance = "Not specified";
  let checkIn = "";
  let checkOut = "";
  let nights = 0;
  let roomType = "Not specified";
  let serviceType = "Not specified";
  let rooms = 0;
  
  // Get details from the first Madina hotel
  const firstHotel = document.querySelector("[id^='hotelBlockA_']");
  if (firstHotel) {
    const idx = firstHotel.id.split("_")[1];
    name = document.getElementById(`hkNameA_${idx}`)?.value || "Not specified";
    distance = document.getElementById(`hkDistA_${idx}`)?.value || "Not specified";
    checkIn = document.getElementById(`hkCheckInA_${idx}`)?.value || "";
    checkOut = document.getElementById(`hkCheckOutA_${idx}`)?.value || "";
    nights = parseInt(document.getElementById(`hkNightsA_${idx}`)?.value || 0);
    roomType = document.getElementById(`hkRoomTypeA_${idx}`)?.value || "Not specified";
    serviceType = document.getElementById(`hkServiceA_${idx}`)?.value || "Not specified";
    rooms = parseInt(document.getElementById(`hkRoomsA_${idx}`)?.value || 0);
  }
  
  return { name, distance, checkIn, checkOut, nights, roomType, serviceType, rooms };
}

function getVisaDetails() {
  let count = 0;
  let cost = 0;
  let service = 0;
  
  if (document.getElementById('visaBlock')) {
    count = parseInt(document.getElementById('visaCount')?.value || 0);
    cost = parseFloat(document.getElementById('visaCost')?.value || 0);
    service = parseFloat(document.getElementById('visaSvc')?.value || 0);
  }
  
  return { count, cost, service };
}

function getTransferDetails() {
  let transferDetails = [];
  
  document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const date = document.getElementById(`tDate_${idx}`)?.value || "";
    const from = document.getElementById(`tFrom_${idx}`)?.value || "";
    const to = document.getElementById(`tTo_${idx}`)?.value || "";
    const vehicle = document.getElementById(`tCar_${idx}`)?.value || "";
    const type = document.getElementById(`tType_${idx}`)?.value || "";
    
    if (date && from && to && vehicle) {
      const formattedDate = formatDateToDMY(date);
      // Format: "10 Nov - Jeddah Airport to Makkah Hotel by Private Car"
      transferDetails.push(`${formattedDate} - ${from} to ${to} by ${type} ${vehicle}`);
    }
  });
  
  if (transferDetails.length === 0) {
    return "No transfers included in this package.";
  }
  
  // Join with line breaks for better readability
  return transferDetails.join("<br>");
}

// --- GENERATE QUOTATION ---
btnGenerateQuotation.addEventListener("click", showQuotationModal);
  function showQuotationModal() {
  const modal = document.getElementById('quotationModal');
  const modalTitle = document.getElementById('quotationModalTitle');
  const modalContent = document.getElementById('quotationModalContent');
  const modalButtons = document.getElementById('quotationModalButtons');

function printQuotation() {
  try {
    const modalContent = document.getElementById("quotationModalContent");
    if (!modalContent) {
      showAlert("Quotation preview not found!", "Error");
      return;
    }
    
    setTimeout(() => {
      let clonedContent = modalContent.cloneNode(true);
      // Remove toggle buttons
      const buttons = clonedContent.querySelectorAll('button[onclick*="toggle"]');
      buttons.forEach(btn => btn.remove());
      // Remove hidden sections
      const sectionIds = ['calculationSummarySection', 'flightSection', 'hotelSection', 'addonSection', 'priceBreakupSection'];
      sectionIds.forEach(id => {
        const div = clonedContent.querySelector('#' + id);
        if (div && div.style.display === 'none') {
          div.remove();
        }
      });
      let html = clonedContent.innerHTML;
      // Make PDF more compact by reducing margins
      html = html.replace(/margin-bottom:\s*20px/g, 'margin-bottom: 15px');
      html = html.replace(/padding:\s*15px/g, 'padding: 10px');
      html = html.replace(/margin:\s*15px/g, 'margin: 10px');
      
      const printWindow = window.open('', '_blank');
      
      const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Quotation #${currentQuotationId}</title>
          <style>
            /* Force colors with multiple methods */
            * {
              -webkit-print-color-adjust: exact !important;
              color-adjust: exact !important;
              print-color-adjust: exact !important;
            }
            
            body { 
              font-family: 'Calibri', Arial, sans-serif;
              margin: 0px;
              color: #111;
              background: white !important;
              font-size: 12px;
              line-height: 1.4;
            }
            
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            
            /* Headers - no blue background, just color */
            h1, h2, h3 { 
              color: #0b76d1 !important;
              padding: 0px 0 !important;
              margin: 15px 0 10px 0 !important;
              display: block !important;
              font-size: 16px !important;
              page-break-after: avoid !important;
              page-break-inside: avoid !important;
              page-break-before: auto !important;
            }
            
            /* Tables - keep exactly as original */
            table { 
              width: 100%;
              border-collapse: collapse;
              margin: 10px 0 15px 0;
              border: 0.5px solid #ddd !important;
              page-break-inside: auto !important;
              page-break-before: auto !important;
              page-break-after: auto !important;
            }
            
            th, td { 
              border: 0.5px solid #ddd !important;
              padding: 6px 8px;
              text-align: left;
              font-size: 11px;
              page-break-inside: avoid !important;
            }
            
            th { 
              background: linear-gradient(to right, #0b76d1, #0a6bbd) !important;
              color: white !important;
              font-weight: bold;
            }
            
            p {
              margin: 5px 0;
              page-break-inside: avoid !important;
              orphans: 2;
              widows: 2;
            }
            
            /* Sections - NO blue background or borders */
            div[style*="border: 1px solid #eee"],
            div[style*="border: 1px solid #ddd"] {
              margin: 10px 0 15px 0 !important;
              padding: 10px !important;
              border: none !important;
              border-radius: 0px !important;
              background: white !important;
              page-break-inside: avoid !important;
              page-break-before: auto !important;
              page-break-after: auto !important;
            }
            
            /* Keep green sections */
            div[style*="background-color: #e8f5e8"], 
            div[style*="background-color: #e8f5e9"] {
              background: #e8f5e8 !important;
              border: 2px solid #2e7d32 !important;
              color: #2e7d32 !important;
              page-break-inside: avoid !important;
            }
            
            /* Keep gray sections */
            div[style*="background-color: #f8f9fa"] {
              background: #f8f9fa !important;
              border: 1px solid #ddd !important;
              color: #666 !important;
              page-break-inside: avoid !important;
            }
            
            /* Keep table rows exactly as original - no alternating colors */
            table tbody tr {
              /* Keep original styling - don't add or remove grey */
            }
            
            /* Total rows with light blue */
            table tfoot tr,
            tr[style*="background-color: #e3f2fd"] {
              background: #e3f2fd !important;
              color: #0b76d1 !important;
              font-weight: bold !important;
              page-break-inside: avoid !important;
            }
            
            /* Remove blue from package total section */
            div[style*="background-color: #e3f2fd"]:not(table tr) {
              background: white !important;
              border: 1px solid #ddd !important;
            }
            
            /* Image styling */
            img {
              max-width: 100% !important;
              height: auto !important;
              page-break-inside: avoid !important;
              page-break-before: auto !important;
              page-break-after: auto !important;
            }
            
            /* Specific page break controls for important sections */
            .section-header {
              page-break-after: avoid !important;
              page-break-inside: avoid !important;
            }
            
            .section-content {
              page-break-inside: avoid !important;
            }
            
            .table-container {
              page-break-inside: avoid !important;
              page-break-before: auto !important;
              page-break-after: auto !important;
            }
            
            /* Print settings */
            @media print {
              @page { 
                margin: 0.5in; 
                size: A4;
                
                /* Header and Footer */
                @top-center {
                  content: "Flight Connection Travel & Tours";
                  font-size: 12px;
                  color: #0b76d1;
                  font-weight: bold;
                }
                
                @bottom-center {
                  content: "Page " counter(page);
                  font-size: 10px;
                  color: #666;
                }
              }
              
              /* Force everything to print with colors */
              * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
              }
              
              /* Page break controls for different elements */
              h1, h2, h3, h4 {
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                page-break-before: auto !important;
              }
              
              table {
                page-break-inside: auto !important;
                page-break-before: auto !important;
                page-break-after: auto !important;
              }
              
              tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
              }
              
              td, th {
                page-break-inside: avoid !important;
              }
              
              div {
                page-break-inside: auto !important;
              }
              
              p, li {
                page-break-inside: avoid !important;
                orphans: 2;
                widows: 2;
              }
              
              img {
                page-break-inside: avoid !important;
                page-break-before: auto !important;
                page-break-after: auto !important;
              }
              
              /* Specific section controls */
              .section, .section-entry {
                page-break-inside: avoid !important;
                page-break-before: auto !important;
                page-break-after: auto !important;
              }
              
              /* Prevent breaks inside important content */
              .client-info, .travel-info, .package-price, .service-details {
                page-break-inside: avoid !important;
              }
              
              /* Table specific controls */
              .cost-table {
                page-break-inside: auto !important;
              }
              
              .cost-table thead {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
              }
              
              .cost-table tfoot {
                page-break-inside: avoid !important;
                page-break-before: auto !important;
              }
            }
          </style>
        </head>
        <body>
          ${html}
        </body>
        </html>
      `;
      
      printWindow.document.write(printHTML);
      printWindow.document.close();
      
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 1000);
      };
      
    }, 1000);
    
  } catch (error) {
    console.error('Error printing quotation:', error);
    showAlert("Failed to print. Please try again.", "Error");
  }
}
  
  // Get all necessary data
  const clientData = getClientData();
  const agentData = getCurrentAgent();
  const roe = parseFloat(roeInput.value || 0);
  
  // Generate a unique quotation number if not exists
  if (!currentQuotationId) {
    currentQuotationId = 'UMH-' + Date.now().toString().slice(-6);
  }
  
  // Calculate totals from the summary table
  let totalCostPKR = 0;
  let totalServicePKR = 0;
  let addonCostPKR = 0;
  let addonServicePKR = 0;
  
  // Recalculate totals from the summary table
  document.querySelectorAll("#calcSummaryBody tr").forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length >= 5) {
      const section = cells[0].textContent;
      const cost = parseFloat(cells[2].textContent.replace(/,/g, ''));
      const svc = parseFloat(cells[3].textContent.replace(/,/g, ''));
      
      if (section.includes("Add-on")) {
        addonCostPKR += cost;
        addonServicePKR += svc;
      } else {
        totalCostPKR += cost;
        totalServicePKR += svc;
      }
    }
  });
  
  // Add service charge
  const svcOption = document.querySelector('input[name="svcOption"]:checked').value;
  let totalExtraServicePKR = 0;
  
  if (svcOption === 'total') {
    totalExtraServicePKR = parseFloat(document.getElementById('extraSvcTotal')?.value || 0);
  } else if (svcOption === 'perPerson') {
    const svcPerAdult = parseFloat(document.getElementById('svcPerAdult')?.value || 0);
    const svcPerChild = parseFloat(document.getElementById('svcPerChild')?.value || 0);
    const svcPerInfant = parseFloat(document.getElementById('svcPerInfant')?.value || 0);
    
    totalExtraServicePKR = (svcPerAdult * clientData.adults) + 
                          (svcPerChild * (clientData.childBed + clientData.childNoBed)) + 
                          (svcPerInfant * clientData.infants);
  }
  
  const finalTotalServicePKR = totalServicePKR + totalExtraServicePKR;
  const finalTotalSellPKR = totalCostPKR + finalTotalServicePKR;
  const finalTotalWithAddonsPKR = finalTotalSellPKR + addonCostPKR + addonServicePKR;
  
// Extract per person costs from the calculation summary
let packagePerAdult = 0, packagePerChildBed = 0, packagePerChildNoBed = 0, packagePerInfant = 0;

// Find the PACKAGE TOTALS row in the calculation summary
const packageTotalsRow = Array.from(document.querySelectorAll("#calcSummaryBody tr")).find(row => {
  const sectionCell = row.querySelector("td:first-child");
  return sectionCell && sectionCell.textContent.includes("PACKAGE TOTALS");
});

if (packageTotalsRow) {
  // Extract the per-person costs from the last cell of the PACKAGE TOTALS row
  const perPersonText = packageTotalsRow.querySelector("td:last-child").textContent;
  
  // Debug: Log the actual text to see what we're working with
  console.log("Per person text:", perPersonText);
  
  // Parse the per-person costs from the text
  const adultMatch = perPersonText.match(/Adult x(\d+): PKR ([\d,]+)/);
  const childBedMatch = perPersonText.match(/Child \(with bed\) x(\d+): PKR ([\d,]+)/);
  const childNoBedMatch = perPersonText.match(/Child \(no bed\) x(\d+): PKR ([\d,]+)/);
  const infantMatch = perPersonText.match(/Infant x(\d+): PKR ([\d,]+)/);
  
  // Debug: Log the matches
  console.log("Adult match:", adultMatch);
  console.log("Child bed match:", childBedMatch);
  console.log("Child no bed match:", childNoBedMatch);
  console.log("Infant match:", infantMatch);
  
  if (adultMatch) packagePerAdult = parseFloat(adultMatch[2].replace(/,/g, ''));
  if (childBedMatch) packagePerChildBed = parseFloat(childBedMatch[2].replace(/,/g, ''));
  if (childNoBedMatch) packagePerChildNoBed = parseFloat(childNoBedMatch[2].replace(/,/g, ''));
  if (infantMatch) packagePerInfant = parseFloat(infantMatch[2].replace(/,/g, ''));
  
  // If child with bed is still 0, try alternative patterns
  if (packagePerChildBed === 0 && clientData.childBed > 0) {
    // Try "Child (bed)" pattern
    const altChildBedMatch = perPersonText.match(/Child \(bed\) x(\d+): PKR ([\d,]+)/);
    if (altChildBedMatch) {
      packagePerChildBed = parseFloat(altChildBedMatch[2].replace(/,/g, ''));
      console.log("Alternative child bed match:", altChildBedMatch);
    }
  }
} else {
  // Fallback to the calculation function if the PACKAGE TOTALS row is not found
  const perPersonCosts = calculatePerPersonCosts(packageCostPKR, finalPackageServicePKR, clientData);
  packagePerAdult = perPersonCosts.perAdult;
  packagePerChildBed = perPersonCosts.perChildBed;
  packagePerChildNoBed = perPersonCosts.perChildNoBed;
  packagePerInfant = perPersonCosts.perInfant;
}

// Calculate the total package amount correctly
const totalPackageAmount = (packagePerAdult * clientData.adults) + 
                           (packagePerChildBed * clientData.childBed) + 
                           (packagePerChildNoBed * clientData.childNoBed) + 
                           (packagePerInfant * clientData.infants);

// Debug: Log the final values
console.log("Final per person costs:", {
  packagePerAdult,
  packagePerChildBed,
  packagePerChildNoBed,
  packagePerInfant
});
console.log("Total package amount:", totalPackageAmount);

  // Build the HTML for the quotation preview
  let quotationHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="https://flightconnection.net.pk/wp-content/uploads/2018/09/cropped-cropped-Flight-Connection-Travel-1.png" alt="Company Logo" style="max-height: 80px;">
      <h2 style="margin: 5px 0; color: #0b76d1;">Flight Connection Travel & Tours</h2>
      <div style="font-size: 18px; font-weight: bold; color: #333; margin-top: 10px;">
        Quotation Number: <span style="color: #0b76d1;">${currentQuotationId}</span>
      </div>
     </div>
    
    <div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #0b76d1;">Client Information</h3>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <div><strong>Client Name:</strong> ${sanitizeInput(clientData.name || 'N/A')}</div>
        <div><strong>Phone:</strong> ${sanitizeInput(clientData.phone || 'N/A')}</div>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <div><strong>Reference:</strong> ${sanitizeInput(clientData.reference || 'N/A')}</div>
        <div><strong>Quotation Date:</strong> ${new Date().toLocaleDateString()}</div>
      </div>
    </div>
    
    <div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #0b76d1;">Travel Information</h3>
      <div style="margin-bottom: 8px;"><strong>Travel Dates:</strong> ${formatDateToDMY(clientData.dateFrom)} to ${formatDateToDMY(clientData.dateTo)}</div>
      <div style="margin-bottom: 8px;"><strong>Duration:</strong> ${clientData.nightsMakkah + clientData.nightsMadina} Nights / ${clientData.nightsMakkah + clientData.nightsMadina + 1} Days</div>
      <div style="margin-bottom: 8px;"><strong>Departure City:</strong> ${sanitizeInput(clientData.depCity || 'N/A')}</div>
      <div><strong>Passengers:</strong> Adults: ${clientData.adults}, Children (with bed): ${clientData.childBed}, Children (without bed): ${clientData.childNoBed}, Infants: ${clientData.infants}</div>
    </div>
    
    <div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #0b76d1;">Package Price</h3>
      <table style="width:100%; border-collapse: collapse;">
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Per Adult</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(packagePerAdult)}</td>
        </tr>
        ${clientData.childBed > 0 ? `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Per Child (with bed)</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(packagePerChildBed)}</td>
        </tr>` : ''}
        ${clientData.childNoBed > 0 ? `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Per Child (without bed)</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(packagePerChildNoBed)}</td>
        </tr>` : ''}
        ${clientData.infants > 0 ? `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Per Infant</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(packagePerInfant)}</td>
        </tr>` : ''}
        <tr style="background-color: #f9f9f9;">
          <td style="border: 1px solid #ddd; padding: 8px;"><strong>Total Package Amount</strong></td>
<td style="border: 1px solid #ddd; padding: 8px;"><strong>PKR ${fmt(totalPackageAmount)}</strong></td>
        </tr>
      </table>
    </div>
        
   <!-- Service Details -->
<div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
  <h3 style="margin-top: 0; color: #0b76d1;">Service Details</h3>
  
  <!-- Flight Details - Only show if flights are included -->
  ${document.querySelectorAll("[id^='flightBlock_']").length > 0 ? `
  <div style="margin-bottom: 15px;">
    <h4 style="color: #0b76d1; margin-bottom: 8px;">Flight</h4>
    <table style="width:100%; border-collapse: collapse;">
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 150px;">Airline</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getFlightDetails().airline}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Flight Type</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getFlightDetails().direct}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; vertical-align: top;">Flight Itinerary</td>
        <td style="border: 1px solid #ddd; padding: 8px; white-space: pre-wrap; font-family: monospace; font-size: 13px;">${getFlightDetails().itinerary}</td>
      </tr>
    </table>
  </div>` : ''}
  
  <!-- Makkah Hotel Details - Only show if Makkah hotels are included -->
  ${document.querySelectorAll("[id^='hotelBlockM_']").length > 0 ? `
  <div style="margin-bottom: 15px;">
    <h4 style="color: #0b76d1; margin-bottom: 8px;">Makkah Hotel</h4>
    <table style="width:100%; border-collapse: collapse;">
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 150px;">Hotel Name</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMakkahHotelDetails().name}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Distance</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMakkahHotelDetails().distance}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Check-in</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDMY(getMakkahHotelDetails().checkIn)}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Check-out</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDMY(getMakkahHotelDetails().checkOut)}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Total Nights</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMakkahHotelDetails().nights}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Room Type</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMakkahHotelDetails().roomType}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Service Type</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMakkahHotelDetails().serviceType}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Number of Rooms</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMakkahHotelDetails().rooms}</td>
      </tr>
    </table>
  </div>` : ''}
  
  <!-- Madina Hotel Details - Only show if Madina hotels are included -->
  ${document.querySelectorAll("[id^='hotelBlockA_']").length > 0 ? `
  <div style="margin-bottom: 15px;">
    <h4 style="color: #0b76d1; margin-bottom: 8px;">Madina Hotel</h4>
    <table style="width:100%; border-collapse: collapse;">
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 150px;">Hotel Name</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMadinaHotelDetails().name}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Distance</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMadinaHotelDetails().distance}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Check-in</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDMY(getMadinaHotelDetails().checkIn)}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Check-out</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${formatDateToDMY(getMadinaHotelDetails().checkOut)}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Total Nights</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMadinaHotelDetails().nights}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Room Type</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMadinaHotelDetails().roomType}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Service Type</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMadinaHotelDetails().serviceType}</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Number of Rooms</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getMadinaHotelDetails().rooms}</td>
      </tr>
    </table>
  </div>` : ''}
  
  <!-- Umrah Visa Details - Only show if visa is included -->
  ${document.getElementById('visaBlock') ? `
  <div style="margin-bottom: 15px;">
    <h4 style="color: #0b76d1; margin-bottom: 8px;">Umrah Visa</h4>
    <table style="width:100%; border-collapse: collapse;">
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; width: 150px;">Visa Type</td>
        <td style="border: 1px solid #ddd; padding: 8px;">Standard Umrah Visa</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Number of Visas</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${getVisaDetails().count}</td>
      </tr>
    </table>
  </div>` : ''}
  
  <!-- Transfer Details - Only show if transfers are included -->
  ${document.querySelectorAll("[id^='transferBlock_']").length > 0 ? `
  <div style="margin-bottom: 15px;">
    <h4 style="color: #0b76d1; margin-bottom: 8px;">Transfer</h4>
    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; text-align: left; font-family: Arial, Helvetica, sans-serif; font-size: 13px; line-height: 1.6;">
      ${getTransferDetails()}
    </div>
  </div>` : ''}
</div>
  
  <button onclick="toggleCalculationSummary()" style="margin-bottom: 10px; padding: 5px 10px; background: #0b76d1; color: white; border: none; border-radius: 4px; cursor: pointer;">Show/Hide Calculation Summary</button>
  <div id="calculationSummarySection" style="margin-bottom: 20px;">
    <h3 style="color: #0b76d1; text-align: center; margin-bottom: 15px; font-size: 18px;">Package Price</h3>
    <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
      <thead>
        <tr style="background: linear-gradient(to right, #0b76d1, #0a6bbd); color: white;">
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Service</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Details</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Adult</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Child (with bed)</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Child (no bed)</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Infant</th>
          <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Total Price</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  // Add flight details
  document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const airline = document.getElementById(`airline_${idx}`)?.value || "Not specified";
    const flightType = document.getElementById(`flightDirect_${idx}`)?.value || "Not specified";
    
    const costAdult = parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0);
    const costChildBed = parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0);
    const costChildNoBed = parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0);
    const costInf = parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0);
    
    const svcAdult = parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0);
    const svcChildBed = parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0);
    const svcChildNoBed = parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0);
    const svcInf = parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0);
    
    // Calculate per person costs
    const perAdultCost = costAdult + svcAdult;
    const perChildBedCost = costChildBed + svcChildBed;
    const perChildNoBedCost = costChildNoBed + svcChildNoBed;
    const perInfantCost = costInf + svcInf;
    
    // Calculate total costs
    const totalAdult = perAdultCost * clientData.adults;
    const totalChildBed = perChildBedCost * clientData.childBed;
    const totalChildNoBed = perChildNoBedCost * clientData.childNoBed;
    const totalInf = perInfantCost * clientData.infants;
    const totalFlight = totalAdult + totalChildBed + totalChildNoBed + totalInf;
    
    quotationHTML += `
  <tr style="background-color: #f8f9fa;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">✈️ Flight ${idx}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${sanitizeInput(airline)} - ${sanitizeInput(flightType)}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.adults > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${clientData.adults}</div><div style="font-weight: 600;">PKR ${fmt(perAdultCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${clientData.childBed}</div><div style="font-weight: 600;">PKR ${fmt(perChildBedCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${clientData.childNoBed}</div><div style="font-weight: 600;">PKR ${fmt(perChildNoBedCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.infants > 0 ? `<div style="font-size: 12px; color: #666;">Infant x${clientData.infants}</div><div style="font-weight: 600;">PKR ${fmt(perInfantCost)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalFlight)}</td>
  </tr>
`;
  });
  
  // Add Makkah hotel details
  document.querySelectorAll("[id^='hotelBlockM_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`hkNameM_${idx}`)?.value || "Not specified";
    const nights = parseFloat(document.getElementById(`hkNightsM_${idx}`)?.value || 0);
    const roomType = document.getElementById(`hkRoomTypeM_${idx}`)?.value || "Not specified";
    const rooms = parseFloat(document.getElementById(`hkRoomsM_${idx}`)?.value || 0);
    const serviceType = document.getElementById(`hkServiceM_${idx}`)?.value || "Not specified";
    const costNight = parseFloat(document.getElementById(`hkCostNightM_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hkSvcNightM_${idx}`)?.value || 0);
    
    // Only Adults and Children with bed pay for hotels
    const payingPax = clientData.adults + clientData.childBed;
    const totalHotel = (costNight + svcNight) * nights * rooms * roe;
    
    // FIXED: Calculate per person cost by dividing by total paying passengers
    const perPersonCost = payingPax > 0 ? totalHotel / payingPax : 0;
    
    const costPerAdult = clientData.adults > 0 ? perPersonCost : 0;
    const costPerChildBed = clientData.childBed > 0 ? perPersonCost : 0;
    const costPerChildNoBed = 0; // Children without bed don't pay for hotels
    const costPerInfant = 0; // Infants don't pay for hotels
    
    // Build table cells for each passenger type, only if they exist
    let adultCell = clientData.adults > 0 ? `<td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(costPerAdult)} (x${clientData.adults})</td>` : '';
    let childBedCell = clientData.childBed > 0 ? `<td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(costPerChildBed)} (x${clientData.childBed})</td>` : '';
    let childNoBedCell = clientData.childNoBed > 0 ? `<td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(costPerChildNoBed)} (x${clientData.childNoBed})</td>` : '';
    let infantCell = clientData.infants > 0 ? `<td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(costPerInfant)} (x${clientData.infants})</td>` : '';
    
    quotationHTML += `
  <tr style="background-color: #fff;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🏨 Makkah Hotel ${idx}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
      <div style="font-weight: 500;">${sanitizeInput(name)}</div>
      <div style="font-size: 12px; color: #666;">${sanitizeInput(roomType)} × ${rooms} rooms | ${nights} nights | ${sanitizeInput(serviceType)}</div>
    </td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.adults > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${clientData.adults}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${clientData.childBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalHotel)}</td>
  </tr>
`;
  });

  // Add Madina hotel details
  document.querySelectorAll("[id^='hotelBlockA_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const name = document.getElementById(`hkNameA_${idx}`)?.value || "Not specified";
    const nights = parseFloat(document.getElementById(`hkNightsA_${idx}`)?.value || 0);
    const roomType = document.getElementById(`hkRoomTypeA_${idx}`)?.value || "Not specified";
    const rooms = parseFloat(document.getElementById(`hkRoomsA_${idx}`)?.value || 0);
    const serviceType = document.getElementById(`hkServiceA_${idx}`)?.value || "Not specified";
    const costNight = parseFloat(document.getElementById(`hkCostNightA_${idx}`)?.value || 0);
    const svcNight = parseFloat(document.getElementById(`hkSvcNightA_${idx}`)?.value || 0);
    
    // Only Adults and Children with bed pay for hotels
    const payingPax = clientData.adults + clientData.childBed;
    const totalHotel = (costNight + svcNight) * nights * rooms * roe;
    
    // FIXED: Calculate per person cost by dividing by total paying passengers
    const perPersonCost = payingPax > 0 ? totalHotel / payingPax : 0;
    
    const costPerAdult = clientData.adults > 0 ? perPersonCost : 0;
    const costPerChildBed = clientData.childBed > 0 ? perPersonCost : 0;
    const costPerChildNoBed = 0; // Children without bed don't pay for hotels
    const costPerInfant = 0; // Infants don't pay for hotels
    
    // Build table cells for each passenger type, only if they exist
    let adultCell = clientData.adults > 0 ? `<td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(costPerAdult)} (x${clientData.adults})</td>` : '';
    let childBedCell = clientData.childBed > 0 ? `<td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(costPerChildBed)} (x${clientData.childBed})</td>` : '';
    let childNoBedCell = clientData.childNoBed > 0 ? `<td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(costPerChildNoBed)} (x${clientData.childNoBed})</td>` : '';
    let infantCell = clientData.infants > 0 ? `<td style="border: 1px solid #ddd; padding: 8px;">PKR ${fmt(costPerInfant)} (x${clientData.infants})</td>` : '';
    
    quotationHTML += `
  <tr style="background-color: #f8f9fa;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🏨 Madina Hotel ${idx}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
      <div style="font-weight: 500;">${sanitizeInput(name)}</div>
      <div style="font-size: 12px; color: #666;">${sanitizeInput(roomType)} × ${rooms} rooms | ${nights} nights | ${sanitizeInput(serviceType)}</div>
    </td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.adults > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${clientData.adults}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${clientData.childBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalHotel)}</td>
  </tr>
`;
  });
  
// Add transfer details
  document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const from = document.getElementById(`tFrom_${idx}`)?.value || "Not specified";
    const to = document.getElementById(`tTo_${idx}`)?.value || "Not specified";
    const vehicle = document.getElementById(`tCar_${idx}`)?.value || "Not specified";
    const type = document.getElementById(`tType_${idx}`)?.value || "Not specified";
    const costSAR = parseFloat(document.getElementById(`tCostSAR_${idx}`)?.value || 0);
    const svcSAR = parseFloat(document.getElementById(`tSvcSAR_${idx}`)?.value || 0);
    
    // Adults, Children with bed, and Children without bed pay for transfers
    const payingPax = clientData.adults + clientData.childBed + clientData.childNoBed;
    const totalTransfer = (costSAR + svcSAR) * roe;
    
    // Calculate per person costs
    const costPerAdult = clientData.adults > 0 ? totalTransfer / payingPax : 0;
    const costPerChildBed = clientData.childBed > 0 ? totalTransfer / payingPax : 0;
    const costPerChildNoBed = clientData.childNoBed > 0 ? totalTransfer / payingPax : 0;
    const costPerInfant = 0; // Infants don't pay for transfers
    
    quotationHTML += `
  <tr style="background-color: #fff;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🚗 Transfer ${idx}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
      <div style="font-weight: 500;">${sanitizeInput(from)} → ${sanitizeInput(to)}</div>
      <div style="font-size: 12px; color: #666;">${sanitizeInput(vehicle)} (${sanitizeInput(type)})</div>
    </td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.adults > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${clientData.adults}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${clientData.childBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${clientData.childNoBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildNoBed)}` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalTransfer)}</td>
  </tr>
`;
  });
  
 // Add visa details
const visaCostVal = parseFloat(document.getElementById("visaCost")?.value || 0);
const visaSvc = parseFloat(document.getElementById("visaSvc")?.value || 0);
const visaCount = parseFloat(document.getElementById("visaCount")?.value || 0);
const visaType = "Standard Visa"; 

if (visaCostVal > 0 || visaSvc > 0) {
  // All passenger types pay for visa
  const costPerVisa = (visaCostVal + visaSvc) * roe;
  const totalVisa = costPerVisa * visaCount;
  
  const costPerAdult = clientData.adults > 0 ? costPerVisa : 0;
  const costPerChildBed = clientData.childBed > 0 ? costPerVisa : 0;
  const costPerChildNoBed = clientData.childNoBed > 0 ? costPerVisa : 0;
  const costPerInfant = clientData.infants > 0 ? costPerVisa : 0;
  
quotationHTML += `
  <tr style="background-color: #f8f9fa;">
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🛂 Visa</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
      <div style="font-weight: 500;">Umrah Visa</div>
      <div style="font-size: 12px; color: #666;">${visaCount} visas</div>
    </td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.adults > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${clientData.adults}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${clientData.childBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${clientData.childNoBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildNoBed)}` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.infants > 0 ? `<div style="font-size: 12px; color: #666;">Infant x${clientData.infants}</div><div style="font-weight: 600;">PKR ${fmt(costPerInfant)}` : '<span style="color: #999;">N/A</span>'}</td>
    <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #0b76d1;">PKR ${fmt(totalVisa)}</td>
  </tr>
`;
}
  
  quotationHTML += `
        </tbody>
      </table>
    </div>
  `;
  
 // Add add-ons if any
const hasAddons = document.querySelectorAll("[id^='dfAddon_'], [id^='mealAddon_'], [id^='ziyarahAddon_']").length > 0;

if (hasAddons) {
    quotationHTML += `
      <div style="margin-bottom: 20px; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px; font-size: 18px;">Add-Ons (Optional)</h3>
        <table style="width:100%; border-collapse: collapse; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
          <thead>
            <tr style="background: linear-gradient(to right, #28a745, #218838); color: white;">
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Add-On</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Details</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Adult</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Child (with bed)</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Child (no bed)</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Price per Infant</th>
              <th style="border: none; padding: 12px 8px; text-align: left; font-weight: 600;">Total Price</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    // Direct Flight Add-ons
    document.querySelectorAll("[id^='dfAddon_']").forEach((el, i) => {
      const idx = i + 1;
      const name = "Upgraded Flight";
      const airline = el.querySelector("input[list='airlist']")?.value || "Not specified";
      const flightType = el.querySelector("select")?.value || "Not specified";
      
      // Get the stored differences from the element dataset
      const adultDifference = parseFloat(el.dataset.adultDifference || 0);
      const childBedDifference = parseFloat(el.dataset.childBedDifference || 0);
      const childNoBedDifference = parseFloat(el.dataset.childNoBedDifference || 0);
      const infantDifference = parseFloat(el.dataset.infantDifference || 0);
      
      // Calculate total difference
      const totalDifference = (adultDifference * clientData.adults) + 
                              (childBedDifference * clientData.childBed) + 
                              (childNoBedDifference * clientData.childNoBed) + 
                              (infantDifference * clientData.infants);
      
      // Get service fees for the upgrade
      let totalSvcPKR = 0;
      const upgradeIndex = el.id.split('_')[1];
      
      // Get service fees for each passenger type
      const upgradeAdultSvc = parseFloat(document.getElementById(`upgradeFlightSvcAdult_${upgradeIndex}`)?.value || 0);
      const upgradeChildBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildBed_${upgradeIndex}`)?.value || 0);
      const upgradeChildNoBedSvc = parseFloat(document.getElementById(`upgradeFlightSvcChildNoBed_${upgradeIndex}`)?.value || 0);
      const upgradeInfantSvc = parseFloat(document.getElementById(`upgradeFlightSvcInf_${upgradeIndex}`)?.value || 0);
      
      totalSvcPKR = (upgradeAdultSvc * clientData.adults) + 
                    (upgradeChildBedSvc * clientData.childBed) + 
                    (upgradeChildNoBedSvc * clientData.childNoBed) + 
                    (upgradeInfantSvc * clientData.infants);
      
      const totalCost = totalDifference + totalSvcPKR;
      
      quotationHTML += `
        <tr style="background-color: #fff;">
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">✈️ ${name} ${idx}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
            <div style="font-weight: 500;">${sanitizeInput(airline)}</div>
            <div style="font-size: 12px; color: #666;">${sanitizeInput(flightType)}</div>
          </td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.adults > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${clientData.adults}</div><div style="font-weight: 600;">PKR ${fmt(adultDifference)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${clientData.childBed}</div><div style="font-weight: 600;">PKR ${fmt(childBedDifference)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${clientData.childNoBed}</div><div style="font-weight: 600;">PKR ${fmt(childNoBedDifference)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.infants > 0 ? `<div style="font-size: 12px; color: #666;">Infant x${clientData.infants}</div><div style="font-weight: 600;">PKR ${fmt(infantDifference)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #28a745;">PKR ${fmt(totalCost)}</td>
        </tr>
      `;
    });
    
    // Meal Type Add-ons
    document.querySelectorAll("[id^='mealAddon_']").forEach((el, i) => {
      const idx = i + 1;
      const name = "Meal Type";
      const selects = el.querySelectorAll('select');
      const city = selects[0]?.value || 'Not specified';
      const mealType = selects[1]?.value || "Not specified";
      
      const inputs = el.querySelectorAll("input[type='number']");
      const costPerPaxPerNightSAR = parseFloat(inputs[0]?.value || 0);
      const svcPerPaxPerNightSAR = parseFloat(inputs[1]?.value || 0);
      
      let cityNights = 0;
      if (city.includes('Madina')) {
        cityNights = parseInt(document.getElementById('nightsMadina')?.value || 0); 
      } else if (city.includes('Makkah')) {
        cityNights = parseInt(document.getElementById('nightsMakkah')?.value || 0);
      }
      
      const totalNights = cityNights > 0 ? cityNights : 0; 
      
      // FIXED: Only Adults and Children with bed pay for meals
      const payingPax = clientData.adults + clientData.childBed;
      const effectivePax = payingPax > 0 ? payingPax : 1; 

      const totalCostSAR = costPerPaxPerNightSAR * effectivePax * totalNights;
      const totalSvcSAR = svcPerPaxPerNightSAR * effectivePax * totalNights;

      const cost = totalCostSAR * roe;
      const svc = totalSvcSAR * roe;
      
      // FIXED: Calculate per person cost by dividing by total paying passengers (Adults + Children with bed)
      const perPersonCost = effectivePax > 0 ? (cost + svc) / effectivePax : 0;
      
      // Each paying passenger type gets the same per-person cost
      const costPerAdult = clientData.adults > 0 ? perPersonCost : 0;
      const costPerChildBed = clientData.childBed > 0 ? perPersonCost : 0;
      const costPerChildNoBed = 0; // Children without bed don't pay for meals
      const costPerInfant = 0; // Infants don't pay for meals
      
      const totalAddon = cost + svc;
      
      quotationHTML += `
        <tr style="background-color: #f8f9fa;">
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🍽️ ${name} ${idx}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
            <div style="font-weight: 500;">${sanitizeInput(city)} - ${sanitizeInput(mealType)}</div>
<div style="font-size: 12px; color: #666;">${totalNights} nights | SAR ${fmt(costPerPaxPerNightSAR + svcPerPaxPerNightSAR)}/pax/night (ROE ${roe})</div>
          </td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.adults > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${clientData.adults}</div><div style="font-weight: 600;">PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${clientData.childBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #28a745;">PKR ${fmt(totalAddon)}</td>
        </tr>
      `;
    });
    
    // Ziyarah Add-ons
    document.querySelectorAll("[id^='ziyarahAddon_']").forEach((el, i) => {
      const idx = i + 1;
      const name = "Ziyarah";
      const selects = el.querySelectorAll('select');
      const city = selects[0]?.value || "Not specified";
      const vehicle = selects[1]?.value || "Not specified";
      const type = selects[2]?.value || "Not specified";
      
      const inlineInput = el.querySelector(".inline-input");
      const inputs = inlineInput?.querySelectorAll("input[type='number']");
      
      const totalCostSAR = parseFloat(inputs?.[0]?.value || 0);
      const totalSvcSAR = parseFloat(inputs?.[1]?.value || 0);
      
      const cost = totalCostSAR * roe;
      const svc = totalSvcSAR * roe;
      const totalAddon = cost + svc;
      
      // FIXED: Calculate per person cost by dividing by paying passengers only (excluding infants)
      const payingPax = clientData.adults + clientData.childBed + clientData.childNoBed;
      const perPersonCost = payingPax > 0 ? (cost + svc) / payingPax : 0;
      
      // Each paying passenger type gets the same per-person cost
      const costPerAdult = clientData.adults > 0 ? perPersonCost : 0;
      const costPerChildBed = clientData.childBed > 0 ? perPersonCost : 0;
      const costPerChildNoBed = clientData.childNoBed > 0 ? perPersonCost : 0;
      const costPerInfant = 0; // Infants don't pay for ziyarah
      
      quotationHTML += `
        <tr style="background-color: #fff;">
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 500;">🕌 ${name} ${idx}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">
            <div style="font-weight: 500;">${sanitizeInput(city)} - ${sanitizeInput(type)}</div>
<div style="font-size: 12px; color: #666;">${sanitizeInput(vehicle)} | SAR ${fmt(totalCostSAR + totalSvcSAR)}/vehicle (ROE ${roe})</div>
          </td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.adults > 0 ? `<div style="font-size: 12px; color: #666;">Adult x${clientData.adults}</div><div style="font-weight: 600;"> PKR ${fmt(costPerAdult)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (bed) x${clientData.childBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;">${clientData.childNoBed > 0 ? `<div style="font-size: 12px; color: #666;">Child (no bed) x${clientData.childNoBed}</div><div style="font-weight: 600;">PKR ${fmt(costPerChildNoBed)}</div>` : '<span style="color: #999;">N/A</span>'}</td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px;"><span style="color: #999;">N/A</span></td>
          <td style="border: 1px solid #e0e0e0; padding: 10px 8px; font-weight: 600; color: #28a745;">PKR ${fmt(totalAddon)}</td>
        </tr>
      `;
    });
    
    quotationHTML += `
          </tbody>
        </table>
        
<!-- Add-ons Summary -->
<div style="background-color: #e8f5e9; border-radius: 8px; padding: 15px; margin-top: 15px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
  <div style="font-weight: 600; color: #2e7d32;">Package Total:</div>
  <div style="font-weight: 600; color: #2e7d32;">PKR ${fmt(totalPackageAmount)}</div>
</div>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <div style="font-weight: 600; color: #2e7d32;">Add-ons Subtotal:</div>
    <div style="font-weight: 600; color: #2e7d32;">PKR ${fmt(addonCostPKR + addonServicePKR)}</div>
  </div>
  <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #c8e6c9;">
    <div style="font-size: 16px; font-weight: bold; color: #2e7d32;">Grand Total (Package + Add-ons):</div>
    <div style="font-size: 16px; font-weight: bold; color: #2e7d32;">PKR ${fmt(totalPackageAmount + addonCostPKR + addonServicePKR)}</div>
  </div>
</div>
    `;
  }

// Add inclusions section
quotationHTML += `
  <div style="margin-bottom: 20px; border: 1px solid #f5e6e6; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px;">Inclusions</h3>
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
      <ul style="padding-left: 20px; margin: 0; text-align: left;">
`;

// Build inclusions list
let inclusionsList = [];

// Check for flights
const flightElements = document.querySelectorAll("[id^='flightBlock_']");
if (flightElements && flightElements.length > 0) {
  flightElements.forEach((el) => {
    if (el && el.id) {
      const idx = el.id.split("_")[1];
      const airline = document.getElementById(`airline_${idx}`)?.value || "Airline";
      const flightType = document.getElementById(`flightDirect_${idx}`)?.value || "Flight Type";
      inclusionsList.push(`${sanitizeInput(airline)} ${sanitizeInput(flightType)} flight tickets`);
    }
  });
}

// Check for hotels
const makkahElements = document.querySelectorAll("[id^='hotelBlockM_']");
if (makkahElements && makkahElements.length > 0) {
  makkahElements.forEach((el) => {
    if (el && el.id) {
      const idx = el.id.split("_")[1];
      const hotelName = document.getElementById(`hkNameM_${idx}`)?.value || "Makkah Hotel";
      const nights = document.getElementById(`hkNightsM_${idx}`)?.value || 0;
      const serviceType = document.getElementById(`hkServiceM_${idx}`)?.value || "Without Breakfast";
      const roomType = document.getElementById(`hkRoomTypeM_${idx}`)?.value || "Room Type";
      const rooms = document.getElementById(`hkRoomsM_${idx}`)?.value || 0;
      
      inclusionsList.push(`${nights} nights, ${rooms} ${roomType} ${serviceType.toLowerCase()} Accommodation in ${sanitizeInput(hotelName)}`);
      if (serviceType === "With Breakfast") {
        inclusionsList.push(`Breakfast in ${sanitizeInput(hotelName)}`);
      }
    }
  });
}

const madinaElements = document.querySelectorAll("[id^='hotelBlockA_']");
if (madinaElements && madinaElements.length > 0) {
  madinaElements.forEach((el) => {
    if (el && el.id) {
      const idx = el.id.split("_")[1];
      const hotelName = document.getElementById(`hkNameA_${idx}`)?.value || "Madina Hotel";
      const nights = document.getElementById(`hkNightsA_${idx}`)?.value || 0;
      const serviceType = document.getElementById(`hkServiceA_${idx}`)?.value || "Without Breakfast";
      const roomType = document.getElementById(`hkRoomTypeA_${idx}`)?.value || "Room Type";
      const rooms = document.getElementById(`hkRoomsA_${idx}`)?.value || 0;
      
      inclusionsList.push(`${nights} nights, ${rooms} ${roomType} ${serviceType.toLowerCase()} Accommodation in ${sanitizeInput(hotelName)}`);
      if (serviceType === "With Breakfast") {
        inclusionsList.push(`Breakfast in ${sanitizeInput(hotelName)}`);
      }
    }
  });
}

// Check for visa
if (document.getElementById('visaBlock')) {
  const visaCount = document.getElementById('visaCount')?.value || 0;
  inclusionsList.push(`${visaCount} x Umrah visa`);
}

// Check for transfers
const transferElements = document.querySelectorAll("[id^='transferBlock_']");
if (transferElements && transferElements.length > 0) {
  transferElements.forEach((el) => {
    if (el && el.id) {
      const idx = el.id.split("_")[1];
      const from = document.getElementById(`tFrom_${idx}`)?.value || "Location";
      const to = document.getElementById(`tTo_${idx}`)?.value || "Location";
      const vehicle = document.getElementById(`tCar_${idx}`)?.value || "Vehicle";
      const type = document.getElementById(`tType_${idx}`)?.value || "Type";
      
      inclusionsList.push(`1 x ${sanitizeInput(type)} ${sanitizeInput(vehicle)} transfer from ${sanitizeInput(from)} to ${sanitizeInput(to)}`);
    }
  });
}

// Add general inclusions
inclusionsList.push("Professional guidance throughout the journey");
inclusionsList.push("All taxes and service charges (as specified)");

// Add all inclusions to HTML
inclusionsList.forEach(inclusion => {
  quotationHTML += `<li>${inclusion}</li>`;
});

quotationHTML += `
      </ul>
    </div>
  </div>
`;

// Add exclusions section
quotationHTML += `
<div style="margin-bottom: 20px; border: 1px solid #f5e6e6; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px;">Exclusions</h3>
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
      <ul style="padding-left: 20px; margin: 0; text-align: left;">
`;

// Check for flight exclusion
const hasFlights = document.querySelectorAll("[id^='flightBlock_']").length > 0;
if (!hasFlights) {
  quotationHTML += `<li>Flight tickets are not included in this package</li>`;
}

// Check for hotel exclusions
const hasMakkahHotels = document.querySelectorAll("[id^='hotelBlockM_']").length > 0;
const hasMadinaHotels = document.querySelectorAll("[id^='hotelBlockA_']").length > 0;

if (hasMakkahHotels) {
  document.querySelectorAll("[id^='hotelBlockM_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const serviceType = document.getElementById(`hkServiceM_${idx}`)?.value || "Without Breakfast";
    if (serviceType === "Without Breakfast") {
      const hotelName = document.getElementById(`hkNameM_${idx}`)?.value || "Makkah Hotel";
      quotationHTML += `<li>Breakfast in ${sanitizeInput(hotelName)}</li>`;
    }
  });
}

if (hasMadinaHotels) {
  document.querySelectorAll("[id^='hotelBlockA_']").forEach((el) => {
    const idx = el.id.split("_")[1];
    const serviceType = document.getElementById(`hkServiceA_${idx}`)?.value || "Without Breakfast";
    if (serviceType === "Without Breakfast") {
      const hotelName = document.getElementById(`hkNameA_${idx}`)?.value || "Madina Hotel";
      quotationHTML += `<li>Breakfast in ${sanitizeInput(hotelName)}</li>`;
    }
  });
}

// Check for visa exclusion
const hasVisa = document.getElementById('visaBlock');
if (!hasVisa) {
  quotationHTML += `<li>Umrah visa is not included in this package</li>`;
}

// Check for transfer exclusion
const hasTransfers = document.querySelectorAll("[id^='transferBlock_']").length > 0;
if (!hasTransfers) {
  quotationHTML += `<li>Airport transfers are not included in this package</li>`;
}

// Add general exclusions
quotationHTML += `
        <li>Any personal expenses such as laundry, telephone calls, etc.</li>
        <li>Meals not mentioned in the package.</li>
        <li>Early check-in or late check-out at hotels.</li>
        <li>Any services not mentioned in the inclusions</li>
        <li>Tips and porterage</li>
        <li>Travel insurance</li>
      </ul>
    </div>
  </div>
`;

// Store default content in Firebase if not already stored
async function initializeVisaRequirements() {
  const defaultVisaRequirements = `
<ul style="padding-left: 20px; margin: 0; text-align: left;">
  <li>Passport (valid for at least 6 months with 2 blank pages)</li>
  <li>CNIC Copy</li>
  <li>Passport-Sized Photograph (white background)</li>
  <li>NADRA B-Form (for children)</li>
  <li>Biometric Registration via Saudi Visa Bio App (mandatory)</li>
</ul>

<div style="margin-top: 15px; margin-bottom: 10px; font-weight: 600;">For Solo Female Travelers:</div>
<ul style="padding-left: 20px; margin: 0 0 15px 0; text-align: left;">
  <li>Affidavit of Consent from Mahram required</li>
</ul>

<ul style="padding-left: 20px; margin: 0; text-align: left;">
  <li>Visa Validity: 15 Days from date of issue</li>
  <li>Stay Validity: 20 days from entry into Saudi Arabia</li>
  <li>Processing Time: 4–7 working days (subject to change)</li>
  <li>Note: In some cases, visa status may change to "Send to Embassy" — the total processing cost will be PKR 17,000 per person, and it will be completed by us.</li>
</ul>`;
  
  try {
    const agent = getCurrentAgent();
    if (agent && agent.uid) {
      const existing = await window.firebaseDB.getData('agents/' + agent.uid + '/data', 'visaRequirements');
      if (!existing) {
        await window.firebaseDB.saveData('agents/' + agent.uid + '/data', 'visaRequirements', { value: defaultVisaRequirements, updatedAt: new Date() });
      }
    }
  } catch (error) {
    console.log('Visa requirements initialization:', error);
  }
  
  if (!localStorage.getItem('visaRequirements')) {
    localStorage.setItem('visaRequirements', defaultVisaRequirements);
  }
}

if (!localStorage.getItem('visaRequirements')) {
  const defaultVisaRequirements = `
<ul style="padding-left: 20px; margin: 0; text-align: left;">
  <li>Passport (valid for at least 6 months with 2 blank pages)</li>
  <li>CNIC Copy</li>
  <li>Passport-Sized Photograph (white background)</li>
  <li>NADRA B-Form (for children)</li>
  <li>Biometric Registration via Saudi Visa Bio App (mandatory)</li>
</ul>

<div style="margin-top: 15px; margin-bottom: 10px; font-weight: 600;">For Solo Female Travelers:</div>
<ul style="padding-left: 20px; margin: 0 0 15px 0; text-align: left;">
  <li>Affidavit of Consent from Mahram required</li>
</ul>

<ul style="padding-left: 20px; margin: 0; text-align: left;">
  <li>Visa Validity: 15 Days from date of issue</li>
  <li>Stay Validity: 20 days from entry into Saudi Arabia</li>
  <li>Processing Time: 4–7 working days (subject to change)</li>
  <li>Note: In some cases, visa status may change to "Send to Embassy" — the total processing cost will be PKR 17,000 per person, and it will be completed by us.</li>
</ul>`;
  localStorage.setItem('visaRequirements', defaultVisaRequirements);
  initializeVisaRequirements();
}

if (!localStorage.getItem('biometricProcess')) {
  const defaultBiometricProcess = `
<p style="margin-top: 0;">As per the Saudi Govt, biometric is now mandatory for Umrah visa processing. You can complete it from home using the Saudi Visa Bio App.</p>

<div style="margin-top: 15px; margin-bottom: 10px; font-weight: 600;">🔽 Download:</div>
<ul style="padding-left: 20px; margin: 0 0 15px 0; text-align: left;">
  <li>Android: <a href="https://bit.ly/Saudi-Visa-Bio-Apps-Google-Play" style="color: #0b76d1; text-decoration: none;">https://bit.ly/Saudi-Visa-Bio-Apps-Google-Play</a></li>
  <li>Apple: <a href="https://bit.ly/‎Saudi-Visa-Bio-Apple-Store" style="color: #0b76d1; text-decoration: none;">https://bit.ly/‎Saudi-Visa-Bio-Apple-Store</a></li>
</ul>

<div style="margin-top: 15px; margin-bottom: 10px; font-weight: 600;">📝 Steps:</div>
<ol style="padding-left: 20px; margin: 0; text-align: left;">
  <li>Open app → Start Self Enrollment → Accept</li>
  <li>Enter your email → Click verification link (Sometimes app shows error please try 3 to 4 times)</li>
  <li>Fill visa form:
    <ul style="padding-left: 20px; margin: 5px 0;">
      <li>Visa Type: Umrah</li>
      <li>Embassy: Islamabad</li>
      <li>Visit Saudi before: Yes/No</li>
    </ul>
  </li>
  <li>Scan passport bio page (on table with good light)</li>
  <li>Check and Confirm your details</li>
  <li>Face Scan: Stand in front of plain wall</li>
  <li>Fingerprint Scan: Follow app instructions</li>
  <li>Tick consent box → Click Send</li>
</ol>

<p style="margin-top: 15px; margin-bottom: 0;">📩 You will get an Enrollment ID by email — Please send us the screenshot so we can apply your visa.</p>`;
  localStorage.setItem('biometricProcess', defaultBiometricProcess);
}

// Get stored content
const visaRequirements = localStorage.getItem('visaRequirements') || '';
const biometricProcess = localStorage.getItem('biometricProcess') || '';

// Add Section 1
quotationHTML += `
  <div style="margin-bottom: 20px; border: 1px solid #e3f2fd; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
      ${visaRequirements}
    </div>
  </div>
  
  <!-- Add Section 2 -->
  <div style="margin-bottom: 20px; border: 1px solid #e3f2fd; padding: 15px; border-radius: 8px; background-color: #ffffff;">
    <div style="font-size: 13px; line-height: 1.6; text-align: left;">
      ${biometricProcess}
    </div>
  </div>
`;
  
// Add terms and conditions
  quotationHTML += `
  <div style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; text-align: left;">
  <div style="font-size: 13px; line-height: 1.6;">
    ${customTerms}
  </div>
  </div>

  <!-- Add your image right after Terms and Conditions -->
<div style="text-align: center; margin-bottom: 30px;">
  <img src="https://flightconnection.net.pk/wp-content/uploads/2020/08/flight-connection.jpeg" 
       alt="Flight Connection Travel & Tours" 
       style="max-width: 800px; width: 100%; height: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
</div>

  <div style="text-align: center; margin-top: 30px; color: #666; font-size: 16px;">
    <p>For any queries, please contact us</p>
    <p style="margin-bottom: 5px;">Prepared by: <strong>${sanitizeInput(agentData?.name || 'N/A')}</strong></p>
    <p style="margin-bottom: 5px;">Phone: <strong>${sanitizeInput(agentData?.phone || 'N/A')}</strong></p>
    <p>Mezzanine Floor, 17-E, Shahbaz Commercial, Phase 6. DHA</p>
  </div>

  `;
  
  // Set modal content
  modalTitle.textContent = "Quotation Preview";
  modalContent.innerHTML = quotationHTML;
  
// Add buttons
modalButtons.innerHTML = `
  <button id="editContentBtn" class="ghost">📝 Edit Content</button>
  <button id="printQuotationBtn" class="green-btn" style="margin-right: 10px;">🖨️ Print Quotation</button>
  <button id="shareWhatsAppBtn" class="whatsapp-btn">📱 Share on WhatsApp</button>
  <button id="closeQuotationBtn" class="ghost">Close</button>
`;
  

// Add event listeners after modal is shown
setTimeout(() => {
// Edit Content button
document.getElementById('editContentBtn').onclick = function() {
  document.getElementById('quotationModal').classList.remove('visible');
  setTimeout(() => {
    showContentEditor();
  }, 300);
};

  // Print Quotation button
  document.getElementById('printQuotationBtn').onclick = function() {
    printQuotation();
  };

  // Share WhatsApp button
  document.getElementById('shareWhatsAppBtn').onclick = function() {
    shareOnWhatsApp();
  };

  // Close button
  document.getElementById('closeQuotationBtn').onclick = function() {
    modal.classList.remove('visible');
  };
}, 100);

  // Show modal
  modal.classList.add('visible');
}

function toggleCalculationSummary() {
  const div = document.getElementById('calculationSummarySection');
  if (div.style.display === 'none') {
    div.style.display = 'block';
  } else {
    div.style.display = 'none';
  }
}

function shareOnWhatsApp() {
  try {
    const clientData = getClientData();
    const agentData = getCurrentAgent();
    const clientPhone = clientData.phone || '';
    
    if (!clientPhone) {
      showAlert("Client phone number is required for WhatsApp sharing.");
      return;
    }
    
    // Create a simple text message
    const message = `Dear ${sanitizeInput(clientData.name)},

Your Umrah package quotation is ready. Please find the details in the attached PDF.

Best regards,
 ${sanitizeInput(agentData?.name || 'Agent')}
 ${sanitizeInput(agentData?.phone || '')}
Flight Connection Travel & Tours
Email: muhammad.atif@flightconnection.net.pk
Website: www.flightconnection.net.pk`;

    // Clean phone number
    const cleanPhone = clientPhone.replace(/\D/g, '');
    
    // WhatsApp URL with pre-filled message
    const whatsappUrl = `https://wa.me/92${cleanPhone.replace(/^0+/, '')}?text=${encodeURIComponent(message)}`;
    
    // Open WhatsApp in a new window
    window.open(whatsappUrl, '_blank');
    
    showNotification("WhatsApp opened with quotation details!", "success");
  } catch (error) {
    console.error('Error sharing on WhatsApp:', error);
    showAlert("Failed to share on WhatsApp. Please try again.", "Error");
  }
}

// --- EXPORT TO EXCEL ---
btnExportExcel.addEventListener("click", exportToExcel);

function exportToExcel() {
  try {
    // Get the table element
    const table = document.getElementById("calcSummaryTable");
    
    // Create a new workbook
    const wb = XLSX.utils.table_to_book(table, {sheet: "Cost Sheet"});
    
    // Get client data
    const clientData = getClientData();
    const agentData = getCurrentAgent();
    
    // Add a sheet with client and travel information
    const clientInfo = [
      ["Client Information", ""],
      ["Client Name", sanitizeInput(clientData.name || 'N/A')],
      ["Phone", sanitizeInput(clientData.phone || 'N/A')],
      ["Reference", sanitizeInput(clientData.reference || 'N/A')],
      ["", ""],
      ["Travel Information", ""],
      ["Travel Dates", `${formatDateToDMY(clientData.dateFrom)} to ${formatDateToDMY(clientData.dateTo)}`],
      ["Duration", `${clientData.nightsMakkah + clientData.nightsMadina} Nights / ${clientData.nightsMakkah + clientData.nightsMadina + 1} Days`],
      ["Departure City", sanitizeInput(clientData.depCity || 'N/A')],
      ["Passengers", `Adults: ${clientData.adults}, Children (with bed): ${clientData.childBed}, Children (without bed): ${clientData.childNoBed}, Infants: ${clientData.infants}`],
      ["", ""],
      ["Agent Information", ""],
      ["Agent Name", sanitizeInput(agentData?.name || 'N/A')],
      ["Agent ID", sanitizeInput(agentData?.id || 'N/A')],
      ["Agent Phone", sanitizeInput(agentData?.phone || 'N/A')],
      ["", ""],
      ["Exchange Rate", `1 SAR = ${roeInput.value} PKR`]
    ];
    
    const wsClient = XLSX.utils.aoa_to_sheet(clientInfo);
    XLSX.utils.book_append_sheet(wb, wsClient, "Client Info");
    
    // Generate a filename with date and client name
    const filename = `Cost_Sheet_${sanitizeInput(clientData.name || 'Client').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
    
    // Save the file
    XLSX.writeFile(wb, filename);
    
    // Show notification
    showNotification("Cost sheet exported successfully!", "success");
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    showAlert("Failed to export cost sheet. Please try again.", "Error");
  }
}

// --- SAVE/LOAD QUOTATION ---
document.getElementById('btnSaveQuotation').addEventListener('click', () => {
  saveQuotation();
});

document.getElementById('btnLoadQuotation').addEventListener('click', () => {
  // Get all quotations
  const allSavedQuotations = JSON.parse(localStorage.getItem('savedQuotations')) || [];
  
  if (allSavedQuotations.length === 0) {
    showAlert("No saved quotations found.");
    return;
  }

  // Create modal content
  const modal = document.getElementById('custom-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const modalButtons = document.getElementById('modal-buttons');
  
  modalTitle.textContent = 'Load Saved Quotation';
  
  // Create a table of quotations
  let tableHTML = `
    <div style="max-height: 400px; overflow-y: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f2f2f2;">
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">ID</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Client</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Destination</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Date</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Total (PKR)</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Status</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Action</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  allSavedQuotations.forEach(quotation => {
    const statusColor = {
      'pending': '#ffc107',
      'followup': '#17a2b8',
      'booked': '#28a745',
      'cancelled': '#dc3545'
    };
    
    tableHTML += `
      <tr>
        <td style="padding: 8px; border: 1px solid #ddd;">${quotation.id}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${quotation.clientData.name}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${quotation.clientData.tourDestination}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${formatDateToDMY(quotation.clientData.dateFrom)} - ${formatDateToDMY(quotation.clientData.dateTo)}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${fmt(quotation.totalAmount || quotation.totalAmount || 0)}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <span style="background-color: ${statusColor[quotation.status] || '#6c757d'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
            ${quotation.status}
          </span>
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <button class="load-quotation-btn" data-id="${quotation.id}" style="padding: 4px 8px; font-size: 12px;">Load</button>
        </td>
      </tr>
    `;
  });
  
  tableHTML += `
        </tbody>
      </table>
    </div>
  `;
  
  modalMessage.innerHTML = tableHTML;
  
  // Clear and add buttons
  modalButtons.innerHTML = '';
  
  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close';
  closeBtn.onclick = () => {
    modal.classList.remove('visible');
  };
  modalButtons.appendChild(closeBtn);
  
  // Show modal
  modal.classList.add('visible');
  
// Add event listeners to load buttons AFTER the modal is shown
setTimeout(() => {
  document.querySelectorAll('.load-quotation-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        // Get the quotation ID from the button's data attribute
        const quotationId = btn.getAttribute('data-id');
        
        // Close modal
        modal.classList.remove('visible');
        
        // Load the quotation
        loadQuotation(quotationId);
      } catch (error) {
        console.error('Error loading quotation:', error);
        showAlert("Failed to load quotation. Please try again.", "error");
      }
    });
  });
}, 100);
});

// Function to save the current quotation
function saveQuotation() {
  try {
    // Check if client data is saved
    if (!isClientDataSaved) {
      showNotification("Please save Client & Pax information first before saving the quotation.", "error");
      return;
    }
    
    // Check if at least one service is added
    const hasFlights = document.querySelectorAll("[id^='flightBlock_']").length > 0;
    const hasMakkahHotels = document.querySelectorAll("[id^='hotelBlockM_']").length > 0;
    const hasMadinaHotels = document.querySelectorAll("[id^='hotelBlockA_']").length > 0;
    const hasTransfers = document.querySelectorAll("[id^='transferBlock_']").length > 0;
    const hasVisa = document.getElementById('visaBlock') !== null;
    const hasDirectFlights = document.querySelectorAll("[id^='dfAddon_']").length > 0;
    const hasMeals = document.querySelectorAll("[id^='mealAddon_']").length > 0;
    const hasZiyarah = document.querySelectorAll("[id^='ziyarahAddon_']").length > 0;
    
    // Check if any service is added
    if (!hasFlights && !hasMakkahHotels && !hasMadinaHotels && 
        !hasTransfers && !hasVisa && !hasDirectFlights && 
        !hasMeals && !hasZiyarah) {
      showNotification("Please add at least one service (Flight, Hotel, Transfer, Visa, or Add-on) before saving the quotation.", "error");
      return;
    }
    
    // Get basic client information
    const clientName = document.getElementById("clientName")?.value || "No Name";
    const clientPhone = document.getElementById("clientPhone")?.value || "No Phone";
    const dateFrom = document.getElementById("dateFrom")?.value || "No Date";
    const dateTo = document.getElementById("dateTo")?.value || "No Date";
    
    // Get current agent
    const agent = getCurrentAgent();
    if (!agent) {
      showNotification("Please login to save quotations.", "error");
      return;
    }
    
    // Calculate expiry date (7 days from creation)
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 30);
    
    // Collect flight data
    const flightsData = [];
    document.querySelectorAll("[id^='flightBlock_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const flightData = {
        itinerary: document.getElementById(`flightItinerary_${idx}`)?.value || "",
        airline: document.getElementById(`airline_${idx}`)?.value || "",
        direct: document.getElementById(`flightDirect_${idx}`)?.value || "",
        costs: {
          adult: {
            cost: parseFloat(document.getElementById(`flightCostAdult_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`flightSvcAdult_${idx}`)?.value || 0)
          },
          childBed: {
            cost: parseFloat(document.getElementById(`flightCostChildBed_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`flightSvcChildBed_${idx}`)?.value || 0)
          },
          childNoBed: {
            cost: parseFloat(document.getElementById(`flightCostChildNoBed_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`flightSvcChildNoBed_${idx}`)?.value || 0)
          },
          infant: {
            cost: parseFloat(document.getElementById(`flightCostInf_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`flightSvcInf_${idx}`)?.value || 0)
          }
        }
      };
      flightsData.push(flightData);
    });
    
    // Collect Makkah hotel data
    const hotelsMakkahData = [];
    document.querySelectorAll("[id^='hotelBlockM_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const hotelData = {
        name: document.getElementById(`hkNameM_${idx}`)?.value || "",
        distance: document.getElementById(`hkDistM_${idx}`)?.value || "",
        checkIn: document.getElementById(`hkCheckInM_${idx}`)?.value || "",
        checkOut: document.getElementById(`hkCheckOutM_${idx}`)?.value || "",
        nights: parseInt(document.getElementById(`hkNightsM_${idx}`)?.value || 0),
        roomType: document.getElementById(`hkRoomTypeM_${idx}`)?.value || "",
        rooms: parseInt(document.getElementById(`hkRoomsM_${idx}`)?.value || 1),
        serviceType: document.getElementById(`hkServiceM_${idx}`)?.value || "",
        costNight: parseFloat(document.getElementById(`hkCostNightM_${idx}`)?.value || 0),
        svcNight: parseFloat(document.getElementById(`hkSvcNightM_${idx}`)?.value || 0)
      };
      hotelsMakkahData.push(hotelData);
    });
    
    // Collect Madina hotel data
    const hotelsMadinaData = [];
    document.querySelectorAll("[id^='hotelBlockA_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const hotelData = {
        name: document.getElementById(`hkNameA_${idx}`)?.value || "",
        distance: document.getElementById(`hkDistA_${idx}`)?.value || "",
        checkIn: document.getElementById(`hkCheckInA_${idx}`)?.value || "",
        checkOut: document.getElementById(`hkCheckOutA_${idx}`)?.value || "",
        nights: parseInt(document.getElementById(`hkNightsA_${idx}`)?.value || 0),
        roomType: document.getElementById(`hkRoomTypeA_${idx}`)?.value || "",
        rooms: parseInt(document.getElementById(`hkRoomsA_${idx}`)?.value || 1),
        serviceType: document.getElementById(`hkServiceA_${idx}`)?.value || "",
        costNight: parseFloat(document.getElementById(`hkCostNightA_${idx}`)?.value || 0),
        svcNight: parseFloat(document.getElementById(`hkSvcNightA_${idx}`)?.value || 0)
      };
      hotelsMadinaData.push(hotelData);
    });
    
    // Collect transfer data
    const transfersData = [];
    document.querySelectorAll("[id^='transferBlock_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const transferData = {
        date: document.getElementById(`tDate_${idx}`)?.value || "",
        from: document.getElementById(`tFrom_${idx}`)?.value || "",
        to: document.getElementById(`tTo_${idx}`)?.value || "",
        vehicle: document.getElementById(`tCar_${idx}`)?.value || "",
        type: document.getElementById(`tType_${idx}`)?.value || "",
        cost: parseFloat(document.getElementById(`tCostSAR_${idx}`)?.value || 0),
        service: parseFloat(document.getElementById(`tSvcSAR_${idx}`)?.value || 0)
      };
      transfersData.push(transferData);
    });
    
    // Collect visa data
    let visaData = null;
    if (document.getElementById('visaBlock')) {
      visaData = {
        count: parseInt(document.getElementById('visaCount')?.value || 0),
        cost: parseFloat(document.getElementById('visaCost')?.value || 0),
        service: parseFloat(document.getElementById('visaSvc')?.value || 0)
      };
    }
    
    // Collect add-ons data
    const addonsData = {
      directFlights: [],
      meals: [],
      ziyarah: []
    };
    
    // Direct flight add-ons
    document.querySelectorAll("[id^='dfAddon_']").forEach((el) => {
      const idx = el.id.split("_")[1];
      const addonData = {
        itinerary: el.querySelector('textarea')?.value || "",
        airline: el.querySelector("input[list='airlist']")?.value || "",
        direct: el.querySelector('select')?.value || "",
        costs: {
          adult: {
            cost: parseFloat(document.getElementById(`upgradeFlightCostAdult_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`upgradeFlightSvcAdult_${idx}`)?.value || 0)
          },
          childBed: {
            cost: parseFloat(document.getElementById(`upgradeFlightCostChildBed_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`upgradeFlightSvcChildBed_${idx}`)?.value || 0)
          },
          childNoBed: {
            cost: parseFloat(document.getElementById(`upgradeFlightCostChildNoBed_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`upgradeFlightSvcChildNoBed_${idx}`)?.value || 0)
          },
          infant: {
            cost: parseFloat(document.getElementById(`upgradeFlightCostInf_${idx}`)?.value || 0),
            service: parseFloat(document.getElementById(`upgradeFlightSvcInf_${idx}`)?.value || 0)
          }
        }
      };
      addonsData.directFlights.push(addonData);
    });
    
    // Meal add-ons
    document.querySelectorAll("[id^='mealAddon_']").forEach((el) => {
      const selects = el.querySelectorAll('select');
      const inputs = el.querySelectorAll("input[type='number']");
      const addonData = {
        hotel: selects[0]?.value || "",
        mealType: selects[1]?.value || "",
        cost: parseFloat(inputs[0]?.value || 0),
        service: parseFloat(inputs[1]?.value || 0)
      };
      addonsData.meals.push(addonData);
    });
    
    // Ziyarah add-ons
    document.querySelectorAll("[id^='ziyarahAddon_']").forEach((el) => {
      const selects = el.querySelectorAll('select');
      const inputs = el.querySelectorAll(".inline-input input[type='number']");
      const addonData = {
        city: selects[0]?.value || "",
        vehicle: selects[1]?.value || "",
        duration: selects[2]?.value || "",
        cost: parseFloat(inputs[0]?.value || 0),
        service: parseFloat(inputs[1]?.value || 0)
      };
      addonsData.ziyarah.push(addonData);
    });
    
    // Get client data from localStorage
    const savedClientData = JSON.parse(localStorage.getItem('savedClientData')) || {};
    
    // Create a complete quotation object
    const quotationData = {
      id: currentQuotationId || 'UMH-' + Date.now().toString().slice(-6),
      clientData: {
        name: savedClientData.name || clientName,
        phone: savedClientData.phone || clientPhone,
        reference: savedClientData.reference || "",
        refExtra: savedClientData.refExtra || "",
        depCity: savedClientData.depCity || "Karachi",
        adults: savedClientData.adults || 0,
        childBed: savedClientData.childBed || 0,
        childNoBed: savedClientData.childNoBed || 0,
        infants: savedClientData.infants || 0,
        dateFrom: savedClientData.dateFrom || dateFrom,
        dateTo: savedClientData.dateTo || dateTo,
        nightsMakkah: savedClientData.nightsMakkah || 0,
        nightsMadina: savedClientData.nightsMadina || 0
      },
      agentData: agent,
      createdAt: currentQuotationId ? 
        (savedQuotations.find(q => q.id === currentQuotationId)?.createdAt || new Date().toISOString()) : 
        new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      expiresAt: expiryDate.toISOString(),
      status: 'pending',
      flights: flightsData,
      hotelsMakkah: hotelsMakkahData,
      hotelsMadina: hotelsMadinaData,
      transfers: transfersData,
      visa: visaData,
      addons: addonsData
    };
    
    // Get ALL existing quotations from localStorage
    let allQuotations = JSON.parse(localStorage.getItem('savedQuotations')) || [];
    
    // Add or update the quotation
    if (currentQuotationId) {
      // Update existing
      const index = allQuotations.findIndex(q => q.id === currentQuotationId);
      if (index !== -1) {
        allQuotations[index] = quotationData;
      }
    } else {
      // Add new
      allQuotations.push(quotationData);
      currentQuotationId = quotationData.id;
    }
    
    // Save to localStorage
    localStorage.setItem('savedQuotations', JSON.stringify(allQuotations));
    
    // Save to Firebase
    const agent = getCurrentAgent();
    if (agent && agent.id) {
      window.firebaseDB.saveData('umrah_quotations', agent.id, { 
        quotations: allQuotations, 
        updatedAt: new Date(),
        agentId: agent.id 
      }).catch(err => console.error('Firebase save error:', err));
    }
    
    // Update the global variable
    savedQuotations = allQuotations;
    
    showNotification("Quotation saved successfully!", "success");
    showStatusSection();
    //refreshDashboardData();
    
  } catch (error) {
    console.error('Error saving quotation:', error);
    showNotification("Failed to save quotation. Please try again.", "error");
  }
}

// Function to load a quotation
function loadQuotation(quotationId) {
  try {
    console.log("Loading quotation with ID:", quotationId);
    
    // Get all saved quotations
    const savedQuotations = JSON.parse(localStorage.getItem('savedQuotations')) || [];
    console.log("Found quotations:", savedQuotations.length);
    
    // Find the quotation
    const quotation = savedQuotations.find(q => q.id === quotationId);
    
    if (!quotation) {
      console.error("Quotation not found with ID:", quotationId);
      showNotification("Quotation not found.", "error");
      return;
    }
    
    console.log("Found quotation:", quotation);
    
    // Set the current quotation ID
    currentQuotationId = quotationId;
    
    // Store the expiry date if it exists
    if (quotation.expiresAt) {
      console.log("Quotation expires on:", new Date(quotation.expiresAt).toLocaleDateString());
    }
    
    // Load client data
    if (quotation.clientData) {
      console.log("Loading client data:", quotation.clientData);
      
      // Save client data to localStorage
      localStorage.setItem("savedClientData", JSON.stringify(quotation.clientData));
      
      // Populate client form fields
      if (document.getElementById("clientName")) document.getElementById("clientName").value = quotation.clientData.name || "";
      if (document.getElementById("reference")) document.getElementById("reference").value = quotation.clientData.reference || "";
      if (document.getElementById("refExtra")) document.getElementById("refExtra").value = quotation.clientData.refExtra || "";
      if (document.getElementById("clientPhone")) document.getElementById("clientPhone").value = quotation.clientData.phone || "";
      if (document.getElementById("depCity")) document.getElementById("depCity").value = quotation.clientData.depCity || "Karachi";
      if (document.getElementById("numAdult")) document.getElementById("numAdult").value = quotation.clientData.adults || 0;
      if (document.getElementById("numChildBed")) document.getElementById("numChildBed").value = quotation.clientData.childBed || 0;
      if (document.getElementById("numChildNoBed")) document.getElementById("numChildNoBed").value = quotation.clientData.childNoBed || 0;
      if (document.getElementById("numInfant")) document.getElementById("numInfant").value = quotation.clientData.infants || 0;
      if (document.getElementById("dateFrom")) document.getElementById("dateFrom").value = quotation.clientData.dateFrom || "";
      if (document.getElementById("dateTo")) document.getElementById("dateTo").value = quotation.clientData.dateTo || "";
      if (document.getElementById("nightsMakkah")) document.getElementById("nightsMakkah").value = quotation.clientData.nightsMakkah || 0;
      if (document.getElementById("nightsMadina")) document.getElementById("nightsMadina").value = quotation.clientData.nightsMadina || 0;
      
      // Mark client data as saved
      isClientDataSaved = true;
      
      console.log("Client data loaded successfully");
    }
    
    // Clear existing sections
    if (document.getElementById("flightContainer")) document.getElementById("flightContainer").innerHTML = "";
    
    const hotelContainerM = document.getElementById("hotelContainerM");
    if (hotelContainerM) {
      const headerM = hotelContainerM.querySelector('.hotel-header');
      hotelContainerM.innerHTML = "";
      if (headerM) hotelContainerM.appendChild(headerM);
    }
    
    const hotelContainerA = document.getElementById("hotelContainerA");
    if (hotelContainerA) {
      const headerA = hotelContainerA.querySelector('.hotel-header');
      hotelContainerA.innerHTML = "";
      if (headerA) hotelContainerA.appendChild(headerA);
    }
    
    if (document.getElementById("transferContainer")) document.getElementById("transferContainer").innerHTML = "";
    if (document.getElementById("visaContainer")) document.getElementById("visaContainer").innerHTML = "";
    if (document.getElementById("directFlightContainer")) document.getElementById("directFlightContainer").innerHTML = "";
    if (document.getElementById("mealTypeContainer")) document.getElementById("mealTypeContainer").innerHTML = "";
    if (document.getElementById("ziyarahContainer")) document.getElementById("ziyarahContainer").innerHTML = "";
    
    // Reset counters
    nextFlightNumber = 0;
    flights = [];
    nextHotelNumberM = 0;
    hotelsMakkah = [];
    nextHotelNumberA = 0;
    hotelsMadina = [];
    nextTransferNumber = 0;
    transfers = [];
    visaAdded = false;
    dfIndex = 0;
    mealIndex = 0;
    ziyarahIndex = 0;
    
    console.log("Loading flights...");
    
    // Load flights with proper timing
    if (quotation.flights && Array.isArray(quotation.flights)) {
      quotation.flights.forEach((flightData, flightIndex) => {
        setTimeout(() => {
          addFlight();
          
          setTimeout(() => {
            const idx = nextFlightNumber;
            console.log(`Loading flight ${idx} with data:`, flightData);
            
            // Fill flight data
            if (document.getElementById(`flightItinerary_${idx}`)) 
              document.getElementById(`flightItinerary_${idx}`).value = flightData.itinerary || "";
            if (document.getElementById(`airline_${idx}`)) 
              document.getElementById(`airline_${idx}`).value = flightData.airline || "";
            if (document.getElementById(`flightDirect_${idx}`)) 
              document.getElementById(`flightDirect_${idx}`).value = flightData.direct || "";
            
            // Fill costs
            if (flightData.costs) {
              if (document.getElementById(`flightCostAdult_${idx}`)) 
                document.getElementById(`flightCostAdult_${idx}`).value = flightData.costs.adult?.cost || 0;
              if (document.getElementById(`flightSvcAdult_${idx}`)) 
                document.getElementById(`flightSvcAdult_${idx}`).value = flightData.costs.adult?.service || 0;
              if (document.getElementById(`flightCostChildBed_${idx}`)) 
                document.getElementById(`flightCostChildBed_${idx}`).value = flightData.costs.childBed?.cost || 0;
              if (document.getElementById(`flightSvcChildBed_${idx}`)) 
                document.getElementById(`flightSvcChildBed_${idx}`).value = flightData.costs.childBed?.service || 0;
              if (document.getElementById(`flightCostChildNoBed_${idx}`)) 
                document.getElementById(`flightCostChildNoBed_${idx}`).value = flightData.costs.childNoBed?.cost || 0;
              if (document.getElementById(`flightSvcChildNoBed_${idx}`)) 
                document.getElementById(`flightSvcChildNoBed_${idx}`).value = flightData.costs.childNoBed?.service || 0;
              if (document.getElementById(`flightCostInf_${idx}`)) 
                document.getElementById(`flightCostInf_${idx}`).value = flightData.costs.infant?.cost || 0;
              if (document.getElementById(`flightSvcInf_${idx}`)) 
                document.getElementById(`flightSvcInf_${idx}`).value = flightData.costs.infant?.service || 0;
            }
            
            console.log(`Flight ${idx} loaded successfully`);
          }, 100);
        }, 200 * flightIndex);
      });
    }
    
    console.log("Loading Makkah hotels...");
    
    // Load Makkah hotels with proper timing
    if (quotation.hotelsMakkah && Array.isArray(quotation.hotelsMakkah)) {
      quotation.hotelsMakkah.forEach((hotelData, hotelIndex) => {
        setTimeout(() => {
          createHotelSectionM(nextHotelNumberM);
          
          setTimeout(() => {
            const idx = nextHotelNumberM;
            console.log(`Loading Makkah hotel ${idx} with data:`, hotelData);
            
            // Fill hotel data
            if (document.getElementById(`hkNameM_${idx}`)) 
              document.getElementById(`hkNameM_${idx}`).value = hotelData.name || "";
            if (document.getElementById(`hkDistM_${idx}`)) 
              document.getElementById(`hkDistM_${idx}`).value = hotelData.distance || "";
            if (document.getElementById(`hkCheckInM_${idx}`)) 
              document.getElementById(`hkCheckInM_${idx}`).value = hotelData.checkIn || "";
            if (document.getElementById(`hkCheckOutM_${idx}`)) 
              document.getElementById(`hkCheckOutM_${idx}`).value = hotelData.checkOut || "";
            if (document.getElementById(`hkNightsM_${idx}`)) 
              document.getElementById(`hkNightsM_${idx}`).value = hotelData.nights || 0;
            if (document.getElementById(`hkRoomTypeM_${idx}`)) 
              document.getElementById(`hkRoomTypeM_${idx}`).value = hotelData.roomType || "";
            if (document.getElementById(`hkRoomsM_${idx}`)) 
              document.getElementById(`hkRoomsM_${idx}`).value = hotelData.rooms || 1;
            if (document.getElementById(`hkServiceM_${idx}`)) 
              document.getElementById(`hkServiceM_${idx}`).value = hotelData.serviceType || "";
            if (document.getElementById(`hkCostNightM_${idx}`)) 
              document.getElementById(`hkCostNightM_${idx}`).value = hotelData.costNight || 0;
            if (document.getElementById(`hkSvcNightM_${idx}`)) 
              document.getElementById(`hkSvcNightM_${idx}`).value = hotelData.svcNight || 0;
            
            console.log(`Makkah hotel ${idx} loaded successfully`);
          }, 100);
        }, 200 * hotelIndex);
      });
    }
    
    console.log("Loading Madina hotels...");
    
    // Load Madina hotels with proper timing
    if (quotation.hotelsMadina && Array.isArray(quotation.hotelsMadina)) {
      quotation.hotelsMadina.forEach((hotelData, hotelIndex) => {
        setTimeout(() => {
          createHotelSectionA(nextHotelNumberA);
          
          setTimeout(() => {
            const idx = nextHotelNumberA;
            console.log(`Loading Madina hotel ${idx} with data:`, hotelData);
            
            // Fill hotel data
            if (document.getElementById(`hkNameA_${idx}`)) 
              document.getElementById(`hkNameA_${idx}`).value = hotelData.name || "";
            if (document.getElementById(`hkDistA_${idx}`)) 
              document.getElementById(`hkDistA_${idx}`).value = hotelData.distance || "";
            if (document.getElementById(`hkCheckInA_${idx}`)) 
              document.getElementById(`hkCheckInA_${idx}`).value = hotelData.checkIn || "";
            if (document.getElementById(`hkCheckOutA_${idx}`)) 
              document.getElementById(`hkCheckOutA_${idx}`).value = hotelData.checkOut || "";
            if (document.getElementById(`hkNightsA_${idx}`)) 
              document.getElementById(`hkNightsA_${idx}`).value = hotelData.nights || 0;
            if (document.getElementById(`hkRoomTypeA_${idx}`)) 
              document.getElementById(`hkRoomTypeA_${idx}`).value = hotelData.roomType || "";
            if (document.getElementById(`hkRoomsA_${idx}`)) 
              document.getElementById(`hkRoomsA_${idx}`).value = hotelData.rooms || 1;
            if (document.getElementById(`hkServiceA_${idx}`)) 
              document.getElementById(`hkServiceA_${idx}`).value = hotelData.serviceType || "";
            if (document.getElementById(`hkCostNightA_${idx}`)) 
              document.getElementById(`hkCostNightA_${idx}`).value = hotelData.costNight || 0;
            if (document.getElementById(`hkSvcNightA_${idx}`)) 
              document.getElementById(`hkSvcNightA_${idx}`).value = hotelData.svcNight || 0;
            
            console.log(`Madina hotel ${idx} loaded successfully`);
          }, 100);
        }, 200 * hotelIndex);
      });
    }
    
    console.log("Loading transfers...");
    
    // Load transfers with proper timing
    if (quotation.transfers && Array.isArray(quotation.transfers)) {
      quotation.transfers.forEach((transferData, transferIndex) => {
        setTimeout(() => {
          addTransfer();
          
          setTimeout(() => {
            const idx = nextTransferNumber;
            console.log(`Loading transfer ${idx} with data:`, transferData);
            
            // Fill transfer data
            if (document.getElementById(`tDate_${idx}`)) 
              document.getElementById(`tDate_${idx}`).value = transferData.date || "";
            if (document.getElementById(`tFrom_${idx}`)) 
              document.getElementById(`tFrom_${idx}`).value = transferData.from || "";
            if (document.getElementById(`tTo_${idx}`)) 
              document.getElementById(`tTo_${idx}`).value = transferData.to || "";
            if (document.getElementById(`tCar_${idx}`)) 
              document.getElementById(`tCar_${idx}`).value = transferData.vehicle || "";
            if (document.getElementById(`tType_${idx}`)) 
              document.getElementById(`tType_${idx}`).value = transferData.type || "";
            if (document.getElementById(`tCostSAR_${idx}`)) 
              document.getElementById(`tCostSAR_${idx}`).value = transferData.cost || 0;
            if (document.getElementById(`tSvcSAR_${idx}`)) 
              document.getElementById(`tSvcSAR_${idx}`).value = transferData.service || 0;
            
            console.log(`Transfer ${idx} loaded successfully`);
          }, 100);
        }, 200 * transferIndex);
      });
    }
    
    console.log("Loading visa...");
    
    // Load visa with proper timing
    if (quotation.visa && quotation.visa.count) {
      setTimeout(() => {
        addVisa();
        
        setTimeout(() => {
          if (document.getElementById('visaCount')) 
            document.getElementById('visaCount').value = quotation.visa.count || 0;
          if (document.getElementById('visaCost')) 
            document.getElementById('visaCost').value = quotation.visa.cost || 0;
          if (document.getElementById('visaSvc')) 
            document.getElementById('visaSvc').value = quotation.visa.service || 0;
            
          console.log("Visa loaded successfully");
        }, 100);
      }, 200);
    }
    
    console.log("Loading add-ons...");
    
    // Load add-ons with proper timing
    if (quotation.addons) {
      // Load direct flight add-ons
      if (quotation.addons.directFlights && Array.isArray(quotation.addons.directFlights)) {
        quotation.addons.directFlights.forEach((addonData, addonIndex) => {
          setTimeout(() => {
            // Open the direct flight panel
            const directFlightPanel = document.getElementById('directFlightPanel');
            if (directFlightPanel && directFlightPanel.style.display === 'none') {
              togglePanel('directFlightPanel', document.querySelector('.addon-header'));
            }
            
            // Trigger the addDirectFlightAddon function
            document.querySelector('.addon-panel button[onclick*="addDirectFlightAddon"]').click();
            
            // Wait a moment for the add-on to be added
            setTimeout(() => {
              const idx = dfIndex;
              
              // Fill add-on data
              const addonElement = document.getElementById(`dfAddon_${idx}`);
              if (addonElement) {
                const textarea = addonElement.querySelector('textarea');
                if (textarea) textarea.value = addonData.itinerary || "";
                
                const airlineInput = addonElement.querySelector("input[list='airlist']");
                if (airlineInput) airlineInput.value = addonData.airline || "";
                
                const directSelect = addonElement.querySelector('select');
                if (directSelect) directSelect.value = addonData.direct || "";
                
                // Fill costs
                if (addonData.costs) {
                  if (document.getElementById(`upgradeFlightCostAdult_${idx}`)) 
                    document.getElementById(`upgradeFlightCostAdult_${idx}`).value = addonData.costs.adult?.cost || 0;
                  if (document.getElementById(`upgradeFlightSvcAdult_${idx}`)) 
                    document.getElementById(`upgradeFlightSvcAdult_${idx}`).value = addonData.costs.adult?.service || 0;
                  if (document.getElementById(`upgradeFlightCostChildBed_${idx}`)) 
                    document.getElementById(`upgradeFlightCostChildBed_${idx}`).value = addonData.costs.childBed?.cost || 0;
                  if (document.getElementById(`upgradeFlightSvcChildBed_${idx}`)) 
                    document.getElementById(`upgradeFlightSvcChildBed_${idx}`).value = addonData.costs.childBed?.service || 0;
                  if (document.getElementById(`upgradeFlightCostChildNoBed_${idx}`)) 
                    document.getElementById(`upgradeFlightCostChildNoBed_${idx}`).value = addonData.costs.childNoBed?.cost || 0;
                  if (document.getElementById(`upgradeFlightSvcChildNoBed_${idx}`)) 
                    document.getElementById(`upgradeFlightSvcChildNoBed_${idx}`).value = addonData.costs.childNoBed?.service || 0;
                  if (document.getElementById(`upgradeFlightCostInf_${idx}`)) 
                    document.getElementById(`upgradeFlightCostInf_${idx}`).value = addonData.costs.infant?.cost || 0;
                  if (document.getElementById(`upgradeFlightSvcInf_${idx}`)) 
                    document.getElementById(`upgradeFlightSvcInf_${idx}`).value = addonData.costs.infant?.service || 0;
                }
              }
            }, 50);
          }, 300 * (addonIndex + 1));
        });
      }
      
      // Load meal add-ons
      if (quotation.addons.meals && Array.isArray(quotation.addons.meals)) {
        quotation.addons.meals.forEach((addonData, addonIndex) => {
          setTimeout(() => {
            // Open the meal type panel
            const mealTypePanel = document.getElementById('mealTypePanel');
            if (mealTypePanel && mealTypePanel.style.display === 'none') {
              togglePanel('mealTypePanel', document.querySelectorAll('.addon-header')[1]);
            }
            
            // Trigger the addMealTypeAddon function
            document.querySelectorAll('.addon-panel button[onclick*="addMealTypeAddon"]')[0].click();
            
            // Wait a moment for the add-on to be added
            setTimeout(() => {
              const idx = mealIndex;
              
              // Fill add-on data
              const addonElement = document.getElementById(`mealAddon_${idx}`);
              if (addonElement) {
                const selects = addonElement.querySelectorAll('select');
                const inputs = addonElement.querySelectorAll("input[type='number']");
                
                if (selects[0]) selects[0].value = addonData.hotel || "";
                if (selects[1]) selects[1].value = addonData.mealType || "";
                if (inputs[0]) inputs[0].value = addonData.cost || 0;
                if (inputs[1]) inputs[1].value = addonData.service || 0;
              }
            }, 50);
          }, 300 * (addonIndex + 1));
        });
      }
      
      // Load ziyarah add-ons
      if (quotation.addons.ziyarah && Array.isArray(quotation.addons.ziyarah)) {
        quotation.addons.ziyarah.forEach((addonData, addonIndex) => {
          setTimeout(() => {
            // Open the ziyarah panel
            const ziyarahPanel = document.getElementById('ziyarahPanel');
            if (ziyarahPanel && ziyarahPanel.style.display === 'none') {
              togglePanel('ziyarahPanel', document.querySelectorAll('.addon-header')[2]);
            }
            
            // Trigger the addZiyarahAddon function
            document.querySelectorAll('.addon-panel button[onclick*="addZiyarahAddon"]')[0].click();
            
            // Wait a moment for the add-on to be added
            setTimeout(() => {
              const idx = ziyarahIndex;
              
              // Fill add-on data
              const addonElement = document.getElementById(`ziyarahAddon_${idx}`);
              if (addonElement) {
                const selects = addonElement.querySelectorAll('select');
                const inputs = addonElement.querySelectorAll(".inline-input input[type='number']");
                
                if (selects[0]) selects[0].value = addonData.city || "";
                if (selects[1]) selects[1].value = addonData.vehicle || "";
                if (selects[2]) selects[2].value = addonData.duration || "";
                if (inputs[0]) inputs[0].value = addonData.cost || 0;
                if (inputs[1]) inputs[1].value = addonData.service || 0;
              }
            }, 50);
          }, 300 * (addonIndex + 1));
        });
      }
    }

    // Show status section
    showStatusSection();
    
    showNotification("Quotation loaded successfully!", "success");
    
  } catch (error) {
    console.error('Error loading quotation:', error);
    showNotification("Failed to load quotation. Please try again.", "error");
  }
}

// Function to check how many quotations are saved
function checkSavedQuotations() {
  const allQuotations = JSON.parse(localStorage.getItem('savedQuotations')) || [];
  const agent = getCurrentAgent();
  
  if (agent) {
    const agentQuotations = allQuotations.filter(q => q.agentData && q.agentData.id === agent.id);
    console.log(`Total quotations in localStorage: ${allQuotations.length}`);
    console.log(`Quotations for current agent (${agent.name}): ${agentQuotations.length}`);
    
    agentQuotations.forEach((q, index) => {
      console.log(`${index + 1}. ID: ${q.id}, Client: ${q.clientData.name}, Created: ${new Date(q.createdAt).toLocaleDateString()}`);
    });
  }
}

// Function to show the load quotation dialog
function showLoadQuotationDialog() {
  try {
    // Get all saved quotations
    savedQuotations = JSON.parse(localStorage.getItem('savedQuotations')) || [];
    
    if (savedQuotations.length === 0) {
      showNotification("No saved quotations found.", "warning");
      return;
    }

    // Create modal content
    const modalTitle = document.getElementById("modal-title");
    const modalMessage = document.getElementById("modal-message");
    const modalButtons = document.getElementById("modal-buttons");
    
    modalTitle.textContent = 'Load Saved Quotation';
    
    // Create a table of quotations
    let tableHTML = `
      <div style="max-height: 400px; overflow-y: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #f2f2f2;">
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">ID</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Client</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Destination</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Date</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Total (PKR)</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Status</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Action</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    savedQuotations.forEach(quotation => {
      const statusColor = {
        'pending': '#ffc107',
        'followup': '#17a2b8',
        'booked': '#28a745',
        'cancelled': '#dc3545'
      };
      
      tableHTML += `
        <tr>
          <td style="padding: 8px; border: 1px solid #ddd;">${quotation.id}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${quotation.clientData.name}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${quotation.clientData.tourDestination}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${formatDateToDMY(quotation.clientData.dateFrom)} - ${formatDateToDMY(quotation.clientData.dateTo)}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">${fmt(quotation.totalAmount)}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <span style="background-color: ${statusColor[quotation.status] || '#6c757d'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
              ${quotation.status}
            </span>
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <button class="load-quotation-btn" data-id="${quotation.id}" style="padding: 4px 8px; font-size: 12px;">Load</button>
          </td>
        </tr>
      `;
    });
    
    tableHTML += `
          </tbody>
        </table>
      </div>
    `;
    
    modalMessage.innerHTML = tableHTML;
    
    // Clear and add buttons
    modalButtons.innerHTML = '';
    
    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Close';
    closeBtn.onclick = () => {
      modal.classList.remove('visible');
    };
    modalButtons.appendChild(closeBtn);
    
    // Show modal
    modal.classList.add('visible');
    
// Add event listeners to load buttons
document.querySelectorAll('.load-quotation-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    // Get the quotation ID from the button's data attribute
    const quotationId = btn.getAttribute('data-id');
    
    // Close modal
    modal.classList.remove('visible');
    
    // Load the quotation
    loadQuotation(quotationId);
  });
});
      
  } catch (error) {
    console.error('Error loading quotations:', error);
    showAlert("Failed to load quotations. Please try again.", "Error");
  }
}

// Debug function to check if hotel containers exist
function debugHotelContainers() {
  const hotelContainerM = document.getElementById("hotelContainerM");
  const hotelContainerA = document.getElementById("hotelContainerA");
  
  console.log("hotelContainerM exists:", !!hotelContainerM);
  console.log("hotelContainerA exists:", !!hotelContainerA);
  
  if (hotelContainerM) {
    console.log("hotelContainerM children:", hotelContainerM.children.length);
    console.log("hotelContainerM innerHTML:", hotelContainerM.innerHTML.substring(0, 200) + "...");
  }
  
  if (hotelContainerA) {
    console.log("hotelContainerA children:", hotelContainerA.children.length);
    console.log("hotelContainerA innerHTML:", hotelContainerA.innerHTML.substring(0, 200) + "...");
  }
}

// Terms Editor Function (This was missing in the original code)
function showTermsEditor() {
  const modal = document.getElementById('termsModal');
  const modalTitle = document.getElementById('termsModalTitle');
  const modalContent = document.getElementById('termsModalContent');
  const modalButtons = document.getElementById('termsModalButtons');
  
  modalTitle.textContent = 'Edit Terms & Conditions';
  
  const editor = document.createElement('textarea');
  editor.className = 'terms-editor';
  editor.value = customTerms || defaultTerms;
  editor.style.height = '400px';
  
  modalContent.innerHTML = '';
  modalContent.appendChild(editor);
  
  modalButtons.innerHTML = '';
  
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Save';
  saveBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    customTerms = editor.value;
    localStorage.setItem('customTerms', customTerms);
    modal.classList.remove('visible');
    showNotification('Terms & Conditions updated successfully!', 'success');
  });
  modalButtons.appendChild(saveBtn);
  
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = 'ghost';
  cancelBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    modal.classList.remove('visible');
  });
  modalButtons.appendChild(cancelBtn);
  
  modal.classList.add('visible');
}

// Content Editor Function with Rich Text Editor and Editable Headings
// Content Editor Function with Rich Text Editor and Section Toggles
function showContentEditor() {
  const modal = document.getElementById('contentEditorModal');
  const modalTitle = document.getElementById('contentEditorModalTitle');
  const modalContent = document.getElementById('contentEditorModalContent');
  const modalButtons = document.getElementById('contentEditorModalButtons');
  
  modalTitle.textContent = 'Edit Content';
  
  // Create tabs for different content types
  const tabsContainer = document.createElement('div');
  tabsContainer.style.display = 'flex';
  tabsContainer.style.marginBottom = '15px';
  tabsContainer.style.borderBottom = '1px solid #ddd';
  
  const tabs = ['Terms & Conditions', 'Section 1', 'Section 2'];
  const tabContents = [];
  const editors = {}; // Store references to editors
  const headingInputs = {}; // Store references to heading inputs
  const sectionToggles = {}; // Store references to section toggles
  
  tabs.forEach((tab, index) => {
    const tabButton = document.createElement('button');
    tabButton.textContent = tab;
    tabButton.style.padding = '8px 15px';
    tabButton.style.border = 'none';
    tabButton.style.background = index === 0 ? 'var(--accent)' : 'transparent';
    tabButton.style.color = index === 0 ? 'white' : '#666';
    tabButton.style.cursor = 'pointer';
    tabButton.style.borderBottom = index === 0 ? '2px solid var(--accent)' : 'none';
    
    tabButton.addEventListener('click', () => {
      // Hide all content areas
      tabContents.forEach(content => content.style.display = 'none');
      
      // Show selected content
      tabContents[index].style.display = 'block';
      
      // Update tab styles
      tabs.forEach((_, i) => {
        tabsContainer.children[i].style.background = i === index ? 'var(--accent)' : 'transparent';
        tabsContainer.children[i].style.color = i === index ? 'white' : '#666';
        tabsContainer.children[i].style.borderBottom = i === index ? '2px solid var(--accent)' : 'none';
      });
    });
    
    tabsContainer.appendChild(tabButton);
  });
  
  // Create content areas for each tab
  const contentContainer = document.createElement('div');
  
  // Function to create rich editor with editable heading and toggle
  function createRichEditorWithHeadingAndToggle(content, tabIndex, defaultHeading) {
    const editorContainer = document.createElement('div');
    
    // Create section toggle (except for Terms & Conditions)
    let toggleContainer = null;
    if (tabIndex !== 0) { // Not Terms & Conditions
      toggleContainer = document.createElement('div');
      toggleContainer.className = 'section-toggle-container';
      
      const toggleLabel = document.createElement('div');
      toggleLabel.className = 'section-toggle-label';
      toggleLabel.innerHTML = `
        <span>Include this section in quotation?</span>
        <span class="section-status" id="status_${tabIndex}">Section will be included</span>
      `;
      
      const toggleSwitch = document.createElement('div');
      toggleSwitch.className = 'toggle-switch active';
      toggleSwitch.id = `toggle_${tabIndex}`;
      
      // Check if section is currently disabled
      const isDisabled = localStorage.getItem(`sectionDisabled_${tabIndex}`) === 'true';
      if (isDisabled) {
        toggleSwitch.classList.remove('active');
        toggleLabel.querySelector('.section-status').textContent = 'Section will be hidden';
      }
      
      toggleSwitch.addEventListener('click', () => {
        toggleSwitch.classList.toggle('active');
        const isActive = toggleSwitch.classList.contains('active');
        
        // Update status text
        const statusText = toggleLabel.querySelector('.section-status');
        statusText.textContent = isActive ? 'Section will be included' : 'Section will be hidden';
        
        // Enable/disable editor
        const editorSection = editorContainer.querySelector('.editor-section');
        if (isActive) {
          editorSection.classList.remove('section-disabled');
          localStorage.setItem(`sectionDisabled_${tabIndex}`, 'false');
        } else {
          editorSection.classList.add('section-disabled');
          localStorage.setItem(`sectionDisabled_${tabIndex}`, 'true');
        }
      });
      
      toggleContainer.appendChild(toggleLabel);
      toggleContainer.appendChild(toggleSwitch);
      editorContainer.appendChild(toggleContainer);
      sectionToggles[tabIndex] = toggleSwitch;
    }
    
    // Create editor section wrapper
    const editorSection = document.createElement('div');
    editorSection.className = 'editor-section';
    
    // Apply disabled state if needed
    if (tabIndex !== 0 && localStorage.getItem(`sectionDisabled_${tabIndex}`) === 'true') {
      editorSection.classList.add('section-disabled');
    }
    
    // Create heading input (except for Terms & Conditions)
    let headingInput = null;
    if (tabIndex !== 0) { // Not Terms & Conditions
      const headingContainer = document.createElement('div');
      headingContainer.style.marginBottom = '15px';
      
      const headingLabel = document.createElement('label');
      headingLabel.textContent = 'Section Heading:';
      headingLabel.style.display = 'block';
      headingLabel.style.marginBottom = '5px';
      headingLabel.style.fontWeight = 'bold';
      headingLabel.style.color = '#333';
      
      headingInput = document.createElement('input');
      headingInput.type = 'text';
      headingInput.className = 'heading-input';
      headingInput.style.width = '100%';
      headingInput.style.padding = '10px';
      headingInput.style.border = '1px solid #ddd';
      headingInput.style.borderRadius = '4px';
      headingInput.style.fontSize = '16px';
      headingInput.style.fontWeight = 'bold';
      
      // Extract current heading from content or use default
      const headingMatch = content.match(/<h3[^>]*>(.*?)<\/h3>/);
      if (headingMatch) {
        headingInput.value = headingMatch[1].replace(/<[^>]*>/g, '').trim();
      } else {
        headingInput.value = defaultHeading;
      }
      
      headingContainer.appendChild(headingLabel);
      headingContainer.appendChild(headingInput);
      editorSection.appendChild(headingContainer);
      headingInputs[tabIndex] = headingInput;
    }
    
    // Create toolbar
    const toolbar = document.createElement('div');
    toolbar.className = 'rich-editor-toolbar';
    toolbar.style.backgroundColor = '#f5f5f5';
toolbar.style.padding = '10px';
toolbar.style.border = '1px solid #ddd';
toolbar.style.borderBottom = 'none';
toolbar.style.borderRadius = '4px 4px 0 0';
toolbar.style.display = 'flex';
toolbar.style.flexWrap = 'wrap';
toolbar.style.gap = '5px';
    
    // Formatting buttons
const buttons = [
  { icon: 'B', title: 'Bold', command: 'bold' },
  { icon: 'I', title: 'Italic', command: 'italic' },
  { icon: 'U', title: 'Underline', command: 'underline' },
  { separator: true },
  { icon: '🔤', title: 'Font Family', command: 'fontFamily', type: 'select' },
  { icon: '📏', title: 'Font Size', command: 'fontSize', type: 'select' },
  { separator: true },
  { icon: '•', title: 'Bullet List', command: 'insertUnorderedList' },
  { icon: '1.', title: 'Numbered List', command: 'insertOrderList' },
  { separator: true },
  { icon: '◀', title: 'Align Left', command: 'justifyLeft' },
  { icon: '▬', title: 'Align Center', command: 'justifyCenter' },
  { icon: '▶', title: 'Align Right', command: 'justifyRight' },
  { separator: true },
  { icon: '🔗', title: 'Insert Link', command: 'createLink' },
  { icon: '✖', title: 'Remove Formatting', command: 'removeFormat' }
];
    
    buttons.forEach(btn => {
  if (btn.separator) {
    const separator = document.createElement('div');
    separator.className = 'rich-editor-separator';
    separator.style.cssText = 'width: 1px; background: #ccc; margin: 0 5px;';
    toolbar.appendChild(separator);
  } else if (btn.type === 'select') {
    // Create dropdown for font family or font size
    const select = document.createElement('select');
    select.style.cssText = 'padding: 6px 8px; border: 1px solid #1a237e; background: #1a237e; color: white; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 5px;';
    
    if (btn.command === 'fontFamily') {
      select.innerHTML = `
        <option value="">Font</option>
        <option value="Arial, sans-serif">Arial</option>
        <option value="Times New Roman, serif">Times</option>
        <option value="Georgia, serif">Georgia</option>
        <option value="Courier New, monospace">Courier</option>
        <option value="Verdana, sans-serif">Verdana</option>
        <option value="Helvetica, sans-serif">Helvetica</option>
        <option value="Tahoma, sans-serif">Tahoma</option>
        <option value="Trebuchet MS, sans-serif">Trebuchet</option>
      `;
      
      select.addEventListener('change', () => {
        if (select.value) {
          document.execCommand('fontName', false, select.value);
        }
      });
      
    } else if (btn.command === 'fontSize') {
      select.innerHTML = `
        <option value="">Size</option>
        <option value="1">Very Small (8pt)</option>
        <option value="2">Small (10pt)</option>
        <option value="3">Normal (12pt)</option>
        <option value="4">Medium (14pt)</option>
        <option value="5">Large (18pt)</option>
        <option value="6">Extra Large (24pt)</option>
        <option value="7">Huge (36pt)</option>
      `;
      
      select.addEventListener('change', () => {
        if (select.value) {
          document.execCommand('fontSize', false, select.value);
        }
      });
    }
    
    // Style the select options
    Array.from(select.options).forEach(option => {
      if (option.value) {
        option.style.background = '#1a237e';
        option.style.color = 'white';
      }
    });
    
    toolbar.appendChild(select);
    
  } else {
    // Regular buttons
    const button = document.createElement('button');
    button.className = 'rich-editor-btn';
    button.textContent = btn.icon;
    button.title = btn.title;
    button.type = 'button';
    button.style.cssText = 'padding: 8px 12px; border: 1px solid #1a237e; background: #1a237e; cursor: pointer; border-radius: 4px; font-size: 14px; font-weight: bold; transition: all 0.2s; min-width: 30px; text-align: center; color: white !important; box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);';
    
    // Apply specific styling for each button type
    if (btn.command === 'bold') {
      button.style.fontWeight = 'bold';
    } else if (btn.command === 'italic') {
      button.style.fontStyle = 'italic';
    } else if (btn.command === 'underline') {
      button.style.textDecoration = 'underline';
    } else if (btn.command === 'insertUnorderedList') {
      button.style.fontSize = '16px';
    } else if (btn.command === 'insertOrderedList') {
      button.style.fontWeight = 'bold';
    } else if (btn.icon === '▬') {
      button.style.fontSize = '12px';
      button.style.letterSpacing = '2px';
    }
    
    button.addEventListener('click', (e) => {
      e.preventDefault();
      
      if (btn.command === 'createLink') {
        const url = prompt('Enter URL:');
        if (url) {
          document.execCommand(btn.command, false, url);
        }
      } else {
        document.execCommand(btn.command, false, null);
      }
      
      // Update button states
      updateToolbarState(toolbar, editorContent);
    });
    
    button.addEventListener('mouseenter', () => {
      button.style.background = '#283593';
      button.style.borderColor = '#3949ab';
      button.style.transform = 'translateY(-1px)';
      button.style.boxShadow = '0 4px 8px rgba(26, 35, 126, 0.4)';
    });
    
    button.addEventListener('mouseleave', () => {
      button.style.background = '#1a237e';
      button.style.borderColor = '#1a237e';
      button.style.transform = 'translateY(0)';
      button.style.boxShadow = '0 2px 4px rgba(26, 35, 126, 0.3)';
    });
    
    toolbar.appendChild(button);
  }
});

// Add quick font size buttons
const fontSizes = [
  { label: 'A-', title: 'Decrease Font', command: 'decreaseFontSize' },
  { label: 'A', title: 'Normal Font', command: 'normalFontSize' },
  { label: 'A+', title: 'Increase Font', command: 'increaseFontSize' }
];

fontSizes.forEach(fontBtn => {
  const sizeButton = document.createElement('button');
  sizeButton.className = 'rich-editor-btn';
  sizeButton.textContent = fontBtn.label;
  sizeButton.title = fontBtn.title;
  sizeButton.type = 'button';
  sizeButton.style.cssText = 'padding: 6px 10px; border: 1px solid #1a237e; background: #1a237e; cursor: pointer; border-radius: 4px; font-size: 12px; font-weight: bold; transition: all 0.2s; color: white !important; margin-right: 3px;';
  
  sizeButton.addEventListener('click', (e) => {
    e.preventDefault();
    
    if (fontBtn.command === 'decreaseFontSize') {
      document.execCommand('fontSize', false, '2');
    } else if (fontBtn.command === 'normalFontSize') {
      document.execCommand('fontSize', false, '3');
    } else if (fontBtn.command === 'increaseFontSize') {
      document.execCommand('fontSize', false, '5');
    }
  });
  
  sizeButton.addEventListener('mouseenter', () => {
    sizeButton.style.background = '#283593';
    sizeButton.style.transform = 'translateY(-1px)';
  });
  
  sizeButton.addEventListener('mouseleave', () => {
    sizeButton.style.background = '#1a237e';
    sizeButton.style.transform = 'translateY(0)';
  });
  
  toolbar.appendChild(sizeButton);
});
    
    // Create editable content area
const editorContent = document.createElement('div');
editorContent.className = 'rich-editor-content';
editorContent.contentEditable = true;
editorContent.style.whiteSpace = 'pre-wrap';
editorContent.style.fontFamily = 'Arial, sans-serif';
editorContent.style.fontSize = '14px';
editorContent.style.lineHeight = '1.5';
editorContent.style.minHeight = '300px';
editorContent.style.padding = '15px';
editorContent.style.border = '1px solid #ddd';
editorContent.style.borderRadius = '4px';
editorContent.style.overflowY = 'auto';
editorContent.style.width = '100%';
    
    // Remove existing heading from content for editing
    let cleanContent = content.replace(/<h3[^>]*>.*?<\/h3>/g, '');
    editorContent.innerHTML = cleanContent;
    
    // Update toolbar state when selection changes
    editorContent.addEventListener('mouseup', () => updateToolbarState(toolbar, editorContent));
    editorContent.addEventListener('keyup', () => updateToolbarState(toolbar, editorContent));
    
    editorSection.appendChild(toolbar);
    editorSection.appendChild(editorContent);
    editorContainer.appendChild(editorSection);
    
    // Store reference
    editors[tabIndex] = editorContent;
    
    return editorContainer;
  }
  
  // Function to update toolbar button states
  function updateToolbarState(toolbar, editor) {
    const buttons = toolbar.querySelectorAll('.rich-editor-btn');
    buttons.forEach(btn => {
      const command = btn.getAttribute('data-command') || 
                     (btn.textContent === 'B' ? 'bold' :
                      btn.textContent === 'I' ? 'italic' :
                      btn.textContent === 'U' ? 'underline' :
                      btn.textContent === '•' ? 'insertUnorderedList' :
                      btn.textContent === '1.' ? 'insertOrderedList' :
                      btn.textContent === '◀' ? 'justifyLeft' :
                      btn.textContent === '▬' ? 'justifyCenter' :
                      btn.textContent === '▶' ? 'justifyRight' :
                      btn.textContent === '🔗' ? 'createLink' :
                      btn.textContent === '✖' ? 'removeFormat' : '');
      
      if (command && command !== 'createLink' && command !== 'removeFormat') {
        try {
          if (document.queryCommandState(command)) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        } catch (e) {
          // Ignore errors for unsupported commands
        }
      }
    });
  }
  
  // Terms & Conditions Tab (no toggle or editable heading)
  const termsContent = document.createElement('div');
  const termsHtml = customTerms || defaultTerms;
  const termsEditor = createRichEditorWithHeadingAndToggle(termsHtml, 0, 'Terms and Conditions');
  termsContent.appendChild(termsEditor);
  contentContainer.appendChild(termsContent);
  tabContents.push(termsContent);
  
  // Section 1 Tab (with toggle and editable heading)
  const section1Content = document.createElement('div');
  section1Content.style.display = 'none';
  const section1Html = localStorage.getItem('visaRequirements') || '';
  const section1Editor = createRichEditorWithHeadingAndToggle(section1Html, 1, 'Section 1 Heading');
  section1Content.appendChild(section1Editor);
  contentContainer.appendChild(section1Content);
  tabContents.push(section1Content);
  
  // Section 2 Tab (with toggle and editable heading)
  const section2Content = document.createElement('div');
  section2Content.style.display = 'none';
  const section2Html = localStorage.getItem('biometricProcess') || '';
  const section2Editor = createRichEditorWithHeadingAndToggle(section2Html, 2, 'Section 2 Heading');
  section2Content.appendChild(section2Editor);
  contentContainer.appendChild(section2Content);
  tabContents.push(section2Content);
  
  modalContent.innerHTML = '';
  modalContent.appendChild(tabsContainer);
  modalContent.appendChild(contentContainer);
  
  modalButtons.innerHTML = '';
  
  const saveBtn = document.createElement('button');
saveBtn.textContent = 'Save Changes';
saveBtn.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  
  // Get the active tab
  const activeTabIndex = Array.from(tabsContainer.children).findIndex(tab => 
    tab.style.background === 'var(--accent)'
  );
  
  // Helper function to save to Firebase and localStorage
  async function saveContentToFirebaseAndLocal(key, content) {
    try {
      const agent = getCurrentAgent();
      if (agent && agent.uid) {
        await window.firebaseDB.saveData('agents/' + agent.uid + '/data', key, { value: content, updatedAt: new Date() });
      }
    } catch (error) {
      console.error('Error saving to Firebase:', error);
    }
    localStorage.setItem(key, content);
  }
  
  // Save the content based on the active tab
  if (activeTabIndex === 0) { // Terms & Conditions
    customTerms = `<h3 style="margin-top: 0; color: #0b76d1; text-align: center;">Terms and Conditions</h3>${editors[0].innerHTML}`;
    saveContentToFirebaseAndLocal('customTerms', customTerms);
    showNotification('Terms & Conditions updated successfully!', 'success');
  } else if (activeTabIndex === 1) { // Section 1
    const section1Heading = headingInputs[1] ? headingInputs[1].value : '';
    const isSection1Disabled = localStorage.getItem('sectionDisabled_1') === 'true';
    
    if (!isSection1Disabled) {
      // Only save content if section is enabled
      let section1Content = '';
      if (section1Heading.trim() !== '') {
        let cleanSection1Content = editors[1].innerHTML.replace(/<h3[^>]*>.*?<\/h3>/gi, '');
        section1Content = `<h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px;">${section1Heading}</h3>${cleanSection1Content}`;
      } else {
        section1Content = editors[1].innerHTML;
      }
      saveContentToFirebaseAndLocal('visaRequirements', section1Content);
    } else {
      // Save empty content if section is disabled
      saveContentToFirebaseAndLocal('visaRequirements', '<!-- SECTION 1 HIDDEN BY USER -->');
    }
    showNotification('Section 1 updated successfully!', 'success');
  } else if (activeTabIndex === 2) { // Section 2
    const section2Heading = headingInputs[2] ? headingInputs[2].value : '';
    const isSection2Disabled = localStorage.getItem('sectionDisabled_2') === 'true';
    
    if (!isSection2Disabled) {
      // Only save content if section is enabled
      let section2Content = '';
      if (section2Heading.trim() !== '') {
        let cleanSection2Content = editors[2].innerHTML.replace(/<h3[^>]*>.*?<\/h3>/gi, '');
        section2Content = `<h3 style="margin-top: 0; color: #0b76d1; text-align: center; margin-bottom: 15px;">${section2Heading}</h3>${cleanSection2Content}`;
      } else {
        section2Content = editors[2].innerHTML;
      }
      saveContentToFirebaseAndLocal('biometricProcess', section2Content);
    } else {
      // Save empty content if section is disabled
      saveContentToFirebaseAndLocal('biometricProcess', '<!-- SECTION 2 HIDDEN BY USER -->');
    }
    showNotification('Section 2 updated successfully!', 'success');
  }
  
  modal.classList.remove('visible');
  // Reopen the quotation modal after saving
  setTimeout(() => {
    showQuotationModal();
  }, 300);
});
  modalButtons.appendChild(saveBtn);
  
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = 'ghost';
  cancelBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    modal.classList.remove('visible');
    // Reopen the quotation modal after canceling
    setTimeout(() => {
      showQuotationModal();
    }, 300);
  });
  modalButtons.appendChild(cancelBtn);
  
  modal.classList.add('visible');
}

// Function to update quotation status
function updateQuotationStatus(quotationId, newStatus) {
  try {
    // Get all quotations
    let savedQuotations = JSON.parse(localStorage.getItem('savedQuotations_umrah')) || [];
    
    // Find and update the quotation
    const quotationIndex = savedQuotations.findIndex(q => q.id === quotationId);
    if (quotationIndex !== -1) {
      savedQuotations[quotationIndex].status = newStatus;
      savedQuotations[quotationIndex].updatedAt = new Date().toISOString();
      
      // Save back to localStorage
      localStorage.setItem('savedQuotations_umrah', JSON.stringify(savedQuotations));
      
      // Save to Firebase
      const agent = getCurrentAgent();
      if (agent && agent.id) {
        window.firebaseDB.saveData('umrah_quotations', agent.id, { 
          quotations: savedQuotations, 
          updatedAt: new Date(),
          agentId: agent.id 
        }).catch(err => console.error('Firebase update error:', err));
      }
      
      // Trigger dashboard refresh
      sessionStorage.setItem('refreshDashboard_umrah', 'true');
      
      showNotification(`Quotation status updated to: ${newStatus}`, "success");
      
      // Add this to ensure status section is visible after update
      showStatusSection();
      
      return true;
    }
    return false;
  } catch (error) {
    console.error('Error updating quotation status:', error);
    showAlert("Failed to update quotation status. Please try again.", "Error");
    return false;
  }
}

function showStatusSection() {
  const statusSection = document.getElementById('statusSection');
  const quotationStatus = document.getElementById('quotationStatus');
  
  // Get all quotations from localStorage
  const allSavedQuotations = JSON.parse(localStorage.getItem('savedQuotations')) || [];
  
  if (currentQuotationId) {
    statusSection.style.display = 'block';
    
    // Get current status
    const quotation = allSavedQuotations.find(q => q.id === currentQuotationId);
    if (quotation && quotation.status) {
      quotationStatus.value = quotation.status;
    } else {
      quotationStatus.value = 'pending';
    }
  } else {
    statusSection.style.display = 'none';
  }
}

// Add a small delay to ensure all elements are loaded
setTimeout(() => {
  showStatusSection();
}, 100);

// Event listener for status update button
document.getElementById('btnUpdateStatus').addEventListener('click', () => {
  if (!currentQuotationId) {
    showAlert("No quotation selected. Please save or load a quotation first.");
    return;
  }
  
  const newStatus = document.getElementById('quotationStatus').value;
  updateQuotationStatus(currentQuotationId, newStatus);
});


// Dashboard button event listener
document.getElementById('btnDashboard').addEventListener('click', () => {
  // Check if user is logged in
  const agent = getCurrentAgent();
  if (!agent) {
    showAlert("Please login to access dashboard");
    return;
  }
  
  // Open dashboard in same window
  window.location.href = 'dashboard.html';
});

// Auto-Save Functionality
let autoSaveTimer;

function setupAutoSave() {
  if (autoSaveTimer) clearTimeout(autoSaveTimer);
  
  autoSaveTimer = setTimeout(() => {
    if (isClientDataSaved) {
      saveQuotation();
      showNotification("Auto-saved", "info", 2000);
    }
  }, 30000); // Auto-save every 30 seconds
}

function handleUrlParameters() {
  const urlParams = new URLSearchParams(window.location.search);
  const viewId = urlParams.get('view');
  const editId = urlParams.get('edit');
  const selectedId = localStorage.getItem('selectedQuotationId');
  
  // Use URL parameter first, then localStorage
  const quotationIdToLoad = viewId || editId || selectedId;
  
  if (quotationIdToLoad) {
    console.log('Loading quotation:', quotationIdToLoad); // Debug log
    
    // Wait for page to fully load
    setTimeout(() => {
      // Load the quotation
      loadQuotation(quotationIdToLoad);
      
      // If viewing, show quotation modal after loading
      if (viewId) {
        setTimeout(() => {
          showQuotationModal();
        }, 2000);
      }
    }, 1000);
    
    // Add this at the end to ensure status is shown
    setTimeout(() => {
      showStatusSection();
    }, 1500);
  }
}

// Add event listeners for auto-save
document.addEventListener('DOMContentLoaded', () => {
  // Add auto-save to all input fields
  document.querySelectorAll('input, select, textarea').forEach(element => {
    element.addEventListener('change', setupAutoSave);
  });
  
  // Handle URL parameters for view/edit
  handleUrlParameters();
});

// Update agent display in header
function updateAgentDisplay() {
  const agent = JSON.parse(localStorage.getItem("loggedInAgent"));
  if (agent) {
    document.getElementById("agentNameDisplay").textContent = agent.name;
    document.getElementById("agentPhoneDisplay").textContent = agent.phone;
  } else {
    document.getElementById("agentNameDisplay").textContent = '—';
    document.getElementById("agentPhoneDisplay").textContent = '';
  }
}
// Call this function after successful login
updateAgentDisplay();

</script>

</form>
</div>
</body>
</html>