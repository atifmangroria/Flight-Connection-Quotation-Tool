<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agent Login - Flight Connection</title>
<style>
  :root{--accent:#0b76d1;--muted:#666;--success:#28a745;--warning:#f39c12;--danger:#e74c3c;--info:#17a2b8}
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;margin:0;padding:0;display:flex;justify-content:center;align-items:center;min-height:100vh;color:#111}
  .login-container{background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.1);width:100%;max-width:400px}
  .logo{text-align:center;margin-bottom:30px}
  .logo img{max-height:80px;margin-bottom:10px}
  .logo h1{margin:0;font-size:24px;color:var(--accent)}
  .logo p{margin:5px 0 0 0;color:var(--muted);font-size:14px}
  .form-group{margin-bottom:20px}
  .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#333}
  .form-group input{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;box-sizing:border-box}
  .form-group input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(11,118,209,0.1)}
  .btn{width:100%;padding:12px;border:none;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s}
  .btn-primary{background:var(--accent);color:white}
  .btn-primary:hover{background:#085ea3;transform:translateY(-1px);box-shadow:0 4px 12px rgba(11,118,209,0.3)}
  .btn-secondary{background:#6c757d;color:white;margin-top:10px}
  .btn-secondary:hover{background:#5a6268}
  .error{color:var(--danger);font-size:14px;margin-top:5px;display:none}
  .success{color:var(--success);font-size:14px;margin-top:5px;display:none}
  .tabs{display:flex;margin-bottom:30px;border-bottom:1px solid #eee}
  .tab{flex:1;padding:10px;text-align:center;cursor:pointer;border-bottom:2px solid transparent;font-weight:600}
  .tab.active{border-bottom-color:var(--accent);color:var(--accent)}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .register-link{text-align:center;margin-top:20px}
  .register-link a{color:var(--accent);text-decoration:none;font-weight:600}
  .register-link a:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="login-container">
  <div class="logo">
    <img src="https://flightconnection.net.pk/wp-content/uploads/2018/09/cropped-cropped-Flight-Connection-Travel-1.png" alt="Flight Connection">
    <h1>Flight Connection</h1>
    <p>Agent Portal</p>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('login')">Login</div>
    <div class="tab" onclick="switchTab('register')">Register</div>
  </div>

  <!-- Login Tab -->
  <div id="loginTab" class="tab-content active">
    <form id="loginForm" onsubmit="return false;">
      <div class="form-group">
        <label for="agentId">Agent ID</label>
        <input type="text" id="agentId" placeholder="e.g. atif@fc" required>
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter password" required>
      </div>
      <div id="loginError" class="error"></div>
      <div id="loginSuccess" class="success"></div>
      <button type="submit" class="btn btn-primary">Login</button>
    </form>
  </div>

  <!-- Register Tab -->
  <div id="registerTab" class="tab-content">
    <form id="registerForm" onsubmit="return false;">
      <div class="form-group">
        <label for="regAgentId">Agent ID</label>
        <input type="text" id="regAgentId" placeholder="e.g. newagent@fc" required>
      </div>
      <div class="form-group">
        <label for="regName">Full Name</label>
        <input type="text" id="regName" placeholder="Enter full name" required>
      </div>
      <div class="form-group">
        <label for="regPhone">Phone Number</label>
        <input type="text" id="regPhone" placeholder="e.g. 03001234567" required>
      </div>
      <div class="form-group">
        <label for="regPassword">Password</label>
        <input type="password" id="regPassword" placeholder="Enter password" required>
      </div>
      <div class="form-group">
        <label for="regConfirmPassword">Confirm Password</label>
        <input type="password" id="regConfirmPassword" placeholder="Confirm password" required>
      </div>
      <div id="registerError" class="error"></div>
      <div id="registerSuccess" class="success"></div>
      <button type="submit" class="btn btn-primary">Register</button>
    </form>
  </div>

  <div class="register-link">
    <p>Need help? Contact support at <a href="mailto:info@flightconnection.net.pk">info@flightconnection.net.pk</a></p>
  </div>
</div>

<script type="module">
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

// Firebase config (same as in firebase.js)
const firebaseConfig = {
  apiKey: "AIzaSyDx3Qxt84vJlz_-mXuxiC0W2flaLadr9Ws",
  authDomain: "fc-quotation-tool.firebaseapp.com",
  projectId: "fc-quotation-tool",
  storageBucket: "fc-quotation-tool.appspot.com",
  messagingSenderId: "370566945624",
  appId: "1:370566945624:web:a84b20d5a8f99d20a6e32d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Switch between tabs
window.switchTab = function(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab + 'Tab').classList.add('active');
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('loginSuccess').style.display = 'none';
  document.getElementById('registerError').style.display = 'none';
  document.getElementById('registerSuccess').style.display = 'none';
}

function showMessage(elementId, message, isError = false) {
  const element = document.getElementById(elementId);
  element.textContent = message;
  element.style.display = 'block';
  if (isError) {
    element.className = 'error';
  } else {
    element.className = 'success';
  }
  setTimeout(() => {
    element.style.display = 'none';
  }, 5000);
}

// Login form submission (Firebase Auth)
document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const agentId = document.getElementById('agentId').value.trim();
  const password = document.getElementById('password').value;
  if (!agentId || !password) {
    showMessage('loginError', 'Please enter Agent ID and password', true);
    return;
  }
  // Use agentId as email for Firebase Auth
  const email = agentId;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    showMessage('loginSuccess', 'Login successful! Redirecting to dashboard...');
    setTimeout(() => {
      window.location.href = 'dashboard.html';
    }, 2000);
  } catch (error) {
    showMessage('loginError', error.message, true);
  }
});

// Register form submission (Firebase Auth + Firestore)
document.getElementById('registerForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const agentId = document.getElementById('regAgentId').value.trim();
  const name = document.getElementById('regName').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const password = document.getElementById('regPassword').value;
  const confirmPassword = document.getElementById('regConfirmPassword').value;
  if (!agentId || !name || !phone || !password || !confirmPassword) {
    showMessage('registerError', 'All fields are required', true);
    return;
  }
  if (!agentId.includes("@fc")) {
    showMessage('registerError', 'Agent ID must contain @fc at the end', true);
    return;
  }
  if (password.length < 6) {
    showMessage('registerError', 'Password must be at least 6 characters long', true);
    return;
  }
  if (password !== confirmPassword) {
    showMessage('registerError', 'Passwords do not match', true);
    return;
  }
  if (!/^03\d{9}$/.test(phone)) {
    showMessage('registerError', 'Please enter a valid Pakistani phone number (e.g., 03001234567)', true);
    return;
  }
  const email = agentId;
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    console.log('User created with UID:', userCredential.user.uid);
    
    try {
      // Save profile in Firestore
      const profileData = {
        id: agentId,
        name: name,
        phone: phone,
        registeredAt: new Date().toISOString()
      };
      console.log('Saving profile data:', profileData);
      await setDoc(doc(db, "users", userCredential.user.uid), profileData);
      console.log('Profile saved successfully');
      showMessage('registerSuccess', 'Registration successful! You can now login.');
      document.getElementById('registerForm').reset();
      setTimeout(() => {
        switchTab('login');
      }, 2000);
    } catch (profileError) {
      console.error('Failed to save profile:', profileError);
      // Delete the user account if profile save fails
      await userCredential.user.delete();
      throw new Error('Failed to save profile. Please try again.');
    }
  } catch (error) {
    console.error('Registration error:', error);
    showMessage('registerError', error.message, true);
  }
});

// Check if user is already logged in
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
onAuthStateChanged(auth, (user) => {
  if (user) {
    window.location.href = 'dashboard.html';
  }
});
</script>
</body>
</html>